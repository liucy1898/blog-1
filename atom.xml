<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hexo</title>
  
  
  <link href="/blog/atom.xml" rel="self"/>
  
  <link href="https://destinywang.github.io/blog/"/>
  <updated>2019-02-18T15:06:38.044Z</updated>
  <id>https://destinywang.github.io/blog/</id>
  
  <author>
    <name>destiny</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Activiti源码分析(2)--流程引擎类</title>
    <link href="https://destinywang.github.io/blog/2019/02/18/Activiti%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-2-%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E7%B1%BB/"/>
    <id>https://destinywang.github.io/blog/2019/02/18/Activiti源码分析-2-流程引擎类/</id>
    <published>2019-02-18T14:42:12.000Z</published>
    <updated>2019-02-18T15:06:38.044Z</updated>
    
    <content type="html"><![CDATA[<p>在上一篇文章中, 我们跟踪了流程引擎配置类对象的创建过程, 今天紧接着来看 Activiti 在获取到流程引擎配置类之后, 如何完成流程引擎的初始化.</p><h1 id="1-ProcessEngineConfiguration-类"><a href="#1-ProcessEngineConfiguration-类" class="headerlink" title="1. ProcessEngineConfiguration 类"></a>1. ProcessEngineConfiguration 类</h1><h2 id="1-1-buildProcessEngine-方法"><a href="#1-1-buildProcessEngine-方法" class="headerlink" title="1.1. buildProcessEngine() 方法"></a>1.1. buildProcessEngine() 方法</h2><p>该方法是一个抽象方法, 实现类分别有:</p><ol><li>MultiSchemaMultiTenantProcessEngineConfiguration</li><li>ProcessEngineConfigurationImpl</li><li>SpringProcessEngineConfiguration</li></ol><h1 id="2-ProcessEngineConfigurationImpl-类"><a href="#2-ProcessEngineConfigurationImpl-类" class="headerlink" title="2. ProcessEngineConfigurationImpl 类"></a>2. ProcessEngineConfigurationImpl 类</h1><h2 id="2-1-buildProcessEngine"><a href="#2-1-buildProcessEngine" class="headerlink" title="2.1. buildProcessEngine()"></a>2.1. buildProcessEngine()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ProcessEngine <span class="title">buildProcessEngine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    init();</span><br><span class="line">    ProcessEngineImpl processEngine = <span class="keyword">new</span> ProcessEngineImpl(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// trigger build of Activiti 5 Engine</span></span><br><span class="line">    <span class="keyword">if</span> (isActiviti5CompatibilityEnabled &amp;&amp; activiti5CompatibilityHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Context.setProcessEngineConfiguration(processEngine.getProcessEngineConfiguration());</span><br><span class="line">        activiti5CompatibilityHandler.getRawProcessEngine();</span><br><span class="line">    &#125;</span><br><span class="line">    postProcessEngineInitialisation();</span><br><span class="line">    <span class="keyword">return</span> processEngine;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-2-init"><a href="#2-2-init" class="headerlink" title="2.2. init()"></a>2.2. init()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    initConfigurators();</span><br><span class="line">    configuratorsBeforeInit();</span><br><span class="line">    initProcessDiagramGenerator();</span><br><span class="line">    initHistoryLevel();</span><br><span class="line">    initExpressionManager();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (usingRelationalDatabase) &#123;</span><br><span class="line">      initDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    initAgendaFactory();</span><br><span class="line">    initHelpers();</span><br><span class="line">    initVariableTypes();</span><br><span class="line">    initBeans();</span><br><span class="line">    initFormEngines();</span><br><span class="line">    initFormTypes();</span><br><span class="line">    initScriptingEngines();</span><br><span class="line">    initClock();</span><br><span class="line">    initBusinessCalendarManager();</span><br><span class="line">    initCommandContextFactory();</span><br><span class="line">    initTransactionContextFactory();</span><br><span class="line">    initCommandExecutors();</span><br><span class="line">    initServices();</span><br><span class="line">    initIdGenerator();</span><br><span class="line">    initBehaviorFactory();</span><br><span class="line">    initListenerFactory();</span><br><span class="line">    initBpmnParser();</span><br><span class="line">    initProcessDefinitionCache();</span><br><span class="line">    initProcessDefinitionInfoCache();</span><br><span class="line">    initKnowledgeBaseCache();</span><br><span class="line">    initJobHandlers();</span><br><span class="line">    initJobManager();</span><br><span class="line">    initAsyncExecutor();</span><br><span class="line"></span><br><span class="line">    initTransactionFactory();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (usingRelationalDatabase) &#123;</span><br><span class="line">      initSqlSessionFactory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    initSessionFactories();</span><br><span class="line">    initDataManagers();</span><br><span class="line">    initEntityManagers();</span><br><span class="line">    initHistoryManager();</span><br><span class="line">    initJpa();</span><br><span class="line">    initDeployers();</span><br><span class="line">    initDelegateInterceptor();</span><br><span class="line">    initEventHandlers();</span><br><span class="line">    initFailedJobCommandFactory();</span><br><span class="line">    initEventDispatcher();</span><br><span class="line">    initProcessValidator();</span><br><span class="line">    initDatabaseEventLogging();</span><br><span class="line">    initActiviti5CompatibilityHandler();</span><br><span class="line">    configuratorsAfterInit();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在上一篇文章中, 我们跟踪了流程引擎配置类对象的创建过程, 今天紧接着来看 Activiti 在获取到流程引擎配置类之后, 如何完成流程引擎的初始化.&lt;/p&gt;
&lt;h1 id=&quot;1-ProcessEngineConfiguration-类&quot;&gt;&lt;a href=&quot;#1-Proce
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>关系型数据库的瓶颈与优化</title>
    <link href="https://destinywang.github.io/blog/2019/01/19/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%93%B6%E9%A2%88%E4%B8%8E%E4%BC%98%E5%8C%96/"/>
    <id>https://destinywang.github.io/blog/2019/01/19/关系型数据库的瓶颈与优化/</id>
    <published>2019-01-19T13:42:46.000Z</published>
    <updated>2019-01-26T14:03:29.735Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-数据库的分类"><a href="#1-数据库的分类" class="headerlink" title="1. 数据库的分类"></a>1. 数据库的分类</h1><p>数据库大致可以分为两部分:</p><ol><li>传统的关系型数据库, 如: MySQL, Oracle, SQLServer 以及 PostgreSQL; MySQL 是国内使用最广泛的数据库, Oracle 在传统行业应用最为广泛, PostgreSQL 性能和功能都比较完善, 但目前文档和社区还有待成长.</li><li>非关系型数据库, 如 HBase(列式数据库), MongoDB(文档型数据库), Redis(高性能 KV 存储), Lucene(搜索引擎) 等等.</li></ol><h1 id="2-关系型数据库的瓶颈与优化"><a href="#2-关系型数据库的瓶颈与优化" class="headerlink" title="2. 关系型数据库的瓶颈与优化"></a>2. 关系型数据库的瓶颈与优化</h1><h2 id="2-1-为什么数据库的架构需要调整"><a href="#2-1-为什么数据库的架构需要调整" class="headerlink" title="2.1 为什么数据库的架构需要调整"></a>2.1 为什么数据库的架构需要调整</h2><ol><li>互联网的数据增长往往是指数型的;</li><li>读写分离, 分布式: 单机性能上存在瓶颈;</li><li>NoSQL, 搜索引擎: 特殊场景的需求无法满足;</li><li>分析系统: 无法满足大数据的分析需求;</li><li>部署要求: 同城容灾/异地容灾.</li></ol><h2 id="2-2-数据库会遇到什么问题"><a href="#2-2-数据库会遇到什么问题" class="headerlink" title="2.2 数据库会遇到什么问题"></a>2.2 数据库会遇到什么问题</h2><h3 id="2-2-1-性能"><a href="#2-2-1-性能" class="headerlink" title="2.2.1 性能"></a>2.2.1 性能</h3><ul><li>查询性能</li><li>写入更新</li><li>并发, 数据量等</li></ul><h3 id="2-2-2-功能"><a href="#2-2-2-功能" class="headerlink" title="2.2.2 功能"></a>2.2.2 功能</h3><ul><li>新功能: LBS/JSON/特殊业务场景</li><li>数据安全性: 强一致性/非强一致性</li><li>大数据分析</li><li>搜索等</li></ul><h1 id="3-不同业务场景的存储选型"><a href="#3-不同业务场景的存储选型" class="headerlink" title="3. 不同业务场景的存储选型"></a>3. 不同业务场景的存储选型</h1><h2 id="3-1-一个简单的问题"><a href="#3-1-一个简单的问题" class="headerlink" title="3.1 一个简单的问题"></a>3.1 一个简单的问题</h2><h4 id="MySQL-已经有-cache-了-为何还需要加一层-Redis"><a href="#MySQL-已经有-cache-了-为何还需要加一层-Redis" class="headerlink" title="MySQL 已经有 cache 了, 为何还需要加一层 Redis"></a>MySQL 已经有 cache 了, 为何还需要加一层 Redis</h4><h2 id="3-2-数据库查询开销"><a href="#3-2-数据库查询开销" class="headerlink" title="3.2 数据库查询开销"></a>3.2 数据库查询开销</h2><p><img src="https://user-images.githubusercontent.com/17758731/51440848-276d6200-1d06-11e9-8a4e-27a280b1a538.png" alt="image"></p><p>其中比较耗时的步骤有:</p><ul><li>建立 TCP 连接</li><li>生成执行计划</li><li>开表</li><li>从磁盘扫描数据</li><li>关闭连接</li></ul><h3 id="3-2-1-SQL-解析"><a href="#3-2-1-SQL-解析" class="headerlink" title="3.2.1 SQL 解析"></a>3.2.1 SQL 解析</h3><p>假设有如下三条语句, 均是根据主键的查询.</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 1 </span><br><span class="line">SELECT id, name, price FROM products WHERE id IN (1, 2, 3, 4, ... 30000);           # (1-2s)</span><br><span class="line"></span><br><span class="line"># 2. 将第一条查询转换成 30000 条语句</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span>, <span class="keyword">name</span>, price <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br><span class="line">...</span><br><span class="line">SELECT id, name, price FROM products WHERE id = 30000;                              # (2-3s)</span><br><span class="line"></span><br><span class="line"># 3. 将第一条转换成 OR 语句</span><br><span class="line">SELECT id, name, price FROM products WHERE id = 1 OR id = 2 OR ... OR id = 30000;   # (8-10s)</span><br></pre></td></tr></table></figure><p>造成第三条语句执行时间如此长的主要原因就是大量的 OR 语句会导致 SQL 解析非常耗时.</p><h3 id="3-2-2-以-MySQL-的-InnoDB-存储引擎主键查询为例"><a href="#3-2-2-以-MySQL-的-InnoDB-存储引擎主键查询为例" class="headerlink" title="3.2.2 以 MySQL 的 InnoDB 存储引擎主键查询为例"></a>3.2.2 以 MySQL 的 InnoDB 存储引擎主键查询为例</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> <span class="keyword">id</span> = ?;</span><br></pre></td></tr></table></figure><p><img src="https://user-images.githubusercontent.com/17758731/51441235-71f0dd80-1d0a-11e9-95ef-24b2c481a4f0.png" alt="image"></p><p>常规配置的服务器基本可以达到 400000 QPS.</p><h3 id="3-2-3-如果查询条件不是主键"><a href="#3-2-3-如果查询条件不是主键" class="headerlink" title="3.2.3 如果查询条件不是主键"></a>3.2.3 如果查询条件不是主键</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> <span class="keyword">name</span> = ?;</span><br></pre></td></tr></table></figure><p><img src="https://user-images.githubusercontent.com/17758731/51441306-2ab71c80-1d0b-11e9-9b86-cf7aa0957787.png" alt="image"></p><p>对于非主键的查询, MySQL 会根据二级索引查询到主索引对应节点的位置. 按照图中的情况, 会首先通过三次 IO 找到对应主键, 在二级索引的叶子节点会同时保存索引字段的值以及主键的值, 再回到主索引通过主键查询到整条记录.</p><p>在 MySQL 中, 主键查询时最为高效的一类查询.</p><p>DBA 往往希望所有的 SQL 语句都是 KV 查询, 但是往往是不现实的.</p><ul><li>主键查询有限, 有些主键没有业务含义;</li><li>设计表结构时, 并没有考虑过主键问题.</li></ul><p>SQL 语句允许开发人员用各种方式从表中获取数据, 但 DBA 却不会希望我们这么做.</p><h3 id="3-2-3-数据库的大字段"><a href="#3-2-3-数据库的大字段" class="headerlink" title="3.2.3 数据库的大字段"></a>3.2.3 数据库的大字段</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content varchar(2046) NOT NULL <span class="keyword">COMMENT</span> <span class="string">'原始消息'</span>;</span><br></pre></td></tr></table></figure><p>以 InnoDB 存储引擎为例:</p><ul><li>TinyText/Text/Mediumtext</li><li>varchar(256)/varchar(500)/varchar(20000)</li><li>tinyBlob/blob/mediumBlob </li></ul><p>text 类型本质上和 varchar 类型没有区别.</p><p><img src="https://user-images.githubusercontent.com/17758731/51544585-3a656b00-1e9b-11e9-9610-28431f9b1b09.png" alt="image"></p><p>MySQL 中, 数据是以页的方式来组织的, 每个数据页默认大小 16 KB, 其中包括页头, 页尾, 中间是一行一行的记录.</p><p>图中的每条记录包括 ID, NAME, AGE 和 DETAIL. 假设 DETAIL 是一个大字段, 达到超过了单页的大小, 此时 DB 会新开一个数据页, 当前页通过指针指向该页. 如果一页依然不够, MySQL 就会不断新加数据页直到能够存下为止.</p><p>一旦存在这样的大字段, 会带来如下问题:</p><ol><li>查询开销大;</li><li>查询影响大, 严重时会触发热页换出, 引起系统抖动. MySQL 将记录从磁盘读取出来的时候, 可能会有很多数据页, MySQL 自带缓存时非常宝贵的, 会导致真正使用频率高的数据页被替换成大字段的数据页. 此外, 对 MySQL 来说, 即便只查记录中的某几个字段, 数据库依然会把整条记录取出, 读进内存, 再进行指定字段的筛选</li></ol><p>对于大字段场景可以尝试的优化方案:</p><ol><li>是否适合存储关系型数据库;</li><li>是否所有数据都需要存数据库;</li><li>是否可以新建一张表存储大字段.</li></ol><h3 id="3-2-4-数据库缓存利用率"><a href="#3-2-4-数据库缓存利用率" class="headerlink" title="3.2.4 数据库缓存利用率"></a>3.2.4 数据库缓存利用率</h3><p>以 InnoDB 存储引擎为例:</p><ol><li>MySQL 默认数据页为 <code>16KB</code>, 哪怕只读一行记录, 也需要从磁盘中取出 <code>16KB</code> 数据取出;</li><li>MySQL 是以页为最小的缓存单位;</li><li>如果每行数据 1kb, 256kb 内存空间能缓存多少行有效数据, 最好的情况是每条数据整齐排列在一个数据页中, 那么可以缓存256条记录, 最坏的情况下每一页只存在一条数据, 那么就只能缓存16条;</li><li>在 256KB 的 Buffer Pool 中, 并不是所有空间都用来做数据页缓存, 有很大的一块在 Write Buffer(MySQL 为了优化写操作, 会将一段时间内的写操作先放在 Write Buffer, 再由后台线程定时异步刷新到磁盘上). 然而剩下的 <code>128KB</code> 中还存在一部分脏页.</li></ol><p><img src="https://user-images.githubusercontent.com/17758731/51545929-02135c00-1e9e-11e9-94ac-d755610749d5.png" alt="image"></p><p>缓存为什么如此重要:</p><ul><li>互联网产品往往读多写少;</li><li>扩展缓存远比扩展 DB 简单;</li><li>数据库缓存利用率很低;</li><li>互联网应用对 DB 响应时间比较敏感, 缓存系统一般性能比较好</li><li>只要符合条件的数据都应该走缓存:<ol><li>修改不频繁的数据;</li><li>非实时的数据, 一致性要求不严的数据;</li><li>查询频率较高, 带有明显热点请求的数据;</li></ol></li></ul><h3 id="3-2-5-缓存带来的问题"><a href="#3-2-5-缓存带来的问题" class="headerlink" title="3.2.5 缓存带来的问题"></a>3.2.5 缓存带来的问题</h3><blockquote><p>用了缓存并不一定代表没有问题</p></blockquote><ol><li>缓存命中</li><li>缓存穿透</li><li>缓存失效</li><li>缓存一致</li></ol><h3 id="3-2-6-选择正确的索引"><a href="#3-2-6-选择正确的索引" class="headerlink" title="3.2.6 选择正确的索引"></a>3.2.6 选择正确的索引</h3><blockquote><p>降低扫描数据量还是降低排序代价</p></blockquote><p>大多数查询只能使用一个索引, 因此在需要对多个列进行操作的 SQL 语句中, 我们需要准确评估每个索引的开销.</p><ul><li>key idx_create_time(createTime)</li><li>key idx_price(price)<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tb_order <span class="keyword">WHERE</span> createTime &gt; xxx <span class="keyword">AND</span> createTime &lt; xxx <span class="keyword">ORDER</span> <span class="keyword">BY</span> price <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure></li></ul><h3 id="3-2-7-索引的使用"><a href="#3-2-7-索引的使用" class="headerlink" title="3.2.7 索引的使用"></a>3.2.7 索引的使用</h3><h4 id="3-2-7-1-索引字段过长-超过索引支持"><a href="#3-2-7-1-索引字段过长-超过索引支持" class="headerlink" title="3.2.7.1 索引字段过长, 超过索引支持"></a>3.2.7.1 索引字段过长, 超过索引支持</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># name varchar(512)</span><br><span class="line"># ket idx_name(name(100))</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">comment</span> <span class="keyword">WHERE</span> <span class="keyword">name</span> &gt;= <span class="string">'destiny'</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">name</span> <span class="keyword">ASC</span> <span class="keyword">LIMIT</span> <span class="number">100</span>;</span><br></pre></td></tr></table></figure><p>上面的例子在实际场景中执行非常慢, 使用 EXPLAIN 打印查询计划: </p><pre><code>  select_type: SIMPLE        table: comment         type: rangepossible_keys: id_name          key: uk_sess      key_len: 403          ref: NULL         rows: 462642        Extra:Using where; Using filesort1 row in set(0.00sec)</code></pre><p>其中需要重点关注的是: <code>Extra:Using where; Using filesort</code></p><ul><li>Using where: 表用到了索引</li><li>Using filesort: MySQL 自带的磁盘排序, 并没有用到索引的排序</li></ul><p>问题是为什么使用了索引, 查询效率依然非常慢?</p><p>真正的原因是字段太长, 而索引的长度只能覆盖 256 字节, 导致 ORDER BY 无法在内存中完成排序</p><h4 id="3-2-7-2"><a href="#3-2-7-2" class="headerlink" title="3.2.7.2"></a>3.2.7.2</h4><p>查询某个用户 id 的分值总和</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- uid varchar(190) NOT NULL DEFAULT '' COMMENT '用户 id',</span></span><br><span class="line"><span class="comment">-- score bigint(20) NOT NULL DEFAULT '0' COMMENT '变动分值, 正增, 负减',</span></span><br><span class="line"><span class="comment">-- primary key ID</span></span><br><span class="line"><span class="comment">-- KEY idx_uid(uid)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">SUM</span>(score) <span class="keyword">FROM</span> <span class="keyword">name</span> <span class="keyword">WHERE</span> uid = <span class="string">'5993156'</span></span><br></pre></td></tr></table></figure><p><img src="https://user-images.githubusercontent.com/17758731/51613355-3f3f2300-1f5e-11e9-8736-f60fca4007b1.png" alt="image"></p><p>这条 SQL 的执行顺序:</p><ol><li>根据二级索引 uid 找到所有主键 id</li><li>再根据主键逐行找到 score</li><li>对 score 进行聚合</li></ol><p>这个 SQL 的问题在于需要进行大量的回表操作(从二级索引回到一级索引), 然后将全部符合过滤条件的记录放在内存中完成聚合操作.</p><p>改进的方法其实很简单, 可以尝试使用 (uid, score) 建立联合索引, 这样只需要查询二级索引就可以获得全部数据.</p><p><img src="https://user-images.githubusercontent.com/17758731/51614040-d062c980-1f5f-11e9-9960-41cc62ad6c77.png" alt="image"></p><p>随机插入 100W 条数据, 现在对比下两条索引的开销.</p><p><img src="https://user-images.githubusercontent.com/17758731/51614096-f0928880-1f5f-11e9-8c2d-bc625ffb2eb1.png" alt="image"></p><h2 id="3-3-数据库写开销"><a href="#3-3-数据库写开销" class="headerlink" title="3.3 数据库写开销"></a>3.3 数据库写开销</h2><ul><li>对持久化要求严格, 写操作代价大</li><li>日志文件需要 fsync, 硬件存在瓶颈</li><li>数据库写操作很难扩展</li><li>主从要求一致场景下还要算上网络开销</li></ul><p><img src="https://user-images.githubusercontent.com/17758731/51615980-191c8180-1f64-11e9-95db-355d532b58d5.png" alt="image"></p><ol><li>将 3 所在的数据页读到缓存中;</li><li>在内存中将 3 改成 5, 提交事务, 触发 Redo Log 的刷新;</li><li>向用户返回操作成功;</li></ol><h2 id="3-4-业务场景触发的高并发写入"><a href="#3-4-业务场景触发的高并发写入" class="headerlink" title="3.4 业务场景触发的高并发写入"></a>3.4 业务场景触发的高并发写入</h2><h3 id="3-4-1-秒杀"><a href="#3-4-1-秒杀" class="headerlink" title="3.4.1 秒杀"></a>3.4.1 秒杀</h3><ul><li>高并发写入的极端情况</li><li>业务优化(缓存/令牌通/排队/Java 信号量/乐观锁)</li><li>热点资源隔离</li><li>引入数据库线程池</li><li>InnoDB 内核层优化: AliSQL</li></ul><h3 id="3-4-2-私信-站内信消息推送"><a href="#3-4-2-私信-站内信消息推送" class="headerlink" title="3.4.2 私信/站内信消息推送"></a>3.4.2 私信/站内信消息推送</h3><ul><li>高并发写入</li><li>伴随大量的读请求</li><li>系统消息/个人消息区分对待</li><li>消息内容单独对待</li><li>延迟写入, 通过队列/缓存达到限流目的</li></ul><h3 id="3-4-3-听歌量"><a href="#3-4-3-听歌量" class="headerlink" title="3.4.3 听歌量"></a>3.4.3 听歌量</h3><p><img src="https://user-images.githubusercontent.com/17758731/51684703-a1178f80-2027-11e9-94ef-6f320b852c29.png" alt="image"></p><ul><li>业务原因导致写入量非常大</li><li>插入更新比不确定, 更新能力强</li><li>数据库需要具备自动扩展的能力</li><li>数据非强一致</li></ul><h2 id="3-5-死锁和超时"><a href="#3-5-死锁和超时" class="headerlink" title="3.5 死锁和超时"></a>3.5 死锁和超时</h2><ul><li>InnoDB 锁超时默认需要 5s 等待</li><li>死锁马上就能被发现, 然后被 DB 自动回滚</li><li>锁超时一般是索引不对, 或者 SQL 语句执行性能较差</li><li>死锁一般是业务实现有问题</li><li>锁超时一般影响较为可控</li><li>死锁情况比较严重, 会导致全站崩溃</li></ul><h2 id="3-6-数据库并发事务-锁"><a href="#3-6-数据库并发事务-锁" class="headerlink" title="3.6 数据库并发事务, 锁"></a>3.6 数据库并发事务, 锁</h2><ul><li>业务流程中的锁: 减库存, 发优惠券</li></ul><p>悲观锁实现:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span> <span class="keyword">FROM</span> tb <span class="keyword">WHERE</span> <span class="keyword">id</span> = ? <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="comment">-- do sth</span></span><br><span class="line"><span class="keyword">UPDATE</span> tb <span class="keyword">SET</span> <span class="keyword">count</span> = <span class="keyword">count</span> - ? <span class="keyword">WHERE</span> <span class="keyword">id</span> = ?;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure></p><p>乐观锁实现:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span> <span class="keyword">FROM</span> tb <span class="keyword">WHERE</span> <span class="keyword">id</span> = ?;</span><br><span class="line"><span class="keyword">UPDATE</span> tb <span class="keyword">SET</span> <span class="keyword">count</span> = <span class="keyword">count</span> - ? <span class="keyword">WHERE</span> <span class="keyword">id</span> = ? <span class="keyword">AND</span> <span class="keyword">count</span> = :<span class="keyword">count</span>;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="comment">-- do sth</span></span><br></pre></td></tr></table></figure></p><h1 id="4-数据库的模块化拆分"><a href="#4-数据库的模块化拆分" class="headerlink" title="4. 数据库的模块化拆分"></a>4. 数据库的模块化拆分</h1><h2 id="4-1-单机服务器的局限"><a href="#4-1-单机服务器的局限" class="headerlink" title="4.1 单机服务器的局限"></a>4.1 单机服务器的局限</h2><ul><li>虽然硬件配置越来越高, 但是总有瓶颈(e.g. CPU/内存/网络/IO/容量)</li><li>为了后续业务的可扩展性</li><li>单机系统崩溃风险较高</li><li>优化性能<ul><li>读写分离</li><li>冷热分离, 创建归档库</li><li>关键链路和非关键链路隔离</li><li>系统层面做好降级</li></ul></li></ul><h2 id="4-2-常见拆分方案"><a href="#4-2-常见拆分方案" class="headerlink" title="4.2 常见拆分方案"></a>4.2 常见拆分方案</h2><h3 id="4-2-1-读写分离"><a href="#4-2-1-读写分离" class="headerlink" title="4.2.1 读写分离"></a>4.2.1 读写分离</h3><p>读写分离的原理就是将数据库读写操作分散到不同的节点上</p><p><img src="https://user-images.githubusercontent.com/17758731/51689739-3586ef80-2032-11e9-8d0a-3bfcb7ac34d3.png" alt="image"></p><p>读写分离的基本原理就是:</p><ul><li>数据库服务器搭建主从集群;</li><li>数据库主机负责写操作, 从机只负责读操作;</li><li>数据库主机通过复制将数据同步到从机, 每台数据库服务器都存储了所有业务数据.</li><li>业务服务器将写操作发给数据库主机, 将读操作发给数据库从机.</li></ul><p>使用读写分离之后, 可能会引入两个问题:</p><ol><li>主从复制延迟</li><li>分配机制</li></ol><h4 id="4-2-1-1-复制延迟"><a href="#4-2-1-1-复制延迟" class="headerlink" title="4.2.1.1 复制延迟"></a>4.2.1.1 复制延迟</h4><p>主从复制的延迟可能达到秒级, 如果有大量数据短时间需要完成同步, 延迟甚至可能达到分钟.</p><p>主从复制所带来的问题: </p><blockquote><p>如果业务服务器将数据写入到主库后进行读取, 此时读操作访问从库, 而主库的数据没有完全复制过来, 从库是无法读取到最新数据的.</p></blockquote><p>解决方案:</p><ol><li>写操作后的读操作指定发给主库, 逻辑会和业务强绑定, 对业务侵入较大.</li><li>读从库失败后再读一次主库, 如果有大量没有命中从库的读请求, 会给主库带来较大压力.</li><li>关键业务读写操作全部走主库, 非关键业务采用读写分离.</li></ol><h4 id="4-2-1-2-分配机制"><a href="#4-2-1-2-分配机制" class="headerlink" title="4.2.1.2 分配机制"></a>4.2.1.2 分配机制</h4><p>将读写操作区分开来, 然后访问不同的数据库服务器, 一般有两种方式: 程序代码封装和中间件封装</p><h5 id="1-程序代码封装"><a href="#1-程序代码封装" class="headerlink" title="1. 程序代码封装"></a>1. 程序代码封装</h5><p>在代码中抽象一个数据访问层, 实现读写操作分离和数据库服务器连接的管理.</p><p><img src="https://user-images.githubusercontent.com/17758731/51787744-9c321780-21b0-11e9-864b-933a0bde94e3.png" alt="image"></p><p>特点:</p><ol><li>实现简单, 可以根据业务定制化;</li><li>无法做到多语言通用, 容易重复开发;</li><li>故障情况下, 如果主从发生切换, 需要将系统配置手动修改.</li></ol><h5 id="2-中间件封装"><a href="#2-中间件封装" class="headerlink" title="2. 中间件封装"></a>2. 中间件封装</h5><p>独立一套系统出来, 实现读写分离和数据库服务器连接的管理, 中间件对业务服务器提供 SQL 兼容的协议, 业务服务器无需自己进行读写分离, 对于业务服务器来说, 访问中间件和访问数据库没有区别</p><p><img src="https://user-images.githubusercontent.com/17758731/51787885-19aa5780-21b2-11e9-8df2-cba6fb8fcc3e.png" alt="image"></p><p>特点:</p><ol><li>能够支持多种编程语言, 因为数据库中间件对业务提供的是标准的 SQL 接口.</li><li>实现较为复杂, 需要完整支持 SQL 语法和数据库服务器的协议.</li><li>性能要求很高, 容易成为瓶颈.</li><li>数据库主从切换对业务服务器无感知, 数据库中间件可以探测数据库服务器的主从状态(e.g. 向某个测试库写入一条数据, 成功的是主机, 失败的是从机)</li></ol><h3 id="4-2-2-分布式"><a href="#4-2-2-分布式" class="headerlink" title="4.2.2 分布式"></a>4.2.2 分布式</h3><p>读写分离分散了读写操作的压力, 但没有分散存储的压力, 当数据量达到千万级以上的时候, 单台数据库服务器的存储能力就会成为瓶颈:</p><ol><li>数据量太大, 读写的性能会大幅下降.</li><li>数据文件备份和恢复都会很困难.</li></ol><p><img src="https://user-images.githubusercontent.com/17758731/51788030-3051ae00-21b4-11e9-99ca-cdd067495813.png" alt="image"></p><ul><li>垂直分表: 适合将某些表中不常用且占用大量空间的列拆分出去. 代价是操作表的数量增加.</li><li>水平拆分: 适合行数较大的表, 会引入更多的复杂度: <code>路由</code>, <code>join 操作</code>, <code>count 操作</code> 等</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;1-数据库的分类&quot;&gt;&lt;a href=&quot;#1-数据库的分类&quot; class=&quot;headerlink&quot; title=&quot;1. 数据库的分类&quot;&gt;&lt;/a&gt;1. 数据库的分类&lt;/h1&gt;&lt;p&gt;数据库大致可以分为两部分:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;传统的关系型数据库, 如: MyS
      
    
    </summary>
    
      <category term="MySQL" scheme="https://destinywang.github.io/blog/categories/MySQL/"/>
    
    
      <category term="关系型数据库" scheme="https://destinywang.github.io/blog/tags/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>Redis详解(1)--数据结构</title>
    <link href="https://destinywang.github.io/blog/2019/01/16/Redis%E8%AF%A6%E8%A7%A3-1-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    <id>https://destinywang.github.io/blog/2019/01/16/Redis详解-1-数据结构/</id>
    <published>2019-01-16T15:34:03.000Z</published>
    <updated>2019-01-16T15:34:03.868Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Activiti源码分析(1)--流程引擎配置类</title>
    <link href="https://destinywang.github.io/blog/2018/12/31/Activiti%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1-%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE%E7%B1%BB/"/>
    <id>https://destinywang.github.io/blog/2018/12/31/Activiti源码分析-1-引擎配置类/</id>
    <published>2018-12-31T15:19:13.000Z</published>
    <updated>2019-02-18T16:31:12.891Z</updated>
    
    <content type="html"><![CDATA[<p>Activiti 配置风格获取引擎源码分析: </p><p>流程引擎管理类 ProcessEngines</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testProcessEngine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">    log.info(<span class="string">"processEngine: &#123;&#125;"</span>, processEngine);   <span class="comment">// org.activiti.engine.impl.ProcessEngineImpl@66ea1466</span></span><br><span class="line">    Class&lt;? extends ProcessEngine&gt; processEngineClass = processEngine.getClass();</span><br><span class="line">    log.info(<span class="string">"class: &#123;&#125;"</span>, processEngineClass);      <span class="comment">// org.activiti.engine.impl.ProcessEngineImpl</span></span><br><span class="line">    DynamicBpmnService dynamicBpmnService = processEngine.getDynamicBpmnService();</span><br><span class="line">    FormService formEngineFormService = processEngine.getFormEngineFormService();</span><br><span class="line">    FormRepositoryService formEngineRepositoryService = processEngine.getFormEngineRepositoryService();</span><br><span class="line">    org.activiti.engine.FormService formService = processEngine.getFormService();</span><br><span class="line">    HistoryService historyService = processEngine.getHistoryService();</span><br><span class="line">    IdentityService identityService = processEngine.getIdentityService();</span><br><span class="line">    ManagementService managementService = processEngine.getManagementService();</span><br><span class="line">    ProcessEngineConfiguration processEngineConfiguration = processEngine.getProcessEngineConfiguration();  <span class="comment">// 流程引擎配置类</span></span><br><span class="line">    RepositoryService repositoryService = processEngine.getRepositoryService();</span><br><span class="line">    RuntimeService runtimeService = processEngine.getRuntimeService();                                      <span class="comment">// 运行时</span></span><br><span class="line">    TaskService taskService = processEngine.getTaskService();                                               <span class="comment">// 任务相关</span></span><br><span class="line">    log.info(<span class="string">"dynamicBpmnService: &#123;&#125;"</span>, dynamicBpmnService);                     <span class="comment">// org.activiti.engine.impl.DynamicBpmnServiceImpl@1601e47</span></span><br><span class="line">    log.info(<span class="string">"formEngineFormService: &#123;&#125;"</span>, formEngineFormService);               <span class="comment">// null</span></span><br><span class="line">    log.info(<span class="string">"formEngineRepositoryService: &#123;&#125;"</span>, formEngineRepositoryService);   <span class="comment">// null</span></span><br><span class="line">    log.info(<span class="string">"formService: &#123;&#125;"</span>, formService);                                   <span class="comment">// org.activiti.engine.impl.FormServiceImpl@3bffddff</span></span><br><span class="line">    log.info(<span class="string">"historyService: &#123;&#125;"</span>, historyService);                             <span class="comment">// org.activiti.engine.impl.HistoryServiceImpl@66971f6b</span></span><br><span class="line">    log.info(<span class="string">"identityService: &#123;&#125;"</span>, identityService);                           <span class="comment">// org.activiti.engine.impl.IdentityServiceImpl@50687efb</span></span><br><span class="line">    log.info(<span class="string">"managementService: &#123;&#125;"</span>, managementService);                       <span class="comment">// org.activiti.engine.impl.ManagementServiceImpl@517bd097</span></span><br><span class="line">    log.info(<span class="string">"processEngineConfiguration: &#123;&#125;"</span>, processEngineConfiguration);     <span class="comment">// org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration@142eef62</span></span><br><span class="line">    log.info(<span class="string">"repositoryService: &#123;&#125;"</span>, repositoryService);                       <span class="comment">// org.activiti.engine.impl.RepositoryServiceImpl@4a9cc6cb</span></span><br><span class="line">    log.info(<span class="string">"runtimeService: &#123;&#125;"</span>, runtimeService);                             <span class="comment">// org.activiti.engine.impl.RuntimeServiceImpl@5990e6c5</span></span><br><span class="line">    log.info(<span class="string">"taskService: &#123;&#125;"</span>, taskService);                                   <span class="comment">// org.activiti.engine.impl.TaskServiceImpl@56e07a08</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>总的来说流程引擎配置类(ProcessEngineConfiguration) 的获取比较简单, 通过默认配置找到 classpath 下的 activiti.cfg.xml 配置文件, 再将该配置文件使用 Spring 的组件完成读取, 将 id 为 <code>processEngineConfiguration</code> 的 bean 完成初始化并返回.</p></blockquote><p><img src="https://user-images.githubusercontent.com/17758731/52964570-96a9a500-33dd-11e9-93fb-e677b4d880ff.png" alt="image"></p><h1 id="1-ProcessEngines"><a href="#1-ProcessEngines" class="headerlink" title="1. ProcessEngines"></a>1. ProcessEngines</h1><p>包含四个重要的集合</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;流程引擎名称, 流程引擎实例&gt;</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> Map&lt;String, ProcessEngine&gt; processEngines = <span class="keyword">new</span> HashMap&lt;String, ProcessEngine&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;流程引擎名称, 流程引擎信息类实例&gt;</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> Map&lt;String, ProcessEngineInfo&gt; processEngineInfosByName = <span class="keyword">new</span> HashMap&lt;String, ProcessEngineInfo&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;构造流程引擎的资源名称(如文件路径名), 流程引擎信息类实例&gt;</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> Map&lt;String, ProcessEngineInfo&gt; processEngineInfosByResourceUrl = <span class="keyword">new</span> HashMap&lt;String, ProcessEngineInfo&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存储流程引擎信息类实例对象</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> List&lt;ProcessEngineInfo&gt; processEngineInfos = <span class="keyword">new</span> ArrayList&lt;ProcessEngineInfo&gt;();</span><br></pre></td></tr></table></figure><h2 id="1-1-getDefaultProcessEngine"><a href="#1-1-getDefaultProcessEngine" class="headerlink" title="1.1. getDefaultProcessEngine"></a>1.1. getDefaultProcessEngine</h2><p>方法体中只有一行代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProcessEngine <span class="title">getDefaultProcessEngine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getProcessEngine(NAME_DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>类中 NAME_DEFAULT 的值是 <code>default</code></p><h2 id="1-2-getProcessEngine-String-processEngineName"><a href="#1-2-getProcessEngine-String-processEngineName" class="headerlink" title="1.2. getProcessEngine(String processEngineName)"></a>1.2. getProcessEngine(String processEngineName)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProcessEngine <span class="title">getProcessEngine</span><span class="params">(String processEngineName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isInitialized()) &#123;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> processEngines.get(processEngineName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>判断该类是否已经被初始化<ol><li>如果没有初始化, 执行 <code>init()</code> 方法</li></ol></li><li>返回 <code>Map&lt;String, ProcessEngine&gt; processEngines</code> 对应 key 的实例对象</li></ol><h3 id="1-2-1-isInitialized"><a href="#1-2-1-isInitialized" class="headerlink" title="1.2.1. isInitialized()"></a>1.2.1. isInitialized()</h3><p>返回类中一个静态常量, 用于标识</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">boolean</span> isInitialized;</span><br></pre></td></tr></table></figure><h2 id="1-3-init"><a href="#1-3-init" class="headerlink" title="1.3. init()"></a>1.3. init()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isInitialized()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (processEngines == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Create new map to store process-engines if current map is</span></span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            processEngines = <span class="keyword">new</span> HashMap&lt;String, ProcessEngine&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        ClassLoader classLoader = ReflectUtil.getClassLoader();</span><br><span class="line">        Enumeration&lt;URL&gt; resources = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            resources = classLoader.getResources(<span class="string">"activiti.cfg.xml"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ActivitiIllegalArgumentException(<span class="string">"problem retrieving activiti.cfg.xml resources on the classpath: "</span> + System.getProperty(<span class="string">"java.class.path"</span>), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Remove duplicated configuration URL's using set. Some</span></span><br><span class="line">        <span class="comment">// classloaders may return identical URL's twice, causing duplicate</span></span><br><span class="line">        <span class="comment">// startups</span></span><br><span class="line">        Set&lt;URL&gt; configUrls = <span class="keyword">new</span> HashSet&lt;URL&gt;();</span><br><span class="line">        <span class="keyword">while</span> (resources.hasMoreElements()) &#123;</span><br><span class="line">            configUrls.add(resources.nextElement());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Iterator&lt;URL&gt; iterator = configUrls.iterator(); iterator.hasNext();) &#123;</span><br><span class="line">            URL resource = iterator.next();</span><br><span class="line">            log.info(<span class="string">"Initializing process engine using configuration '&#123;&#125;'"</span>, resource.toString());</span><br><span class="line">            initProcessEngineFromResource(resource);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            resources = classLoader.getResources(<span class="string">"activiti-context.xml"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ActivitiIllegalArgumentException(<span class="string">"problem retrieving activiti-context.xml resources on the classpath: "</span> + System.getProperty(<span class="string">"java.class.path"</span>), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (resources.hasMoreElements()) &#123;</span><br><span class="line">            URL resource = resources.nextElement();</span><br><span class="line">            log.info(<span class="string">"Initializing process engine using Spring configuration '&#123;&#125;'"</span>, resource.toString());</span><br><span class="line">            initProcessEngineFromSpringResource(resource);</span><br><span class="line">        &#125;</span><br><span class="line">        setInitialized(<span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.info(<span class="string">"Process engines already initialized"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>再判断是否已经初始化<ol><li>如果未初始化, 先初始化 <code>Map&lt;String, ProcessEngine&gt; processEngines</code></li><li>获取当前类加载器</li><li>使用该类加载器指定加载 <code>activiti.cfg.xml</code> 路径下的资源, 并保存在 Set 中</li><li>遍历 Set 集合执行 <code>initProcessEngineFromResource(URL resource)</code></li><li>获取 spring 风格配置文件</li><li>将类中 <code>initialized</code> 设置为 true</li></ol></li><li>如果已被初始化, 直接返回</li></ol><h2 id="1-4-initProcessEngineFromResource-URL-resourceUrl"><a href="#1-4-initProcessEngineFromResource-URL-resourceUrl" class="headerlink" title="1.4. initProcessEngineFromResource(URL resourceUrl)"></a>1.4. initProcessEngineFromResource(URL resourceUrl)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ProcessEngineInfo <span class="title">initProcessEngineFromResource</span><span class="params">(URL resourceUrl)</span> </span>&#123;</span><br><span class="line">    ProcessEngineInfo processEngineInfo = processEngineInfosByResourceUrl.get(resourceUrl.toString());</span><br><span class="line">    <span class="comment">// if there is an existing process engine info</span></span><br><span class="line">    <span class="keyword">if</span> (processEngineInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// remove that process engine from the member fields</span></span><br><span class="line">        processEngineInfos.remove(processEngineInfo);</span><br><span class="line">        <span class="keyword">if</span> (processEngineInfo.getException() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            String processEngineName = processEngineInfo.getName();</span><br><span class="line">            processEngines.remove(processEngineName);</span><br><span class="line">            processEngineInfosByName.remove(processEngineName);</span><br><span class="line">        &#125;</span><br><span class="line">        processEngineInfosByResourceUrl.remove(processEngineInfo.getResourceUrl());</span><br><span class="line">    &#125;</span><br><span class="line">    String resourceUrlString = resourceUrl.toString();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">"initializing process engine for resource &#123;&#125;"</span>, resourceUrl);</span><br><span class="line">        ProcessEngine processEngine = buildProcessEngine(resourceUrl);</span><br><span class="line">        String processEngineName = processEngine.getName();</span><br><span class="line">        log.info(<span class="string">"initialised process engine &#123;&#125;"</span>, processEngineName);</span><br><span class="line">        processEngineInfo = <span class="keyword">new</span> ProcessEngineInfoImpl(processEngineName, resourceUrlString, <span class="keyword">null</span>);</span><br><span class="line">        processEngines.put(processEngineName, processEngine);</span><br><span class="line">        processEngineInfosByName.put(processEngineName, processEngineInfo);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        log.error(<span class="string">"Exception while initializing process engine: &#123;&#125;"</span>, e.getMessage(), e);</span><br><span class="line">        processEngineInfo = <span class="keyword">new</span> ProcessEngineInfoImpl(<span class="keyword">null</span>, resourceUrlString, getExceptionString(e));</span><br><span class="line">    &#125;</span><br><span class="line">    processEngineInfosByResourceUrl.put(resourceUrlString, processEngineInfo);</span><br><span class="line">    processEngineInfos.add(processEngineInfo);</span><br><span class="line">    <span class="keyword">return</span> processEngineInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>根据路径尝试从 <code>Map&lt;String, ProcessEngineInfo&gt; processEngineInfosByResourceUrl</code> 获取流程引擎类实例<ol><li>如果不为空</li><li>将 <code>List&lt;ProcessEngineInfo&gt; processEngineInfos</code> 中对应的元素删除</li><li>流程引擎信息类实例没有 Exception, 将 <code>Map&lt;String, ProcessEngine&gt; processEngines</code> 和 <code>Map&lt;String, ProcessEngineInfo&gt; processEngineInfosByName</code> 中 key 对应的元素都删除</li><li><code>Map&lt;String, ProcessEngineInfo&gt; processEngineInfosByResourceUrl</code> 中 key 对应的元素也删除.</li></ol></li><li>通过 <code>buildProcessEngine</code> 方法获取 ProcessEngine 对象</li><li>将 <code>Map&lt;String, ProcessEngine&gt; processEngines</code> 和 <code>Map&lt;String, ProcessEngineInfo&gt; processEngineInfosByName</code> 设置对应的 key 和 value</li><li>将 <code>Map&lt;String, ProcessEngineInfo&gt; processEngineInfosByResourceUrl</code> 和 <code>List&lt;ProcessEngineInfo&gt; processEngineInfos</code> 也添加对应元素</li></ol><h2 id="1-5-buildProcessEngine-URL-resource"><a href="#1-5-buildProcessEngine-URL-resource" class="headerlink" title="1.5. buildProcessEngine(URL resource)"></a>1.5. buildProcessEngine(URL resource)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ProcessEngine <span class="title">buildProcessEngine</span><span class="params">(URL resource)</span> </span>&#123;</span><br><span class="line">    InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        inputStream = resource.openStream();</span><br><span class="line">        ProcessEngineConfiguration processEngineConfiguration = ProcessEngineConfiguration.createProcessEngineConfigurationFromInputStream(inputStream);</span><br><span class="line">        <span class="keyword">return</span> processEngineConfiguration.buildProcessEngine();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ActivitiIllegalArgumentException(<span class="string">"couldn't open resource stream: "</span> + e.getMessage(), e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtil.closeSilently(inputStream);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>通过传入的 URL 获取输入流;</li><li>通过 <code>createProcessEngineConfigurationFromInputStream()</code> 方法获取流程引擎配置对象</li><li>根据流程引擎配置类实例返回流程引擎实例</li><li>关闭流</li></ol><h1 id="2-ProcessEngineConfiguration-类"><a href="#2-ProcessEngineConfiguration-类" class="headerlink" title="2. ProcessEngineConfiguration 类"></a>2. ProcessEngineConfiguration 类</h1><h2 id="2-1-createProcessEngineConfigurationFromInputStream-InputStream-inputStream"><a href="#2-1-createProcessEngineConfigurationFromInputStream-InputStream-inputStream" class="headerlink" title="2.1. createProcessEngineConfigurationFromInputStream(InputStream inputStream)"></a>2.1. createProcessEngineConfigurationFromInputStream(InputStream inputStream)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProcessEngineConfiguration <span class="title">createProcessEngineConfigurationFromInputStream</span><span class="params">(InputStream inputStream)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createProcessEngineConfigurationFromInputStream(inputStream, <span class="string">"processEngineConfiguration"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>方法只有一行, 用来添加默认的 beanName: <code>processEngineConfiguration</code></p><p>这个 beanName 非常重要, Activiti 要求在配置文件中必须完成 id 为 <code>processEngineConfiguration</code> 的 bean</p><h2 id="2-2-createProcessEngineConfigurationFromInputStream-InputStream-inputStream-String-beanName"><a href="#2-2-createProcessEngineConfigurationFromInputStream-InputStream-inputStream-String-beanName" class="headerlink" title="2.2. createProcessEngineConfigurationFromInputStream(InputStream inputStream, String beanName)"></a>2.2. createProcessEngineConfigurationFromInputStream(InputStream inputStream, String beanName)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProcessEngineConfiguration <span class="title">createProcessEngineConfigurationFromInputStream</span><span class="params">(InputStream inputStream, String beanName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BeansConfigurationHelper.parseProcessEngineConfigurationFromInputStream(inputStream, beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="3-BeansConfigurationHelper-类"><a href="#3-BeansConfigurationHelper-类" class="headerlink" title="3. BeansConfigurationHelper 类"></a>3. BeansConfigurationHelper 类</h1><h2 id="3-1-parseProcessEngineConfigurationFromInputStream-InputStream-inputStream-String-beanName"><a href="#3-1-parseProcessEngineConfigurationFromInputStream-InputStream-inputStream-String-beanName" class="headerlink" title="3.1. parseProcessEngineConfigurationFromInputStream(InputStream inputStream, String beanName)"></a>3.1. parseProcessEngineConfigurationFromInputStream(InputStream inputStream, String beanName)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProcessEngineConfiguration <span class="title">parseProcessEngineConfigurationFromInputStream</span><span class="params">(InputStream inputStream, String beanName)</span> </span>&#123;</span><br><span class="line">    Resource springResource = <span class="keyword">new</span> InputStreamResource(inputStream);</span><br><span class="line">    <span class="keyword">return</span> parseProcessEngineConfiguration(springResource, beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>将输入流转化为 <code>org.springframework.core.io.Resource</code>, Spring 的资源抽象接口, 用于后续的 spring 风格配置文件解析;</li><li>将配置文件解析为 bean, 最终构造 ProcessEngineConfiguration 并返回</li></ol><h2 id="3-2-parseProcessEngineConfiguration-Resource-springResource-String-beanName"><a href="#3-2-parseProcessEngineConfiguration-Resource-springResource-String-beanName" class="headerlink" title="3.2. parseProcessEngineConfiguration(Resource springResource, String beanName)"></a>3.2. parseProcessEngineConfiguration(Resource springResource, String beanName)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProcessEngineConfiguration <span class="title">parseProcessEngineConfiguration</span><span class="params">(Resource springResource, String beanName)</span> </span>&#123;</span><br><span class="line">    DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">    XmlBeanDefinitionReader xmlBeanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line">    xmlBeanDefinitionReader.setValidationMode(XmlBeanDefinitionReader.VALIDATION_XSD);</span><br><span class="line">    xmlBeanDefinitionReader.loadBeanDefinitions(springResource);</span><br><span class="line">    ProcessEngineConfigurationImpl processEngineConfiguration = (ProcessEngineConfigurationImpl) beanFactory.getBean(beanName);</span><br><span class="line">    processEngineConfiguration.setBeans(<span class="keyword">new</span> SpringBeanFactoryProxyMap(beanFactory));</span><br><span class="line">    <span class="keyword">return</span> processEngineConfiguration;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>创建 BeanFactory;</li><li>创建 XmlBeanDefinitionReader, 用于读取 XML 中的 bean 定义;</li><li>指定 XML 验证方式为 XSD;</li><li>读取配置文件资源;</li><li>根据 beanName 从 beanFactory 中获取指定对象, 并强转为 ProcessEngineConfigurationImpl;</li></ol><h1 id="4-回到-ProcessEngines-类中"><a href="#4-回到-ProcessEngines-类中" class="headerlink" title="4. 回到 ProcessEngines 类中"></a>4. 回到 ProcessEngines 类中</h1><p>此时已经完成了 <code>ProcessEngineConfiguration.createProcessEngineConfigurationFromInputStream(inputStream);</code> 的执行, 得到了 ProcessEngineConfiguration 对象, 接下来调用 <code>processEngineConfiguration.buildProcessEngine()</code> 来获取 ProcessEngine 并返回.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Activiti 配置风格获取引擎源码分析: &lt;/p&gt;
&lt;p&gt;流程引擎管理类 ProcessEngines&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;
      
    
    </summary>
    
      <category term="activiti" scheme="https://destinywang.github.io/blog/categories/activiti/"/>
    
      <category term="源码" scheme="https://destinywang.github.io/blog/categories/activiti/%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="activiti" scheme="https://destinywang.github.io/blog/tags/activiti/"/>
    
  </entry>
  
  <entry>
    <title>Activiti(7)--多实例加签</title>
    <link href="https://destinywang.github.io/blog/2018/12/23/Activiti-7-%E5%A4%9A%E5%AE%9E%E4%BE%8B%E5%8A%A0%E7%AD%BE/"/>
    <id>https://destinywang.github.io/blog/2018/12/23/Activiti-7-多实例加签/</id>
    <published>2018-12-22T18:08:46.000Z</published>
    <updated>2018-12-22T18:15:22.844Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>加入多实例任务节点定义了三个人, 现在需要临时添加一个</p></blockquote><p>思路:</p><ol><li>根据一级流程实例查找二级流程执行实例.</li><li>判断二级执行实例是否是多实例任务节点的父级实例<ul><li>通过二级执行实例创建三级执行实例;</li><li>通过二级执行实例获取 <code>nrOfInstance</code> 并 +1</li></ul></li><li>通知新的实例开始执行, 并创建相应的数据.</li><li>执行用户任务行为类, 进而创建任务相关的数据.</li></ol><blockquote><p>不要触发多实例的行为类, 一定要触发原生的行为类, 否则会出错.</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;加入多实例任务节点定义了三个人, 现在需要临时添加一个&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;思路:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;根据一级流程实例查找二级流程执行实例.&lt;/li&gt;
&lt;li&gt;判断二级执行实例是否是多实例任务节点的父级实例&lt;ul&gt;
&lt;
      
    
    </summary>
    
      <category term="Activiti" scheme="https://destinywang.github.io/blog/categories/Activiti/"/>
    
      <category term="工作流" scheme="https://destinywang.github.io/blog/categories/Activiti/%E5%B7%A5%E4%BD%9C%E6%B5%81/"/>
    
    
      <category term="Activiti" scheme="https://destinywang.github.io/blog/tags/Activiti/"/>
    
  </entry>
  
  <entry>
    <title>Activiti(5)--任意节点跳转</title>
    <link href="https://destinywang.github.io/blog/2018/12/22/Activiti-5-%E4%BB%BB%E6%84%8F%E8%8A%82%E7%82%B9%E8%B7%B3%E8%BD%AC/"/>
    <id>https://destinywang.github.io/blog/2018/12/22/Activiti-5-任意节点跳转/</id>
    <published>2018-12-22T13:00:18.000Z</published>
    <updated>2018-12-22T14:32:41.266Z</updated>
    
    <content type="html"><![CDATA[<ul><li>常规节点跳转<ul><li>跳转到目标节点</li><li>跳转到目标节点的入线</li><li>跳转到目标节点的上一个节点并触发连线的条件计算</li></ul></li><li>多实例节点的跳转<ul><li>普通节点跳转到多实例节点</li><li>多实例节点跳转到普通节点</li></ul></li></ul><p><img src="https://user-images.githubusercontent.com/17758731/50369657-2bf20e00-05d4-11e9-9af3-9416a020adae.png" alt="image"></p><p>比如总经理审批节点跳转到请假申请节点:</p><p>思路一:</p><ol><li>可以获取总经理审批节点对应的任务 ID, 实例 ID, 执行实例 ID</li><li>可以通过 <code>planContiuneProcessInCompensation</code> 方法让当前执行的实例按照我们预期的效果流转</li></ol><p>思路二:</p><ol><li>我们可以将当前执行实例中的 <code>currentFlowElement</code> 字段设置为 <code>请假申请</code> 节点 XML 中的 id 值;</li><li>因为执行实例运转之后, 当前的任务节点并没有被删除, 所以需要手工删除;</li><li>历史表跳转之前的任务节点也不会被完成, 需要手工进行完成.</li></ol><ul><li>获取 <code>ActivitiEngineAgenda</code></li><li><code>commandContext.getExecutionEntityManager()</code> 获取 ExecutionEntityManager</li><li><code>commandContext.getTaskEntityManager()</code> 获取 TaskEntityManager</li><li>设置执行实例的运行节点</li><li>触发执行实例运转</li><li>设置删除当前的任务节点</li><li>更新历史实例表以及历史任务表, 当前的任务节点为完成状态</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JumpCmd</span> <span class="keyword">implements</span> <span class="title">Command</span>&lt;<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String taskId;</span><br><span class="line">    <span class="keyword">private</span> String targetNodeId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JumpCmd</span><span class="params">(String taskId, String targetNodeId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.taskId = taskId;</span><br><span class="line">        <span class="keyword">this</span>.targetNodeId = targetNodeId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Void <span class="title">execute</span><span class="params">(CommandContext commandContext)</span> </span>&#123;</span><br><span class="line">        ActivitiEngineAgenda agenda = commandContext.getAgenda();</span><br><span class="line">        TaskEntityManager taskEntityManager = commandContext.getTaskEntityManager();</span><br><span class="line">        TaskEntity taskEntity = taskEntityManager.findById(taskId);</span><br><span class="line">        <span class="comment">// 执行实例 id</span></span><br><span class="line">        String executionId = taskEntity.getExecutionId();</span><br><span class="line">        String processDefinitionId = taskEntity.getProcessDefinitionId();</span><br><span class="line">        ExecutionEntityManager executionEntityManager = commandContext.getExecutionEntityManager();</span><br><span class="line">        <span class="comment">// 执行实例对象</span></span><br><span class="line">        ExecutionEntity executionEntity = executionEntityManager.findById(executionId);</span><br><span class="line"></span><br><span class="line">        Process process = ProcessDefinitionUtil.getProcess(processDefinitionId);</span><br><span class="line">        FlowElement flowElement = process.getFlowElement(targetNodeId);</span><br><span class="line">        <span class="keyword">if</span> (flowElement == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"目标节点不存在"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        executionEntity.setCurrentFlowElement(flowElement);</span><br><span class="line">        <span class="comment">// 跳转</span></span><br><span class="line">        agenda.planContinueProcessInCompensation(executionEntity);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但此时数据库中会同时出现两个未完成的任务, 尝试完成时会出现如下异常信息:</p><pre><code>org.activiti.engine.ActivitiException: UserTask should not be signalled before complete    at org.activiti.engine.impl.bpmn.behavior.UserTaskActivityBehavior.trigger(UserTaskActivityBehavior.java:232)    at org.activiti.engine.impl.agenda.TriggerExecutionOperation.run(TriggerExecutionOperation.java:38)    at org.activiti.engine.impl.interceptor.CommandInvoker.executeOperation(CommandInvoker.java:73)    at org.activiti.engine.impl.interceptor.CommandInvoker.executeOperations(CommandInvoker.java:57)    at org.activiti.engine.impl.interceptor.CommandInvoker.execute(CommandInvoker.java:42)    at org.activiti.engine.impl.interceptor.TransactionContextInterceptor.execute(TransactionContextInterceptor.java:48)    at org.activiti.engine.impl.interceptor.CommandContextInterceptor.execute(CommandContextInterceptor.java:63)    at org.activiti.engine.impl.interceptor.LogInterceptor.execute(LogInterceptor.java:29)    at org.activiti.engine.impl.cfg.CommandExecutorImpl.execute(CommandExecutorImpl.java:44)    at org.activiti.engine.impl.cfg.CommandExecutorImpl.execute(CommandExecutorImpl.java:39)    at org.activiti.engine.impl.TaskServiceImpl.complete(TaskServiceImpl.java:182)    at org.destiny.activiti.shareniu.CountSignTest.testComplete(CountSignTest.java:67)    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)    at java.lang.reflect.Method.invoke(Method.java:498)    at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)    at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)    at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)    at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)    at org.activiti.engine.test.ActivitiRule$1.evaluate(ActivitiRule.java:116)    at org.junit.rules.RunRules.evaluate(RunRules.java:20)    at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:271)    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70)    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:50)    at org.junit.runners.ParentRunner$3.run(ParentRunner.java:238)    at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:63)    at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:236)    at org.junit.runners.ParentRunner.access$000(ParentRunner.java:53)    at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:229)    at org.junit.runners.ParentRunner.run(ParentRunner.java:309)    at org.junit.runner.JUnitCore.run(JUnitCore.java:160)    at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68)    at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:47)    at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:242)    at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:70)</code></pre><p>需要分别在历史任务表, 历史活动表当前的任务节点:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Void <span class="title">execute</span><span class="params">(CommandContext commandContext)</span> </span>&#123;</span><br><span class="line">    ActivitiEngineAgenda agenda = commandContext.getAgenda();</span><br><span class="line">    TaskEntityManager taskEntityManager = commandContext.getTaskEntityManager();</span><br><span class="line">    TaskEntity taskEntity = taskEntityManager.findById(taskId);</span><br><span class="line">    <span class="comment">// 执行实例 id</span></span><br><span class="line">    String executionId = taskEntity.getExecutionId();</span><br><span class="line">    String processDefinitionId = taskEntity.getProcessDefinitionId();</span><br><span class="line">    ExecutionEntityManager executionEntityManager = commandContext.getExecutionEntityManager();</span><br><span class="line">    HistoryManager historyManager = commandContext.getHistoryManager();</span><br><span class="line">    <span class="comment">// 执行实例对象</span></span><br><span class="line">    ExecutionEntity executionEntity = executionEntityManager.findById(executionId);</span><br><span class="line">    Process process = ProcessDefinitionUtil.getProcess(processDefinitionId);</span><br><span class="line">    FlowElement flowElement = process.getFlowElement(targetNodeId);</span><br><span class="line">    <span class="keyword">if</span> (flowElement == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"目标节点不存在"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将历史活动表更新</span></span><br><span class="line">    historyManager.recordActivityEnd(executionEntity, <span class="string">"jump"</span>);</span><br><span class="line">    <span class="comment">// 设置当前流程</span></span><br><span class="line">    executionEntity.setCurrentFlowElement(flowElement);</span><br><span class="line">    <span class="comment">// 跳转</span></span><br><span class="line">    agenda.planContinueProcessInCompensation(executionEntity);</span><br><span class="line">    <span class="comment">// 删除当前任务</span></span><br><span class="line">    taskEntityManager.delete(taskId);</span><br><span class="line">    <span class="comment">// 将历史任务表更新, 历史任务</span></span><br><span class="line">    historyManager.recordTaskEnd(taskId, <span class="string">"jump"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;常规节点跳转&lt;ul&gt;
&lt;li&gt;跳转到目标节点&lt;/li&gt;
&lt;li&gt;跳转到目标节点的入线&lt;/li&gt;
&lt;li&gt;跳转到目标节点的上一个节点并触发连线的条件计算&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;多实例节点的跳转&lt;ul&gt;
&lt;li&gt;普通节点跳转到多实例节点&lt;/li&gt;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Activiti(6)--加签功能的实现</title>
    <link href="https://destinywang.github.io/blog/2018/12/22/Activiti-6-%E5%8A%A0%E7%AD%BE%E5%8A%9F%E8%83%BD%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
    <id>https://destinywang.github.io/blog/2018/12/22/Activiti-6-加签功能的实现/</id>
    <published>2018-12-22T02:18:37.000Z</published>
    <updated>2018-12-22T13:01:27.073Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>假设有如下流程:</p><p><img src="https://user-images.githubusercontent.com/17758731/50369657-2bf20e00-05d4-11e9-9af3-9416a020adae.png" alt="image"></p><p>我们在流程进行的时候, 需要在申请和经理审批之间临时新增一个节点, 达到如下的效果:</p><p><img src="https://user-images.githubusercontent.com/17758731/50369682-6a87c880-05d4-11e9-8b4e-232ab3e708c5.png" alt="image"></p><p>该行为我们称之为加签.</p><p>加签的两种思路</p><ol><li>直接修改模板, 在模板中添加节点以及连线, 并修改实例的走向;</li><li>直接修改流程定义对应的缓存数据, 不修改模板, 新增的节点与当前需要加签的实例挂钩.</li></ol><h1 id="2-实现方式"><a href="#2-实现方式" class="headerlink" title="2. 实现方式"></a>2. 实现方式</h1><h2 id="2-1-修改模板"><a href="#2-1-修改模板" class="headerlink" title="2.1. 修改模板"></a>2.1. 修改模板</h2><p>步骤:</p><ol><li>找到当前实例对象对应的模板数据;</li><li>在模板数据的基础上添加新节点, 修改连线, 并更新数据库中的模板;</li><li>更新模板对应的流程定义缓存, 否则加签节点不会生效;</li><li>完成新增的节点任务后, 再把新增的节点以及连线删除, 即还原流程模板.</li></ol><ul><li>模板是共享的, 所以把模板修改了, 所有运行实例对应的模板也会被修改;</li><li>修改模板容易导致当前实例影响到其他实例, 这种方法并不可取;</li></ul><h2 id="2-2-修改流程定义缓存"><a href="#2-2-修改流程定义缓存" class="headerlink" title="2.2 修改流程定义缓存"></a>2.2 修改流程定义缓存</h2><p>因为模板是共享的, 不修改模板就不会影响其他实例;</p><p>也不需要修改原有流程的流向, 要让流程按照新的流向运行.</p><blockquote><p>因为流程在运转过程中, 需要实时获取该实例对应的模板数据才能知道应该如何流转</p></blockquote><ol><li>首先从流程定义缓存中获取模板数据;</li><li>如果流程缓存定义丢失, 则需要重新执行模板的解析工作并将其防止到流程缓存中;</li></ol><p>因此修改流程定义缓存就可以实现功能.</p><p>但仍有一个问题需要解决: 如果流程定义缓存丢失, 引擎默认解析的是数据库中存在的模板数据, 而新增的临时节点不会存在与 XML 中.</p><h3 id="2-2-1-步骤"><a href="#2-2-1-步骤" class="headerlink" title="2.2.1 步骤"></a>2.2.1 步骤</h3><p><img src="https://user-images.githubusercontent.com/17758731/50369997-a5402f80-05d9-11e9-9ef3-a8549723f74b.png" alt="image"></p><ol><li>在流程缓存中添加一个任务节点并为任务节点添加出线信息, 出线信息是需要到达的目标节点;</li><li>添加的目标节点并没有入线, 也就是说不会影响到其他的实例, 正常的流程实例启动的时候不会走到这个节点;</li><li>加签完成后可以触发执行实例走到新增的任务节点, 这样当前实例就按照最新的路线进行运转;</li><li>如果当前的节点加签后不想让实例运转到最新的节点, 可以复制一个当前节点, 继续让实例运转;</li><li>加签的最终目的是让实例按照最新的路线走, 与模板中规划的路线脱离关系.</li></ol><p>需要解决的问题:</p><ol><li>新增的节点以及连线如何存储;</li><li>流程定义缓存如何修改;</li><li>加签的节点以及连线信息如何持久化;</li><li>缓存丢失, 新的路线图丢失;</li><li>流程实例结束, 当前加签的节点以及连线已经不需要应该如何删除;</li></ol><p>修改流程定义缓存后, 由于缓存失效, 依然会报错</p><p>此时就需要先添加缓存, 然后完成任务</p><h1 id="3-加签原理代码讲解"><a href="#3-加签原理代码讲解" class="headerlink" title="3. 加签原理代码讲解"></a>3. 加签原理代码讲解</h1><h1 id="4-加签节点存储表设计"><a href="#4-加签节点存储表设计" class="headerlink" title="4. 加签节点存储表设计"></a>4. 加签节点存储表设计</h1><blockquote><p>Activiti 继承了 MyBatis 框架, 因此可以让我们注入配置文件或者注解类使用 MyBatis.</p></blockquote><h2 id="4-1-表结构"><a href="#4-1-表结构" class="headerlink" title="4.1. 表结构"></a>4.1. 表结构</h2><h2 id="4-2-实体类"><a href="#4-2-实体类" class="headerlink" title="4.2. 实体类"></a>4.2. 实体类</h2><h2 id="4-3-Mapper-类"><a href="#4-3-Mapper-类" class="headerlink" title="4.3. Mapper 类"></a>4.3. Mapper 类</h2><h2 id="4-4-注入流程引擎"><a href="#4-4-注入流程引擎" class="headerlink" title="4.4. 注入流程引擎"></a>4.4. 注入流程引擎</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;1-概述&quot;&gt;&lt;a href=&quot;#1-概述&quot; class=&quot;headerlink&quot; title=&quot;1. 概述&quot;&gt;&lt;/a&gt;1. 概述&lt;/h1&gt;&lt;p&gt;假设有如下流程:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://user-images.githubusercont
      
    
    </summary>
    
      <category term="Activiti" scheme="https://destinywang.github.io/blog/categories/Activiti/"/>
    
      <category term="工作流" scheme="https://destinywang.github.io/blog/categories/Activiti/%E5%B7%A5%E4%BD%9C%E6%B5%81/"/>
    
    
      <category term="Activiti" scheme="https://destinywang.github.io/blog/tags/Activiti/"/>
    
  </entry>
  
  <entry>
    <title>Activiti(4)--多实例实现会签功能</title>
    <link href="https://destinywang.github.io/blog/2018/12/16/Activiti-4-%E5%A4%9A%E5%AE%9E%E4%BE%8B%E5%AE%9E%E7%8E%B0%E4%BC%9A%E7%AD%BE%E5%8A%9F%E8%83%BD/"/>
    <id>https://destinywang.github.io/blog/2018/12/16/Activiti-4-多实例实现会签功能/</id>
    <published>2018-12-16T03:19:58.000Z</published>
    <updated>2018-12-24T15:52:14.435Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-Activiti-多实例"><a href="#1-Activiti-多实例" class="headerlink" title="1. Activiti 多实例"></a>1. Activiti 多实例</h1><blockquote><p>多实例节点是在业务流程中定义重复环节的一种方式</p></blockquote><p>从开发角度讲, 多实例类似于循环, 可以根据给定的集合, 为每个元素执行一个环境甚至一个子流程, 既可以顺序依次执行也可以并发同步执行.</p><p>多实例是在一个普通节点上添加额外的属性定义, 这样被多实例修饰的节点就会执行多次, 在 BPMN 规范中, 下面的节点都可以成为一个多实例节点:</p><ul><li>UserTask</li><li>Script Task</li><li>Java Service Task</li><li>Web Service Task</li><li>Business Rule Task</li><li>Email Task</li><li>Manual Task</li><li>Receive Task</li><li>Sub-Process</li><li>Call Activity</li></ul><p>每个上级流程为每个实例创建分支的时候都要提供如下变量:</p><ol><li>nrOfInstances: 实例总数</li><li>nrOfActiveInstances: 当前活动的实例数量, 对于顺序执行的多实例, 该值始终为1</li><li>nrOfCompletedInstances: 已经完成的实例数量</li><li>loopCounter: 当前实例所在循环的索引值, 其他实例不可见, 不会保存到流程实例级别.</li></ol><p>可以通过 <code>execution.getVariable(String key)</code> 方法获得这些变量</p><h3 id="1-1-isSequential"><a href="#1-1-isSequential" class="headerlink" title="1.1. isSequential"></a>1.1. <code>isSequential</code></h3><p>表示节点时顺序执行还是并行执行, 默认为 <code>false</code>, 表示并行执行</p><h2 id="1-2-指定实例数量"><a href="#1-2-指定实例数量" class="headerlink" title="1.2. 指定实例数量"></a>1.2. 指定实例数量</h2><p>实例的数量会在进入节点时进行计算, 但也可以直接指定</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">multiInstanceLoopCharacteristics</span> <span class="attr">isSequential</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 可以使用loopCardinality子元素直接指定一个数字 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loopCardinality</span>&gt;</span>5<span class="tag">&lt;/<span class="name">loopCardinality</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 也可以使用结果为整数的表达式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loopCardinality</span>&gt;</span>$&#123;nrOfOrders-nrOfCancellations&#125;<span class="tag">&lt;/<span class="name">loopCardinality</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">multiInstanceLoopCharacteristics</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="1-3-接收并遍历集合"><a href="#1-3-接收并遍历集合" class="headerlink" title="1.3. 接收并遍历集合"></a>1.3. 接收并遍历集合</h2><p>除此之外还可以通过 <code>loopDataInputRef</code> 元素设置一个类型为集合的流程变量名, 对于集合中的每个元素都会创建一个实例, 也可以通过 <code>inputDataItem</code> 子元素指定集合</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"someTask"</span> <span class="attr">name</span>=<span class="string">"Activiti is awesome!"</span> <span class="attr">activiti:assignee</span>=<span class="string">"$&#123;user&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">multiInstanceLoopCharacteristics</span> <span class="attr">isSequential</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">loopDataInputRef</span>&gt;</span>userList<span class="tag">&lt;/<span class="name">loopDataInputRef</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">inputDataItem</span> <span class="attr">name</span>=<span class="string">"user"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">multiInstanceLoopCharacteristics</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>loopDataInputRef 中的 userList 表示需要遍历的元素列表</li><li>inputDataItem 中的 user 表示每个分支都会拥有一个名为 user 的流程变量, 这个变量会包含集合中的对应元素, 在例子中用来设置用户任务的办理者, 也就是说 userTask 中的 <code>activiti:assignee</code> 属性的值需要和 <code>inputDataItem</code> 一致.</li></ul><p>此外, 上述的变量名存在如下缺点:</p><ol><li>名称复杂</li><li>BPMN2.0 规定不能该节点不能包含表达式</li></ol><p>Activiti 通过 multiInstanceCharacteristics 中设置 <code>collection</code> 和 <code>elementVariable</code> 属性来解决这个问题:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"someTask"</span> <span class="attr">name</span>=<span class="string">"Activiti is awesome!"</span> <span class="attr">activiti:assignee</span>=<span class="string">"$&#123;user&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">multiInstanceLoopCharacteristics</span> <span class="attr">isSequential</span>=<span class="string">"false"</span> <span class="attr">activiti:collection</span>=<span class="string">"$&#123;userList&#125;"</span> <span class="attr">activiti:elementVariable</span>=<span class="string">"user"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br></pre></td></tr></table></figure><p>二者实现的功能是相同的, 不过后者可以支持表达式, 这是我们动态配置用户任务属性的重要功能</p><h2 id="1-4-结束条件"><a href="#1-4-结束条件" class="headerlink" title="1.4. 结束条件"></a>1.4. 结束条件</h2><p>多实例节点默认会在所有节点完成后结束, 也可以指定一个表达式在每个实例结束时执行, 如果表达式返回 true, 所有其他的实例都会销毁, 多实例节点也会结束, 流程会继续执行.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"someTask"</span> <span class="attr">name</span>=<span class="string">"Activiti is awesome!"</span> <span class="attr">activiti:assignee</span>=<span class="string">"$&#123;user&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">multiInstanceLoopCharacteristics</span> <span class="attr">isSequential</span>=<span class="string">"false"</span> <span class="attr">activiti:collection</span>=<span class="string">"$&#123;userList&#125;"</span> <span class="attr">activiti:elementVariable</span>=<span class="string">"user"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 如果有 60% 的任务完成时, 其他任务会被删除, 流程继续进行 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">completionCondition</span>&gt;</span>$&#123;nrOfCompletedInstances/nrOfInstances &gt;= 0.6&#125;<span class="tag">&lt;/<span class="name">completionCondition</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">multiInstanceLoopCharacteristics</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="2-会签逻辑"><a href="#2-会签逻辑" class="headerlink" title="2. 会签逻辑"></a>2. 会签逻辑</h1><p>经过以上对 Activiti 多实例的介绍可知, 实现会签功能几个重要的点在于:</p><ol><li>利用多实例完成动态实例的创建</li><li>根据业务设置合适的结束条件</li></ol><h2 id="2-1-流程定义"><a href="#2-1-流程定义" class="headerlink" title="2.1. 流程定义"></a>2.1. 流程定义</h2><h3 id="2-1-1-XML-格式"><a href="#2-1-1-XML-格式" class="headerlink" title="2.1.1. XML 格式"></a>2.1.1. XML 格式</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"my-process"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"start"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow1"</span> <span class="attr">sourceRef</span>=<span class="string">"start"</span> <span class="attr">targetRef</span>=<span class="string">"someTask"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"someTask"</span> <span class="attr">name</span>=<span class="string">"Activiti is awesome!"</span> <span class="attr">activiti:assignee</span>=<span class="string">"$&#123;user&#125;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">multiInstanceLoopCharacteristics</span> <span class="attr">isSequential</span>=<span class="string">"false"</span> <span class="attr">activiti:collection</span>=<span class="string">"$&#123;userList&#125;"</span> <span class="attr">activiti:elementVariable</span>=<span class="string">"user"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow2"</span> <span class="attr">sourceRef</span>=<span class="string">"someTask"</span> <span class="attr">targetRef</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"end"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-1-2-BpmnModel-模型"><a href="#2-1-2-BpmnModel-模型" class="headerlink" title="2.1.2. BpmnModel 模型"></a>2.1.2. BpmnModel 模型</h3><p>用到的测试类: </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersBean</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getUsers</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"userId: &#123;&#125;"</span>, userId);</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(userId + <span class="string">"1"</span>, userId + <span class="string">"2"</span>, userId + <span class="string">"3"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testExclusionGatewayModel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BpmnModel bpmnModel = <span class="keyword">new</span> BpmnModel();</span><br><span class="line">    Process process = <span class="keyword">new</span> Process();</span><br><span class="line">    process.setId(<span class="string">"my-process"</span>);</span><br><span class="line">    StartEvent startEvent = <span class="keyword">new</span> StartEvent();</span><br><span class="line">    startEvent.setId(<span class="string">"startEvent"</span>);</span><br><span class="line">    UserTask someTask = <span class="keyword">new</span> UserTask();</span><br><span class="line">    someTask.setId(<span class="string">"someTask"</span>);</span><br><span class="line">    someTask.setName(<span class="string">"Activiti is awesome!"</span>);</span><br><span class="line">    someTask.setAssignee(<span class="string">"$&#123;user&#125;"</span>);</span><br><span class="line">    MultiInstanceLoopCharacteristics multiInstanceLoopCharacteristics = <span class="keyword">new</span> MultiInstanceLoopCharacteristics();</span><br><span class="line">    multiInstanceLoopCharacteristics.setSequential(<span class="keyword">false</span>);</span><br><span class="line">    multiInstanceLoopCharacteristics.setInputDataItem(<span class="string">"$&#123;usersBean.getUsers(name)&#125;"</span>);</span><br><span class="line">    multiInstanceLoopCharacteristics.setElementVariable(<span class="string">"user"</span>);</span><br><span class="line">    multiInstanceLoopCharacteristics.setCompletionCondition(<span class="string">"$&#123;nrOfCompletedInstances &gt; 0&#125;"</span>);</span><br><span class="line">    someTask.setLoopCharacteristics(multiInstanceLoopCharacteristics);</span><br><span class="line">    EndEvent endEvent = <span class="keyword">new</span> EndEvent();</span><br><span class="line">    endEvent.setId(<span class="string">"endEvent"</span>);</span><br><span class="line">    SequenceFlow flow1 = createSequence(<span class="string">"startEvent"</span>, <span class="string">"someTask"</span>, <span class="string">"flow1"</span>, <span class="string">"flow1"</span>, <span class="keyword">null</span>);</span><br><span class="line">    SequenceFlow flow2 = createSequence(<span class="string">"someTask"</span>, <span class="string">"endEvent"</span>, <span class="string">"flow2"</span>, <span class="string">"flow2"</span>, <span class="keyword">null</span>);</span><br><span class="line">    process.addFlowElement(startEvent);</span><br><span class="line">    process.addFlowElement(someTask);</span><br><span class="line">    process.addFlowElement(endEvent);</span><br><span class="line">    process.addFlowElement(flow1);</span><br><span class="line">    process.addFlowElement(flow2);</span><br><span class="line">    bpmnModel.addProcess(process);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// client</span></span><br><span class="line">    Deployment deployment = activitiRule.getRepositoryService().createDeployment()</span><br><span class="line">            .addBpmnModel(<span class="string">"bpmn"</span>, bpmnModel)</span><br><span class="line">            .deploy();</span><br><span class="line">    log.info(<span class="string">"deployment: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(deployment, ToStringStyle.JSON_STYLE));</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">"usersBean"</span>, usersBean);</span><br><span class="line">    map.put(<span class="string">"name"</span>, <span class="string">"wk"</span>);</span><br><span class="line">    </span><br><span class="line">    ProcessInstance processInstance = activitiRule.getRuntimeService().startProcessInstanceByKey(<span class="string">"my-process"</span>, map);</span><br><span class="line">    log.info(<span class="string">"processInstance: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(processInstance, ToStringStyle.JSON_STYLE));</span><br><span class="line">    List&lt;Task&gt; taskList = activitiRule.getTaskService().createTaskQuery().list();</span><br><span class="line">    log.info(<span class="string">"当前 taskList 数量: &#123;&#125;"</span>, taskList.size());</span><br><span class="line">    <span class="keyword">for</span> (Task task : taskList) &#123;</span><br><span class="line">        log.info(<span class="string">"task: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(task, ToStringStyle.JSON_STYLE));</span><br><span class="line">    &#125;</span><br><span class="line">    activitiRule.getTaskService().complete(taskList.get(<span class="number">0</span>).getId());</span><br><span class="line">    log.info(<span class="string">"其中一个节点完成审批"</span>);</span><br><span class="line">    taskList = activitiRule.getTaskService().createTaskQuery().list();</span><br><span class="line">    log.info(<span class="string">"第一个节点审批完成后 taskList 数量: &#123;&#125;"</span>, taskList.size());</span><br><span class="line">    <span class="keyword">for</span> (Task task : taskList) &#123;</span><br><span class="line">        log.info(<span class="string">"第一个节点审批完成后 task: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(task, ToStringStyle.JSON_STYLE));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-1-3-日志输出"><a href="#2-1-3-日志输出" class="headerlink" title="2.1.3. 日志输出"></a>2.1.3. 日志输出</h3><pre><code>09:55:17,517 [main] INFO  org.destiny.activiti.GatewayExpressSpringTest  - processInstance: {&quot;currentFlowElement&quot;:null,&quot;currentActivitiListener&quot;:null,&quot;processInstance&quot;:&quot;ProcessInstance[4]&quot;,&quot;parent&quot;:null,&quot;executions&quot;:[Multi instance root execution[ id &apos;8&apos; ] - activity &apos;someTask - parent &apos;4&apos;],&quot;superExecution&quot;:null,&quot;subProcessInstance&quot;:null,&quot;tenantId&quot;:&quot;&quot;,&quot;name&quot;:null,&quot;description&quot;:null,&quot;localizedName&quot;:null,&quot;localizedDescription&quot;:null,&quot;lockTime&quot;:null,&quot;isActive&quot;:true,&quot;isScope&quot;:true,&quot;isConcurrent&quot;:false,&quot;isEnded&quot;:false,&quot;isEventScope&quot;:false,&quot;isMultiInstanceRoot&quot;:false,&quot;isCountEnabled&quot;:false,&quot;eventName&quot;:null,&quot;eventSubscriptions&quot;:[],&quot;jobs&quot;:[],&quot;timerJobs&quot;:[],&quot;tasks&quot;:[],&quot;identityLinks&quot;:[IdentityLinkEntity[id=24, type=participant, userId=wk1, processInstanceId=4], IdentityLinkEntity[id=27, type=participant, userId=wk2, processInstanceId=4], IdentityLinkEntity[id=30, type=participant, userId=wk3, processInstanceId=4]],&quot;deleteReason&quot;:null,&quot;suspensionState&quot;:1,&quot;startUserId&quot;:null,&quot;startTime&quot;:&quot;Sun Dec 16 21:55:17 CST 2018&quot;,&quot;eventSubscriptionCount&quot;:0,&quot;taskCount&quot;:0,&quot;jobCount&quot;:0,&quot;timerJobCount&quot;:0,&quot;suspendedJobCount&quot;:0,&quot;deadLetterJobCount&quot;:0,&quot;variableCount&quot;:0,&quot;identityLinkCount&quot;:0,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;processDefinitionKey&quot;:&quot;my-process&quot;,&quot;processDefinitionName&quot;:null,&quot;processDefinitionVersion&quot;:1,&quot;deploymentId&quot;:null,&quot;activityId&quot;:null,&quot;activityName&quot;:null,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;businessKey&quot;:null,&quot;parentId&quot;:null,&quot;superExecutionId&quot;:null,&quot;rootProcessInstanceId&quot;:&quot;4&quot;,&quot;rootProcessInstance&quot;:null,&quot;forcedUpdate&quot;:false,&quot;queryVariables&quot;:null,&quot;isDeleted&quot;:false,&quot;variableInstances&quot;:{usersBean=VariableInstanceEntity[id=6, name=usersBean, type=serializable, byteArrayValueId=5]},&quot;usedVariablesCache&quot;:{},&quot;transientVariabes&quot;:null,&quot;cachedElContext&quot;:null,&quot;id&quot;:&quot;4&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:true,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}09:59:03,449 [main] INFO  org.destiny.activiti.GatewayExpressSpringTest  - 当前 taskList 数量: 309:59:03,450 [main] INFO  org.destiny.activiti.GatewayExpressSpringTest  - task: {&quot;owner&quot;:null,&quot;assigneeUpdatedCount&quot;:1,&quot;originalAssignee&quot;:null,&quot;assignee&quot;:&quot;wk1&quot;,&quot;delegationState&quot;:null,&quot;parentTaskId&quot;:null,&quot;name&quot;:&quot;Activiti is awesome!&quot;,&quot;localizedName&quot;:null,&quot;description&quot;:null,&quot;localizedDescription&quot;:null,&quot;priority&quot;:50,&quot;createTime&quot;:&quot;Sun Dec 16 21:59:03 CST 2018&quot;,&quot;dueDate&quot;:null,&quot;suspensionState&quot;:1,&quot;category&quot;:null,&quot;isIdentityLinksInitialized&quot;:false,&quot;taskIdentityLinkEntities&quot;:[],&quot;executionId&quot;:&quot;14&quot;,&quot;execution&quot;:null,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;processInstance&quot;:null,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;taskDefinitionKey&quot;:&quot;someTask&quot;,&quot;formKey&quot;:null,&quot;isDeleted&quot;:false,&quot;isCanceled&quot;:false,&quot;eventName&quot;:null,&quot;currentActivitiListener&quot;:null,&quot;tenantId&quot;:&quot;&quot;,&quot;queryVariables&quot;:null,&quot;forcedUpdate&quot;:false,&quot;claimTime&quot;:null,&quot;variableInstances&quot;:null,&quot;usedVariablesCache&quot;:{},&quot;transientVariabes&quot;:null,&quot;cachedElContext&quot;:null,&quot;id&quot;:&quot;24&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}09:59:03,450 [main] INFO  org.destiny.activiti.GatewayExpressSpringTest  - task: {&quot;owner&quot;:null,&quot;assigneeUpdatedCount&quot;:1,&quot;originalAssignee&quot;:null,&quot;assignee&quot;:&quot;wk2&quot;,&quot;delegationState&quot;:null,&quot;parentTaskId&quot;:null,&quot;name&quot;:&quot;Activiti is awesome!&quot;,&quot;localizedName&quot;:null,&quot;description&quot;:null,&quot;localizedDescription&quot;:null,&quot;priority&quot;:50,&quot;createTime&quot;:&quot;Sun Dec 16 21:59:03 CST 2018&quot;,&quot;dueDate&quot;:null,&quot;suspensionState&quot;:1,&quot;category&quot;:null,&quot;isIdentityLinksInitialized&quot;:false,&quot;taskIdentityLinkEntities&quot;:[],&quot;executionId&quot;:&quot;15&quot;,&quot;execution&quot;:null,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;processInstance&quot;:null,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;taskDefinitionKey&quot;:&quot;someTask&quot;,&quot;formKey&quot;:null,&quot;isDeleted&quot;:false,&quot;isCanceled&quot;:false,&quot;eventName&quot;:null,&quot;currentActivitiListener&quot;:null,&quot;tenantId&quot;:&quot;&quot;,&quot;queryVariables&quot;:null,&quot;forcedUpdate&quot;:false,&quot;claimTime&quot;:null,&quot;variableInstances&quot;:null,&quot;usedVariablesCache&quot;:{},&quot;transientVariabes&quot;:null,&quot;cachedElContext&quot;:null,&quot;id&quot;:&quot;27&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}09:59:03,451 [main] INFO  org.destiny.activiti.GatewayExpressSpringTest  - task: {&quot;owner&quot;:null,&quot;assigneeUpdatedCount&quot;:1,&quot;originalAssignee&quot;:null,&quot;assignee&quot;:&quot;wk3&quot;,&quot;delegationState&quot;:null,&quot;parentTaskId&quot;:null,&quot;name&quot;:&quot;Activiti is awesome!&quot;,&quot;localizedName&quot;:null,&quot;description&quot;:null,&quot;localizedDescription&quot;:null,&quot;priority&quot;:50,&quot;createTime&quot;:&quot;Sun Dec 16 21:59:03 CST 2018&quot;,&quot;dueDate&quot;:null,&quot;suspensionState&quot;:1,&quot;category&quot;:null,&quot;isIdentityLinksInitialized&quot;:false,&quot;taskIdentityLinkEntities&quot;:[],&quot;executionId&quot;:&quot;16&quot;,&quot;execution&quot;:null,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;processInstance&quot;:null,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;taskDefinitionKey&quot;:&quot;someTask&quot;,&quot;formKey&quot;:null,&quot;isDeleted&quot;:false,&quot;isCanceled&quot;:false,&quot;eventName&quot;:null,&quot;currentActivitiListener&quot;:null,&quot;tenantId&quot;:&quot;&quot;,&quot;queryVariables&quot;:null,&quot;forcedUpdate&quot;:false,&quot;claimTime&quot;:null,&quot;variableInstances&quot;:null,&quot;usedVariablesCache&quot;:{},&quot;transientVariabes&quot;:null,&quot;cachedElContext&quot;:null,&quot;id&quot;:&quot;30&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}...09:55:17,585 [main] INFO  org.destiny.activiti.GatewayExpressSpringTest  - 其中一个节点完成审批09:55:17,587 [main] INFO  org.destiny.activiti.GatewayExpressSpringTest  - 第一个节点审批完成后 taskList 数量: 0</code></pre><h1 id="3-多实例任务节点完成自定义条件"><a href="#3-多实例任务节点完成自定义条件" class="headerlink" title="3. 多实例任务节点完成自定义条件"></a>3. 多实例任务节点完成自定义条件</h1>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;1-Activiti-多实例&quot;&gt;&lt;a href=&quot;#1-Activiti-多实例&quot; class=&quot;headerlink&quot; title=&quot;1. Activiti 多实例&quot;&gt;&lt;/a&gt;1. Activiti 多实例&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;多实例节点是在
      
    
    </summary>
    
      <category term="Activiti" scheme="https://destinywang.github.io/blog/categories/Activiti/"/>
    
      <category term="Java" scheme="https://destinywang.github.io/blog/categories/Activiti/Java/"/>
    
      <category term="工作流" scheme="https://destinywang.github.io/blog/categories/Activiti/Java/%E5%B7%A5%E4%BD%9C%E6%B5%81/"/>
    
    
      <category term="Activiti" scheme="https://destinywang.github.io/blog/tags/Activiti/"/>
    
  </entry>
  
  <entry>
    <title>Activiti(3)--数据模型设计</title>
    <link href="https://destinywang.github.io/blog/2018/12/11/Activiti-3-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1/"/>
    <id>https://destinywang.github.io/blog/2018/12/11/Activiti-3-数据模型设计/</id>
    <published>2018-12-11T14:24:27.000Z</published>
    <updated>2018-12-12T13:32:47.165Z</updated>
    
    <content type="html"><![CDATA[<table><thead><tr><th>数据表分类</th><th>描述</th></tr></thead><tbody><tr><td>ACT_GE_*</td><td>通用数据表</td></tr><tr><td>ACT_RE_*</td><td>流程定义存储表</td></tr><tr><td>ACT_ID_*</td><td>身份信息表</td></tr><tr><td>ACT_RU_*</td><td>运行时数据库表</td></tr><tr><td>ACT_HI_*</td><td>历史数据库表, 为了保证运行时数据尽可能少, 流程执行完就会将相关数据迁移到历史表中</td></tr></tbody></table><ul><li>核心引擎: activiti.mysql.create.engine.sql</li><li>历史数据: activiti.mysql.create.history.sql</li><li>身份数据: activiti.mysql.create.identity.sql</li></ul><p>Activiti 除了核心引擎以外, 其他都是可选的.</p><p>首先创建 <code>ACT_GE_PROPERTY</code> 表, 并写入:</p><ol><li><code>schema.version</code>(schema 版本)</li><li><code>schema.history</code>(schema 历史)</li><li><code>next.dbid</code>(自增 id)<br>三条记录</li></ol><h1 id="1-通用数据库"><a href="#1-通用数据库" class="headerlink" title="1. 通用数据库"></a>1. 通用数据库</h1><table><thead><tr><th>数据表分类</th><th>描述</th></tr></thead><tbody><tr><td>ACT_GE_PROPERTY</td><td>属性表(保存流程引擎的 kv 键值属性)</td></tr><tr><td>ACT_GE_BYTEARRAY</td><td>资源表(存储流程定义相关的资源, 如 xml, 流程定义图)</td></tr></tbody></table><h2 id="1-1-ACT-GE-PROPERTY"><a href="#1-1-ACT-GE-PROPERTY" class="headerlink" title="1.1. ACT_GE_PROPERTY"></a>1.1. ACT_GE_PROPERTY</h2><p>对应实体类 <code>org.activiti.engine.impl.persistence.entity.PropertyEntityImpl</code></p><p><img src="https://user-images.githubusercontent.com/17758731/49807932-40ddce80-fd96-11e8-8959-b2ccad75a9c1.png" alt="image"></p><h2 id="1-2-ACT-GE-BYTEARRAY"><a href="#1-2-ACT-GE-BYTEARRAY" class="headerlink" title="1.2 ACT_GE_BYTEARRAY"></a>1.2 ACT_GE_BYTEARRAY</h2><p>对应实体类 <code>org.activiti.engine.impl.persistence.entity.ByteArrayEntityImpl</code></p><p><img src="https://user-images.githubusercontent.com/17758731/49808023-797da800-fd96-11e8-9940-8aa8ac085e7f.png" alt="image"></p><p>其中 GENERATED_ 字段标识该资源文件是自动生成还是人工上传</p><p>如果不想添加身份信息相关数据库和历史数据相关数据库, 可以在配置中显式指定</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"processEngineConfiguration"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"jdbc:h2:mem:activiti;DB_CLOSE_DELAY=1000;MVCC=TRUE"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcDriver"</span> <span class="attr">value</span>=<span class="string">"org.h2.Driver"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUsername"</span> <span class="attr">value</span>=<span class="string">"sa"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcPassword"</span> <span class="attr">value</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 不创建 ACT_ID_* 相关的表 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dbIdentityUsed"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 不创建 ACT_HI_* 相关的表 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dbHistoryUsed"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="2-流程定义存储表"><a href="#2-流程定义存储表" class="headerlink" title="2. 流程定义存储表"></a>2. 流程定义存储表</h1><table><thead><tr><th>数据表分类</th><th>描述</th></tr></thead><tbody><tr><td>ACT_RE_DEPLOYMENT</td><td>流程部署记录表</td></tr><tr><td>ACT_RE_PROCDEF</td><td>流程定义信息表</td></tr><tr><td>ACT_RE_MODEL</td><td>模型信息表(用于 web 设计器)</td></tr><tr><td>ACT_PROCDEF_INFO</td><td>流程定义动态改变信息表</td></tr></tbody></table><h2 id="2-1-ACT-RE-DEPLOYMENT"><a href="#2-1-ACT-RE-DEPLOYMENT" class="headerlink" title="2.1. ACT_RE_DEPLOYMENT"></a>2.1. ACT_RE_DEPLOYMENT</h2><p>对应实体 <code>org.activiti.engine.impl.persistence.entity.DeploymentEntityImpl</code></p><table><thead><tr><th>关键字段</th><th>描述</th></tr></thead><tbody><tr><td>ID_</td><td>主键</td></tr><tr><td>NAME_</td><td>名称</td></tr><tr><td>CATEGORY_</td><td>分类</td></tr><tr><td>TENANT_ID_</td><td>多租户标志</td></tr><tr><td>DEPLOY_TIME_</td><td>部署时间</td></tr><tr><td>KEY_</td><td>标志 key</td></tr><tr><td>ENGINE_VERSION_</td><td>兼容版本, 如果使用 Activiti5, 在升级到6后会有特殊标志</td></tr></tbody></table><h2 id="2-2-ACT-RE-PROCDEF"><a href="#2-2-ACT-RE-PROCDEF" class="headerlink" title="2.2 ACT_RE_PROCDEF"></a>2.2 ACT_RE_PROCDEF</h2><p>对应实体 <code>org.activiti.engine.impl.persistence.entity.ProcessDefinitionEntityImpl</code></p><table><thead><tr><th>关键字段</th><th>描述</th></tr></thead><tbody><tr><td>DEPLOYMENT_ID_</td><td>关联部署 id</td></tr><tr><td>RESOURCE_NAME_</td><td>流程定义资源名称</td></tr><tr><td>DGRM_RESOURCE_NAME_</td><td>流程图片资源名称</td></tr><tr><td>HAS_START_FORM_KEY_</td><td>是否存在开始表单标志</td></tr><tr><td>HAS_GRAPHICAL_NOTATION_</td><td>是否有图形信息</td></tr><tr><td>SUSPENSION_STATE_</td><td>挂起状态 1 正常, 2 挂起</td></tr></tbody></table><h2 id="2-3-测试代码"><a href="#2-3-测试代码" class="headerlink" title="2.3. 测试代码"></a>2.3. 测试代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeploy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    activitiRule.getRepositoryService()</span><br><span class="line">            .createDeployment()</span><br><span class="line">            .name(<span class="string">"二次审批流程"</span>)</span><br><span class="line">            .addClasspathResource(<span class="string">"org/destiny/activiti/SecondApprove.bpmn20.xml"</span>)</span><br><span class="line">            .deploy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ACT_RE_DEPLOYMENT 表内容:</p></blockquote><pre><code>mysql&gt; select * from ACT_RE_DEPLOYMENT \G;*************************** 1. row ***************************            ID_: 1          NAME_: 二次审批流程      CATEGORY_: NULL           KEY_: NULL     TENANT_ID_:   DEPLOY_TIME_: 2018-12-11 09:11:27.538ENGINE_VERSION_: NULL</code></pre><blockquote><p>ACT_RE_PROCDEF 表内容:</p></blockquote><pre><code>mysql&gt; select * from ACT_RE_PROCDEF \G;*************************** 1. row ***************************                    ID_: SecondApprove:1:4                   REV_: 1              CATEGORY_: http://www.activiti.org/test                  NAME_: 二级审批                   KEY_: SecondApprove               VERSION_: 1         DEPLOYMENT_ID_: 1         RESOURCE_NAME_: org/destiny/activiti/SecondApprove.bpmn20.xml    DGRM_RESOURCE_NAME_: org/destiny/activiti/SecondApprove.SecondApprove.png           DESCRIPTION_: NULL    HAS_START_FORM_KEY_: 0HAS_GRAPHICAL_NOTATION_: 1      SUSPENSION_STATE_: 1             TENANT_ID_:        ENGINE_VERSION_: NULL</code></pre><p>可以看到, 其中 <code>HAS_START_FORM_KEY_</code> 为 0, <code>DESCRIPTION_</code> 为 NULL, 二者都需要去流程定义文件中设置</p><ul><li><code>HAS_START_FORM_KEY_</code> 需要在 startEvent 中设置 actviti:formKey;</li><li><code>DESCRIPTION</code> 需要设置 documentation</li></ul><p>修改流程定义文件:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">xmlns:activiti</span>=<span class="string">"http://activiti.org/bpmn"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:bpmndi</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/DI"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdc</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DC"</span> <span class="attr">xmlns:omgdi</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DI"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">typeLanguage</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">expressionLanguage</span>=<span class="string">"http://www.w3.org/1999/XPath"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">targetNamespace</span>=<span class="string">"http://www.activiti.org/test"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"SecondApprove"</span> <span class="attr">name</span>=<span class="string">"二级审批"</span> <span class="attr">isExecutable</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>审批流程描述<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"startEvent"</span> <span class="attr">name</span>=<span class="string">"开始"</span> <span class="attr">activiti:formKey</span>=<span class="string">"/process/form/key"</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"submitApprove"</span> <span class="attr">name</span>=<span class="string">"填写申请信息"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后重新部署即可看到: </p><pre><code>mysql&gt; select * from ACT_RE_PROCDEF \G;*************************** 1. row ***************************                    ID_: SecondApprove:1:4                   REV_: 1              CATEGORY_: http://www.activiti.org/test                  NAME_: 二级审批                   KEY_: SecondApprove               VERSION_: 1         DEPLOYMENT_ID_: 1         RESOURCE_NAME_: org/destiny/activiti/SecondApprove.bpmn20.xml    DGRM_RESOURCE_NAME_: org/destiny/activiti/SecondApprove.SecondApprove.png           DESCRIPTION_: NULL    HAS_START_FORM_KEY_: 0HAS_GRAPHICAL_NOTATION_: 1      SUSPENSION_STATE_: 1             TENANT_ID_:        ENGINE_VERSION_: NULL*************************** 2. row ***************************                    ID_: SecondApprove:2:2504                   REV_: 1              CATEGORY_: http://www.activiti.org/test                  NAME_: 二级审批                   KEY_: SecondApprove               VERSION_: 2         DEPLOYMENT_ID_: 2501         RESOURCE_NAME_: org/destiny/activiti/SecondApprove.bpmn20.xml    DGRM_RESOURCE_NAME_: org/destiny/activiti/SecondApprove.SecondApprove.png           DESCRIPTION_: 审批流程描述    HAS_START_FORM_KEY_: 0HAS_GRAPHICAL_NOTATION_: 1      SUSPENSION_STATE_: 1             TENANT_ID_:        ENGINE_VERSION_: NULL</code></pre><p>ACT_RE_PROCDEF 是基于 KEY_ 去升级版本号, 当原有的 key 已经存在, 就会升级版本号, 其中 KEY_, VERSION_, TENANT_ID_ 共同组成一个唯一键</p><h1 id="3-身份数据表设计"><a href="#3-身份数据表设计" class="headerlink" title="3. 身份数据表设计"></a>3. 身份数据表设计</h1><table><thead><tr><th>数据表设计</th><th>描述</th></tr></thead><tbody><tr><td>ACT_ID_USER</td><td>用户的基本信息</td></tr><tr><td>ACT_ID_INFO</td><td>用户的扩展信息</td></tr><tr><td>ACT_ID_GROUP</td><td>群组</td></tr><tr><td>ACT_ID_MEMBERSHIP</td><td>用户与群组关系</td></tr></tbody></table><h2 id="3-1-用户信息表"><a href="#3-1-用户信息表" class="headerlink" title="3.1. 用户信息表"></a>3.1. 用户信息表</h2><p>对应实体 <code>org.activiti.engine.impl.persistence.entity.UserEntityImpl</code></p><pre><code>+-------------+--------------+------+-----+---------+-------+| Field       | Type         | Null | Key | Default | Extra |+-------------+--------------+------+-----+---------+-------+| ID_         | varchar(64)  | NO   | PRI | NULL    |       || REV_        | int(11)      | YES  |     | NULL    |       || FIRST_      | varchar(255) | YES  |     | NULL    |       || LAST_       | varchar(255) | YES  |     | NULL    |       || EMAIL_      | varchar(255) | YES  |     | NULL    |       || PWD_        | varchar(255) | YES  |     | NULL    |       || PICTURE_ID_ | varchar(64)  | YES  |     | NULL    |       |+-------------+--------------+------+-----+---------+-------+</code></pre><h2 id="3-2-用户扩展信息"><a href="#3-2-用户扩展信息" class="headerlink" title="3.2. 用户扩展信息"></a>3.2. 用户扩展信息</h2><p>对应实体 <code>org.activiti.engine.impl.persistence.entity.IdentityInfoEntityImpl</code></p><pre><code>+------------+--------------+------+-----+---------+-------+| Field      | Type         | Null | Key | Default | Extra |+------------+--------------+------+-----+---------+-------+| ID_        | varchar(64)  | NO   | PRI | NULL    |       || REV_       | int(11)      | YES  |     | NULL    |       || USER_ID_   | varchar(64)  | YES  |     | NULL    |       || TYPE_      | varchar(64)  | YES  |     | NULL    |       || KEY_       | varchar(255) | YES  |     | NULL    |       || VALUE_     | varchar(255) | YES  |     | NULL    |       || PASSWORD_  | longblob     | YES  |     | NULL    |       || PARENT_ID_ | varchar(255) | YES  |     | NULL    |       |+------------+--------------+------+-----+---------+-------+</code></pre><ul><li>USER_ID_: 关联用户 id</li><li>TYPE_: 类型(固定值)</li><li>KEY_: 属性名</li><li>VALUE_: 属性值</li><li>PASSWORD_: 密码(未使用)</li><li>PARENT_ID_: 上级关联(不建议使用)</li></ul><h2 id="3-3-ACT-ID-GROUP"><a href="#3-3-ACT-ID-GROUP" class="headerlink" title="3.3. ACT_ID_GROUP"></a>3.3. ACT_ID_GROUP</h2><p>对应实体 <code>org.activiti.engine.impl.persistence.entity.GroupEntityImpl</code></p><pre><code>+-------+--------------+------+-----+---------+-------+| Field | Type         | Null | Key | Default | Extra |+-------+--------------+------+-----+---------+-------+| ID_   | varchar(64)  | NO   | PRI | NULL    |       || REV_  | int(11)      | YES  |     | NULL    |       || NAME_ | varchar(255) | YES  |     | NULL    |       || TYPE_ | varchar(255) | YES  |     | NULL    |       |+-------+--------------+------+-----+---------+-------+</code></pre><h2 id="3-4-用户组关系表"><a href="#3-4-用户组关系表" class="headerlink" title="3.4. 用户组关系表"></a>3.4. 用户组关系表</h2><p>对应实体 <code>org.activiti.engine.impl.persistence.entity.MembershipEntityImpl</code></p><pre><code>+-----------+-------------+------+-----+---------+-------+| Field     | Type        | Null | Key | Default | Extra |+-----------+-------------+------+-----+---------+-------+| USER_ID_  | varchar(64) | NO   | PRI | NULL    |       || GROUP_ID_ | varchar(64) | NO   | PRI | NULL    |       |+-----------+-------------+------+-----+---------+-------+</code></pre><p>测试代码:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIdentity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    IdentityService identityService = activitiRule.getIdentityService();</span><br><span class="line">    User user1 = identityService.newUser(<span class="string">"user1"</span>);</span><br><span class="line">    user1.setFirstName(<span class="string">"firstName"</span>);</span><br><span class="line">    user1.setLastName(<span class="string">"lastName"</span>);</span><br><span class="line">    user1.setEmail(<span class="string">"user1@126.com"</span>);</span><br><span class="line">    user1.setPassword(<span class="string">"pwd"</span>);</span><br><span class="line">    identityService.saveUser(user1);</span><br><span class="line">    User user2 = identityService.newUser(<span class="string">"user2"</span>);</span><br><span class="line">    identityService.saveUser(user2);</span><br><span class="line">    Group group1 = identityService.newGroup(<span class="string">"group1"</span>);</span><br><span class="line">    group1.setName(<span class="string">"for test"</span>);</span><br><span class="line">    identityService.saveGroup(group1);</span><br><span class="line">    identityService.createMembership(user1.getId(), group1.getId());</span><br><span class="line">    identityService.createMembership(user2.getId(), group1.getId());</span><br><span class="line">    <span class="comment">// 扩展信息</span></span><br><span class="line">    identityService.setUserInfo(user1.getId(), <span class="string">"age"</span>, <span class="string">"18"</span>);</span><br><span class="line">    identityService.setUserInfo(user1.getId(), <span class="string">"identity"</span>, <span class="string">"destiny"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="4-运行时流程数据表"><a href="#4-运行时流程数据表" class="headerlink" title="4. 运行时流程数据表"></a>4. 运行时流程数据表</h1><table><thead><tr><th>数据表分类</th><th>描述</th></tr></thead><tbody><tr><td>ACT_RU_EXECUTION</td><td>流程实例与分支执行信息</td></tr><tr><td>ACT_RU_TASK</td><td>用户任务信息</td></tr><tr><td>ACT_RU_VARIABLE</td><td>变量信息</td></tr><tr><td>ACT_RU_IDENTITYLINK</td><td>参与者相关信息</td></tr><tr><td>ACT_RU_EVENT_SUBSCR</td><td>事件监听表</td></tr><tr><td>ACT_RU_JOB</td><td>作业表</td></tr><tr><td>ACT_RU_TIMER_JOB</td><td>定时器表</td></tr><tr><td>ACT_RU_SUSPENDED_JOB</td><td>暂停作业表</td></tr><tr><td>ACT_RU_DEADLETTER_JOB</td><td>死信表</td></tr></tbody></table><h2 id="4-1-ACT-RU-EXECUTION"><a href="#4-1-ACT-RU-EXECUTION" class="headerlink" title="4.1. ACT_RU_EXECUTION"></a>4.1. ACT_RU_EXECUTION</h2><p>对应实体类 <code>org.activiti.engine.impl.persistence.entity.ExecutionEntityImpl</code></p><table><thead><tr><th>关键字段</th><th>描述</th></tr></thead><tbody><tr><td>PROC_INST_ID_</td><td>流程实例 ID</td></tr><tr><td>BUSINESS_KEY_</td><td>业务标志</td></tr><tr><td>PARENT_ID_</td><td>父执行信息</td></tr><tr><td>PROC_DEF_ID_</td><td>流程定义 ID</td></tr><tr><td>SUPER_EXEC_</td><td>父流程实例对应的执行</td></tr><tr><td>ACT_ID_</td><td>流程定义节点 ID</td></tr><tr><td>IS_ACTIVE</td><td>是否活动的执行 0-非活动, 1-活动</td></tr><tr><td>IS_CONCURRENT_</td><td>是否并行分支 0-非, 1-是</td></tr><tr><td>IS_SCOPE_</td><td>是否全局流程执行 0-非, 1-是</td></tr><tr><td>IS_EVENT_SCOPE_</td><td>是否激活状态</td></tr><tr><td>SUSPENSION_STATE</td><td>挂起状态 1-正常, 2-挂起</td></tr><tr><td>LOCK_TIME_</td><td>锁定时间</td></tr></tbody></table><h2 id="4-2-ACT-RU-TASK"><a href="#4-2-ACT-RU-TASK" class="headerlink" title="4.2. ACT_RU_TASK"></a>4.2. ACT_RU_TASK</h2><p>对应实体类 <code>org.activiti.engine.impl.persistence.entity.TaskEntityImpl</code></p><table><thead><tr><th>关键字段</th><th>描述</th></tr></thead><tbody><tr><td>EXECUTION_ID_</td><td>执行流 id</td></tr><tr><td>PROC_INST_ID_</td><td>流程实例 ID</td></tr><tr><td>PROC_DEF_ID_</td><td>流程定义 ID</td></tr><tr><td>PARENT_TASK_ID_</td><td>父任务</td></tr><tr><td>TASK_DEF_KEY_</td><td>任务定义 ID</td></tr><tr><td>NAME_</td><td>任务定义名称</td></tr><tr><td>OWNER_</td><td>拥有人</td></tr><tr><td>ASSIGNEE_</td><td>代理人</td></tr><tr><td>DELEGATION_</td><td>委托状态 PENDING-委托中, RESOLVED 已处理</td></tr><tr><td>PRIORITY_</td><td>优先级</td></tr><tr><td>DUE_DATE_</td><td>过期时间</td></tr><tr><td>FORM_KEY_</td><td>表单标志</td></tr></tbody></table><h2 id="4-3-ACT-RU-VARIABLE"><a href="#4-3-ACT-RU-VARIABLE" class="headerlink" title="4.3. ACT_RU_VARIABLE"></a>4.3. ACT_RU_VARIABLE</h2><p>对应实体类 <code>org.activiti.engine.impl.persistence.entity.VariableInstanceEntityImpl</code></p><table><thead><tr><th>关键字段</th><th>描述</th></tr></thead><tbody><tr><td>TYPE_</td><td>变量名称(integer, string, double, json)</td></tr><tr><td>NAME_</td><td>变量名</td></tr><tr><td>BYTEARRAY_ID_</td><td>资源表 id</td></tr><tr><td>DOUBLE_</td><td>浮点值</td></tr><tr><td>LONG_</td><td>长整型数值</td></tr><tr><td>TEXT_</td><td>文本值</td></tr></tbody></table><h2 id="4-4-ACT-RU-IDENTITYLINK"><a href="#4-4-ACT-RU-IDENTITYLINK" class="headerlink" title="4.4. ACT_RU_IDENTITYLINK"></a>4.4. ACT_RU_IDENTITYLINK</h2><p>对应实体类 <code>org.activiti.engine.impl.persistence.entity.IdentityInfoEntityImpl</code></p><blockquote><p>当用户和流程建立关系的时候, 就会在此表中插入记录</p></blockquote><table><thead><tr><th>关键字段</th><th>描述</th></tr></thead><tbody><tr><td>ID_</td><td>主键</td></tr><tr><td>GROUP_ID_</td><td>用户组 ID</td></tr><tr><td>TYPE_</td><td>类型 assignee, candidate, owner, starter…</td></tr><tr><td>USER_ID_</td><td>用户 ID</td></tr><tr><td>TASK_ID_</td><td>任务 ID</td></tr><tr><td>PROC_INST_ID_</td><td>流程实例</td></tr></tbody></table><h2 id="4-5-ACT-RU-EVENT-SUBSCR"><a href="#4-5-ACT-RU-EVENT-SUBSCR" class="headerlink" title="4.5. ACT_RU_EVENT_SUBSCR"></a>4.5. ACT_RU_EVENT_SUBSCR</h2><p>对应实体类 <code>org.activiti.engine.impl.persistence.entity.EventSubscriptionEntityImpl</code></p><table><thead><tr><th>关键字段</th><th>描述</th></tr></thead><tbody><tr><td>EVENT_TYPE_</td><td>事件类型 message, signal</td></tr><tr><td>EVENT_NAME_</td><td>事件名称</td></tr><tr><td>EXECUTION_ID_</td><td>流程执行 ID</td></tr><tr><td>PROC_INST_ID_</td><td>流程实例 ID</td></tr><tr><td>ACTIVITY_ID_</td><td>流程定义节点 ID</td></tr><tr><td>CONFIGURATION_</td><td>配置</td></tr></tbody></table><h2 id="4-6-ACT-RU-JOB"><a href="#4-6-ACT-RU-JOB" class="headerlink" title="4.6. ACT_RU_JOB"></a>4.6. ACT_RU_JOB</h2><p>对应实体类 <code>org.activiti.engine.impl.persistence.entity.JobEntityImpl</code></p><table><thead><tr><th>关键字段</th><th>描述</th></tr></thead><tbody><tr><td>TYPE_</td><td>类型</td></tr><tr><td>LOCK_EXP_TIME_</td><td>锁定过期时间</td></tr><tr><td>LOCK_OWNER_</td><td>锁定接点</td></tr><tr><td>EXCLUSIVE_</td><td>是否唯一</td></tr><tr><td>RETRIES_</td><td>重试次数3</td></tr><tr><td>REPEAT_</td><td>重复表达式 R5/PT10S</td></tr><tr><td>EXCEPTION_STACK_ID_</td><td>异常堆栈(资源表 ID)</td></tr><tr><td>EXCEPTION_MSG_</td><td>异常信息</td></tr><tr><td>DUEDATE_</td><td>过期时间</td></tr><tr><td>HANDLER_TYPE_</td><td>处理器类型</td></tr><tr><td>HANDLER_CFG</td><td>处理器配置</td></tr><tr><td>EXECUTION_ID_</td><td>流程执行表 ID</td></tr></tbody></table><h2 id="4-7-测试代码"><a href="#4-7-测试代码" class="headerlink" title="4.7 测试代码"></a>4.7 测试代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRuntime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Deployment deployment = activitiRule.getRepositoryService()</span><br><span class="line">            .createDeployment()</span><br><span class="line">            .name(<span class="string">"二次审批"</span>)</span><br><span class="line">            .addClasspathResource(<span class="string">"org/destiny/activiti/SecondApprove.bpmn20.xml"</span>)</span><br><span class="line">            .deploy();</span><br><span class="line">    log.info(<span class="string">"deployment: &#123;&#125;"</span>, deployment);</span><br><span class="line">    Map&lt;String, Object&gt; variables = Maps.newHashMap();</span><br><span class="line">    variables.put(<span class="string">"k1"</span>, <span class="string">"v1"</span>);</span><br><span class="line">    ProcessInstance processInstance = activitiRule.getRuntimeService()</span><br><span class="line">            .startProcessInstanceByKey(<span class="string">"SecondApprove"</span>, variables);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-7-1-ACT-RU-EXECUTION-表"><a href="#4-7-1-ACT-RU-EXECUTION-表" class="headerlink" title="4.7.1 ACT_RU_EXECUTION 表"></a>4.7.1 ACT_RU_EXECUTION 表</h3><p>执行完成后, <code>ACT_RU_EXECUTION</code> 表会生成如下两条记录, 流程启动和用户任务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">*************************** 1. row ***************************</span><br><span class="line">                  ID_: 5</span><br><span class="line">                 REV_: 1</span><br><span class="line">        PROC_INST_ID_: 5</span><br><span class="line">        BUSINESS_KEY_: NULL</span><br><span class="line">           PARENT_ID_: NULL</span><br><span class="line">         PROC_DEF_ID_: SecondApprove:1:4</span><br><span class="line">          SUPER_EXEC_: NULL</span><br><span class="line">   ROOT_PROC_INST_ID_: 5</span><br><span class="line">              ACT_ID_: NULL</span><br><span class="line">           IS_ACTIVE_: 1</span><br><span class="line">       IS_CONCURRENT_: 0</span><br><span class="line">            IS_SCOPE_: 1</span><br><span class="line">      IS_EVENT_SCOPE_: 0</span><br><span class="line">          IS_MI_ROOT_: 0</span><br><span class="line">    SUSPENSION_STATE_: 1</span><br><span class="line">    CACHED_ENT_STATE_: NULL</span><br><span class="line">           TENANT_ID_:</span><br><span class="line">                NAME_: NULL</span><br><span class="line">          START_TIME_: 2018-12-12 03:40:16.634</span><br><span class="line">       START_USER_ID_: NULL</span><br><span class="line">           LOCK_TIME_: NULL</span><br><span class="line">    IS_COUNT_ENABLED_: 0</span><br><span class="line">    EVT_SUBSCR_COUNT_: 0</span><br><span class="line">          TASK_COUNT_: 0</span><br><span class="line">           JOB_COUNT_: 0</span><br><span class="line">     TIMER_JOB_COUNT_: 0</span><br><span class="line">      SUSP_JOB_COUNT_: 0</span><br><span class="line">DEADLETTER_JOB_COUNT_: 0</span><br><span class="line">           VAR_COUNT_: 0</span><br><span class="line">       ID_LINK_COUNT_: 0</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">                  ID_: 7</span><br><span class="line">                 REV_: 1</span><br><span class="line">        PROC_INST_ID_: 5</span><br><span class="line">        BUSINESS_KEY_: NULL</span><br><span class="line">           PARENT_ID_: 5</span><br><span class="line">         PROC_DEF_ID_: SecondApprove:1:4</span><br><span class="line">          SUPER_EXEC_: NULL</span><br><span class="line">   ROOT_PROC_INST_ID_: 5</span><br><span class="line">              ACT_ID_: submitApprove</span><br><span class="line">           IS_ACTIVE_: 1</span><br><span class="line">       IS_CONCURRENT_: 0</span><br><span class="line">            IS_SCOPE_: 0</span><br><span class="line">      IS_EVENT_SCOPE_: 0</span><br><span class="line">          IS_MI_ROOT_: 0</span><br><span class="line">    SUSPENSION_STATE_: 1</span><br><span class="line">    CACHED_ENT_STATE_: NULL</span><br><span class="line">           TENANT_ID_:</span><br><span class="line">                NAME_: NULL</span><br><span class="line">          START_TIME_: 2018-12-12 03:40:16.636</span><br><span class="line">       START_USER_ID_: NULL</span><br><span class="line">           LOCK_TIME_: NULL</span><br><span class="line">    IS_COUNT_ENABLED_: 0</span><br><span class="line">    EVT_SUBSCR_COUNT_: 0</span><br><span class="line">          TASK_COUNT_: 0</span><br><span class="line">           JOB_COUNT_: 0</span><br><span class="line">     TIMER_JOB_COUNT_: 0</span><br><span class="line">      SUSP_JOB_COUNT_: 0</span><br><span class="line">DEADLETTER_JOB_COUNT_: 0</span><br><span class="line">           VAR_COUNT_: 0</span><br><span class="line">       ID_LINK_COUNT_: 0</span><br></pre></td></tr></table></figure><ul><li>两条记录的 <code>PROC_DEF_ID_</code> 相同, 说明是同一个流程的实例.</li><li>第一条记录的 <code>ID_</code> 是5, 第二条记录的 <code>PARENT_ID_</code> 是 5, 说明第二条是第一条生成的.</li><li>第二条记录的 <code>ACT_ID_</code> 值为 submitApprove, 代表 userTask 的一个节点</li><li>第二条记录的 <code>IS_SCOPE</code> 值为 0, 代表不是一个全局的执行流, 而第一条是一个全局执行流.</li></ul><h3 id="4-7-2-ACT-RU-TASK-表"><a href="#4-7-2-ACT-RU-TASK-表" class="headerlink" title="4.7.2 ACT_RU_TASK 表"></a>4.7.2 ACT_RU_TASK 表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">*************************** 1. row ***************************</span><br><span class="line">              ID_: 10</span><br><span class="line">             REV_: 1</span><br><span class="line">    EXECUTION_ID_: 7</span><br><span class="line">    PROC_INST_ID_: 5</span><br><span class="line">     PROC_DEF_ID_: SecondApprove:1:4</span><br><span class="line">            NAME_: 填写申请信息</span><br><span class="line">  PARENT_TASK_ID_: NULL</span><br><span class="line">     DESCRIPTION_: NULL</span><br><span class="line">    TASK_DEF_KEY_: submitApprove</span><br><span class="line">           OWNER_: NULL</span><br><span class="line">        ASSIGNEE_: NULL</span><br><span class="line">      DELEGATION_: NULL</span><br><span class="line">        PRIORITY_: 50</span><br><span class="line">     CREATE_TIME_: 2018-12-12 03:40:16.641</span><br><span class="line">        DUE_DATE_: NULL</span><br><span class="line">        CATEGORY_: NULL</span><br><span class="line">SUSPENSION_STATE_: 1</span><br><span class="line">       TENANT_ID_:</span><br><span class="line">        FORM_KEY_: NULL</span><br><span class="line">      CLAIM_TIME_: NULL</span><br></pre></td></tr></table></figure><ul><li><code>PROC_DEF_ID_</code> 为 SecondApprove:1:4</li></ul><h3 id="4-7-3-ACT-RU-VARIABLE-表"><a href="#4-7-3-ACT-RU-VARIABLE-表" class="headerlink" title="4.7.3. ACT_RU_VARIABLE 表"></a>4.7.3. ACT_RU_VARIABLE 表</h3><blockquote><p>保存启动时候设置的变量</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">*************************** 1. row ***************************</span><br><span class="line">          ID_: 6</span><br><span class="line">         REV_: 1</span><br><span class="line">        TYPE_: string</span><br><span class="line">        NAME_: k1</span><br><span class="line">EXECUTION_ID_: 5</span><br><span class="line">PROC_INST_ID_: 5</span><br><span class="line">     TASK_ID_: NULL</span><br><span class="line">BYTEARRAY_ID_: NULL</span><br><span class="line">      DOUBLE_: NULL</span><br><span class="line">        LONG_: NULL</span><br><span class="line">        TEXT_: v1</span><br><span class="line">       TEXT2_: NULL</span><br></pre></td></tr></table></figure><p>执行设置所属人的代码:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSetOwner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TaskService taskService = activitiRule.getTaskService();</span><br><span class="line">    Task task = taskService</span><br><span class="line">            .createTaskQuery()</span><br><span class="line">            .processDefinitionKey(<span class="string">"SecondApprove"</span>)</span><br><span class="line">            .singleResult();</span><br><span class="line">    <span class="comment">// 设置所属人</span></span><br><span class="line">    taskService.setOwner(task.getId(), <span class="string">"destiny"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-7-4-ACT-RU-IDENTITYLINK"><a href="#4-7-4-ACT-RU-IDENTITYLINK" class="headerlink" title="4.7.4 ACT_RU_IDENTITYLINK"></a>4.7.4 ACT_RU_IDENTITYLINK</h3><pre><code>*************************** 1. row ***************************          ID_: 2501         REV_: 1    GROUP_ID_: NULL        TYPE_: participant     USER_ID_: destiny     TASK_ID_: NULLPROC_INST_ID_: 5 PROC_DEF_ID_: NULL</code></pre><p>而此时在 <code>ACT_RU_TASK</code> 表, 对应的 task 的 <code>OWNER_</code> 字段已经赋值为 destiny</p><h3 id="4-7-5-ACT-RU-TASK"><a href="#4-7-5-ACT-RU-TASK" class="headerlink" title="4.7.5 ACT_RU_TASK"></a>4.7.5 ACT_RU_TASK</h3><pre><code>*************************** 1. row ***************************              ID_: 10             REV_: 2    EXECUTION_ID_: 7    PROC_INST_ID_: 5     PROC_DEF_ID_: SecondApprove:1:4            NAME_: 填写申请信息  PARENT_TASK_ID_: NULL     DESCRIPTION_: NULL    TASK_DEF_KEY_: submitApprove           OWNER_: destiny        ASSIGNEE_: NULL      DELEGATION_: NULL        PRIORITY_: 50     CREATE_TIME_: 2018-12-12 07:19:33.134        DUE_DATE_: NULL        CATEGORY_: NULLSUSPENSION_STATE_: 1       TENANT_ID_:        FORM_KEY_: NULL      CLAIM_TIME_: NULL</code></pre><h1 id="5-历史流程数据表"><a href="#5-历史流程数据表" class="headerlink" title="5. 历史流程数据表"></a>5. 历史流程数据表</h1><table><thead><tr><th>数据表分类</th><th>描述</th></tr></thead><tbody><tr><td>ACT_HI_PROCINST</td><td>历史流程实例表</td></tr><tr><td>ACT_HI_ACTINST</td><td>历史节点信息表, 执行过程中每经过一个节点就会插入一条记录</td></tr><tr><td>ACT_HI_TASKINST</td><td>历史任务表</td></tr><tr><td>ACT_HI_VARINST</td><td>历史变量</td></tr><tr><td>ACT_HI_IDENTITYLINK</td><td>历史参与者</td></tr><tr><td>ACT_HI_DETAIL</td><td>历史变更, 当使用 FormService 提交表单时, 表单的属性就会存储在该表, 以及变量的更改</td></tr><tr><td>ACT_HI_ATTACHMENT</td><td>附件</td></tr><tr><td>ACT_HI_COMMENT</td><td>评论</td></tr><tr><td>ACT_EVT_LOG</td><td>事件日志</td></tr></tbody></table><h2 id="5-1-ACT-HI-PROCINST"><a href="#5-1-ACT-HI-PROCINST" class="headerlink" title="5.1 ACT_HI_PROCINST"></a>5.1 ACT_HI_PROCINST</h2><p>| 关键字段 | </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;数据表分类&lt;/th&gt;
&lt;th&gt;描述&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;ACT_GE_*&lt;/td&gt;
&lt;td&gt;通用数据表&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ACT_RE_*&lt;/td&gt;
&lt;t
      
    
    </summary>
    
      <category term="Activiti" scheme="https://destinywang.github.io/blog/categories/Activiti/"/>
    
      <category term="Java" scheme="https://destinywang.github.io/blog/categories/Activiti/Java/"/>
    
      <category term="工作流" scheme="https://destinywang.github.io/blog/categories/Activiti/Java/%E5%B7%A5%E4%BD%9C%E6%B5%81/"/>
    
    
      <category term="Activiti" scheme="https://destinywang.github.io/blog/tags/Activiti/"/>
    
  </entry>
  
  <entry>
    <title>Activiti(2)--BPMN2.0规范</title>
    <link href="https://destinywang.github.io/blog/2018/12/08/Activiti-2-BPMN2-0%E8%A7%84%E8%8C%83/"/>
    <id>https://destinywang.github.io/blog/2018/12/08/Activiti-2-BPMN2-0规范/</id>
    <published>2018-12-07T16:08:52.000Z</published>
    <updated>2018-12-08T10:30:53.174Z</updated>
    
    <content type="html"><![CDATA[<p>BPMN2.0:</p><ul><li>是一套业务流程模型与符号建模标准</li><li>精准的执行语义来描述元素的操作</li><li>以 XML 为载体, 以符号可视化业务</li></ul><p>BPMN2.0元素:</p><ul><li>流对象</li><li>连接对象</li><li>数据</li><li>泳道</li><li>描述对象</li></ul><blockquote><p>其中最重要的流对象, 流对象包括活动, 事件和网关, 通过连接对象连接起来, 用来表示数据的流转, 泳道用来对业务的范围做区分, 描述对象并不影响业务的进行, 为流程图的可读性做补充性的描述.</p></blockquote><p><img src="https://user-images.githubusercontent.com/17758731/49372749-a26ac100-f736-11e8-89f1-b01d14fa6f1d.png" alt="image"><br><img src="https://user-images.githubusercontent.com/17758731/49372819-d0e89c00-f736-11e8-984f-34464892a1b9.png" alt="image"></p><h1 id="1-事件"><a href="#1-事件" class="headerlink" title="1. 事件"></a>1. 事件</h1><h2 id="1-1-分类"><a href="#1-1-分类" class="headerlink" title="1.1 分类"></a>1.1 分类</h2><p>按照位置分类:</p><ul><li>开始事件</li><li>中间事件/边界事件(中间事件是指出现在流程中, 可以单独作为流程节点的事件, 而边界事件指的是附属于某个流程节点的事件)</li><li>结束事件</li></ul><p>按照特征分类:</p><ul><li>捕获时间, 捕获事件是一直在等待被触发的事件, 所有的开始事件都是等待被触发的事件</li><li>抛出事件, 执行到节点会自动执行并抛出结果, 结束事件都属于抛出事件.</li></ul><p>按照定义分类:</p><ul><li>定时事件</li><li>错误事件</li><li>信号事件</li><li>消息事件</li></ul><h3 id="1-1-1-定时事件"><a href="#1-1-1-定时事件" class="headerlink" title="1.1.1 定时事件"></a>1.1.1 定时事件</h3><blockquote><p>在使用定时事件时, 首先需要流程引擎的异步开关打开</p></blockquote><ul><li>指定时间(timeDate)</li><li>指定持续时间(timeDuration)</li><li>周期执行(timeCycle)</li></ul><p>定时事件的定义方式: </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">timerEventDefinition</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 指定定时时间的类型: timeDate --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timeDate</span>&gt;</span>2018-01-01T10:10:10<span class="tag">&lt;/<span class="name">timeDate</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">timerEventDefinition</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="1-1-1-1-定时开始事件"><a href="#1-1-1-1-定时开始事件" class="headerlink" title="1.1.1.1 定时开始事件"></a>1.1.1.1 定时开始事件</h4><p><img src="https://user-images.githubusercontent.com/17758731/49680055-62576580-facb-11e8-97d2-daa701f4993f.png" alt="image"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"timerStartEvent"</span> <span class="attr">name</span>=<span class="string">"Timer Start"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timerEventDefinition</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--在流程部署完成 5 分钟后,  执行5次 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">timeCycle</span>&gt;</span>R5/PT5M<span class="tag">&lt;/<span class="name">timeCycle</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">timerEventDefinition</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="1-1-1-2-定时边界事件"><a href="#1-1-1-2-定时边界事件" class="headerlink" title="1.1.1.2 定时边界事件"></a>1.1.1.2 定时边界事件</h4><blockquote><p>流程流转到一个普通任务时, 如果在指定时间内没有完成, 就会触发定时边界事件</p></blockquote><p><img src="https://user-images.githubusercontent.com/17758731/49680088-d1cd5500-facb-11e8-8cd7-94c1b85d7402.png" alt="image"></p><h5 id="流程定义"><a href="#流程定义" class="headerlink" title="流程定义"></a>流程定义</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"startEvent"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"commonTask"</span> <span class="attr">name</span>=<span class="string">"Common Task"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 声明边界事件, attachedToRef 指定边界事件的宿主 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">boundaryEvent</span> <span class="attr">id</span>=<span class="string">"boundaryEvent"</span> <span class="attr">name</span>=<span class="string">"Timer"</span> <span class="attr">attachedToRef</span>=<span class="string">"commonTask"</span> <span class="attr">cancelActivity</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timerEventDefinition</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 部署完 5 秒之后 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">timeDuration</span>&gt;</span>PT5S<span class="tag">&lt;/<span class="name">timeDuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">timerEventDefinition</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">boundaryEvent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"timeoutTask"</span> <span class="attr">name</span>=<span class="string">"Timeout Task"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"end1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"end2"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 构建顺序流 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">sourceRef</span>=<span class="string">"startEvent"</span> <span class="attr">targetRef</span>=<span class="string">"commonTask"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">sourceRef</span>=<span class="string">"commonTask"</span> <span class="attr">targetRef</span>=<span class="string">"end1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">sourceRef</span>=<span class="string">"boundaryEvent"</span> <span class="attr">targetRef</span>=<span class="string">"timeoutTask"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">sourceRef</span>=<span class="string">"timeoutTask"</span> <span class="attr">targetRef</span>=<span class="string">"end2"</span>/&gt;</span></span><br></pre></td></tr></table></figure><h5 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 超时边界事件</span></span><br><span class="line"><span class="comment"> * 流程启动之后, 流转到 commonTask, 此时让当前线程休眠 10 秒(5秒就会超时)</span></span><br><span class="line"><span class="comment"> * 定时任务超时后执行 timeoutTask</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process-time-boundary.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTimerBoundary</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    activitiRule.getRuntimeService().startProcessInstanceByKey(<span class="string">"my-process"</span>);</span><br><span class="line">    <span class="comment">// task 列表</span></span><br><span class="line">    List&lt;Task&gt; taskList = activitiRule.getTaskService().createTaskQuery().list();</span><br><span class="line">    log.info(<span class="string">"task 总数: &#123;&#125;"</span>, taskList.size());</span><br><span class="line">    <span class="keyword">for</span> (Task task : taskList) &#123;</span><br><span class="line">        log.info(<span class="string">"task.name = &#123;&#125;"</span>, task.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 强制睡眠等待边界事件触发</span></span><br><span class="line">    Thread.sleep(<span class="number">10</span> * <span class="number">1000</span>);</span><br><span class="line">    <span class="comment">// task 列表</span></span><br><span class="line">    taskList = activitiRule.getTaskService().createTaskQuery().list();</span><br><span class="line">    log.info(<span class="string">"休眠后 task 总数: &#123;&#125;"</span>, taskList.size());</span><br><span class="line">    <span class="keyword">for</span> (Task task : taskList) &#123;</span><br><span class="line">        log.info(<span class="string">"休眠后 task.name = &#123;&#125;"</span>, task.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="日志输出"><a href="#日志输出" class="headerlink" title="日志输出"></a>日志输出</h5><pre><code>11:06:06,568 [main] INFO  org.destiny.activiti.bpmn20.TimerEventTest  - task 总数: 111:06:06,568 [main] INFO  org.destiny.activiti.bpmn20.TimerEventTest  - task.name = Common Task...11:06:16,573 [main] INFO  org.destiny.activiti.bpmn20.TimerEventTest  - 休眠后 task 总数: 111:06:16,573 [main] INFO  org.destiny.activiti.bpmn20.TimerEventTest  - 休眠后 task.name = Timeout Task</code></pre><h3 id="1-1-2-错误事件"><a href="#1-1-2-错误事件" class="headerlink" title="1.1.2 错误事件"></a>1.1.2 错误事件</h3><blockquote><p>网关中由提交的表单信息判断正常结束还是异常结束, 错误事件会被错误信息所触发, 主要用于处理业务异常</p></blockquote><p><img src="https://user-images.githubusercontent.com/17758731/49682183-c3dafc80-faea-11e8-9160-48f2f59d1c3f.png" alt="image"></p><blockquote><h4 id="流程图简单分析"><a href="#流程图简单分析" class="headerlink" title="流程图简单分析"></a>流程图简单分析</h4><blockquote><p>提交一个新的 <code>sales leader</code>, 创建一个子流程, 在子流程中同时对 <code>customer rating</code> 以及 <code>profitability</code> 进行考察, 如果同时通过, 则结束子流程, 完成主流程的 <code>Store lead in CRM system</code> 任务以及结束节点</p><blockquote><p>如果 <code>profitability</code> 任务没有提供足够的信息, 则会抛出错误事件, 错误事件被边界事件所捕获, 进入 <code>Provide additional details</code> 流程, 并进入开始子流程</p></blockquote></blockquote></blockquote><h4 id="流程定义-1"><a href="#流程定义-1" class="headerlink" title="流程定义"></a>流程定义</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">error</span> <span class="attr">id</span>=<span class="string">"notEnoughInfoError"</span> <span class="attr">errorCode</span>=<span class="string">"not_enough_info"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"reviewSaledLead"</span> <span class="attr">name</span>=<span class="string">"Review sales lead"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"theStart"</span> <span class="attr">activiti:initiator</span>=<span class="string">"initiator"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow1"</span> <span class="attr">sourceRef</span>=<span class="string">"theStart"</span> <span class="attr">targetRef</span>=<span class="string">"provideNewSalesLead"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"provideNewSalesLead"</span> <span class="attr">name</span>=<span class="string">"Provide new sales lead"</span> <span class="attr">activiti:assignee</span>=<span class="string">"$&#123;initiator&#125;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activiti:formProperty</span> <span class="attr">id</span>=<span class="string">"customerName"</span> <span class="attr">name</span>=<span class="string">"Customer name"</span> <span class="attr">type</span>=<span class="string">"string"</span> <span class="attr">required</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activiti:formProperty</span> <span class="attr">id</span>=<span class="string">"potentialProfit"</span> <span class="attr">name</span>=<span class="string">"Potential profit"</span> <span class="attr">type</span>=<span class="string">"long"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activiti:formProperty</span> <span class="attr">id</span>=<span class="string">"details"</span> <span class="attr">name</span>=<span class="string">"Details"</span> <span class="attr">type</span>=<span class="string">"string"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow2"</span> <span class="attr">sourceRef</span>=<span class="string">"provideNewSalesLead"</span> <span class="attr">targetRef</span>=<span class="string">"reviewSalesLeadSubProcess"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 子流程 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">subProcess</span> <span class="attr">id</span>=<span class="string">"reviewSalesLeadSubProcess"</span> <span class="attr">name</span>=<span class="string">"Review sales lead"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"subProcessStart"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow3"</span> <span class="attr">sourceRef</span>=<span class="string">"subProcessStart"</span> <span class="attr">targetRef</span>=<span class="string">"fork"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow4"</span> <span class="attr">sourceRef</span>=<span class="string">"fork"</span> <span class="attr">targetRef</span>=<span class="string">"reviewProfitability"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">parallelGateway</span> <span class="attr">id</span>=<span class="string">"fork"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow5"</span> <span class="attr">sourceRef</span>=<span class="string">"fork"</span> <span class="attr">targetRef</span>=<span class="string">"reviewCustomerRating"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"reviewCustomerRating"</span> <span class="attr">name</span>=<span class="string">"Review customer rating"</span> <span class="attr">activiti:candidateGroups</span>=<span class="string">"accountancy"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow6"</span> <span class="attr">sourceRef</span>=<span class="string">"reviewCustomerRating"</span> <span class="attr">targetRef</span>=<span class="string">"subProcessEnd1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"subProcessEnd1"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"reviewProfitability"</span> <span class="attr">name</span>=<span class="string">"Review profitability"</span> <span class="attr">activiti:candidateGroups</span>=<span class="string">"management"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">documentation</span>&gt;</span></span><br><span class="line">                $&#123;initiator&#125; has published a new sales lead: $&#123;customerName&#125;. Details: $&#123;details&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">activiti:formProperty</span> <span class="attr">id</span>=<span class="string">"notEnoughInformation"</span> <span class="attr">name</span>=<span class="string">"Do you believe this customer is profitable?"</span> <span class="attr">type</span>=<span class="string">"enum"</span> <span class="attr">required</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">activiti:value</span> <span class="attr">id</span>=<span class="string">"false"</span> <span class="attr">name</span>=<span class="string">"Yes"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">activiti:value</span> <span class="attr">id</span>=<span class="string">"true"</span> <span class="attr">name</span>=<span class="string">"No (= request more info)"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">activiti:formProperty</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow7"</span> <span class="attr">sourceRef</span>=<span class="string">"reviewProfitability"</span> <span class="attr">targetRef</span>=<span class="string">"enoughInformationCheck"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusiveGateway</span> <span class="attr">id</span>=<span class="string">"enoughInformationCheck"</span> <span class="attr">name</span>=<span class="string">"Enough information?"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow8"</span> <span class="attr">sourceRef</span>=<span class="string">"enoughInformationCheck"</span> <span class="attr">targetRef</span>=<span class="string">"notEnoughInformationEnd"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">conditionExpression</span>&gt;</span>$&#123;notEnoughInformation == 'true'&#125;<span class="tag">&lt;/<span class="name">conditionExpression</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow9"</span> <span class="attr">sourceRef</span>=<span class="string">"enoughInformationCheck"</span> <span class="attr">targetRef</span>=<span class="string">"subProcessEnd2"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">conditionExpression</span>&gt;</span>$&#123;notEnoughInformation == 'false'&#125;<span class="tag">&lt;/<span class="name">conditionExpression</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"subProcessEnd2"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"notEnoughInformationEnd"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">errorEventDefinition</span> <span class="attr">errorRef</span>=<span class="string">"notEnoughInfoError"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">subProcess</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow10"</span> <span class="attr">sourceRef</span>=<span class="string">"reviewSalesLeadSubProcess"</span> <span class="attr">targetRef</span>=<span class="string">"storeLeadInCrmSystem"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">boundaryEvent</span> <span class="attr">attachedToRef</span>=<span class="string">"reviewSalesLeadSubProcess"</span> <span class="attr">cancelActivity</span>=<span class="string">"true"</span> <span class="attr">id</span>=<span class="string">"catchNotEnoughInformationError"</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">errorEventDefinition</span> <span class="attr">errorRef</span>=<span class="string">"notEnoughInfoError"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">boundaryEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow11"</span> <span class="attr">sourceRef</span>=<span class="string">"catchNotEnoughInformationError"</span> <span class="attr">targetRef</span>=<span class="string">"provideAdditionalDetails"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"provideAdditionalDetails"</span> <span class="attr">name</span>=<span class="string">"Provide additional details"</span> <span class="attr">activiti:assignee</span>=<span class="string">"$&#123;initiator&#125;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>Provide additional details for $&#123;customerName&#125;.<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activiti:formProperty</span> <span class="attr">id</span>=<span class="string">"details"</span> <span class="attr">name</span>=<span class="string">"Additional details"</span> <span class="attr">type</span>=<span class="string">"string"</span> <span class="attr">required</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow12"</span> <span class="attr">sourceRef</span>=<span class="string">"provideAdditionalDetails"</span> <span class="attr">targetRef</span>=<span class="string">"reviewSalesLeadSubProcess"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">task</span> <span class="attr">id</span>=<span class="string">"storeLeadInCrmSystem"</span> <span class="attr">name</span>=<span class="string">"Store lead in CRM system"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow13"</span> <span class="attr">sourceRef</span>=<span class="string">"storeLeadInCrmSystem"</span> <span class="attr">targetRef</span>=<span class="string">"processEnd"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"processEnd"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="测试代码-1"><a href="#测试代码-1" class="headerlink" title="测试代码"></a>测试代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoundaryErrorEventTest</span> <span class="keyword">extends</span> <span class="title">PluggableActivitiTestCase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">public</span> ActivitiRule activitiRule = <span class="keyword">new</span> ActivitiRule();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setUp();</span><br><span class="line">        <span class="comment">// 设置当前用户</span></span><br><span class="line">        Authentication.setAuthenticatedUserId(<span class="string">"destiny"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Authentication.setAuthenticatedUserId(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">super</span>.tearDown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/reviewSalesLead.bpmn20.xml"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReviewSalesLeadProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; variables = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        variables.put(<span class="string">"details"</span>, <span class="string">"interesting"</span>);</span><br><span class="line">        variables.put(<span class="string">"customerName"</span>, <span class="string">"Camery"</span>);</span><br><span class="line"></span><br><span class="line">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"reviewSaledLead"</span>, variables);</span><br><span class="line">        log.info(<span class="string">"processInstance: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(processInstance, ToStringStyle.JSON_STYLE));</span><br><span class="line"></span><br><span class="line">        Task task = taskService.createTaskQuery()</span><br><span class="line">                .taskAssignee(<span class="string">"destiny"</span>)</span><br><span class="line">                .singleResult();</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"task: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(task, ToStringStyle.JSON_STYLE));</span><br><span class="line">        <span class="comment">// 使用断言确认</span></span><br><span class="line">        assertEquals(task.getName(), <span class="string">"Provide new sales lead"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提交节点</span></span><br><span class="line">        taskService.complete(task.getId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 进入并行网关, 会同时生成两个 task</span></span><br><span class="line">        Task ratingTask = taskService.createTaskQuery().taskCandidateGroup(<span class="string">"accountancy"</span>).singleResult();</span><br><span class="line">        log.info(<span class="string">"ratingTask: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(ratingTask, ToStringStyle.JSON_STYLE));</span><br><span class="line">        assertEquals(ratingTask.getName(), <span class="string">"Review customer rating"</span>);</span><br><span class="line"></span><br><span class="line">        Task profitabilityTask = taskService.createTaskQuery().taskCandidateGroup(<span class="string">"management"</span>).singleResult();</span><br><span class="line">        log.info(<span class="string">"profitabilityTask: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(profitabilityTask, ToStringStyle.JSON_STYLE));</span><br><span class="line">        assertEquals(profitabilityTask.getName(), <span class="string">"Review profitability"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Review profitability 提交后就会触发 errorEvent</span></span><br><span class="line">        variables = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        variables.put(<span class="string">"notEnoughInformation"</span>, <span class="keyword">true</span>);</span><br><span class="line">        taskService.complete(profitabilityTask.getId(), variables);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查找流程发起者 destiny 对应的 task</span></span><br><span class="line">        <span class="comment">// 此时 errorEvent 会被边界条件捕获, 流转到 Review profitability</span></span><br><span class="line">        Task provideDetailsTask = taskService.createTaskQuery().taskAssignee(<span class="string">"destiny"</span>).singleResult();</span><br><span class="line">        log.info(<span class="string">"provideDetailsTask: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(provideDetailsTask, ToStringStyle.JSON_STYLE));</span><br><span class="line">        assertEquals(provideDetailsTask.getName(), <span class="string">"Provide additional details"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 完成 Review profitability 节点后, 会重新进入子流程</span></span><br><span class="line">        taskService.complete(provideDetailsTask.getId());</span><br><span class="line">        List&lt;Task&gt; reviewTasks = taskService.createTaskQuery().orderByTaskName().asc().list();</span><br><span class="line">        <span class="keyword">for</span> (Task reviewTask : reviewTasks) &#123;</span><br><span class="line">            log.info(<span class="string">"reviewTask: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(reviewTask, ToStringStyle.JSON_STYLE));</span><br><span class="line">        &#125;</span><br><span class="line">        assertEquals(reviewTasks.get(<span class="number">0</span>).getName(), <span class="string">"Review customer rating"</span>);</span><br><span class="line">        assertEquals(reviewTasks.get(<span class="number">1</span>).getName(), <span class="string">"Review profitability"</span>);</span><br><span class="line"></span><br><span class="line">        taskService.complete(reviewTasks.get(<span class="number">0</span>).getId());</span><br><span class="line">        variables.put(<span class="string">"notEnoughInformation"</span>, <span class="keyword">false</span>);</span><br><span class="line">        taskService.complete(reviewTasks.get(<span class="number">1</span>).getId(), variables);</span><br><span class="line">        assertProcessEnded(processInstance.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="日志输出-1"><a href="#日志输出-1" class="headerlink" title="日志输出"></a>日志输出</h4><blockquote><p>分析日志可以看到, 没有错误所有的断言全部通过, 证明整个流程无误(日志量比较大, 为了能够清晰描述流程特地将日志格式调整)</p></blockquote><pre><code>03:53:20,823 [main] INFO  org.activiti.engine.ProcessEngines  - initialised process engine default03:53:23,006 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,008 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : theStart (StartEvent, parent id 5 (active)03:53:23,009 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,009 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : theStart (StartEvent, parent id 5 (active)03:53:23,010 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,010 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : theStart -&gt; provideNewSalesLead, parent id 5 (active)03:53:23,010 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,011 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : provideNewSalesLead (UserTask, parent id 5 (active)03:53:23,053 [main] INFO  org.activiti.engine.impl.test.AbstractTestCase  - processInstance: {&quot;currentFlowElement&quot;:null,&quot;currentActivitiListener&quot;:null,&quot;processInstance&quot;:&quot;ProcessInstance[5]&quot;,&quot;parent&quot;:null,&quot;executions&quot;:[Execution[ id &apos;10&apos; ] - activity &apos;provideNewSalesLead - parent &apos;5&apos;],&quot;superExecution&quot;:null,&quot;subProcessInstance&quot;:null,&quot;tenantId&quot;:&quot;&quot;,&quot;name&quot;:null,&quot;description&quot;:null,&quot;localizedName&quot;:null,&quot;localizedDescription&quot;:null,&quot;lockTime&quot;:null,&quot;isActive&quot;:true,&quot;isScope&quot;:true,&quot;isConcurrent&quot;:false,&quot;isEnded&quot;:false,&quot;isEventScope&quot;:false,&quot;isMultiInstanceRoot&quot;:false,&quot;isCountEnabled&quot;:false,&quot;eventName&quot;:null,&quot;eventSubscriptions&quot;:[],&quot;jobs&quot;:[],&quot;timerJobs&quot;:[],&quot;tasks&quot;:[],&quot;identityLinks&quot;:[IdentityLinkEntity[id=7, type=starter, userId=destiny, processInstanceId=5]],&quot;deleteReason&quot;:null,&quot;suspensionState&quot;:1,&quot;startUserId&quot;:&quot;destiny&quot;,&quot;startTime&quot;:&quot;Sat Dec 08 15:53:23 CST 2018&quot;,&quot;eventSubscriptionCount&quot;:0,&quot;taskCount&quot;:0,&quot;jobCount&quot;:0,&quot;timerJobCount&quot;:0,&quot;suspendedJobCount&quot;:0,&quot;deadLetterJobCount&quot;:0,&quot;variableCount&quot;:0,&quot;identityLinkCount&quot;:0,&quot;processDefinitionId&quot;:&quot;reviewSaledLead:1:4&quot;,&quot;processDefinitionKey&quot;:&quot;reviewSaledLead&quot;,&quot;processDefinitionName&quot;:&quot;Review sales lead&quot;,&quot;processDefinitionVersion&quot;:1,&quot;deploymentId&quot;:null,&quot;activityId&quot;:null,&quot;activityName&quot;:null,&quot;processInstanceId&quot;:&quot;5&quot;,&quot;businessKey&quot;:null,&quot;parentId&quot;:null,&quot;superExecutionId&quot;:null,&quot;rootProcessInstanceId&quot;:&quot;5&quot;,&quot;rootProcessInstance&quot;:null,&quot;forcedUpdate&quot;:false,&quot;queryVariables&quot;:null,&quot;isDeleted&quot;:false,&quot;variableInstances&quot;:{details=VariableInstanceEntity[id=8, name=details, type=string, textValue=interesting], customerName=VariableInstanceEntity[id=9, name=customerName, type=string, textValue=Camery], initiator=VariableInstanceEntity[id=6, name=initiator, type=string, textValue=destiny]},&quot;usedVariablesCache&quot;:{},&quot;transientVariabes&quot;:null,&quot;cachedElContext&quot;:null,&quot;id&quot;:&quot;5&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:true,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}03:53:23,075 [main] INFO  org.activiti.engine.impl.test.AbstractTestCase  - task: {&quot;owner&quot;:null,&quot;assigneeUpdatedCount&quot;:1,&quot;originalAssignee&quot;:null,&quot;assignee&quot;:&quot;destiny&quot;,&quot;delegationState&quot;:null,&quot;parentTaskId&quot;:null,&quot;name&quot;:&quot;Provide new sales lead&quot;,&quot;localizedName&quot;:null,&quot;description&quot;:null,&quot;localizedDescription&quot;:null,&quot;priority&quot;:50,&quot;createTime&quot;:&quot;Sat Dec 08 15:53:23 CST 2018&quot;,&quot;dueDate&quot;:null,&quot;suspensionState&quot;:1,&quot;category&quot;:null,&quot;isIdentityLinksInitialized&quot;:false,&quot;taskIdentityLinkEntities&quot;:[],&quot;executionId&quot;:&quot;10&quot;,&quot;execution&quot;:null,&quot;processInstanceId&quot;:&quot;5&quot;,&quot;processInstance&quot;:null,&quot;processDefinitionId&quot;:&quot;reviewSaledLead:1:4&quot;,&quot;taskDefinitionKey&quot;:&quot;provideNewSalesLead&quot;,&quot;formKey&quot;:null,&quot;isDeleted&quot;:false,&quot;isCanceled&quot;:false,&quot;eventName&quot;:null,&quot;currentActivitiListener&quot;:null,&quot;tenantId&quot;:&quot;&quot;,&quot;queryVariables&quot;:null,&quot;forcedUpdate&quot;:false,&quot;claimTime&quot;:null,&quot;variableInstances&quot;:null,&quot;usedVariablesCache&quot;:{},&quot;transientVariabes&quot;:null,&quot;cachedElContext&quot;:null,&quot;id&quot;:&quot;13&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}03:53:23,081 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TriggerExecutionOperation :03:53:23,082 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : provideNewSalesLead (UserTask, parent id 5 (active)03:53:23,083 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,083 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : provideNewSalesLead (UserTask, parent id 5 (active)03:53:23,084 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,084 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : provideNewSalesLead -&gt; reviewSalesLeadSubProcess, parent id 5 (active)03:53:23,084 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,084 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active)03:53:23,086 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,087 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    └── 17 : subProcessStart (StartEvent, parent id 14 (active)03:53:23,087 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,087 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    └── 17 : subProcessStart (StartEvent, parent id 14 (active)03:53:23,087 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,088 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    └── 17 : subProcessStart -&gt; fork, parent id 14 (active)03:53:23,088 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,088 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    └── 17 : fork (ParallelGateway, parent id 14 (active)03:53:23,088 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,089 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    └── 17 : fork (ParallelGateway, parent id 14 (not active)03:53:23,089 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,089 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    ├── 17 : fork -&gt; reviewProfitability, parent id 14 (active)    └── 20 : fork -&gt; reviewCustomerRating, parent id 14 (active)03:53:23,089 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,090 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    ├── 17 : reviewProfitability (UserTask, parent id 14 (active)    └── 20 : fork -&gt; reviewCustomerRating, parent id 14 (active)03:53:23,090 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,090 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    ├── 17 : reviewProfitability (UserTask, parent id 14 (active)    └── 20 : reviewCustomerRating (UserTask, parent id 14 (active)03:53:23,092 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,092 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 10 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    ├── 17 : reviewProfitability (UserTask, parent id 14 (active)    └── 20 : reviewCustomerRating (UserTask, parent id 14 (active)03:53:23,114 [main] INFO  org.activiti.engine.impl.test.AbstractTestCase  - ratingTask: {&quot;owner&quot;:null,&quot;assigneeUpdatedCount&quot;:0,&quot;originalAssignee&quot;:null,&quot;assignee&quot;:null,&quot;delegationState&quot;:null,&quot;parentTaskId&quot;:null,&quot;name&quot;:&quot;Review customer rating&quot;,&quot;localizedName&quot;:null,&quot;description&quot;:null,&quot;localizedDescription&quot;:null,&quot;priority&quot;:50,&quot;createTime&quot;:&quot;Sat Dec 08 15:53:23 CST 2018&quot;,&quot;dueDate&quot;:null,&quot;suspensionState&quot;:1,&quot;category&quot;:null,&quot;isIdentityLinksInitialized&quot;:false,&quot;taskIdentityLinkEntities&quot;:[],&quot;executionId&quot;:&quot;20&quot;,&quot;execution&quot;:null,&quot;processInstanceId&quot;:&quot;5&quot;,&quot;processInstance&quot;:null,&quot;processDefinitionId&quot;:&quot;reviewSaledLead:1:4&quot;,&quot;taskDefinitionKey&quot;:&quot;reviewCustomerRating&quot;,&quot;formKey&quot;:null,&quot;isDeleted&quot;:false,&quot;isCanceled&quot;:false,&quot;eventName&quot;:null,&quot;currentActivitiListener&quot;:null,&quot;tenantId&quot;:&quot;&quot;,&quot;queryVariables&quot;:null,&quot;forcedUpdate&quot;:false,&quot;claimTime&quot;:null,&quot;variableInstances&quot;:null,&quot;usedVariablesCache&quot;:{},&quot;transientVariabes&quot;:null,&quot;cachedElContext&quot;:null,&quot;id&quot;:&quot;25&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}03:53:23,116 [main] INFO  org.activiti.engine.impl.test.AbstractTestCase  - profitabilityTask: {&quot;owner&quot;:null,&quot;assigneeUpdatedCount&quot;:0,&quot;originalAssignee&quot;:null,&quot;assignee&quot;:null,&quot;delegationState&quot;:null,&quot;parentTaskId&quot;:null,&quot;name&quot;:&quot;Review profitability&quot;,&quot;localizedName&quot;:null,&quot;description&quot;:&quot;destiny has published a new sales lead: Camery. Details: interesting&quot;,&quot;localizedDescription&quot;:null,&quot;priority&quot;:50,&quot;createTime&quot;:&quot;Sat Dec 08 15:53:23 CST 2018&quot;,&quot;dueDate&quot;:null,&quot;suspensionState&quot;:1,&quot;category&quot;:null,&quot;isIdentityLinksInitialized&quot;:false,&quot;taskIdentityLinkEntities&quot;:[],&quot;executionId&quot;:&quot;17&quot;,&quot;execution&quot;:null,&quot;processInstanceId&quot;:&quot;5&quot;,&quot;processInstance&quot;:null,&quot;processDefinitionId&quot;:&quot;reviewSaledLead:1:4&quot;,&quot;taskDefinitionKey&quot;:&quot;reviewProfitability&quot;,&quot;formKey&quot;:null,&quot;isDeleted&quot;:false,&quot;isCanceled&quot;:false,&quot;eventName&quot;:null,&quot;currentActivitiListener&quot;:null,&quot;tenantId&quot;:&quot;&quot;,&quot;queryVariables&quot;:null,&quot;forcedUpdate&quot;:false,&quot;claimTime&quot;:null,&quot;variableInstances&quot;:null,&quot;usedVariablesCache&quot;:{},&quot;transientVariabes&quot;:null,&quot;cachedElContext&quot;:null,&quot;id&quot;:&quot;22&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}03:53:23,122 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TriggerExecutionOperation :03:53:23,125 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    ├── 17 : reviewProfitability (UserTask, parent id 14 (active)    └── 20 : reviewCustomerRating (UserTask, parent id 14 (active)03:53:23,126 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,126 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    ├── 17 : reviewProfitability (UserTask, parent id 14 (active)    └── 20 : reviewCustomerRating (UserTask, parent id 14 (active)03:53:23,126 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,127 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    ├── 17 : reviewProfitability -&gt; enoughInformationCheck, parent id 14 (active)    └── 20 : reviewCustomerRating (UserTask, parent id 14 (active)03:53:23,127 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,127 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    ├── 17 : enoughInformationCheck (ExclusiveGateway, parent id 14 (active)    └── 20 : reviewCustomerRating (UserTask, parent id 14 (active)03:53:23,131 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,131 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    ├── 17 : enoughInformationCheck -&gt; notEnoughInformationEnd, parent id 14 (active)    └── 20 : reviewCustomerRating (UserTask, parent id 14 (active)03:53:23,132 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,132 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    ├── 17 : enoughInformationCheck -&gt; notEnoughInformationEnd, parent id 14 (active)    └── 20 : reviewCustomerRating (UserTask, parent id 14 (active)03:53:23,132 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,132 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    ├── 17 : notEnoughInformationEnd (EndEvent, parent id 14 (active)    └── 20 : reviewCustomerRating (UserTask, parent id 14 (active)03:53:23,133 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TriggerExecutionOperation :03:53:23,134 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 14 (active)    ├── 17 : notEnoughInformationEnd (EndEvent, parent id 14 (active)    └── 20 : reviewCustomerRating (UserTask, parent id 14 (active)03:53:23,139 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,139 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (scope) (ended)    ├── 17 : notEnoughInformationEnd (EndEvent, parent id 14 (not active) (ended)    └── 20 : reviewCustomerRating (UserTask, parent id 14 (not active) (ended)└── 16 : catchNotEnoughInformationError (BoundaryEvent, parent id 5 (active)03:53:23,139 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,139 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (scope) (ended)    ├── 17 : notEnoughInformationEnd (EndEvent, parent id 14 (not active) (ended)    └── 20 : reviewCustomerRating (UserTask, parent id 14 (not active) (ended)└── 16 : catchNotEnoughInformationError -&gt; provideAdditionalDetails, parent id 5 (active)03:53:23,139 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,140 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 14 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (scope) (ended)    ├── 17 : notEnoughInformationEnd (EndEvent, parent id 14 (not active) (ended)    └── 20 : reviewCustomerRating (UserTask, parent id 14 (not active) (ended)└── 16 : provideAdditionalDetails (UserTask, parent id 5 (active)03:53:23,150 [main] INFO  org.activiti.engine.impl.test.AbstractTestCase  - provideDetailsTask: {&quot;owner&quot;:null,&quot;assigneeUpdatedCount&quot;:1,&quot;originalAssignee&quot;:null,&quot;assignee&quot;:&quot;destiny&quot;,&quot;delegationState&quot;:null,&quot;parentTaskId&quot;:null,&quot;name&quot;:&quot;Provide additional details&quot;,&quot;localizedName&quot;:null,&quot;description&quot;:&quot;Provide additional details for Camery.&quot;,&quot;localizedDescription&quot;:null,&quot;priority&quot;:50,&quot;createTime&quot;:&quot;Sat Dec 08 15:53:23 CST 2018&quot;,&quot;dueDate&quot;:null,&quot;suspensionState&quot;:1,&quot;category&quot;:null,&quot;isIdentityLinksInitialized&quot;:false,&quot;taskIdentityLinkEntities&quot;:[],&quot;executionId&quot;:&quot;16&quot;,&quot;execution&quot;:null,&quot;processInstanceId&quot;:&quot;5&quot;,&quot;processInstance&quot;:null,&quot;processDefinitionId&quot;:&quot;reviewSaledLead:1:4&quot;,&quot;taskDefinitionKey&quot;:&quot;provideAdditionalDetails&quot;,&quot;formKey&quot;:null,&quot;isDeleted&quot;:false,&quot;isCanceled&quot;:false,&quot;eventName&quot;:null,&quot;currentActivitiListener&quot;:null,&quot;tenantId&quot;:&quot;&quot;,&quot;queryVariables&quot;:null,&quot;forcedUpdate&quot;:false,&quot;claimTime&quot;:null,&quot;variableInstances&quot;:null,&quot;usedVariablesCache&quot;:{},&quot;transientVariabes&quot;:null,&quot;cachedElContext&quot;:null,&quot;id&quot;:&quot;32&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}03:53:23,152 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TriggerExecutionOperation :03:53:23,153 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 16 : provideAdditionalDetails (UserTask, parent id 5 (active)03:53:23,154 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,154 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 16 : provideAdditionalDetails (UserTask, parent id 5 (active)03:53:23,155 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,155 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 16 : provideAdditionalDetails -&gt; reviewSalesLeadSubProcess, parent id 5 (active)03:53:23,155 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,155 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 16 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active)03:53:23,156 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,157 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 16 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : subProcessStart (StartEvent, parent id 33 (active)03:53:23,157 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,157 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 16 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : subProcessStart (StartEvent, parent id 33 (active)03:53:23,157 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,158 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 16 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : subProcessStart -&gt; fork, parent id 33 (active)03:53:23,158 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,158 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 16 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : fork (ParallelGateway, parent id 33 (active)03:53:23,159 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,159 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 16 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : fork (ParallelGateway, parent id 33 (not active)03:53:23,159 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,159 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 16 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    ├── 36 : fork -&gt; reviewProfitability, parent id 33 (active)    └── 39 : fork -&gt; reviewCustomerRating, parent id 33 (active)03:53:23,159 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,159 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 16 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    ├── 36 : reviewProfitability (UserTask, parent id 33 (active)    └── 39 : fork -&gt; reviewCustomerRating, parent id 33 (active)03:53:23,159 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,160 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 16 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    ├── 36 : reviewProfitability (UserTask, parent id 33 (active)    └── 39 : reviewCustomerRating (UserTask, parent id 33 (active)03:53:23,161 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,162 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 16 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (ended)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    ├── 36 : reviewProfitability (UserTask, parent id 33 (active)    └── 39 : reviewCustomerRating (UserTask, parent id 33 (active)03:53:23,180 [main] INFO  org.activiti.engine.impl.test.AbstractTestCase  - reviewTask: {&quot;owner&quot;:null,&quot;assigneeUpdatedCount&quot;:0,&quot;originalAssignee&quot;:null,&quot;assignee&quot;:null,&quot;delegationState&quot;:null,&quot;parentTaskId&quot;:null,&quot;name&quot;:&quot;Review customer rating&quot;,&quot;localizedName&quot;:null,&quot;description&quot;:null,&quot;localizedDescription&quot;:null,&quot;priority&quot;:50,&quot;createTime&quot;:&quot;Sat Dec 08 15:53:23 CST 2018&quot;,&quot;dueDate&quot;:null,&quot;suspensionState&quot;:1,&quot;category&quot;:null,&quot;isIdentityLinksInitialized&quot;:false,&quot;taskIdentityLinkEntities&quot;:[],&quot;executionId&quot;:&quot;39&quot;,&quot;execution&quot;:null,&quot;processInstanceId&quot;:&quot;5&quot;,&quot;processInstance&quot;:null,&quot;processDefinitionId&quot;:&quot;reviewSaledLead:1:4&quot;,&quot;taskDefinitionKey&quot;:&quot;reviewCustomerRating&quot;,&quot;formKey&quot;:null,&quot;isDeleted&quot;:false,&quot;isCanceled&quot;:false,&quot;eventName&quot;:null,&quot;currentActivitiListener&quot;:null,&quot;tenantId&quot;:&quot;&quot;,&quot;queryVariables&quot;:null,&quot;forcedUpdate&quot;:false,&quot;claimTime&quot;:null,&quot;variableInstances&quot;:null,&quot;usedVariablesCache&quot;:{},&quot;transientVariabes&quot;:null,&quot;cachedElContext&quot;:null,&quot;id&quot;:&quot;44&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}03:53:23,180 [main] INFO  org.activiti.engine.impl.test.AbstractTestCase  - reviewTask: {&quot;owner&quot;:null,&quot;assigneeUpdatedCount&quot;:0,&quot;originalAssignee&quot;:null,&quot;assignee&quot;:null,&quot;delegationState&quot;:null,&quot;parentTaskId&quot;:null,&quot;name&quot;:&quot;Review profitability&quot;,&quot;localizedName&quot;:null,&quot;description&quot;:&quot;destiny has published a new sales lead: Camery. Details: interesting&quot;,&quot;localizedDescription&quot;:null,&quot;priority&quot;:50,&quot;createTime&quot;:&quot;Sat Dec 08 15:53:23 CST 2018&quot;,&quot;dueDate&quot;:null,&quot;suspensionState&quot;:1,&quot;category&quot;:null,&quot;isIdentityLinksInitialized&quot;:false,&quot;taskIdentityLinkEntities&quot;:[],&quot;executionId&quot;:&quot;36&quot;,&quot;execution&quot;:null,&quot;processInstanceId&quot;:&quot;5&quot;,&quot;processInstance&quot;:null,&quot;processDefinitionId&quot;:&quot;reviewSaledLead:1:4&quot;,&quot;taskDefinitionKey&quot;:&quot;reviewProfitability&quot;,&quot;formKey&quot;:null,&quot;isDeleted&quot;:false,&quot;isCanceled&quot;:false,&quot;eventName&quot;:null,&quot;currentActivitiListener&quot;:null,&quot;tenantId&quot;:&quot;&quot;,&quot;queryVariables&quot;:null,&quot;forcedUpdate&quot;:false,&quot;claimTime&quot;:null,&quot;variableInstances&quot;:null,&quot;usedVariablesCache&quot;:{},&quot;transientVariabes&quot;:null,&quot;cachedElContext&quot;:null,&quot;id&quot;:&quot;41&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}03:53:23,183 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TriggerExecutionOperation :03:53:23,190 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 39 : reviewCustomerRating (UserTask, parent id 33 (active)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : reviewProfitability (UserTask, parent id 33 (active)03:53:23,190 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,190 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 39 : reviewCustomerRating (UserTask, parent id 33 (active)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : reviewProfitability (UserTask, parent id 33 (active)03:53:23,191 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,191 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 39 : reviewCustomerRating -&gt; subProcessEnd1, parent id 33 (active)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : reviewProfitability (UserTask, parent id 33 (active)03:53:23,191 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,191 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 39 : subProcessEnd1 (EndEvent, parent id 33 (active)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : reviewProfitability (UserTask, parent id 33 (active)03:53:23,191 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,192 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 39 : subProcessEnd1 (EndEvent, parent id 33 (active)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : reviewProfitability (UserTask, parent id 33 (active)03:53:23,192 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.EndExecutionOperation :03:53:23,193 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 39 : subProcessEnd1 (EndEvent, parent id 33 (active)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : reviewProfitability (UserTask, parent id 33 (active)03:53:23,203 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TriggerExecutionOperation :03:53:23,204 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : reviewProfitability (UserTask, parent id 33 (active)03:53:23,205 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,205 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : reviewProfitability (UserTask, parent id 33 (active)03:53:23,206 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,206 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : reviewProfitability -&gt; enoughInformationCheck, parent id 33 (active)03:53:23,206 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,206 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : enoughInformationCheck (ExclusiveGateway, parent id 33 (active)03:53:23,206 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,206 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : enoughInformationCheck -&gt; subProcessEnd2, parent id 33 (active)03:53:23,207 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,207 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : enoughInformationCheck -&gt; subProcessEnd2, parent id 33 (active)03:53:23,207 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,207 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : subProcessEnd2 (EndEvent, parent id 33 (active)03:53:23,207 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,207 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : subProcessEnd2 (EndEvent, parent id 33 (active)03:53:23,208 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.EndExecutionOperation :03:53:23,208 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active) (scope)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (active)    └── 36 : subProcessEnd2 (EndEvent, parent id 33 (active)03:53:23,211 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,211 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (scope) (ended)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (not active) (ended)    └── 36 : subProcessEnd2 (EndEvent, parent id 33 (not active) (ended)└── 49 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (active)03:53:23,211 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,211 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (scope) (ended)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (not active) (ended)    └── 36 : subProcessEnd2 (EndEvent, parent id 33 (not active) (ended)└── 49 : reviewSalesLeadSubProcess -&gt; storeLeadInCrmSystem, parent id 5 (active)03:53:23,211 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,212 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (scope) (ended)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (not active) (ended)    └── 36 : subProcessEnd2 (EndEvent, parent id 33 (not active) (ended)└── 49 : storeLeadInCrmSystem (ManualTask, parent id 5 (active)03:53:23,212 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,212 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (scope) (ended)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (not active) (ended)    └── 36 : subProcessEnd2 (EndEvent, parent id 33 (not active) (ended)└── 49 : storeLeadInCrmSystem (ManualTask, parent id 5 (active)03:53:23,212 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,212 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (scope) (ended)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (not active) (ended)    └── 36 : subProcessEnd2 (EndEvent, parent id 33 (not active) (ended)└── 49 : storeLeadInCrmSystem -&gt; processEnd, parent id 5 (active)03:53:23,212 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :03:53:23,212 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (scope) (ended)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (not active) (ended)    └── 36 : subProcessEnd2 (EndEvent, parent id 33 (not active) (ended)└── 49 : processEnd (EndEvent, parent id 5 (active)03:53:23,212 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :03:53:23,213 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (scope) (ended)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (not active) (ended)    └── 36 : subProcessEnd2 (EndEvent, parent id 33 (not active) (ended)└── 49 : processEnd (EndEvent, parent id 5 (active)03:53:23,213 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.EndExecutionOperation :03:53:23,213 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - 5 (process instance)└── 33 : reviewSalesLeadSubProcess (SubProcess, parent id 5 (not active) (scope) (ended)    ├── 35 : catchNotEnoughInformationError (BoundaryEvent, parent id 33 (not active) (ended)    └── 36 : subProcessEnd2 (EndEvent, parent id 33 (not active) (ended)└── 49 : processEnd (EndEvent, parent id 5 (active)03:53:23,281 [main] INFO  org.activiti.engine.impl.test.AbstractTestCase  - database was clean</code></pre><h3 id="1-1-3-信号事件"><a href="#1-1-3-信号事件" class="headerlink" title="1.1.3. 信号事件"></a>1.1.3. 信号事件</h3><h4 id="1-1-3-1-信号开始事件"><a href="#1-1-3-1-信号开始事件" class="headerlink" title="1.1.3.1. 信号开始事件"></a>1.1.3.1. 信号开始事件</h4><blockquote><p>信号开始事件的启动方式与普通开始事件启动方式很接近, 需要发出对应的信号去启动它</p></blockquote><p><img src="https://user-images.githubusercontent.com/17758731/49683712-2bea0c80-fb04-11e8-9a9d-f580144f604d.png" alt="image"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">signal</span> <span class="attr">id</span>=<span class="string">"theSignal"</span> <span class="attr">name</span>=<span class="string">"The signal"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"processWithSignalStart1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"theStart"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">signalEventDefinition</span> <span class="attr">id</span>=<span class="string">"theSignalEventDefinition"</span> <span class="attr">signalRef</span>=<span class="string">"theSignal"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="1-1-3-2-信号中间事件"><a href="#1-1-3-2-信号中间事件" class="headerlink" title="1.1.3.2 信号中间事件"></a>1.1.3.2 信号中间事件</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">signal</span> <span class="attr">id</span>=<span class="string">"alterSignal"</span> <span class="attr">name</span>=<span class="string">"alter"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"catchSignal"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 信号抛出事件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intermediateThrowEvent</span> <span class="attr">id</span>=<span class="string">"throwSignalEvent"</span> <span class="attr">name</span>=<span class="string">"Alter"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">signalEventDefinition</span> <span class="attr">signalRef</span>=<span class="string">"alterSignal"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intermediateThrowEvent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 信号捕获事件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intermediateCatchEvent</span> <span class="attr">id</span>=<span class="string">"throwSignalEvent"</span> <span class="attr">name</span>=<span class="string">"On Alter"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">signalEventDefinition</span> <span class="attr">signalRef</span>=<span class="string">"alterSignal"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intermediateCatchEvent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="1-1-4-消息事件"><a href="#1-1-4-消息事件" class="headerlink" title="1.1.4 消息事件"></a>1.1.4 消息事件</h3><blockquote><p>消息事件的定义和信号事件的定义非常相近</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">message</span> <span class="attr">id</span>=<span class="string">"newInvoice"</span> <span class="attr">name</span>=<span class="string">"newInvoiceMessage"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">message</span> <span class="attr">id</span>=<span class="string">"payment"</span> <span class="attr">name</span>=<span class="string">"paymentMessage"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"catchSignal"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"messageStart"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">messsageEventDefinition</span> <span class="attr">messageRef</span>=<span class="string">"newInvoice"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 信号捕获事件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intermediateCatchEvent</span> <span class="attr">id</span>=<span class="string">"paymentEvt"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">messageEventDefinition</span> <span class="attr">messageRef</span>=<span class="string">"payment"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intermediateCatchEvent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="3-顺序流和和网关"><a href="#3-顺序流和和网关" class="headerlink" title="3. 顺序流和和网关"></a>3. 顺序流和和网关</h1><p>顺序流的分类: </p><ul><li>顺序流</li><li>条件顺序流</li><li>默认顺序流</li></ul><h2 id="3-1-网关"><a href="#3-1-网关" class="headerlink" title="3.1. 网关"></a>3.1. 网关</h2><p>网关的分类:</p><ul><li>排他网关(Exclusive Gateway)</li><li>并行网关(Parallel Gateway)</li><li>包容网关(Inclusive Gateway), 类似排他网关和并行网关的组合体, 即支持多条路, 有支持表达式</li><li>事件网关(Event-based Gateway), 每个分支都有一个捕获事件等待被触发, 一个触发后, 其他都会失效</li></ul><h3 id="3-1-1-排他网关"><a href="#3-1-1-排他网关" class="headerlink" title="3.1.1. 排他网关"></a>3.1.1. 排他网关</h3><blockquote><p>分支判断<br>只能选一<br>支持默认</p></blockquote><p><img src="https://user-images.githubusercontent.com/17758731/49684049-f562c080-fb08-11e8-9c3f-ef357ceb32b7.png" alt="image"></p><h4 id="流程定义-2"><a href="#流程定义-2" class="headerlink" title="流程定义"></a>流程定义</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">exclusiveGateway</span> <span class="attr">id</span>=<span class="string">"exclusiveGateway1"</span> <span class="attr">name</span>=<span class="string">"Exclusive Gateway"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"userTask1"</span> <span class="attr">name</span>=<span class="string">"精英"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"userTask2"</span> <span class="attr">name</span>=<span class="string">"优秀"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"userTask3"</span> <span class="attr">name</span>=<span class="string">"普通"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow2"</span> <span class="attr">sourceRef</span>=<span class="string">"exclusiveGateway1"</span> <span class="attr">targetRef</span>=<span class="string">"userTask1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">conditionExpression</span> <span class="attr">xsi:type</span>=<span class="string">"tFormalExpression"</span>&gt;</span></span><br><span class="line">        &lt;![CDATA[score &gt;= 90]]&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">conditionExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow3"</span> <span class="attr">sourceRef</span>=<span class="string">"exclusiveGateway1"</span> <span class="attr">targetRef</span>=<span class="string">"userTask2"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">conditionExpression</span> <span class="attr">xsi:type</span>=<span class="string">"tFormalExpression"</span>&gt;</span></span><br><span class="line">        &lt;![CDATA[score &gt;= 75 &amp;&amp; score &lt; 90]]&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">conditionExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 默认数据流 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow4"</span> <span class="attr">sourceRef</span>=<span class="string">"exclusiveGateway1"</span> <span class="attr">targetRef</span>=<span class="string">"userTask1"</span>/&gt;</span></span><br></pre></td></tr></table></figure><h4 id="测试代码-2"><a href="#测试代码-2" class="headerlink" title="测试代码"></a>测试代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process-exclusive.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testExclusiveGateway</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; variables = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    variables.put(<span class="string">"key1"</span>, <span class="number">3</span>);</span><br><span class="line">    variables.put(<span class="string">"score"</span>, <span class="number">91</span>);</span><br><span class="line">    ProcessInstance processInstance = activitiRule.getRuntimeService().startProcessInstanceByKey(<span class="string">"my-process"</span>, variables);</span><br><span class="line">    Task task = activitiRule.getTaskService().createTaskQuery().singleResult();</span><br><span class="line">    <span class="comment">// org.destiny.activiti.bpmn20.GatewayTest  - task.name = 精英</span></span><br><span class="line">    log.info(<span class="string">"task.name = &#123;&#125;"</span>, task.getName());     </span><br><span class="line">    assertEquals(task.getName(), <span class="string">"精英"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-1-2-并行网关"><a href="#3-1-2-并行网关" class="headerlink" title="3.1.2. 并行网关"></a>3.1.2. 并行网关</h3><blockquote><p>让流程从单线程变为并发情况, 原有的一条流转数据变为两条, 可以同时进行确认支付和确认收货, 当这两个条件同时满足时, 继续进行后面的操作</p></blockquote><p><img src="https://user-images.githubusercontent.com/17758731/49684527-edf2e580-fb0f-11e8-9c43-d8e34140d663.png" alt="image"></p><ul><li>流程并发</li><li>分支</li><li>合并</li><li>忽略条件(即使填了条件也不会生效)</li><li>非对称(不要求所有的分支最终都合并在一起)</li></ul><h4 id="流程定义-3"><a href="#流程定义-3" class="headerlink" title="流程定义"></a>流程定义</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parallelGateway</span> <span class="attr">id</span>=<span class="string">"parallelGateway1"</span> <span class="attr">name</span>=<span class="string">"Parallel Gateway"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"userTask1"</span> <span class="attr">name</span>=<span class="string">"确认支付"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"userTask2"</span> <span class="attr">name</span>=<span class="string">"确认收货"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow3"</span> <span class="attr">sourceRef</span>=<span class="string">"parallelGateway1"</span> <span class="attr">targetRef</span>=<span class="string">"userTask1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow4"</span> <span class="attr">sourceRef</span>=<span class="string">"parallelGateway1"</span> <span class="attr">targetRef</span>=<span class="string">"userTask2"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parallelGateway</span> <span class="attr">id</span>=<span class="string">"parallelGateway2"</span> <span class="attr">name</span>=<span class="string">"parallelGateway"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow8"</span> <span class="attr">sourceRef</span>=<span class="string">"userTask1"</span> <span class="attr">targetRef</span>=<span class="string">"parallelGateway2"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow9"</span> <span class="attr">sourceRef</span>=<span class="string">"userTask2"</span> <span class="attr">targetRef</span>=<span class="string">"parallelGateway2"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"userTask3"</span> <span class="attr">name</span>=<span class="string">"订单完成"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow10"</span> <span class="attr">sourceRef</span>=<span class="string">"parallelGateway2"</span> <span class="attr">targetRef</span>=<span class="string">"userTask3"</span>/&gt;</span></span><br></pre></td></tr></table></figure><h4 id="测试代码-3"><a href="#测试代码-3" class="headerlink" title="测试代码"></a>测试代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process-parallel.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testParallelGateway</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    activitiRule.getRuntimeService().startProcessInstanceByKey(<span class="string">"my-process"</span>);</span><br><span class="line">    List&lt;Task&gt; taskList = activitiRule.getTaskService().createTaskQuery().list();</span><br><span class="line">    log.info(<span class="string">"过并行网关时的 task 数量: &#123;&#125;"</span>, taskList.size());</span><br><span class="line">    <span class="keyword">for</span> (Task task : taskList) &#123;</span><br><span class="line">        log.info(<span class="string">"task name: &#123;&#125;"</span>, task.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    assertEquals(<span class="number">2</span>, taskList.size());</span><br><span class="line">    activitiRule.getTaskService().complete(taskList.get(<span class="number">0</span>).getId());</span><br><span class="line">    List&lt;Task&gt; taskList1 = activitiRule.getTaskService().createTaskQuery().list();</span><br><span class="line">    log.info(<span class="string">"提交第 1 个任务时的 task 数量: [&#123;&#125;]"</span>, taskList1.size());</span><br><span class="line">    <span class="keyword">for</span> (Task task : taskList1) &#123;</span><br><span class="line">        log.info(<span class="string">"task name: &#123;&#125;"</span>, task.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    assertEquals(<span class="number">1</span>, taskList1.size());</span><br><span class="line">    activitiRule.getTaskService().complete(taskList.get(<span class="number">1</span>).getId());</span><br><span class="line">    List&lt;Task&gt; taskList2 = activitiRule.getTaskService().createTaskQuery().list();</span><br><span class="line">    log.info(<span class="string">"提交第 2 个任务时的 task 数量: [&#123;&#125;]"</span>, taskList2.size());</span><br><span class="line">    <span class="keyword">for</span> (Task task : taskList2) &#123;</span><br><span class="line">        log.info(<span class="string">"task name: &#123;&#125;"</span>, task.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    assertEquals(<span class="number">1</span>, taskList1.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="日志输出-2"><a href="#日志输出-2" class="headerlink" title="日志输出"></a>日志输出</h4><pre><code>06:17:51,705 [main] INFO  org.destiny.activiti.bpmn20.GatewayTest  - 过并行网关时的 task 数量: 206:17:51,705 [main] INFO  org.destiny.activiti.bpmn20.GatewayTest  - task name: 确认支付06:17:51,706 [main] INFO  org.destiny.activiti.bpmn20.GatewayTest  - task name: 确认收货06:17:51,710 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TriggerExecutionOperation :06:17:51,721 [main] INFO  org.destiny.activiti.bpmn20.GatewayTest  - 提交第 1 个任务时的 task 数量: [1]06:17:51,721 [main] INFO  org.destiny.activiti.bpmn20.GatewayTest  - task name: 确认收货06:17:51,724 [main] INFO  org.activiti.engine.impl.interceptor.DebugCommandInvoker  - Execution tree while executing operation class org.activiti.engine.impl.agenda.TriggerExecutionOperation :06:17:51,738 [main] INFO  org.destiny.activiti.bpmn20.GatewayTest  - 提交第 2 个任务时的 task 数量: [1]06:17:51,738 [main] INFO  org.destiny.activiti.bpmn20.GatewayTest  - task name: 订单完成</code></pre><h3 id="3-1-3-包容性网关"><a href="#3-1-3-包容性网关" class="headerlink" title="3.1.3. 包容性网关"></a>3.1.3. 包容性网关</h3><blockquote><p>可以理解为排他网关和并行网关的结合体</p></blockquote><ul><li>排他网关有条件, 只能选择一条路径</li><li>并行网关不带条件, 所有路径都会执行</li><li>包容性网关有条件, 且支持并行运行</li></ul><ol><li>并发</li><li>分支</li><li>合并</li><li>条件</li><li>非对称</li></ol><h4 id="事件网关"><a href="#事件网关" class="headerlink" title="事件网关"></a>事件网关</h4><blockquote><p>会根据连接的捕获时间决定流程的走向, 只能走一条线路</p></blockquote><ol><li>流程暂停</li><li>事件订阅</li><li>捕获事件</li><li>单一执行</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;BPMN2.0:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;是一套业务流程模型与符号建模标准&lt;/li&gt;
&lt;li&gt;精准的执行语义来描述元素的操作&lt;/li&gt;
&lt;li&gt;以 XML 为载体, 以符号可视化业务&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;BPMN2.0元素:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;流对象&lt;/l
      
    
    </summary>
    
      <category term="Activiti" scheme="https://destinywang.github.io/blog/categories/Activiti/"/>
    
      <category term="工作流" scheme="https://destinywang.github.io/blog/categories/Activiti/%E5%B7%A5%E4%BD%9C%E6%B5%81/"/>
    
      <category term="Java" scheme="https://destinywang.github.io/blog/categories/Activiti/%E5%B7%A5%E4%BD%9C%E6%B5%81/Java/"/>
    
    
      <category term="Activiti" scheme="https://destinywang.github.io/blog/tags/Activiti/"/>
    
  </entry>
  
  <entry>
    <title>Activiti6.0用户指引中文版</title>
    <link href="https://destinywang.github.io/blog/2018/12/05/Activiti6-0%E7%94%A8%E6%88%B7%E6%8C%87%E5%BC%95%E4%B8%AD%E6%96%87%E7%89%88/"/>
    <id>https://destinywang.github.io/blog/2018/12/05/Activiti6-0用户指引中文版/</id>
    <published>2018-12-05T14:20:30.000Z</published>
    <updated>2018-12-07T15:38:59.099Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-引导"><a href="#1-引导" class="headerlink" title="1. 引导"></a>1. 引导</h1><h2 id="1-1-License-许可"><a href="#1-1-License-许可" class="headerlink" title="1.1. License 许可"></a>1.1. License 许可</h2><p>Activiti 是在 <a href="http://www.apache.org/licenses/LICENSE-2.0.html" target="_blank" rel="noopener">Apache V2 license</a> 许可下发布的.</p><h2 id="1-2-下载"><a href="#1-2-下载" class="headerlink" title="1.2. 下载"></a>1.2. 下载</h2><p><a href="http://activiti.org/download.html" target="_blank" rel="noopener">http://activiti.org/download.html</a></p><h2 id="1-3-源代码"><a href="#1-3-源代码" class="headerlink" title="1.3. 源代码"></a>1.3. 源代码</h2><p>该发行版以 jar 文件的形式包含了大多数源代码, Activiti 的源代码可以在 <a href="https://github.com/Activiti/Activiti" target="_blank" rel="noopener">https://github.com/Activiti/Activiti</a> 找到.</p><h2 id="1-4-Required-software-必需的软件"><a href="#1-4-Required-software-必需的软件" class="headerlink" title="1.4. Required software 必需的软件"></a>1.4. Required software 必需的软件</h2><h3 id="1-4-1-JDK-7"><a href="#1-4-1-JDK-7" class="headerlink" title="1.4.1. JDK 7+"></a>1.4.1. JDK 7+</h3><p>Activiti 需要 JDK 版本高于或等于 7, 前往 <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="noopener">Oracle Java SE downloads</a> 进行下载. 在该页面上有相关的下载说明, 可以通过在命令行运行 <code>java -version</code> 命令来验证安装是否成功. 该命令会打印出安装的 JDK 版本.</p><h3 id="1-4-2-IDE"><a href="#1-4-2-IDE" class="headerlink" title="1.4.2. IDE"></a>1.4.2. IDE</h3><h1 id="2-Getting-Started-启动"><a href="#2-Getting-Started-启动" class="headerlink" title="2. Getting Started 启动"></a>2. Getting Started 启动</h1><h2 id="2-1-One-minute-version-一分钟版"><a href="#2-1-One-minute-version-一分钟版" class="headerlink" title="2.1. One minute version 一分钟版"></a>2.1. One minute version 一分钟版</h2><p>在从 <a href="http://www.activiti.org/" target="_blank" rel="noopener">Activiti website</a> 下载了 Activiti UI 的 WAR 包之后, 按照这些步骤去以默认配置运行样例. 你需要安装 <a href="http://java.sun.com/javase/downloads/index.jsp" target="_blank" rel="noopener">Java runtime</a> 和 <a href="http://tomcat.apache.org/download-80.cgi" target="_blank" rel="noopener">Apache Tomcat</a>(实际上, 任意一个 web 容器都可以正常运行, 因为我们只依赖与 Servlet 的能力, 但我们主要在 Tomcat 上进行测试)</p><ul><li>将下载的 activiti-app.war 文件复制到 Tomcat 的 webapps 路径下</li><li>通过 bin 路径下的 startup.sh 或 startop.bat 启动 Tomcat</li><li>当 Tomcat 启动后, 打开浏览器并前往 <a href="http://localhost:8080/activiti-app" target="_blank" rel="noopener">http://localhost:8080/activiti-app</a>, 使用账号 admin, 密码 test 登录</li></ul><p>这样就可以了, ActivitiUI 应用默认使用基于内存的 H2 数据库</p><h2 id="2-2-Activiti-setup-Activiti-的安装"><a href="#2-2-Activiti-setup-Activiti-的安装" class="headerlink" title="2.2 Activiti setup Activiti 的安装"></a>2.2 Activiti setup Activiti 的安装</h2><p>要安装 Activiti, 需要安装 <a href="http://java.sun.com/javase/downloads/index.jsp" target="_blank" rel="noopener">Java runtime</a> 和 <a href="http://tomcat.apache.org/download-70.cgi" target="_blank" rel="noopener">Apache Tomcat</a>, 并且确认系统变量 <code>JAVA_HOME</code> 已经正确的设置, 具体设置的方式取决于你的操作系统.</p><p>只需要将 war 文件从 Activiti 下载页面下载到 Tomcat 安装路径下的 <code>webapps</code> 路径就可以让 Activiti UI 和 REST 应用启动. 默认情况下 UI 应用使用内存数据库运行.</p><p>示例用户:</p><table><thead><tr><th>userId</th><th>Password</th><th>Security roles</th></tr></thead><tbody><tr><td>admin</td><td>test</td><td>admin</td></tr></tbody></table><p>现在可以访问的应用:</p><table><thead><tr><th>Webapp Name</th><th>URL</th><th>Description</th></tr></thead><tbody><tr><td>Activiti UI</td><td><a href="http://localhost:8080/activiti-app" target="_blank" rel="noopener">http://localhost:8080/activiti-app</a></td><td>流程引擎用户控制台, 通过该工具可以开启新的流程, 分配任务, 查看和认领任务等</td></tr></tbody></table><p>需要注意的是, Activiti UI 项目实例的启动只是一个简单快速演示功能的方式, 并不是说只能使用这种方式使用 Activiti. Activiti 只是一个 jar 文件, 可以嵌入到任何 Java 环境中, 比如 swing, Tomcat, JBoss, WebSphere 等. 或者也可以选择将Activiti作为一个典型的独立BPM服务器来运行, 只要能在 Java 中完成的, 就能使用 Activiti.</p><h2 id="2-3-Activiti-database-setup-数据库安装"><a href="#2-3-Activiti-database-setup-数据库安装" class="headerlink" title="2.3. Activiti database setup 数据库安装"></a>2.3. Activiti database setup 数据库安装</h2><p>如同在一分钟版示例说的, Activiti UI 应用默认使用内存数据库 H2. 要让 Activiti UI  应用使用独立的 H2 或者其他的数据库, 可以修改 <code>WEB-INF/classes/META-INF/activiti-app</code> 路径下的 <code>activiti-app.properties</code> 文件</p><h2 id="2-4-Include-the-Activiti-jar-and-its-denpendices-包含-jar-及其依赖"><a href="#2-4-Include-the-Activiti-jar-and-its-denpendices-包含-jar-及其依赖" class="headerlink" title="2.4 Include the Activiti jar and its denpendices 包含 jar 及其依赖"></a>2.4 Include the Activiti jar and its denpendices 包含 jar 及其依赖</h2><p>为了包含 Activiti jar 和它的依赖库, 我们决定使用 maven, 因为它简化了我们双方的依赖管理. 根据引导 <a href="http://www.activiti.org/community.html#maven.repository" target="_blank" rel="noopener">http://www.activiti.org/community.html#maven.repository</a> 来引入必要的依赖.</p><p>作为选择, 如果你不想使用 maven, 可以直接在项目中引入 jar 文件. Activiti 下载的压缩包包含一个文件夹 <code>libs</code>, 其中包含了所有 Activiti jar 文件(以及源代码 jar). 依赖不是通过这种方式提供的, Activiti 必须的依赖如下所示(使用 <code>mvn dependency:tree</code> 生成):</p><pre><code>org.activiti:activiti-engine:jar:6.x+- org.activiti:activiti-bpmn-converter:jar:6.x:compile|  \- org.activiti:activiti-bpmn-model:jar:6.x:compile|     +- com.fasterxml.jackson.core:jackson-core:jar:2.2.3:compile|     \- com.fasterxml.jackson.core:jackson-databind:jar:2.2.3:compile|        \- com.fasterxml.jackson.core:jackson-annotations:jar:2.2.3:compile+- org.activiti:activiti-process-validation:jar:6.x:compile+- org.activiti:activiti-image-generator:jar:6.x:compile+- org.apache.commons:commons-email:jar:1.2:compile|  +- javax.mail:mail:jar:1.4.1:compile|  \- javax.activation:activation:jar:1.1:compile+- org.apache.commons:commons-lang3:jar:3.3.2:compile+- org.mybatis:mybatis:jar:3.3.0:compile+- org.springframework:spring-beans:jar:4.1.6.RELEASE:compile|  \- org.springframework:spring-core:jar:4.1.6.RELEASE:compile+- joda-time:joda-time:jar:2.6:compile+- org.slf4j:slf4j-api:jar:1.7.6:compile+- org.slf4j:jcl-over-slf4j:jar:1.7.6:compile</code></pre><p>注意, 如果需要使用 <a href="https://www.activiti.org/userguide/#bpmnEmailTask" target="_blank" rel="noopener">mail service task</a> 才需要引入 mail 依赖 jar.</p><p>所有的依赖可以很轻松的通过使用 <code>mvn denpendency:cpoy-dependencies</code> 在 <a href="https://github.com/Activiti/Activiti" target="_blank" rel="noopener">activiti源代码</a> 上下载.</p><h2 id="2-5-Next-steps-下一步"><a href="#2-5-Next-steps-下一步" class="headerlink" title="2.5. Next steps 下一步"></a>2.5. Next steps 下一步</h2><h1 id="3-Configuration-配置"><a href="#3-Configuration-配置" class="headerlink" title="3. Configuration 配置"></a>3. Configuration 配置</h1><h2 id="3-1-Creating-a-ProcessEngine-创建一个流程引擎"><a href="#3-1-Creating-a-ProcessEngine-创建一个流程引擎" class="headerlink" title="3.1. Creating a ProcessEngine 创建一个流程引擎"></a>3.1. Creating a ProcessEngine 创建一个流程引擎</h2><p>Activiti 流程引擎通过 XML 文件 <code>activiti.cfg.xml</code> 配置, 需要注意的是不适用于 <a href="https://www.activiti.org/userguide/#springintegration" target="_blank" rel="noopener">Spring 风格下的流程引擎创建</a>.</p><p>获取 <code>流程引擎</code> 最简单的方式是使用 <code>org.activiti.engine.ProcessEngines</code> 类:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ProcessEngine processEngine = ProcessEngines.getDefauleProcesEngine();</span><br></pre></td></tr></table></figure><p>这样的方式会在 classpath 上寻找 <code>activiti.cfg.xml</code> 文件, 并且基于文件中的配置去构造引擎. 下面的片段展示了一个配置文件的样例, 后面的章节会给出配置参数的详细介绍.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"processEngineConfiguration"</span> <span class="attr">class</span>=<span class="string">"org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"jdbc:h2:mem:activiti;DB_CLOSE_DELAY=1000"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcDriver"</span> <span class="attr">value</span>=<span class="string">"org.h2.Driver"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUsername"</span> <span class="attr">value</span>=<span class="string">"sa"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcPassword"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"databaseSchemaUpdate"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"asyncExecutorActivate"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mailServerHost"</span> <span class="attr">value</span>=<span class="string">"mail.my-corp.com"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mailServerPort"</span> <span class="attr">value</span>=<span class="string">"5025"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>值得注意的是, 这个 XML 配置文件实际上是一个 Spring 配置文件. 这并不意味着 Activiti 只能运行在 Spring 环境中. 我们仅仅是在内部利用 Spring 解析和依赖注入的能力来构建引擎.</p><p><code>ProcessEngineConfiguration</code> 对象也可以被配置文件编程式的创建, 也可以用一个不同 bean id.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基于默认配置文件 activiti.cfg.xml</span></span><br><span class="line">ProcessEngineConfiguration.createProcessEngineConfigurationFromResourceDefault();</span><br><span class="line"><span class="comment">// 指定路径</span></span><br><span class="line">ProcessEngineConfiguration.createProcessEngineConfigurationFromResource(String resource);</span><br><span class="line"><span class="comment">// 指定路径和提取的 bean id</span></span><br><span class="line">ProcessEngineConfiguration.createProcessEngineConfigurationFromResource(String resource, String beanName);</span><br><span class="line"><span class="comment">// 指定输入流</span></span><br><span class="line">ProcessEngineConfiguration.createProcessEngineConfigurationFromInputStream(InputStream inputStream);</span><br><span class="line"><span class="comment">// 指定输入流和 bean id</span></span><br><span class="line">ProcessEngineConfiguration.createProcessEngineConfigurationFromInputStream(InputStream inputStream, String beanName);</span><br></pre></td></tr></table></figure><p>与此同时, 也可以不使用配置文件, 直接通过默认创建配置(参考<a href="https://www.activiti.org/userguide/#configurationClasses" target="_blank" rel="noopener">不同的支持类</a>)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ProcessEngineConfiguraion.createStandaloneProcessEngineConfiguration();</span><br><span class="line">ProcessEngineConfiguraion.createStandaloneInMemProcessEngineConfiguration();</span><br></pre></td></tr></table></figure><p>所有这些 <code>ProcessEngineConfiguraion.createXXX()</code> 方法返回一个后续可调整的 <code>ProcessEngineConfiguraion</code> 方便链式调用, 在调用 <code>buildProcessEngine()</code> 操作后, 就会创建一个 <code>ProcessEngine</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ProcessEngine processEngine = ProcessEngineConfiguraion.createStandaloneInMemProcessEngineConfiguration()</span><br><span class="line">    .setDatabaseSchemaUpdate(ProcessEngineConfiguration.DB_SCHEMA_UPDATE_FALSE)</span><br><span class="line">    .setJdbcUrl(<span class="string">"jdbc:h2:mem:my-own-db;DB_CLOSE_DELAY=1000"</span>)</span><br><span class="line">    .setAsyncExcutorActivate(<span class="keyword">false</span>)</span><br><span class="line">    .buildProcessEngine();</span><br></pre></td></tr></table></figure><h2 id="3-2-ProcessEngineConfiguration-bean"><a href="#3-2-ProcessEngineConfiguration-bean" class="headerlink" title="3.2. ProcessEngineConfiguration bean"></a>3.2. ProcessEngineConfiguration bean</h2><p><code>activiti.cfg.xml</code> 必须包含一个 id 为 <code>processEngineConfiguraion</code> 的 bean</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"processEngineConfiguration"</span> <span class="attr">class</span>=<span class="string">"org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这个 bean 会用来构建 <code>ProceeEngine</code>, 有多个类可以用来定义 <code>processEngineConfiguration</code>, 这些类代表了不同的环境, 并且设置了对应的默认值. 最佳的实践是选择与你当前环境最符合的类, 这样可以少配置几个引擎的参数, 下面是当前可用的类:</p><ul><li><strong>org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration</strong>: 这个 ProcessEngine 单独运行, Activiti 会自己处理事务, 默认情况下, 数据库只会在引擎启动的时候检查(并且如果没有 Activiti 的表或者表的版本不正确时会抛出异常);</li><li><strong>org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration</strong>: 这是一个方便的单元测试类, Activiti 会自己控制事务, 默认使用一个基于内存的 H2 数据库, 数据库分别会在启动和关闭的时候创建以及销毁, 当使用它的时候, 或许不需要额外的配置(除了使用 job 执行器或者邮件功能以外);</li><li><strong>org.activiti.spring.SpringProcessEngineConfiguration</strong>: 在 Spring 环境下使用流程引擎, 参考 <a href="">Spring 集成</a>;</li><li><strong>org.activiti.engine.impl.cfg.JtaProcessEngineConfiguration</strong>: 单独运行的流程引擎, 并使用 JTA 事务.</li></ul><h2 id="3-3-Database-Configuration-数据库配置"><a href="#3-3-Database-Configuration-数据库配置" class="headerlink" title="3.3. Database Configuration 数据库配置"></a>3.3. Database Configuration 数据库配置</h2><p>有两种方式配置数据库给 Activiti 引擎使用, 第一种方式是定义 JDBC 的数据库配置文件</p><ul><li>jdbcUrl: 数据库连接</li><li>jdbcDriver: 驱动类</li><li>jdbcUsername: 数据库用户名</li><li>jdbcPassword: 数据库用户密码</li></ul><p>基于 JDBC 配置文件构造出的数据源将默认使用 MyBatis 连接池, 下面的配置可以用来构造连接池:</p><ul><li>jdbcMaxActiveConnections: 任意时间数据库连接池中的最大连接数, 默认为 10;</li><li>jdbcMaxIdleConnections: 连接池中处于空闲状态的连接的最大值;</li><li>jdbcMaxCheckoutTime: 连接被取出使用的最长时间, 超过时间会被强制回收. 默认为20000(20 秒);</li><li>jdbcMaxWaitTime: 这是一个底层配置, 当获得的时间较长时, 给连接池一个打印日志并重新尝试获得连接的机会, 默认为20000(20 秒).</li></ul><p>数据库连接池默认配置:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"jdbc:h2:mem:activiti;DB_CLOSE_DELAY=1000"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcDriver"</span> <span class="attr">value</span>=<span class="string">"org.h2.Driver"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUsername"</span> <span class="attr">value</span>=<span class="string">"sa"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcPassword"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>我们的基准表明, MyBatis 连接池在大量并发请求下并不是最有效率的, 因此, 建议使用 <code>javax.sql.DataSource</code> 的实现 并且注入到 <code>ProcessEngine</code> 配置中(比如 DBCP, C3P0, Hikari, Tomcat Connection Pool等):</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/activiti"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"activiti"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"activiti"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultAutoCommit"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"processEngineConfiguration"</span> <span class="attr">class</span>=<span class="string">"org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>注意, Activiti 并没有包含这些数据源, 因此你必须确保这些类库在你的类路径下.</p><p>不管是采用 JDBC 还是 DataSource 的方式, 下面的配置可以被设置:</p><ul><li>databaseType: 通常是不需要去单独制定这项配置, 因为会被数据库连接的元数据自动分析出来, 只有当自动制定失败的时候才需要被设置. 可能的值有 {h2, mysql, oracle, postgres, mssql, db2}. 这项配置会决定哪些创建/删除脚本和查询语句会被使用. 参考 <a href="https://www.activiti.org/userguide/#supporteddatabases" target="_blank" rel="noopener">支持数据库章节</a> 了解支持哪些类型.</li><li>databaseSchemaUpdate: 允许设置的策略去决定数据库表在流程启动和结束的时候被如何处理:<ul><li>false(默认): 当 <code>ProcessEngine</code> 启动的时候, 检查数据库表的版本是否匹配依赖库的版本, 并在不匹配的时候抛出异常;</li><li>true: 在 <code>ProcessEngine</code> 构建时, 执行检查, 如果有需要就执行更新, 如果数据库表不存在, 就重新创建;</li><li>create-drop: 在 <code>ProcessEngine</code> 启动的时候创建数据库表, 并且在 <code>ProcessEngine</code> 关闭的时候删除数据库表.</li></ul></li></ul><h1 id="4-The-Activiti-API-Activiti-API"><a href="#4-The-Activiti-API-Activiti-API" class="headerlink" title="4. The Activiti API Activiti API"></a>4. The Activiti API Activiti API</h1><h2 id="4-1-The-Process-Engine-API-ans-Service-ProcessEngine-的-API-和服务"><a href="#4-1-The-Process-Engine-API-ans-Service-ProcessEngine-的-API-和服务" class="headerlink" title="4.1. The Process Engine API ans Service ProcessEngine 的 API 和服务"></a>4.1. The Process Engine API ans Service <code>ProcessEngine</code> 的 API 和服务</h2><p>引擎的相关 API 是与 Activiti 交互最多的方式, 最重要的开始点就是 <code>ProcessEngine</code>, 它可以被多种在 <a href="">配置部分</a> 描述的方式创建, 你可以获得多种包含 工作流/BPM 方法的服务. <code>ProcessEngine</code> 和服务对象都是线程安全的, 因此可以在整个应用中维护一个实例.</p><p><img src="https://www.activiti.org/userguide/images/api.services.png" alt=""></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();</span><br><span class="line"></span><br><span class="line">Engine.getRuntimeService();</span><br><span class="line">RepositoryService repositoryService = processEngine.getRepositoryService();</span><br><span class="line">TaskService taskService = processEngine.getTaskService();</span><br><span class="line">ManagementService managementService = processEngine.getManagementService();</span><br><span class="line">IdentityService identityService = processEngine.getIdentityService();</span><br><span class="line">HistoryService historyService = processEngine.getHistoryService();</span><br><span class="line">FormService formService = processEngine.getFormService();</span><br><span class="line">DynamicBpmnService dynamicBpmnService = processEngine.getDynamicBpmnService();</span><br></pre></td></tr></table></figure><ul><li><code>ProcessEngines.getDefaultProcessEngine()</code> 会在第一次调用时初始化并构建一个 <code>ProcessEngine</code>, 并且后面始终返回相同的实例. 对应的可以创建和关闭所有 <code>ProcessEngine</code>: <code>ProcessEngine.init()</code> 和 <code>ProcessEngine.destroy()</code></li><li><code>ProcessEngine</code> 类会扫描所有的 <code>activiti.cfg.xml</code> 和 <code>activiti-context.xml</code> 文件, 对于 <code>activtivi.cfg.xml</code> 文件, 流程引擎会使用专有的方式构建: <code>ProcessEngineConfiguration.createProcessEngineConfigurationFromInputStream(inputStream).buildProcessEngine()</code></li><li><code></code></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;1-引导&quot;&gt;&lt;a href=&quot;#1-引导&quot; class=&quot;headerlink&quot; title=&quot;1. 引导&quot;&gt;&lt;/a&gt;1. 引导&lt;/h1&gt;&lt;h2 id=&quot;1-1-License-许可&quot;&gt;&lt;a href=&quot;#1-1-License-许可&quot; class=&quot;header
      
    
    </summary>
    
      <category term="Activiti" scheme="https://destinywang.github.io/blog/categories/Activiti/"/>
    
      <category term="工作流" scheme="https://destinywang.github.io/blog/categories/Activiti/%E5%B7%A5%E4%BD%9C%E6%B5%81/"/>
    
      <category term="翻译" scheme="https://destinywang.github.io/blog/categories/Activiti/%E5%B7%A5%E4%BD%9C%E6%B5%81/%E7%BF%BB%E8%AF%91/"/>
    
    
      <category term="Activiti" scheme="https://destinywang.github.io/blog/tags/Activiti/"/>
    
  </entry>
  
  <entry>
    <title>Activiti工作流引擎</title>
    <link href="https://destinywang.github.io/blog/2018/11/26/Activiti%E5%B7%A5%E4%BD%9C%E6%B5%81%E5%BC%95%E6%93%8E/"/>
    <id>https://destinywang.github.io/blog/2018/11/26/Activiti工作流引擎/</id>
    <published>2018-11-26T14:25:27.000Z</published>
    <updated>2018-12-03T16:01:10.835Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>前段时间入职字节跳动, 目前负责 Lark 工作流审批功能的开发, 选用工作流引擎 <code>Activiti</code> 进行开发, 因此在此记录下对 <code>Activiti</code> 的学习过程.</p></blockquote><h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><blockquote><p>工作流引擎是用来驱动业务, 按照流程图次逐步流转的核心框架, 在复杂多变的场景下采用工作流引擎可以大大降低业务部署成本. 通过标准的业务流程模型作为业务与开发工作的桥梁, 有效减少业务团队与技术交流的障碍.</p></blockquote><p>工作流引擎最早用于企业 OA, CRM, 流程审批等系统的流程审批.<br>现在的工作流引擎已经大量运用到互联网电商, 金融出行, 中台支撑等.</p><p>工作流引擎在互联网公司快速盛行, 掌握工作流引擎技术可以提升技术架构和业务建模能力. </p><p>目录:</p><ul><li>工作流入门</li><li>Activiti 6.0 源码浅析</li><li>Activiti 6.0 引擎配置</li><li>Activiti 6.0 核心 API</li><li>数据设计与模型映射</li><li>BPMN 2.0 规范</li><li>集成 SpringBoot 2.0</li><li>搭建工作流平台</li></ul><h1 id="1-工作流入门"><a href="#1-工作流入门" class="headerlink" title="1. 工作流入门"></a>1. 工作流入门</h1><h2 id="1-1-工作流介绍"><a href="#1-1-工作流介绍" class="headerlink" title="1.1 工作流介绍"></a>1.1 工作流介绍</h2><h3 id="1-1-1-出差流程"><a href="#1-1-1-出差流程" class="headerlink" title="1.1.1 出差流程"></a>1.1.1 出差流程</h3><p>审批业务场景:</p><p><img src=".Activiti工作流引擎_images/08008382.png" alt=""> </p><p>审批流程模型化:</p><p><img src=".Activiti工作流引擎_images/835a7f82.png" alt=""></p><p>从一个开始节点, 经过多个任务节点和分支节点, 最终流向结束节点.</p><h3 id="1-1-2-电商购物流程"><a href="#1-1-2-电商购物流程" class="headerlink" title="1.1.2 电商购物流程"></a>1.1.2 电商购物流程</h3><p><img src=".Activiti工作流引擎_images/0b951608.png" alt=""></p><p>抽象成泳道图:</p><p><img src=".Activiti工作流引擎_images/3a10b0ab.png" alt=""></p><table><thead><tr><th style="text-align:center">节点</th><th style="text-align:center">抽象名称</th><th style="text-align:center">功能</th></tr></thead><tbody><tr><td style="text-align:center">电商购物流程</td><td style="text-align:center">泳池(Pool)</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">用户/电商平台/仓储物流</td><td style="text-align:center">泳道(Line)</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">校验库存</td><td style="text-align:center">服务任务(Service Task)</td><td style="text-align:center">不需要人工参与, 需要系统自动化完成的操作节点</td></tr></tbody></table><h3 id="1-1-3-工作流是什么"><a href="#1-1-3-工作流是什么" class="headerlink" title="1.1.3 工作流是什么"></a>1.1.3 工作流是什么</h3><blockquote><h4 id="工作流"><a href="#工作流" class="headerlink" title="工作流:"></a>工作流:</h4><p>是对工作流程以及各个步骤之间的业务规则的抽象, 概括描述.</p></blockquote><blockquote><h4 id="工作流建模"><a href="#工作流建模" class="headerlink" title="工作流建模:"></a>工作流建模:</h4><p>将工作流程中的工作如何前后组织在一起的逻辑和规则, 在计算机中以恰当的模型表达并对其实施计算.</p></blockquote><blockquote><h4 id="要解决的问题"><a href="#要解决的问题" class="headerlink" title="要解决的问题:"></a>要解决的问题:</h4><p>为实现某个业务目标, 利用计算机在多个参与者之间按某种预定规则自动传递文档, 信息或任务.</p></blockquote><table><thead><tr><th>关键词</th><th>概念</th></tr></thead><tbody><tr><td>工作流管理系统</td><td>处理工作流的电脑软件系统, 主要功能是通过计算机技术的支持去定义, 执行和管理工作流, 协调工作流执行过程中工作之间以及群体之间的信息交互</td></tr><tr><td>计算机支持的协同工作</td><td>研究一个群体如何在计算机的帮助下实现协同工作的, 工作流属于计算机支持的协同工作的一部分</td></tr><tr><td>工作流管理联盟</td><td>工作流技术标准化的工业组织, 发布了用于工作流管理系统之间互操作的工作流参考模型, 并相继制定了一些列工业标准</td></tr></tbody></table><h3 id="1-1-4-为什么需要工作流"><a href="#1-1-4-为什么需要工作流" class="headerlink" title="1.1.4 为什么需要工作流"></a>1.1.4 为什么需要工作流</h3><h4 id="日常开发中经常遇到的问题"><a href="#日常开发中经常遇到的问题" class="headerlink" title="日常开发中经常遇到的问题:"></a>日常开发中经常遇到的问题:</h4><ol><li>产品需求遗漏, 开发上线之后需求经常改;</li><li>业务代码复杂, 开发时间紧迫;</li><li>代码后期维护不足, 逐渐难以维护.</li></ol><h4 id="使用工作流能够带来的改变"><a href="#使用工作流能够带来的改变" class="headerlink" title="使用工作流能够带来的改变:"></a>使用工作流能够带来的改变:</h4><ol><li>可以快速响应, 灵活调整线上产品流程;</li><li>业务和开发基于流程模型沟通, 基于业务建模快速部署;</li><li>流程可视化, 方便查看流程的运行进展.</li></ol><h4 id="使用工作流对团队的作用"><a href="#使用工作流对团队的作用" class="headerlink" title="使用工作流对团队的作用:"></a>使用工作流对团队的作用:</h4><ol><li>提高效率, 减少等待;</li><li>规范行为, 落实制度;</li><li>协同内外, 快速响应;</li><li>监控全面, 提升执行.</li></ol><h2 id="1-2-工作流技术选型"><a href="#1-2-工作流技术选型" class="headerlink" title="1.2 工作流技术选型"></a>1.2 工作流技术选型</h2><blockquote><p>二者都是成熟的工作流框架</p></blockquote><table><thead><tr><th>jBPM</th><th>Activiti</th></tr></thead><tbody><tr><td>Hibernate</td><td>ByBatis</td></tr><tr><td>Drools Flow</td><td>JBPM4</td></tr><tr><td>JPA</td><td>Spring</td></tr><tr><td>Message</td><td>RESTful</td></tr></tbody></table><h2 id="1-3-Activiti6-0-快速体验"><a href="#1-3-Activiti6-0-快速体验" class="headerlink" title="1.3 Activiti6.0 快速体验"></a>1.3 Activiti6.0 快速体验</h2><h3 id="1-3-1-准备物料"><a href="#1-3-1-准备物料" class="headerlink" title="1.3.1 准备物料"></a>1.3.1 准备物料</h3><ul><li>Activiti 软件包: <code>activiti-6.0.0.zip</code></li><li>JDK</li><li>Servlet 容器 (如 Tomcat)</li></ul><h4 id="安装-sdkman"><a href="#安装-sdkman" class="headerlink" title="安装 sdkman"></a>安装 sdkman</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -s <span class="string">"https://get.sdkman.io"</span> | bash</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> <span class="string">"<span class="variable">$HOME</span>/.sdkman/bin/sdkman-init.sh"</span></span><br><span class="line"></span><br><span class="line">sdk version</span><br></pre></td></tr></table></figure><h4 id="安装-JDK"><a href="#安装-JDK" class="headerlink" title="安装 JDK"></a>安装 JDK</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sdk install java 8u161-oracle</span><br><span class="line"></span><br><span class="line">java -version</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$JAVA_HOME</span></span><br></pre></td></tr></table></figure><h4 id="安装-Tomcat"><a href="#安装-Tomcat" class="headerlink" title="安装 Tomcat"></a>安装 Tomcat</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget http://mirror.bit.edu.cn/apache/tomcat/tomcat/8/v8.0.50/bin/apache-tomcat-8.0.50.zip</span><br><span class="line"></span><br><span class="line">tar -zxvf apache-tomcat-8.0.50.zip</span><br><span class="line"></span><br><span class="line">./apache-tomcat-8.0.50/bin/startup.sh</span><br><span class="line"></span><br><span class="line">jdp-mlv</span><br></pre></td></tr></table></figure><h4 id="部署-Activiti"><a href="#部署-Activiti" class="headerlink" title="部署 Activiti"></a>部署 Activiti</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/Activiti/Activiti/releases/download/activiti-6.0.0/activiti-6.0.0.zip</span><br><span class="line"></span><br><span class="line">tar -zxvf activiti-6.0.0.zip</span><br><span class="line"></span><br><span class="line">cp activiti-6.0.0/wars/activiti-app.war apache-tomcat-8.0.50/webapps</span><br><span class="line">cp activiti-6.0.0/wars/activiti-admin.war apache-tomcat-8.0.50/webapps</span><br></pre></td></tr></table></figure><p>此时打开浏览器, 输入 <a href="http://localhost:8080/activiti-app" target="_blank" rel="noopener">http://localhost:8080/activiti-app</a> 即可进入流程引擎的登录界面</p><pre><code>账号: admin密码: test</code></pre><h3 id="1-3-2-设计一个审批流程"><a href="#1-3-2-设计一个审批流程" class="headerlink" title="1.3.2 设计一个审批流程"></a>1.3.2 设计一个审批流程</h3><p>设计如下流程:</p><p>开始 -&gt; TL 审批 -&gt; HR 审批 -&gt; 结束</p><h4 id="流程参与者"><a href="#流程参与者" class="headerlink" title="流程参与者"></a>流程参与者</h4><table><thead><tr><th>ID</th><th>Email</th><th>Name</th></tr></thead><tbody><tr><td>admin</td><td>admin</td><td>Administrator</td></tr><tr><td>userdev</td><td><a href="mailto:userdev@126.com" target="_blank" rel="noopener">userdev@126.com</a></td><td>userdevDEV</td></tr><tr><td>userhr</td><td><a href="mailto:userhr@126.com" target="_blank" rel="noopener">userhr@126.com</a></td><td>userhrHR</td></tr><tr><td>usertl</td><td><a href="mailto:usertl@126.com" target="_blank" rel="noopener">usertl@126.com</a></td><td>usertlTL</td></tr></tbody></table><h1 id="2-源码概述"><a href="#2-源码概述" class="headerlink" title="2. 源码概述"></a>2. 源码概述</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@github.com:DestinyWang/Activiti.git</span><br><span class="line"></span><br><span class="line">git checkout -b study6 activiti-6.0.0</span><br><span class="line"></span><br><span class="line">mvn clean <span class="built_in">test</span>-compile</span><br></pre></td></tr></table></figure><table><thead><tr><th>路径</th><th>功能</th></tr></thead><tbody><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/cfg</code></td><td>Activiti 的启动依赖 <code>activiti.cfg.xml</code>, 在该目录完成</td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/compatibility</code></td><td>Activiti 从 5 升级到 6 的时候有部分不兼容, 在该目录完成适配</td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/debug</code></td><td>调试相关目录</td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/delegate</code></td><td>需要制定的节点 Task 都需要实现 <code>JavaDelegate</code></td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/event</code></td><td>定义了事件和监听机制</td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/form</code></td><td>通用表单</td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/history</code></td><td>历史数据归档</td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/identity</code></td><td>身份认证相关操作</td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/impl</code></td><td>各个接口层的实现</td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/logging</code></td><td>LogMDC 将重要的变量(如流程 id 放在上下文, logback 可以打印出来)</td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/management</code></td><td>管理相关</td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/parse</code></td><td>流程文件是 xml, 需要解析和验证</td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/query</code></td><td>抽象了一些查询接口, 基于 mybatis</td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/repository</code></td><td>抽象流程部署到数据库的过程</td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/runtime</code></td><td>与 history 相对应, 是流程在流转过程中的数据</td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/task</code></td><td>每个流程在需要人工处理的时候都会对应一个 task</td></tr><tr><td><code>Activiti/activiti-engine/src/main/java/org/activiti/engine/test</code></td><td>支持集成测试的帮助类</td></tr></tbody></table><p>核心模块:</p><ul><li><code>module/activiti-engine</code>: 核心引擎</li><li><code>module/activiti-spring</code>: Spring 集成模块</li><li><code>module/activiti-spring-boot</code>: SpringBoot 集成模块</li><li><code>module/activiti-rest</code>: 对外提供 rest api 模块</li><li><code>module/activiti-form-engine</code>: 表单引擎模块</li><li><code>module/activiti-ldap</code>: 集成 ldap 用户模块</li></ul><p>Activiti-engine 依赖的模块:</p><ul><li>bpmn-converter: 模型转换</li><li>process-validation: 流程校验</li><li>image-generator: 流程图绘制(BPMN 转 PNG)</li><li>dmn-api: 决策标准</li><li>form-api/form-model: form 表单相关</li></ul><h2 id="2-1-基于源码运行-activiti-app"><a href="#2-1-基于源码运行-activiti-app" class="headerlink" title="2.1 基于源码运行 activiti-app"></a>2.1 基于源码运行 activiti-app</h2><h3 id="2-1-1-启动-activiti-app"><a href="#2-1-1-启动-activiti-app" class="headerlink" title="2.1.1 启动 activiti-app"></a>2.1.1 启动 activiti-app</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> modules/activiti-ui/activiti-app</span><br><span class="line"></span><br><span class="line">mvn clean tomcat7:run</span><br><span class="line"></span><br><span class="line">open http://localhost:9999/activi-app</span><br></pre></td></tr></table></figure><h2 id="2-2-剖析-activiti-app"><a href="#2-2-剖析-activiti-app" class="headerlink" title="2.2 剖析 activiti-app"></a>2.2 剖析 activiti-app</h2><p>activiti-ui 的组成:</p><ul><li>activiti-app: 集成发布的 war 工程</li><li>activiti-app-conf: UI 独立域业务外的配置</li><li>activiti-app-logic: UI 的业务逻辑</li><li>activiti-app-rest: 提供接口的 rest api</li></ul><h1 id="3-HelloWorld"><a href="#3-HelloWorld" class="headerlink" title="3. HelloWorld"></a>3. HelloWorld</h1><p><img src="https://user-images.githubusercontent.com/17758731/49322695-b05cee00-f54c-11e8-8aeb-8f47882a7de9.png" alt="image"></p><ul><li>填写审批信息: 姓名, 时间, 是否提交</li><li>主管审批: 审批结果, 备注</li><li>审批结果, 备注</li></ul><h2 id="3-1-在-IDEA-中完成流程图的设计并配置"><a href="#3-1-在-IDEA-中完成流程图的设计并配置" class="headerlink" title="3.1 在 IDEA 中完成流程图的设计并配置"></a>3.1 在 IDEA 中完成流程图的设计并配置</h2><p><img src="https://user-images.githubusercontent.com/17758731/49323198-d7b6b980-f552-11e8-960e-271783710299.png" alt="image"></p><p>配置点:</p><ol><li>节点 id, 名称;</li><li>对每个网关的分支做判断(基于填写信息);</li><li>Task 节点接收的表单信息.</li></ol><h3 id="3-1-2-Task-节点接收的表单信息"><a href="#3-1-2-Task-节点接收的表单信息" class="headerlink" title="3.1.2 Task 节点接收的表单信息"></a>3.1.2 Task 节点接收的表单信息</h3><h4 id="填写申请信息"><a href="#填写申请信息" class="headerlink" title="填写申请信息"></a>填写申请信息</h4><table><thead><tr><th>Id</th><th>Name</th><th>Type</th><th>Expression</th><th>Variable</th><th>Default</th><th>Date Pattern</th><th>Readable</th><th>Writable</th><th>Required</th><th>Values</th></tr></thead><tbody><tr><td>message</td><td>申请信息</td><td>string</td><td></td><td></td><td></td><td></td><td></td><td></td><td>True</td><td></td></tr><tr><td>name</td><td>申请人姓名</td><td>string</td><td></td><td></td><td></td><td></td><td></td><td></td><td>True</td><td></td></tr><tr><td>submitTime</td><td>提交时间</td><td>date</td><td></td><td></td><td></td><td>yyyy-MM-dd</td><td></td><td></td><td>True</td><td></td></tr><tr><td>submitType</td><td>确认申请</td><td>string</td><td></td><td></td><td></td><td></td><td></td><td></td><td>True</td></tr></tbody></table><h4 id="主管审批"><a href="#主管审批" class="headerlink" title="主管审批"></a>主管审批</h4><table><thead><tr><th>Id</th><th>Name</th><th>Type</th><th>Expression</th><th>Variable</th><th>Default</th><th>Date Pattern</th><th>Readable</th><th>Writable</th><th>Required</th><th>Values</th></tr></thead><tbody><tr><td>tlApprove</td><td>主管审批结果</td><td>string</td><td></td><td></td><td></td><td></td><td></td><td></td><td>false</td><td></td></tr><tr><td>tlMessage</td><td>主管审批备注</td><td>string</td><td></td><td></td><td></td><td></td><td></td><td></td><td>true</td></tr></tbody></table><h4 id="人事审批"><a href="#人事审批" class="headerlink" title="人事审批"></a>人事审批</h4><table><thead><tr><th>Id</th><th>Name</th><th>Type</th><th>Expression</th><th>Variable</th><th>Default</th><th>Date Pattern</th><th>Readable</th><th>Writable</th><th>Required</th><th>Values</th></tr></thead><tbody><tr><td>hrApprove</td><td>人事审批结果</td><td>string</td><td></td><td></td><td></td><td></td><td></td><td></td><td>true</td><td></td></tr><tr><td>hrMessage</td><td>人事审批备注</td><td>string</td><td></td><td></td><td></td><td></td><td></td><td></td><td>true</td></tr></tbody></table><h3 id="3-1-3-排他网关配置"><a href="#3-1-3-排他网关配置" class="headerlink" title="3.1.3 排他网关配置"></a>3.1.3 排他网关配置</h3><blockquote><p>排他网关需要对流入网关的某个值做判断, 从而决定流程后续的流向</p></blockquote><h4 id="flow3-配置"><a href="#flow3-配置" class="headerlink" title="flow3 配置"></a>flow3 配置</h4><pre><code>${submitType==&quot;Y&quot; || submitType==&quot;y&quot;}</code></pre><h4 id="flow4-配置"><a href="#flow4-配置" class="headerlink" title="flow4 配置"></a>flow4 配置</h4><pre><code>${submitType==&quot;N&quot; || submitType==&quot;n&quot;}</code></pre><h4 id="flow6-配置"><a href="#flow6-配置" class="headerlink" title="flow6 配置"></a>flow6 配置</h4><pre><code>${tlApprove == &quot;Y&quot; || tlApprove == &quot;y&quot;}</code></pre><h4 id="flow7-配置"><a href="#flow7-配置" class="headerlink" title="flow7 配置"></a>flow7 配置</h4><pre><code>${tlApprove == &quot;N&quot; || tlApprove == &quot;n&quot;}</code></pre><h4 id="flow9-配置"><a href="#flow9-配置" class="headerlink" title="flow9 配置"></a>flow9 配置</h4><pre><code>${hrApprove == &quot;Y&quot; || tlApprove == &quot;y&quot;}</code></pre><h4 id="flow10-配置"><a href="#flow10-配置" class="headerlink" title="flow10 配置"></a>flow10 配置</h4><pre><code>${hrApprove == &quot;N&quot; || tlApprove == &quot;n&quot;}</code></pre><p>配置后的流程图</p><p><img src="https://user-images.githubusercontent.com/17758731/49323670-e18feb00-f559-11e8-9967-a2bac264e9fe.png" alt="image"></p><h3 id="3-2-helloworld程序"><a href="#3-2-helloworld程序" class="headerlink" title="3.2 helloworld程序"></a>3.2 helloworld程序</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DemoMain.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"----- 启动我们的程序 -----"</span>);</span><br><span class="line">        <span class="comment">// 1. 创建流程引擎</span></span><br><span class="line">        ProcessEngine processEngine = getProcessEngine();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 部署流程定义文件</span></span><br><span class="line">        ProcessDefinition processDefinition = getProcessDefinition(processEngine);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 启动运行流程</span></span><br><span class="line">        ProcessInstance processInstance = getProcessInstance(processEngine, processDefinition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 处理流程任务</span></span><br><span class="line">        processTask(processEngine, processInstance);</span><br><span class="line">        logger.info(<span class="string">"----- 结束我们的程序 -----"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理流程任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> processEngine   流程引擎</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> processInstance 流程实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ParseException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">processTask</span><span class="params">(ProcessEngine processEngine, ProcessInstance processInstance)</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="keyword">while</span> (processInstance != <span class="keyword">null</span> &amp;&amp; !processInstance.isEnded()) &#123;</span><br><span class="line">            logger.info(<span class="string">"processInstanceId: [&#123;&#125;]"</span>, processInstance.getId());</span><br><span class="line">            logger.info(<span class="string">"processInstance.processInstanceId: [&#123;&#125;]"</span>, processInstance.getProcessInstanceId());</span><br><span class="line">            TaskService taskService = processEngine.getTaskService();</span><br><span class="line">            List&lt;Task&gt; list = taskService.createTaskQuery().list();</span><br><span class="line">            logger.info(<span class="string">"待处理任务数量: [&#123;&#125;]"</span>, list.size());</span><br><span class="line">            <span class="keyword">for</span> (Task task : list) &#123;</span><br><span class="line">                logger.info(<span class="string">"待处理任务: [&#123;&#125;]"</span>, task.getName());</span><br><span class="line">                Map&lt;String, Object&gt; variables = getVariables(processEngine, scanner, task);</span><br><span class="line">                taskService.complete(task.getId(), variables);</span><br><span class="line">                processInstance = processEngine.getRuntimeService()</span><br><span class="line">                        .createProcessInstanceQuery()</span><br><span class="line">                        .processInstanceId(processInstance.getId())</span><br><span class="line">                        .singleResult();</span><br><span class="line">                logger.info(<span class="string">"当前 ProcessInstance :&#123;&#125;"</span>, processInstance);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        scanner.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取变量</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> processEngine</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> scanner</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ParseException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title">getVariables</span><span class="params">(ProcessEngine processEngine, Scanner scanner, Task task)</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">        FormService formService = processEngine.getFormService();</span><br><span class="line">        TaskFormData taskFormData = formService.getTaskFormData(task.getId());</span><br><span class="line">        List&lt;FormProperty&gt; formProperties = taskFormData.getFormProperties();</span><br><span class="line">        Map&lt;String, Object&gt; variables = Maps.newHashMap();</span><br><span class="line">        <span class="keyword">for</span> (FormProperty property : formProperties) &#123;</span><br><span class="line">            String line = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (StringFormType.class.isInstance(property.getType())) &#123;</span><br><span class="line">                <span class="comment">// 如果是 String 类型, 不需要做任何格式化</span></span><br><span class="line">                logger.info(<span class="string">"请输入 [&#123;&#125;] ?"</span>, property.getName());</span><br><span class="line">                line = scanner.nextLine();</span><br><span class="line">                variables.put(property.getId(), line);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DateFormType.class.isInstance(property.getType())) &#123;</span><br><span class="line">                <span class="comment">// 如果是日期类型</span></span><br><span class="line">                logger.info(<span class="string">"请输入 [&#123;&#125;] ?, 格式 (yyyy-MM-dd)"</span>, property.getName());</span><br><span class="line">                line = scanner.nextLine();</span><br><span class="line">                SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line">                Date date = simpleDateFormat.parse(line);</span><br><span class="line">                variables.put(property.getId(), date);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.info(<span class="string">"类型不支持: &#123;&#125;"</span>, property.getType());</span><br><span class="line">            &#125;</span><br><span class="line">            logger.info(<span class="string">"您输入的内容是 [&#123;&#125;]"</span>, line);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> variables;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ProcessInstance <span class="title">getProcessInstance</span><span class="params">(ProcessEngine processEngine, ProcessDefinition processDefinition)</span> </span>&#123;</span><br><span class="line">        RuntimeService runtimeService = processEngine.getRuntimeService();</span><br><span class="line">        ProcessInstance processInstance = runtimeService.startProcessInstanceById(processDefinition.getId());</span><br><span class="line">        logger.info(<span class="string">"启动流程: [&#123;&#125;]"</span>, processInstance.getProcessDefinitionKey());</span><br><span class="line">        <span class="keyword">return</span> processInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ProcessDefinition <span class="title">getProcessDefinition</span><span class="params">(ProcessEngine processEngine)</span> </span>&#123;</span><br><span class="line">        RepositoryService repositoryService = processEngine.getRepositoryService();</span><br><span class="line">        DeploymentBuilder deploymentBuilder = repositoryService.createDeployment();</span><br><span class="line">        deploymentBuilder.addClasspathResource(<span class="string">"SecondApprove.bpmn20.xml"</span>);</span><br><span class="line">        Deployment deployment = deploymentBuilder.deploy();</span><br><span class="line"></span><br><span class="line">        String deploymentId = deployment.getId();</span><br><span class="line">        <span class="comment">// deploymentId: 1</span></span><br><span class="line">        logger.info(<span class="string">"deploymentId: [&#123;&#125;]"</span>, deploymentId);</span><br><span class="line">        ProcessDefinition processDefinition = repositoryService.</span><br><span class="line">                createProcessDefinitionQuery().</span><br><span class="line">                deploymentId(deploymentId)</span><br><span class="line">                .singleResult();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// processDefinition.getId() 是 SecondApprove:1:4, 根据部署 id 和流程 id 组装出的数据</span></span><br><span class="line">        logger.info(<span class="string">"流程定义文件: [&#123;&#125;], 流程 id: [&#123;&#125;]"</span>, processDefinition.getName(), processDefinition.getId());</span><br><span class="line">        <span class="keyword">return</span> processDefinition;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ProcessEngine <span class="title">getProcessEngine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ProcessEngineConfiguration configuration = ProcessEngineConfiguration.createStandaloneInMemProcessEngineConfiguration();</span><br><span class="line">        ProcessEngine processEngine = configuration.buildProcessEngine();</span><br><span class="line">        String name = processEngine.getName();</span><br><span class="line">        String version = ProcessEngine.VERSION;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"流程引擎名称: [&#123;&#125;], 版本: [&#123;&#125;]"</span>, name, version);</span><br><span class="line">        <span class="keyword">return</span> processEngine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="4-Activiti-引擎配置"><a href="#4-Activiti-引擎配置" class="headerlink" title="4. Activiti 引擎配置"></a>4. Activiti 引擎配置</h1><h2 id="4-1-流程引擎配置"><a href="#4-1-流程引擎配置" class="headerlink" title="4.1 流程引擎配置"></a>4.1 流程引擎配置</h2><p>流程引擎配置的载体就是 <code>ProcessEngineConfiguration</code> 及其子类, Activiti 是通过 <code>activiti.cfg.xml</code> 来完成配置</p><p>然后构建出流程引擎 <code>ProcessEngine</code>, 最终获取业务开发中需要的各个 Service.</p><p><img src="https://user-images.githubusercontent.com/17758731/49327683-12deda00-f59f-11e8-8a37-b02ee297e713.png" alt="image"></p><p>ProcessorEngineConfiguration:</p><ol><li>查找并解析 XML 配置文件 <code>activiti.cfg.xml</code></li><li>提供多个静态方法创建配置对象</li><li>实现几个基于不同场景的子类, 配置方式灵活</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置 ProcessEngineConfiguration  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"processEngineConfiguration"</span> <span class="attr">class</span>=<span class="string">"org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置数据库连接 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcDriver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/activitiDB?createDatabaseIfNotExist=true&amp;amp;useUnicode=true&amp;amp;characterEncoding=utf8"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUsername"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcPassword"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- false: 不会自动创建表, 没有表, 则抛异常 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- create-drop: 先删除, 再创建表 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- true: 没有表时，自动创建--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"databaseSchemaUpdate"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ProcessEngineConfigurationImpl: 抽象类, 配置了 ProcessEngineConfiguration 大部分属性;<br>StandaloneProcessEngineConfiguration: 独立部署运行, 可以通过 new 的方式创建;<br>SpringProcessEngineConfiguration: 完成与 Spring 的集成, 同时扩展了数据源配置, 事务, 自动装载部署文件的目录.</p><h2 id="4-2-数据库配置"><a href="#4-2-数据库配置" class="headerlink" title="4.2 数据库配置"></a>4.2 数据库配置</h2><ul><li>缺省配置默认使用 H2 内存数据库;</li><li>配置 JDBC 属性, 使用 MyBatis 提供的连接池;</li><li>配置 DataSource, 可自选第三方实现.</li></ul><p>配置 JDBC 属性使用 MyBatis 提供的连接池</p><table><thead><tr><th>基本属性</th><th>连接池配置</th></tr></thead><tbody><tr><td>jdbcUrl</td><td>jdbcMaxActiveConnections(最大活跃连接数)</td></tr><tr><td>jdbcDriver</td><td>jdbcMaxIdleConnections(最大空闲连接数)</td></tr><tr><td>jdbcUsername</td><td>jdbcMaxCheckoutTime(最大)</td></tr><tr><td>jdbcPassword</td><td>jdbcMaxWaitTIme(最大等待时间)</td></tr></tbody></table><p>配置第三方实现的 DataSource</p><ul><li>Druid: 为监控而生的数据库连接池</li><li>Dbcp: Tomcat 自带</li><li>HikariCP: 极速数据源连接池, Spring 默认</li></ul><h3 id="4-2-1-Druid-数据源连接池"><a href="#4-2-1-Druid-数据源连接池" class="headerlink" title="4.2.1 Druid 数据源连接池"></a>4.2.1 Druid 数据源连接池</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"processEngineConfiguration"</span> <span class="attr">class</span>=<span class="string">"org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置数据库连接 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- false: 不会自动创建表, 没有表, 则抛异常 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- create-drop: 先删除, 再创建表 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- true: 没有表时，自动创建--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"databaseSchemaUpdate"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.alibaba.druid.pool.DruidDataSource"</span> <span class="attr">init-method</span>=<span class="string">"init"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/activitiDB"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"initialSize"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxActive"</span> <span class="attr">value</span>=<span class="string">"20"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filters"</span> <span class="attr">value</span>=<span class="string">"stat,slf4f"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="4-2-2-数据库更新策略"><a href="#4-2-2-数据库更新策略" class="headerlink" title="4.2.2 数据库更新策略"></a>4.2.2 数据库更新策略</h3><ol><li>配置 databaseSchemaUpdate:<ul><li>false: 启动时检查数据库版本, 发生不匹配则抛出异常(线上默认)</li><li>true: 启动时自动检查并更新数据库表, 不存在会创建(开发环境默认)</li><li>create-drop: 启动时创建数据库表结构, 结束时删除表结构</li></ul></li></ol><h2 id="4-3-日志和数据记录配置"><a href="#4-3-日志和数据记录配置" class="headerlink" title="4.3 日志和数据记录配置"></a>4.3 日志和数据记录配置</h2><h3 id="4-3-1-日志组件的关系及-MDC"><a href="#4-3-1-日志组件的关系及-MDC" class="headerlink" title="4.3.1 日志组件的关系及 MDC"></a>4.3.1 日志组件的关系及 MDC</h3><table><thead><tr><th>日志分类</th><th>描述</th><th>分类内容</th></tr></thead><tbody><tr><td>日志门面</td><td>直接应用在程序中记录日志的组件</td><td>slf4j, commons-logging, log4j</td></tr><tr><td>日志实现</td><td>日志门面不能直接打日志, 需要日志实现</td><td>logback, log4j, log4j2, Java util logging</td></tr><tr><td>桥接方式</td><td>有些特殊需求, 例如需要 slf4j 作为门面, 但需要以 log4j 作为实现</td><td>slf4j-log4j12, slf4j-jdk14, …</td></tr><tr><td>改变依赖</td><td>将原有门面的功能委托给其他实现, 主要用于解决历史软件内部依赖的改变</td><td>jcl-over-slf4j, log4j-over-slf4j, …</td></tr></tbody></table><p>配置开启 MDC(Mapped Diagnostic Context): 可以理解为将上下文数据存储在 ThreadLocal 中</p><ul><li>默认没有开启, 需要手动设置 <code>LogMDC.setMDCEnable(true)</code></li><li>配置 logback.xml, 日志模板添加 <code>%X{mdcProcessInstanceID}</code>, 即打印当前 instance 的 id</li><li>流程只有在执行过程出现异常的时候才会记录 MDC 信息</li></ul><h4 id="4-3-1-1-默认日志输出"><a href="#4-3-1-1-默认日志输出" class="headerlink" title="4.3.1.1 默认日志输出"></a>4.3.1.1 默认日志输出</h4><h5 id="测试类"><a href="#测试类" class="headerlink" title="测试类"></a>测试类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigMDCTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自动构建 ProcessEngine</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">public</span> ActivitiRule activitiRule = <span class="keyword">new</span> ActivitiRule();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Deployment</span>(resources = &#123;<span class="string">"my-process.bpmn20.xml"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ProcessInstance processInstance = activitiRule.getRuntimeService().startProcessInstanceByKey(<span class="string">"my-process"</span>);</span><br><span class="line">        assertNotNull(processInstance);</span><br><span class="line">        Task task = activitiRule.getTaskService().createTaskQuery().singleResult();</span><br><span class="line">        assertEquals(<span class="string">"Activiti is awesome!"</span>, task.getName());</span><br><span class="line">        activitiRule.getTaskService().complete(task.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="logback-xml"><a href="#logback-xml" class="headerlink" title="logback.xml"></a>logback.xml</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">debug</span>=<span class="string">"false"</span> <span class="attr">scan</span>=<span class="string">"true"</span> <span class="attr">scanPeriod</span>=<span class="string">"30 seconds"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"log.dir"</span> <span class="attr">value</span>=<span class="string">"target/logs"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"encoding"</span> <span class="attr">value</span>=<span class="string">"UTF-8"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"plain"</span> <span class="attr">value</span>=<span class="string">"%msg%n"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"std"</span> <span class="attr">value</span>=<span class="string">"%d&#123;HH:mm:ss.SSS&#125; [%thread] [%level] %msg %X&#123;user&#125; %logger&#123;10&#125;.%M:%L%n"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"normal"</span> <span class="attr">value</span>=<span class="string">"%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;10&#125;.%M:%L - %msg%n"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 控制台输出 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"stdout"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;std&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>$&#123;encoding&#125;<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"stdout"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"file"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="日志输出"><a href="#日志输出" class="headerlink" title="日志输出"></a>日志输出</h5><pre><code>00:19:43.624 [main] [INFO] Loading XML bean definitions from class path resource [activiti.cfg.xml]  o.s.b.f.x.XmlBeanDefinitionReader.loadBeanDefinitions:31600:19:45.162 [main] [INFO] Activiti 5 compatibility handler implementation not found or error during instantiation : org.activiti.compatibility.DefaultActiviti5CompatibilityHandler. Activiti 5 backwards compatibility disabled.  o.a.e.c.DefaultActiviti5CompatibilityHandlerFactory.createActiviti5CompatibilityHandler:3800:19:45.174 [main] [INFO] performing create on engine with resource org/activiti/db/create/activiti.mysql.create.engine.sql  o.a.e.i.d.DbSqlSession.executeSchemaResource:114700:19:45.176 [main] [INFO] Found MySQL: majorVersion=5 minorVersion=7  o.a.e.i.d.DbSqlSession.executeSchemaResource:116200:19:46.466 [main] [INFO] performing create on history with resource org/activiti/db/create/activiti.mysql.create.history.sql  o.a.e.i.d.DbSqlSession.executeSchemaResource:114700:19:46.466 [main] [INFO] Found MySQL: majorVersion=5 minorVersion=7  o.a.e.i.d.DbSqlSession.executeSchemaResource:116200:19:46.922 [main] [INFO] performing create on identity with resource org/activiti/db/create/activiti.mysql.create.identity.sql  o.a.e.i.d.DbSqlSession.executeSchemaResource:114700:19:46.922 [main] [INFO] Found MySQL: majorVersion=5 minorVersion=7  o.a.e.i.d.DbSqlSession.executeSchemaResource:116200:19:47.035 [main] [INFO] ProcessEngine default created  o.a.e.i.ProcessEngineImpl.&lt;init&gt;:87</code></pre><h4 id="4-3-1-2-MDC-日志输出"><a href="#4-3-1-2-MDC-日志输出" class="headerlink" title="4.3.1.2 MDC 日志输出"></a>4.3.1.2 MDC 日志输出</h4><h5 id="测试类-1"><a href="#测试类-1" class="headerlink" title="测试类"></a>测试类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigMDCTest</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">public</span> ActivitiRule activitiRule = <span class="keyword">new</span> ActivitiRule();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Deployment</span>(resources = &#123;<span class="string">"my-process.bpmn20.xml"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 开启 MDC, 整个过程在正常情况下是不会激活 MDC 的</span></span><br><span class="line">        LogMDC.setMDCEnabled(<span class="keyword">true</span>);</span><br><span class="line">        ProcessInstance processInstance = activitiRule.getRuntimeService().startProcessInstanceByKey(<span class="string">"my-process"</span>);</span><br><span class="line">        assertNotNull(processInstance);</span><br><span class="line">        Task task = activitiRule.getTaskService().createTaskQuery().singleResult();</span><br><span class="line">        assertEquals(<span class="string">"Activiti is awesome!"</span>, task.getName());</span><br><span class="line">        activitiRule.getTaskService().complete(task.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="BPMN-流程图"><a href="#BPMN-流程图" class="headerlink" title="BPMN 流程图"></a>BPMN 流程图</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:activiti</span>=<span class="string">"http://activiti.org/bpmn"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:bpmndi</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/DI"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdc</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DC"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdi</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="attr">typeLanguage</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">expressionLanguage</span>=<span class="string">"http://www.w3.org/1999/XPath"</span> <span class="attr">targetNamespace</span>=<span class="string">"http://www.activiti.org/test"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"my-process"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"start"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow1"</span> <span class="attr">sourceRef</span>=<span class="string">"start"</span> <span class="attr">targetRef</span>=<span class="string">"someTask"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- org.destiny.activiti.delegate.MDCErrorDelegate 是一个会自动抛出异常 "test only" 的JavaDelegate --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">serviceTask</span> <span class="attr">id</span>=<span class="string">"someTask"</span> <span class="attr">activiti:class</span>=<span class="string">"org.destiny.activiti.delegate.MDCErrorDelegate"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow2"</span> <span class="attr">sourceRef</span>=<span class="string">"someTask"</span> <span class="attr">targetRef</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="logback"><a href="#logback" class="headerlink" title="logback"></a>logback</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">debug</span>=<span class="string">"false"</span> <span class="attr">scan</span>=<span class="string">"true"</span> <span class="attr">scanPeriod</span>=<span class="string">"30 seconds"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"log.dir"</span> <span class="attr">value</span>=<span class="string">"target/logs"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"encoding"</span> <span class="attr">value</span>=<span class="string">"UTF-8"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"plain"</span> <span class="attr">value</span>=<span class="string">"%msg%n"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"std"</span> <span class="attr">value</span>=<span class="string">"%d&#123;HH:mm:ss.SSS&#125; [%thread] [%level] %msg %X&#123;user&#125; %logger&#123;10&#125;.%M:%L%n"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">     - MDC 配置:</span></span><br><span class="line"><span class="comment">     - ProcessDefinitionId: 流程定义 id</span></span><br><span class="line"><span class="comment">     - executionId:</span></span><br><span class="line"><span class="comment">     - mdcProcessInstanceId: 流程实例 id</span></span><br><span class="line"><span class="comment">     - mdcBusinessKey: 业务 key</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mdc"</span> <span class="attr">value</span>=<span class="string">"%d&#123;HH:mm:ss.SSS&#125; [%thread] [%level] %msg ProcessDefinitionId=%X&#123;mdcProcessDefinitionID&#125;</span></span></span><br><span class="line"><span class="tag"><span class="string">    executionId=%X&#123;mdcExecutionId&#125; mdcProcessInstanceId=%X&#123;mdcProcessInstanceId&#125; mdcBusinessKey=%X&#123;mdcBusinessKey&#125; %logger&#123;10&#125;.%M:%L%n"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"normal"</span> <span class="attr">value</span>=<span class="string">"%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;10&#125;.%M:%L - %msg%n"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 控制台输出 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"stdout"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 此处将默认值输出由 std 改为 mdc --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--&lt;pattern&gt;$&#123;std&#125;&lt;/pattern&gt;--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;mdc&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--&lt;pattern&gt;$&#123;mdc&#125;&lt;/pattern&gt;--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>$&#123;encoding&#125;<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"stdout"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"file"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="日志输出-1"><a href="#日志输出-1" class="headerlink" title="日志输出"></a>日志输出</h5><pre><code>00:32:57.204 [main] [INFO] Loading XML bean definitions from class path resource [activiti.cfg.xml] ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.s.b.f.x.XmlBeanDefinitionReader.loadBeanDefinitions:31600:32:58.659 [main] [INFO] Activiti 5 compatibility handler implementation not found or error during instantiation : org.activiti.compatibility.DefaultActiviti5CompatibilityHandler. Activiti 5 backwards compatibility disabled. ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.c.DefaultActiviti5CompatibilityHandlerFactory.createActiviti5CompatibilityHandler:3800:32:58.671 [main] [INFO] performing create on engine with resource org/activiti/db/create/activiti.mysql.create.engine.sql ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.d.DbSqlSession.executeSchemaResource:114700:32:58.673 [main] [INFO] Found MySQL: majorVersion=5 minorVersion=7 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.d.DbSqlSession.executeSchemaResource:116200:33:00.219 [main] [INFO] performing create on history with resource org/activiti/db/create/activiti.mysql.create.history.sql ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.d.DbSqlSession.executeSchemaResource:114700:33:00.220 [main] [INFO] Found MySQL: majorVersion=5 minorVersion=7 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.d.DbSqlSession.executeSchemaResource:116200:33:00.657 [main] [INFO] performing create on identity with resource org/activiti/db/create/activiti.mysql.create.identity.sql ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.d.DbSqlSession.executeSchemaResource:114700:33:00.657 [main] [INFO] Found MySQL: majorVersion=5 minorVersion=7 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.d.DbSqlSession.executeSchemaResource:116200:33:00.771 [main] [INFO] ProcessEngine default created ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.ProcessEngineImpl.&lt;init&gt;:8700:33:00.932 [main] [INFO] MDCErrorDelegate.execute ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.d.MDCErrorDelegate.execute:2400:33:00.935 [main] [ERROR] Error while closing command context ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.CommandContext.logException:122java.lang.RuntimeException: test only...</code></pre><p>可以看到, 在 ERROR 行中, 打印出了 MDC 信息</p><h4 id="4-3-1-3-使用拦截器让每个流程节点都把-MDC-信息打印出来"><a href="#4-3-1-3-使用拦截器让每个流程节点都把-MDC-信息打印出来" class="headerlink" title="4.3.1.3 使用拦截器让每个流程节点都把 MDC 信息打印出来"></a>4.3.1.3 使用拦截器让每个流程节点都把 MDC 信息打印出来</h4><h5 id="新建拦截器"><a href="#新建拦截器" class="headerlink" title="新建拦截器"></a>新建拦截器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MDCCommandInvoker</span> <span class="keyword">extends</span> <span class="title">DebugCommandInvoker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 先判断可运行的对象是不是 Activiti 支持的 Operation</span></span><br><span class="line"><span class="comment">     * 如果是, 将它强转, 并取出执行对象并输出</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> runnable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeOperation</span><span class="params">(Runnable runnable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> mdcEnabled = LogMDC.isMDCEnabled();</span><br><span class="line">        LogMDC.setMDCEnabled(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (runnable <span class="keyword">instanceof</span> AbstractOperation) &#123;</span><br><span class="line">            AbstractOperation operation = (AbstractOperation) runnable;</span><br><span class="line">            <span class="keyword">if</span> (operation.getExecution() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果是可操作对象, 将该信息放入 MDC 上下文对象</span></span><br><span class="line">                LogMDC.putMDCExecution(operation.getExecution());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.executeOperation(runnable);</span><br><span class="line">        LogMDC.clear();</span><br><span class="line">        <span class="keyword">if</span> (!mdcEnabled) &#123;</span><br><span class="line">            <span class="comment">// 如果 MDC 原本不生效, 需要将 MDC 重新置为 false</span></span><br><span class="line">            LogMDC.setMDCEnabled(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="配置该拦截器"><a href="#配置该拦截器" class="headerlink" title="配置该拦截器"></a>配置该拦截器</h5><blockquote><p>修改默认配置文件 activiti.cfg.xml, 新增该 MDCCommandInvoker</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置 ProcessEngineConfiguration  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"processEngineConfiguration"</span> <span class="attr">class</span>=<span class="string">"org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置数据库连接 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcDriver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/activitiDB?createDatabaseIfNotExist=true&amp;amp;useUnicode=true&amp;amp;characterEncoding=utf8&amp;amp;useSSL=false"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUsername"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcPassword"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"databaseSchemaUpdate"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"commandInvoker"</span> <span class="attr">ref</span>=<span class="string">"commandInvoker"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"commandInvoker"</span> <span class="attr">class</span>=<span class="string">"org.destiny.activiti.interceptor.MDCCommandInvoker"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="最终产出日志"><a href="#最终产出日志" class="headerlink" title="最终产出日志"></a>最终产出日志</h5><pre><code>00:56:35.631 [main] [INFO] Loading XML bean definitions from class path resource [activiti_mdc.cfg.xml] ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.s.b.f.x.XmlBeanDefinitionReader.loadBeanDefinitions:31600:56:37.141 [main] [INFO] Activiti 5 compatibility handler implementation not found or error during instantiation : org.activiti.compatibility.DefaultActiviti5CompatibilityHandler. Activiti 5 backwards compatibility disabled. ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.c.DefaultActiviti5CompatibilityHandlerFactory.createActiviti5CompatibilityHandler:3800:56:37.153 [main] [INFO] performing create on engine with resource org/activiti/db/create/activiti.mysql.create.engine.sql ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.d.DbSqlSession.executeSchemaResource:114700:56:37.154 [main] [INFO] Found MySQL: majorVersion=5 minorVersion=7 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.d.DbSqlSession.executeSchemaResource:116200:56:38.655 [main] [INFO] performing create on history with resource org/activiti/db/create/activiti.mysql.create.history.sql ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.d.DbSqlSession.executeSchemaResource:114700:56:38.656 [main] [INFO] Found MySQL: majorVersion=5 minorVersion=7 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.d.DbSqlSession.executeSchemaResource:116200:56:39.109 [main] [INFO] performing create on identity with resource org/activiti/db/create/activiti.mysql.create.identity.sql ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.d.DbSqlSession.executeSchemaResource:114700:56:39.110 [main] [INFO] Found MySQL: majorVersion=5 minorVersion=7 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.d.DbSqlSession.executeSchemaResource:116200:56:39.218 [main] [INFO] ProcessEngine default created ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.ProcessEngineImpl.&lt;init&gt;:8700:56:39.403 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation : ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3300:56:39.407 [main] [INFO] 4 (process instance)└── 5 : start (StartEvent, parent id 4 (active) ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3400:56:39.409 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation : ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3300:56:39.410 [main] [INFO] 4 (process instance)└── 5 : start (StartEvent, parent id 4 (active) ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3400:56:39.411 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation : ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3300:56:39.412 [main] [INFO] 4 (process instance)└── 5 : start -&gt; someTask, parent id 4 (active) ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3400:56:39.412 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation : ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3300:56:39.412 [main] [INFO] 4 (process instance)└── 5 : someTask (UserTask, parent id 4 (active) ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3400:56:39.497 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.TriggerExecutionOperation : ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3300:56:39.501 [main] [INFO] 4 (process instance)└── 5 : someTask (UserTask, parent id 4 (active) ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3400:56:39.502 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation : ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3300:56:39.503 [main] [INFO] 4 (process instance)└── 5 : someTask (UserTask, parent id 4 (active) ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3400:56:39.504 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation : ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3300:56:39.504 [main] [INFO] 4 (process instance)└── 5 : someTask -&gt; end, parent id 4 (active) ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3400:56:39.505 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation : ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3300:56:39.505 [main] [INFO] 4 (process instance)└── 5 : end (EndEvent, parent id 4 (active) ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3400:56:39.505 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation : ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3300:56:39.506 [main] [INFO] 4 (process instance)└── 5 : end (EndEvent, parent id 4 (active) ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3400:56:39.507 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.EndExecutionOperation : ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:3300:56:39.507 [main] [INFO] 4 (process instance)└── 5 : end (EndEvent, parent id 4 (active) ProcessDefinitionId=my-process:1:3     executionId=5 mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.i.DebugCommandInvoker.executeOperation:34</code></pre><blockquote><p>可以看到最终所有级别的日志都输出了 MDC 信息</p></blockquote><h3 id="4-3-2-配置历史记录级别"><a href="#4-3-2-配置历史记录级别" class="headerlink" title="4.3.2 配置历史记录级别"></a>4.3.2 配置历史记录级别</h3><p>配置 HistoryLevel:</p><ul><li>none: 不记录历史记录, 性能高, 流程结束后不可读取;</li><li>activiti: 归档流程实例和活动实例, 流程变量不同步;</li><li>audit: 默认值, 在 activiti 基础上同步变量值, 保存表单属性;</li><li>full: 性能较差, 记录所有实例和变量细节变化.</li></ul><h3 id="4-3-3-配置基于-DB-的事件日志"><a href="#4-3-3-配置基于-DB-的事件日志" class="headerlink" title="4.3.3 配置基于 DB 的事件日志"></a>4.3.3 配置基于 DB 的事件日志</h3><p>配置 Event Logging</p><ul><li>实验性的事件记录机制, 性能影响较大;</li><li>开启默认记录所有数据的变化过程, 导致表记录快速增长;</li><li>日志内容基于 JSON 格式, 建议存入 MongoDB, Elastic Search;</li></ul><h2 id="4-4-命令拦截器的配置"><a href="#4-4-命令拦截器的配置" class="headerlink" title="4.4 命令拦截器的配置"></a>4.4 命令拦截器的配置</h2><h3 id="4-4-1-命令模式与责任链模式"><a href="#4-4-1-命令模式与责任链模式" class="headerlink" title="4.4.1 命令模式与责任链模式"></a>4.4.1 命令模式与责任链模式</h3><h4 id="4-4-1-1-Command"><a href="#4-4-1-1-Command" class="headerlink" title="4.4.1.1 Command"></a>4.4.1.1 Command</h4><blockquote><p>命令拦截器使用命令模式实现, 多个拦截器会组成一个拦截器链, 实现了责任链模式</p></blockquote><p><img src="https://user-images.githubusercontent.com/17758731/49334530-3e031100-f613-11e8-9e2c-9e32150b0f33.png" alt="image"></p><ul><li>Command: 命令接口</li><li>ConcreteCommand: 命令实现, 构造命令的时候, 需要传入接受者, 即 Received</li><li>Receiver: Client 在实现 Command 接口的时候传入</li><li>Invoker: 调用者, 最终调用 ConcreteCommand 对象</li></ul><p><img src="https://user-images.githubusercontent.com/17758731/49334596-9edf1900-f614-11e8-99e2-ee9049405f55.png" alt="image"></p><h4 id="4-4-1-2-Chain-of-Responsibility"><a href="#4-4-1-2-Chain-of-Responsibility" class="headerlink" title="4.4.1.2 Chain of Responsibility"></a>4.4.1.2 Chain of Responsibility</h4><p><img src="https://user-images.githubusercontent.com/17758731/49334608-dea60080-f614-11e8-95e0-d55a75405c27.png" alt="image"></p><blockquote><p>customPre, default, customPost 中 <code>execute()</code> 的实现基本都是调用了 <code>next</code> 的 <code>execute()</code>, 只有 CommandInvoker 真正完成了执行器.</p></blockquote><ul><li>CustomPre: default 之前的拦截器</li><li>default: Activiti 默认的 CommandInterceptor</li><li>CustomPost: default 之后的拦截器</li><li>CommandInvoker: 最终的命令执行者</li></ul><h3 id="4-4-2-命令拦截器的配置"><a href="#4-4-2-命令拦截器的配置" class="headerlink" title="4.4.2 命令拦截器的配置"></a>4.4.2 命令拦截器的配置</h3><ul><li>配置Interceptor<ul><li>customProCommandInterceptors: 配置在默认拦截器之前</li><li>customPostCommandInterceptors: 配置在默认拦截器之后</li><li>commandInvoker: 配置在最后的执行器</li></ul></li></ul><h3 id="4-4-3-示例"><a href="#4-4-3-示例" class="headerlink" title="4.4.3 示例"></a>4.4.3 示例</h3><blockquote><h4 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h4><p>实现一个可以统计所有命令完成时间的拦截器</p></blockquote><h4 id="拦截器实现"><a href="#拦截器实现" class="headerlink" title="拦截器实现"></a>拦截器实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DurationCommandInterceptor</span> <span class="keyword">extends</span> <span class="title">AbstractCommandInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DurationCommandInterceptor.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(CommandConfig config, Command&lt;T&gt; command)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 记录当前时间</span></span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getNext().execute(config, command);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> duration = System.currentTimeMillis() - start;</span><br><span class="line">            logger.info(<span class="string">"&#123;&#125; 执行时长: &#123;&#125; 毫秒"</span>, command.getClass().getSimpleName(), duration);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置 ProcessEngineConfiguration  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"processEngineConfiguration"</span> <span class="attr">class</span>=<span class="string">"org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"databaseSchemaUpdate"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"commandInvoker"</span> <span class="attr">ref</span>=<span class="string">"commandInvoker"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"customPreCommandInterceptors"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.destiny.activiti.interceptor.DurationCommandInterceptor"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"commandInvoker"</span> <span class="attr">class</span>=<span class="string">"org.destiny.activiti.interceptor.MDCCommandInvoker"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="日志输出-2"><a href="#日志输出-2" class="headerlink" title="日志输出"></a>日志输出</h4><pre><code>10:10:09.371 [main] [INFO] SchemaOperationsProcessEngineBuild 执行时长: 113 毫秒 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.i.DurationCommandInterceptor.execute:3310:10:09.372 [main] [INFO] ProcessEngine default created ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.a.e.i.ProcessEngineImpl.&lt;init&gt;:8710:10:09.391 [main] [INFO] ValidateExecutionRelatedEntityCountCfgCmd 执行时长: 14 毫秒 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.i.DurationCommandInterceptor.execute:3310:10:09.394 [main] [INFO]  执行时长: 1 毫秒 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.i.DurationCommandInterceptor.execute:3310:10:09.401 [main] [INFO] GetNextIdBlockCmd 执行时长: 4 毫秒 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.i.DurationCommandInterceptor.execute:3310:10:09.508 [main] [INFO] GetProcessDefinitionInfoCmd 执行时长: 2 毫秒 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.i.DurationCommandInterceptor.execute:3310:10:09.513 [main] [INFO] DeployCmd 执行时长: 116 毫秒 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.i.DurationCommandInterceptor.execute:3310:10:09.616 [main] [INFO] CompleteTaskCmd 执行时长: 22 毫秒 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.i.DurationCommandInterceptor.execute:3310:10:09.630 [main] [INFO] DeleteDeploymentCmd 执行时长: 14 毫秒 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.i.DurationCommandInterceptor.execute:33</code></pre><h2 id="4-5-作业执行器-Job-Executor"><a href="#4-5-作业执行器-Job-Executor" class="headerlink" title="4.5 作业执行器 Job Executor"></a>4.5 作业执行器 Job Executor</h2><h3 id="4-5-1-作业执行器的配置"><a href="#4-5-1-作业执行器的配置" class="headerlink" title="4.5.1 作业执行器的配置"></a>4.5.1 作业执行器的配置</h3><ul><li>asyncExecutorActivate: 激活作业执行器</li><li>asyncExecutorXXX: 异步执行器的属性配置</li><li><p>asyncExecutor: 异步执行器 bean</p></li><li><p>定时开始事件</p><ul><li>timeDate: 指定启动时间</li><li>timeDuration: 指定持续时间间隔后执行</li><li>timeCycle:R5/P1DT1H 指定时间段后周期执行</li></ul></li></ul><h3 id="4-5-2-配置自定义线程池"><a href="#4-5-2-配置自定义线程池" class="headerlink" title="4.5.2 配置自定义线程池"></a>4.5.2 配置自定义线程池</h3><ul><li>corePoolSize: 核心线程数</li><li>maxPoolSize: 最大线程数</li><li>queueCapacity: 阻塞队列大小</li></ul><blockquote><p>如果核心线程数没满, 每当有一个任务, 不管原有线程是否空闲都会开启一个新的线程去执行, 直到达到核心线程数;<br>如果所有核心线程都在运行, 每当有一个任务, 会先放在阻塞队列等待, 直到核心线程执行完上一个任务, 会取阻塞队列第一个任务继续执行;<br>如果队列已满, 会继续创建新的线程, 直到达到最大线程数;<br>如果最大线程数和队列都已满, 此时会执行拒绝策略.</p></blockquote><h3 id="4-5-3-流程定义定时启动流程"><a href="#4-5-3-流程定义定时启动流程" class="headerlink" title="4.5.3 流程定义定时启动流程"></a>4.5.3 流程定义定时启动流程</h3><h3 id="4-5-4-Demo"><a href="#4-5-4-Demo" class="headerlink" title="4.5.4 Demo"></a>4.5.4 Demo</h3><h4 id="配置异步执行器"><a href="#配置异步执行器" class="headerlink" title="配置异步执行器"></a>配置异步执行器</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置 ProcessEngineConfiguration  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"processEngineConfiguration"</span> <span class="attr">class</span>=<span class="string">"org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"databaseSchemaUpdate"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"commandInvoker"</span> <span class="attr">ref</span>=<span class="string">"commandInvoker"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 打开异步执行器 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"asyncExecutorActivate"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"asyncExecutor"</span> <span class="attr">value</span>=<span class="string">"asyncExecutor"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 事件监听 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"eventListeners"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.destiny.activiti.listener.JobEventListener"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"asyncExecutor"</span> <span class="attr">class</span>=<span class="string">"org.activiti.engine.impl.asyncexecutor.DefaultAsyncJobExecutor"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"executorService"</span> <span class="attr">ref</span>=<span class="string">"executorService"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"executorService"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.concurrent.ThreadPoolExecutorFactoryBean"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"threadNamePrefix"</span> <span class="attr">value</span>=<span class="string">"activiti-job-"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"corePoolSize"</span> <span class="attr">value</span>=<span class="string">"5"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxPoolSize"</span> <span class="attr">value</span>=<span class="string">"20"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"queueCapacity"</span> <span class="attr">value</span>=<span class="string">"100"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"rejectedExecutionHandler"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"java.util.concurrent.ThreadPoolExecutor$AbortPolicy"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"commandInvoker"</span> <span class="attr">class</span>=<span class="string">"org.destiny.activiti.interceptor.MDCCommandInvoker"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="流程定义文件"><a href="#流程定义文件" class="headerlink" title="流程定义文件"></a>流程定义文件</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"my-process"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;startEvent id="start"/&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"start"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">timerEventDefinition</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 每 10 秒执行一次, 共执行 5 次 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeCycle</span>&gt;</span>R5/PT10S<span class="tag">&lt;/<span class="name">timeCycle</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">timerEventDefinition</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow1"</span> <span class="attr">sourceRef</span>=<span class="string">"start"</span> <span class="attr">targetRef</span>=<span class="string">"someTask"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"someTask"</span> <span class="attr">name</span>=<span class="string">"Activiti is awesome!"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow2"</span> <span class="attr">sourceRef</span>=<span class="string">"someTask"</span> <span class="attr">targetRef</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="添加监听器"><a href="#添加监听器" class="headerlink" title="添加监听器"></a>添加监听器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobEventListener</span> <span class="keyword">implements</span> <span class="title">ActivitiEventListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(JobEventListener.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(ActivitiEvent event)</span> </span>&#123;</span><br><span class="line">        ActivitiEventType eventType = event.getType();</span><br><span class="line">        String name = eventType.name();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name.startsWith(<span class="string">"TIMER"</span>) || name.startsWith(<span class="string">"JOB"</span>)) &#123;</span><br><span class="line">            logger.info(<span class="string">"监听 Job 事件: &#123;&#125; \t &#123;&#125;"</span>, eventType, event.getProcessInstanceId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFailOnException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="日志输出-3"><a href="#日志输出-3" class="headerlink" title="日志输出"></a>日志输出</h4><pre><code>11:34:50.048 [main] [INFO] 监听 Job 事件: TIMER_SCHEDULED      null ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.l.JobEventListener.onEvent:3411:34:50.056 [main] [INFO] start ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.c.ConfigJobTest.test:3311:34:50.080 [main] [INFO] 定时任务 TimerJobEntity [id=4], 默认重试次数: 3 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.c.ConfigJobTest.test:3611:34:50.080 [main] [INFO] jobList.size: 1 ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.c.ConfigJobTest.test:3811:35:09.981 [activiti-job-1] [INFO] 监听 Job 事件: TIMER_FIRED      null ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.l.JobEventListener.onEvent:3411:35:09.990 [activiti-job-1] [INFO] 监听 Job 事件: TIMER_SCHEDULED      null ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.l.JobEventListener.onEvent:3411:35:09.990 [activiti-job-1] [INFO] 监听 Job 事件: JOB_EXECUTION_SUCCESS      null ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.l.JobEventListener.onEvent:3411:35:19.950 [activiti-job-2] [INFO] 监听 Job 事件: TIMER_FIRED      null ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.l.JobEventListener.onEvent:3411:35:19.951 [activiti-job-2] [INFO] 监听 Job 事件: TIMER_SCHEDULED      null ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.l.JobEventListener.onEvent:3411:35:19.951 [activiti-job-2] [INFO] 监听 Job 事件: JOB_EXECUTION_SUCCESS      null ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.l.JobEventListener.onEvent:3411:35:29.958 [activiti-job-3] [INFO] 监听 Job 事件: TIMER_FIRED      null ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.l.JobEventListener.onEvent:3411:35:29.959 [activiti-job-3] [INFO] 监听 Job 事件: TIMER_SCHEDULED      null ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.l.JobEventListener.onEvent:3411:35:29.960 [activiti-job-3] [INFO] 监听 Job 事件: JOB_EXECUTION_SUCCESS      null ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.l.JobEventListener.onEvent:3411:35:39.966 [activiti-job-4] [INFO] 监听 Job 事件: TIMER_FIRED      null ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.l.JobEventListener.onEvent:3411:35:39.970 [activiti-job-4] [INFO] 监听 Job 事件: TIMER_SCHEDULED      null ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.l.JobEventListener.onEvent:3411:35:39.971 [activiti-job-4] [INFO] 监听 Job 事件: JOB_EXECUTION_SUCCESS      null ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.l.JobEventListener.onEvent:3411:35:49.975 [activiti-job-5] [INFO] 监听 Job 事件: TIMER_FIRED      null ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.l.JobEventListener.onEvent:3411:35:49.975 [activiti-job-5] [INFO] 监听 Job 事件: JOB_EXECUTION_SUCCESS      null ProcessDefinitionId=     executionId= mdcProcessInstanceId= mdcBusinessKey= o.d.a.l.JobEventListener.onEvent:34</code></pre><h2 id="4-6-Activiti-与-Spring-集成"><a href="#4-6-Activiti-与-Spring-集成" class="headerlink" title="4.6 Activiti 与 Spring 集成"></a>4.6 Activiti 与 Spring 集成</h2><h3 id="4-6-1-集成-Spring-配置"><a href="#4-6-1-集成-Spring-配置" class="headerlink" title="4.6.1 集成 Spring 配置"></a>4.6.1 集成 Spring 配置</h3><ul><li>添加依赖:</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>基于 Spring 的默认配置: <code>activiti-context.xml</code>, 如果配置该文件, Activiti 在启动过程中就会查找基于 Spring 的 <code>ProcessEngineConfiguration</code> 对象;</li><li>Activiti 核心服务注入 Spring 容器</li></ul><h3 id="4-6-2-基于-Spring-对-Activiti-的管理"><a href="#4-6-2-基于-Spring-对-Activiti-的管理" class="headerlink" title="4.6.2 基于 Spring 对 Activiti 的管理"></a>4.6.2 基于 Spring 对 Activiti 的管理</h3><h4 id="4-6-2-1-集成-Spring-事务管理器"><a href="#4-6-2-1-集成-Spring-事务管理器" class="headerlink" title="4.6.2.1  集成 Spring 事务管理器"></a>4.6.2.1  集成 Spring 事务管理器</h4><h4 id="activiti-context-xml"><a href="#activiti-context-xml" class="headerlink" title="activiti-context.xml"></a>activiti-context.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置 ProcessEngineConfiguration  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"processEngineConfiguration"</span> <span class="attr">class</span>=<span class="string">"org.activiti.spring.SpringProcessEngineConfiguration"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Spring 需要单独配置 DataSource --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"transactionManager"</span> <span class="attr">ref</span>=<span class="string">"transactionManager"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"databaseSchemaUpdate"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 数据源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.alibaba.druid.pool.DruidDataSource"</span> <span class="attr">init-method</span>=<span class="string">"init"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"org.h2.Driver"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:h2:mem:activiti"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"sa"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 事务管理器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 流程引擎对象 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"processEngine"</span> <span class="attr">class</span>=<span class="string">"org.activiti.spring.ProcessEngineFactoryBean"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"processEngineConfiguration"</span> <span class="attr">ref</span>=<span class="string">"processEngineConfiguration"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 将服务暴露给 Spring --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"runtimeService"</span> <span class="attr">factory-bean</span>=<span class="string">"processEngine"</span> <span class="attr">factory-method</span>=<span class="string">"getRuntimeService"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"repositoryService"</span> <span class="attr">factory-bean</span>=<span class="string">"processEngine"</span> <span class="attr">factory-method</span>=<span class="string">"getRepositoryService"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"formService"</span> <span class="attr">factory-bean</span>=<span class="string">"processEngine"</span> <span class="attr">factory-method</span>=<span class="string">"getFormService"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"taskService"</span> <span class="attr">factory-bean</span>=<span class="string">"processEngine"</span> <span class="attr">factory-method</span>=<span class="string">"getTaskService"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"historyService"</span> <span class="attr">factory-bean</span>=<span class="string">"processEngine"</span> <span class="attr">factory-method</span>=<span class="string">"getHistoryService"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置 activitiRule 用于测试 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"activitiRule"</span> <span class="attr">class</span>=<span class="string">"org.activiti.engine.test.ActivitiRule"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"processEngine"</span> <span class="attr">ref</span>=<span class="string">"processEngine"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="4-6-2-2-定义文件表达式中使用-Spring-Bean"><a href="#4-6-2-2-定义文件表达式中使用-Spring-Bean" class="headerlink" title="4.6.2.2 定义文件表达式中使用 Spring Bean"></a>4.6.2.2 定义文件表达式中使用 Spring Bean</h4><h5 id="HelloBean"><a href="#HelloBean" class="headerlink" title="HelloBean"></a>HelloBean</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(HelloBean.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"sayHello"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="my-process-spring-bpmn20-xml"><a href="#my-process-spring-bpmn20-xml" class="headerlink" title="my-process-spring.bpmn20.xml"></a>my-process-spring.bpmn20.xml</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:activiti</span>=<span class="string">"http://activiti.org/bpmn"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:bpmndi</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/DI"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdc</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DC"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdi</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="attr">typeLanguage</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">expressionLanguage</span>=<span class="string">"http://www.w3.org/1999/XPath"</span> <span class="attr">targetNamespace</span>=<span class="string">"http://www.activiti.org/test"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"my-process"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"start"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow1"</span> <span class="attr">sourceRef</span>=<span class="string">"start"</span> <span class="attr">targetRef</span>=<span class="string">"someTask"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"someTask"</span> <span class="attr">name</span>=<span class="string">"Activiti is awesome!"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow2"</span> <span class="attr">sourceRef</span>=<span class="string">"someTask"</span> <span class="attr">targetRef</span>=<span class="string">"helloBean"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 从 Spring 容器中查找 Hello bean, 并且调用 sayHello() 方法 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">serviceTask</span> <span class="attr">id</span>=<span class="string">"helloBean"</span> <span class="attr">activiti:expression</span>=<span class="string">"$&#123;helloBean.sayHello()&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow3"</span> <span class="attr">sourceRef</span>=<span class="string">"helloBean"</span> <span class="attr">targetRef</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="测试类-2"><a href="#测试类-2" class="headerlink" title="测试类"></a>测试类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(locations = &#123;<span class="string">"classpath:activiti-context.xml"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigSpringTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(ConfigSpringTest.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> ActivitiRule activitiRule;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RuntimeService runtimeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TaskService taskService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Deployment</span>(resources = &#123;<span class="string">"my-process-spring.bpmn20.xml"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"my-process"</span>);</span><br><span class="line">        Task task = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();</span><br><span class="line">        taskService.complete(task.getId());</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"processInstance: [&#123;&#125;]"</span>, processInstance);</span><br><span class="line">        logger.info(<span class="string">"task: [&#123;&#125;]"</span>, task);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-6-2-3-自动部署资源文件"><a href="#4-6-2-3-自动部署资源文件" class="headerlink" title="4.6.2.3 自动部署资源文件"></a>4.6.2.3 自动部署资源文件</h4><h3 id="4-6-3-基于-Spring-的流程单元测试"><a href="#4-6-3-基于-Spring-的流程单元测试" class="headerlink" title="4.6.3 基于 Spring 的流程单元测试"></a>4.6.3 基于 Spring 的流程单元测试</h3><ul><li>添加依赖 <code>spring-test</code></li><li>辅助测试 Rule: ActivitiRule</li><li>辅助测试 TestCase: SpringActivitiTestCase</li></ul><h1 id="5-Activiti-核心-API"><a href="#5-Activiti-核心-API" class="headerlink" title="5. Activiti 核心 API"></a>5. Activiti 核心 API</h1><table><thead><tr><th>服务名称</th><th>功能</th></tr></thead><tbody><tr><td>RepositoryServie</td><td>负责对静态文件的管理, 涉及部署对象和资源对象, 其二者是一对多的关系</td></tr><tr><td>RuntimeService</td><td>负责对流程进行控制的服务, 可以对流程实例完成启动, 暂停, 挂起等操作</td></tr><tr><td>TaskService</td><td>负责管理运行中的 UserTask(人工任务)</td></tr><tr><td>IdentityService</td><td>负责对用户和用户组的管理</td></tr><tr><td>FormService</td><td>负责解析流程定义中的表单, 对表单的数据类型做渲染</td></tr><tr><td>HistoryService</td><td>提供了对运行结束的流程实例的查询和删除操作</td></tr><tr><td>ManagementService</td><td>提供了对流程引擎基础的管理, 提供对定时任务 Job 的管理, 获取表结构, 表明的操作</td></tr><tr><td>DynamicBpmnService</td><td>提供了对动态的流程定义模型做修改</td></tr></tbody></table><h2 id="5-1-RepositoryService"><a href="#5-1-RepositoryService" class="headerlink" title="5.1 RepositoryService"></a>5.1 RepositoryService</h2><ul><li>管理流程定义文件 xml 及静态资源服务</li><li>对特定的流程的暂停和激活</li><li>流程定义启动权限管理</li><li>部署文件构造器 <code>DeploymentBuilder</code></li><li>部署文件查询器 <code>DeploymentQuery</code></li><li>流程定义文件查询对象 <code>ProcessDefinitionQuery</code></li><li>流程部署文件对象 <code>Deployment</code></li><li>流程定义文件对象 <code>ProcessDefinition</code></li><li>流程定义的 Java 格式 <code>BpmnModel</code></li></ul><p>RepositoryService API:</p><table><thead><tr><th>方法名</th><th>功能</th></tr></thead><tbody><tr><td>createDeployment</td><td>添加资源文件</td></tr><tr><td>deleteDeployment</td><td>删除资源文件</td></tr><tr><td>setDeploymentCategory</td><td>指定分类名称</td></tr><tr><td>createProcessDefinitionQuery</td><td>创建流程定义查询对象</td></tr><tr><td>createNativeProcessDefinitionQuery</td><td>通过 SQL 查询流程定义对象</td></tr><tr><td>suspendProcessDefinitionByXX</td><td>通过某些条件暂停/挂起流程定义对象, 使之不能再生成新的流程实例</td></tr><tr><td>activateProcessDefinitionByXX</td><td>通过某些条件激活流程定义对象, 使之可以继续生成新的流程实例</td></tr><tr><td>getProcssDiagram</td><td>获取流程图的数据流</td></tr><tr><td>getBpmnModel</td><td>获取 BpmnModel 对象</td></tr><tr><td>addCandidateStarterUser</td><td>设置某个流程文件只能由指定的用户去启动</td></tr><tr><td>addCandidateStarterGroup</td><td>设置某个流程文件只能由指定的用户组去启动</td></tr><tr><td>…</td><td>…</td></tr></tbody></table><h3 id="5-1-1-ProcessDefinitionId-的含义"><a href="#5-1-1-ProcessDefinitionId-的含义" class="headerlink" title="5.1.1 ProcessDefinitionId 的含义"></a>5.1.1 ProcessDefinitionId 的含义</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRepository</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RepositoryService repositoryService = activitiRule.getRepositoryService();</span><br><span class="line">    DeploymentBuilder deploymentBuilder1 = repositoryService.createDeployment();</span><br><span class="line">    deploymentBuilder1   <span class="comment">// 一个部署对象就记录了一次部署</span></span><br><span class="line">            .name(<span class="string">"测试部署资源1"</span>)                 <span class="comment">// 设置名称</span></span><br><span class="line">            .addClasspathResource(<span class="string">"org/destiny/activiti/my-process.bpmn20.xml"</span>)</span><br><span class="line">            .addClasspathResource(<span class="string">"org/destiny/activiti/SecondApprove.bpmn20.xml"</span>)</span><br><span class="line">            .deploy();                          <span class="comment">// 完成部署</span></span><br><span class="line"></span><br><span class="line">    DeploymentBuilder deploymentBuilder2 = repositoryService.createDeployment();</span><br><span class="line">    deploymentBuilder2   <span class="comment">// 一个部署对象就记录了一次部署</span></span><br><span class="line">            .name(<span class="string">"测试部署资源2"</span>)                 <span class="comment">// 设置名称</span></span><br><span class="line">            .addClasspathResource(<span class="string">"org/destiny/activiti/my-process.bpmn20.xml"</span>)</span><br><span class="line">            .addClasspathResource(<span class="string">"org/destiny/activiti/SecondApprove.bpmn20.xml"</span>)</span><br><span class="line">            .deploy();                          <span class="comment">// 完成部署</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询部署对象</span></span><br><span class="line">    List&lt;Deployment&gt; deploymentList = repositoryService.createDeploymentQuery()</span><br><span class="line">            .orderByDeploymenTime().asc()</span><br><span class="line">            .list();</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">"size of deploymentList: &#123;&#125;"</span>, deploymentList.size());</span><br><span class="line">    <span class="keyword">for</span> (Deployment deployment : deploymentList) &#123;</span><br><span class="line">        logger.info(<span class="string">"deployment: &#123;&#125;"</span>, deployment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 流程定义</span></span><br><span class="line">    List&lt;ProcessDefinition&gt; processDefinitionList = repositoryService</span><br><span class="line">            .createProcessDefinitionQuery()</span><br><span class="line">            .orderByProcessDefinitionKey().asc()</span><br><span class="line">            .listPage(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">for</span> (ProcessDefinition processDefinition : processDefinitionList) &#123;</span><br><span class="line">        logger.info(<span class="string">"processDefinition: &#123;&#125;, version: &#123;&#125;, key: &#123;&#125;, name: &#123;&#125;"</span>,</span><br><span class="line">                processDefinition, processDefinition.getVersion(), processDefinition.getKey(), processDefinition.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>生成的日志:</p><pre><code>08:42:45,507 [main] INFO  org.springframework.beans.factory.xml.XmlBeanDefinitionReader  - Loading XML bean definitions from class path resource [activiti.cfg.xml]08:42:47,193 [main] INFO  org.activiti.engine.compatibility.DefaultActiviti5CompatibilityHandlerFactory  - Activiti 5 compatibility handler implementation not found or error during instantiation : org.activiti.compatibility.DefaultActiviti5CompatibilityHandler. Activiti 5 backwards compatibility disabled.08:42:47,207 [main] INFO  org.activiti.engine.impl.db.DbSqlSession  - performing create on engine with resource org/activiti/db/create/activiti.h2.create.engine.sql08:42:47,268 [main] INFO  org.activiti.engine.impl.db.DbSqlSession  - performing create on history with resource org/activiti/db/create/activiti.h2.create.history.sql08:42:47,274 [main] INFO  org.activiti.engine.impl.db.DbSqlSession  - performing create on identity with resource org/activiti/db/create/activiti.h2.create.identity.sql08:42:47,280 [main] INFO  org.activiti.engine.impl.ProcessEngineImpl  - ProcessEngine default created08:42:49,736 [main] INFO  org.destiny.activiti.coreapi.RepositoryServiceTest  - size of deploymentList: 208:42:49,736 [main] INFO  org.destiny.activiti.coreapi.RepositoryServiceTest  - deployment: DeploymentEntity[id=1, name=测试部署资源1]08:42:49,736 [main] INFO  org.destiny.activiti.coreapi.RepositoryServiceTest  - deployment: DeploymentEntity[id=7, name=测试部署资源2]08:42:49,742 [main] INFO  org.destiny.activiti.coreapi.RepositoryServiceTest  - processDefinition: ProcessDefinitionEntity[SecondApprove:1:5], version: 1, key: SecondApprove, name: 二级审批08:42:49,742 [main] INFO  org.destiny.activiti.coreapi.RepositoryServiceTest  - processDefinition: ProcessDefinitionEntity[SecondApprove:2:11], version: 2, key: SecondApprove, name: 二级审批08:42:49,742 [main] INFO  org.destiny.activiti.coreapi.RepositoryServiceTest  - processDefinition: ProcessDefinitionEntity[my-process:1:6], version: 1, key: my-process, name: null08:42:49,743 [main] INFO  org.destiny.activiti.coreapi.RepositoryServiceTest  - processDefinition: ProcessDefinitionEntity[my-process:2:12], version: 2, key: my-process, name: null</code></pre><p>两个 DeploymentEntity, 一个 id 为 1, 一个 id 为 7,  id 的设置使用全局自增, 说明在两个 Deployment 对象的部署过程中插入了 6 条记录:</p><ol><li>1 个部署记录;</li><li>2 个流程定义记录;</li><li>2 个 xml 文件对应的数据流记录;</li><li>1 个流程定义所生成的图片记录;(my-process 没有生成图片)</li></ol><h3 id="5-1-2-流程挂起-激活"><a href="#5-1-2-流程挂起-激活" class="headerlink" title="5.1.2 流程挂起/激活"></a>5.1.2 流程挂起/激活</h3><p>测试代码:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@org</span>.activiti.engine.test.Deployment(resources = <span class="string">"org/destiny/activiti/my-process.bpmn20.xml"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSuspend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RepositoryService repositoryService = activitiRule.getRepositoryService();</span><br><span class="line">    ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span><br><span class="line">    String processDefinitionId = processDefinition.getId();</span><br><span class="line">    logger.info(<span class="string">"processDefinitionId: &#123;&#125;"</span>, processDefinitionId);</span><br><span class="line"></span><br><span class="line">    repositoryService.suspendProcessDefinitionById(processDefinitionId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        logger.info(<span class="string">"开始启动"</span>);</span><br><span class="line">        activitiRule.getRuntimeService().startProcessInstanceById(processDefinitionId);</span><br><span class="line">        logger.info(<span class="string">"启动成功"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(<span class="string">"启动失败, 原因: &#123;&#125;"</span>, e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    repositoryService.activateProcessDefinitionById(processDefinitionId);</span><br><span class="line">    logger.info(<span class="string">"激活后开始启动"</span>);</span><br><span class="line">    activitiRule.getRuntimeService().startProcessInstanceById(processDefinitionId);</span><br><span class="line">    logger.info(<span class="string">"激活后启动成功"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出日志:</p><pre><code>09:12:42,071 [main] INFO  org.springframework.beans.factory.xml.XmlBeanDefinitionReader  - Loading XML bean definitions from class path resource [activiti.cfg.xml]09:12:43,614 [main] INFO  org.activiti.engine.compatibility.DefaultActiviti5CompatibilityHandlerFactory  - Activiti 5 compatibility handler implementation not found or error during instantiation : org.activiti.compatibility.DefaultActiviti5CompatibilityHandler. Activiti 5 backwards compatibility disabled.09:12:43,627 [main] INFO  org.activiti.engine.impl.db.DbSqlSession  - performing create on engine with resource org/activiti/db/create/activiti.h2.create.engine.sql09:12:43,682 [main] INFO  org.activiti.engine.impl.db.DbSqlSession  - performing create on history with resource org/activiti/db/create/activiti.h2.create.history.sql09:12:43,688 [main] INFO  org.activiti.engine.impl.db.DbSqlSession  - performing create on identity with resource org/activiti/db/create/activiti.h2.create.identity.sql09:12:43,692 [main] INFO  org.activiti.engine.impl.ProcessEngineImpl  - ProcessEngine default created09:12:43,882 [main] INFO  org.destiny.activiti.coreapi.RepositoryServiceTest  - processDefinitionId: my-process:1:309:12:43,887 [main] INFO  org.destiny.activiti.coreapi.RepositoryServiceTest  - 开始启动09:12:43,893 [main] ERROR org.activiti.engine.impl.interceptor.CommandContext  - Error while closing command contextorg.activiti.engine.ActivitiException: Cannot start process instance. Process definition null (id = my-process:1:3) is suspended    at org.activiti.engine.impl.util.ProcessInstanceHelper.createAndStartProcessInstance(ProcessInstanceHelper.java:67)    at org.activiti.engine.impl.util.ProcessInstanceHelper.createAndStartProcessInstance(ProcessInstanceHelper.java:51)    at org.activiti.engine.impl.cmd.StartProcessInstanceCmd.createAndStartProcessInstance(StartProcessInstanceCmd.java:109)    at org.activiti.engine.impl.cmd.StartProcessInstanceCmd.execute(StartProcessInstanceCmd.java:102)    at org.activiti.engine.impl.cmd.StartProcessInstanceCmd.execute(StartProcessInstanceCmd.java:37)    at org.activiti.engine.impl.interceptor.CommandInvoker$1.run(CommandInvoker.java:37)    at org.activiti.engine.impl.interceptor.CommandInvoker.executeOperation(CommandInvoker.java:78)    at org.activiti.engine.impl.interceptor.CommandInvoker.executeOperations(CommandInvoker.java:57)    at org.activiti.engine.impl.interceptor.CommandInvoker.execute(CommandInvoker.java:42)    at org.activiti.engine.impl.interceptor.TransactionContextInterceptor.execute(TransactionContextInterceptor.java:48)    at org.activiti.engine.impl.interceptor.CommandContextInterceptor.execute(CommandContextInterceptor.java:63)    at org.activiti.engine.impl.interceptor.LogInterceptor.execute(LogInterceptor.java:29)    at org.activiti.engine.impl.cfg.CommandExecutorImpl.execute(CommandExecutorImpl.java:44)    at org.activiti.engine.impl.cfg.CommandExecutorImpl.execute(CommandExecutorImpl.java:39)    at org.activiti.engine.impl.RuntimeServiceImpl.startProcessInstanceById(RuntimeServiceImpl.java:114)    at org.destiny.activiti.coreapi.RepositoryServiceTest.testSuspend(RepositoryServiceTest.java:86)    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)    at java.lang.reflect.Method.invoke(Method.java:498)    at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)    at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)    at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)    at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)    at org.activiti.engine.test.ActivitiRule$1.evaluate(ActivitiRule.java:116)    at org.junit.rules.RunRules.evaluate(RunRules.java:20)    at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:271)    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70)    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:50)    at org.junit.runners.ParentRunner$3.run(ParentRunner.java:238)    at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:63)    at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:236)    at org.junit.runners.ParentRunner.access$000(ParentRunner.java:53)    at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:229)    at org.junit.runners.ParentRunner.run(ParentRunner.java:309)    at org.junit.runner.JUnitCore.run(JUnitCore.java:160)    at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68)    at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:47)    at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:242)    at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:70)09:12:43,895 [main] ERROR org.destiny.activiti.coreapi.RepositoryServiceTest  - 启动失败, 原因: Cannot start process instance. Process definition null (id = my-process:1:3) is suspended09:12:43,897 [main] INFO  org.destiny.activiti.coreapi.RepositoryServiceTest  - 激活后开始启动09:12:43,923 [main] INFO  org.destiny.activiti.coreapi.RepositoryServiceTest  - 激活后启动成功</code></pre><h3 id="5-1-3-绑定用户-用户组"><a href="#5-1-3-绑定用户-用户组" class="headerlink" title="5.1.3 绑定用户/用户组"></a>5.1.3 绑定用户/用户组</h3><blockquote></blockquote><p>测试代码:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试用户组</span></span><br><span class="line"><span class="comment"> * repositoryService 只提供了构建关系的方式, 具体的校验逻辑需要自己完成</span></span><br><span class="line"><span class="comment"> * 可以取出用户/用户组信息, 自行通过逻辑判断</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@org</span>.activiti.engine.test.Deployment(resources = <span class="string">"org/destiny/activiti/my-process.bpmn20.xml"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCandidateStarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RepositoryService repositoryService = activitiRule.getRepositoryService();</span><br><span class="line">    ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span><br><span class="line">    String processDefinitionId = processDefinition.getId();</span><br><span class="line">    logger.info(<span class="string">"processDefinitionId: &#123;&#125;"</span>, processDefinitionId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// userId/groupM 是对应的用户/用户组管理服务中创建的 id</span></span><br><span class="line">    repositoryService.addCandidateStarterUser(processDefinitionId, <span class="string">"user"</span>);</span><br><span class="line">    repositoryService.addCandidateStarterGroup(processDefinitionId, <span class="string">"groupM"</span>);</span><br><span class="line"></span><br><span class="line">    List&lt;IdentityLink&gt; identityLinkList = repositoryService.getIdentityLinksForProcessDefinition(processDefinitionId);</span><br><span class="line">    <span class="keyword">for</span> (IdentityLink identityLink : identityLinkList) &#123;</span><br><span class="line">        logger.info(<span class="string">"删除前: identityLink: [&#123;&#125;]"</span>, identityLink);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    repositoryService.deleteCandidateStarterGroup(processDefinitionId, <span class="string">"groupM"</span>);</span><br><span class="line">    repositoryService.deleteCandidateStarterUser(processDefinitionId, <span class="string">"user"</span>);</span><br><span class="line"></span><br><span class="line">    List&lt;IdentityLink&gt; identityLinkList1 = repositoryService.getIdentityLinksForProcessDefinition(processDefinitionId);</span><br><span class="line">    <span class="keyword">for</span> (IdentityLink identityLink : identityLinkList1) &#123;</span><br><span class="line">        logger.info(<span class="string">"删除后: identityLink: [&#123;&#125;]"</span>, identityLink);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>日志输出:</p><pre><code>10:08:35,380 [main] INFO  org.springframework.beans.factory.xml.XmlBeanDefinitionReader  - Loading XML bean definitions from class path resource [activiti.cfg.xml]10:08:36,784 [main] INFO  org.activiti.engine.compatibility.DefaultActiviti5CompatibilityHandlerFactory  - Activiti 5 compatibility handler implementation not found or error during instantiation : org.activiti.compatibility.DefaultActiviti5CompatibilityHandler. Activiti 5 backwards compatibility disabled.10:08:36,796 [main] INFO  org.activiti.engine.impl.db.DbSqlSession  - performing create on engine with resource org/activiti/db/create/activiti.h2.create.engine.sql10:08:36,842 [main] INFO  org.activiti.engine.impl.db.DbSqlSession  - performing create on history with resource org/activiti/db/create/activiti.h2.create.history.sql10:08:36,846 [main] INFO  org.activiti.engine.impl.db.DbSqlSession  - performing create on identity with resource org/activiti/db/create/activiti.h2.create.identity.sql10:08:36,849 [main] INFO  org.activiti.engine.impl.ProcessEngineImpl  - ProcessEngine default created10:08:37,009 [main] INFO  org.destiny.activiti.coreapi.RepositoryServiceTest  - processDefinitionId: my-process:1:310:08:37,016 [main] INFO  org.destiny.activiti.coreapi.RepositoryServiceTest  - 删除前: identityLink: [IdentityLinkEntity[id=4, type=candidate, userId=user, processDefId=my-process:1:3]]10:08:37,016 [main] INFO  org.destiny.activiti.coreapi.RepositoryServiceTest  - 删除前: identityLink: [IdentityLinkEntity[id=5, type=candidate, groupId=groupM, processDefId=my-process:1:3]]</code></pre><h2 id="5-2-RuntimeService-流程运行控制服务"><a href="#5-2-RuntimeService-流程运行控制服务" class="headerlink" title="5.2 RuntimeService 流程运行控制服务"></a>5.2 RuntimeService 流程运行控制服务</h2><p>功能:</p><ul><li>启动流程及对流程数据的控制</li><li>流程实例(ProcessInstance)与执行流(Execution)查询(当创建实例的时候, 一般也会创建一个执行流)</li><li>触发流程操作, 接受信号的消息</li></ul><p>Runtime 启动流程及变量管理:</p><ul><li>启动流程的常用方式(id, key, message)</li><li>启动流程可选参数:<ul><li>businessKey</li><li>variables</li><li>tenantId</li></ul></li><li>变量(variables)的设置和获取</li></ul><h3 id="5-2-1-基本操作"><a href="#5-2-1-基本操作" class="headerlink" title="5.2.1 基本操作"></a>5.2.1 基本操作</h3><h4 id="5-2-1-1-根据流程定义-key-启动流程"><a href="#5-2-1-1-根据流程定义-key-启动流程" class="headerlink" title="5.2.1.1 根据流程定义 key 启动流程"></a>5.2.1.1 根据流程定义 key 启动流程</h4><blockquote><p>每次流程部署时, 对应 ProcessDefintion 的 id 和 version 都会改变, 根据 ProcessDefintionKey 默认取最后一个版本的数据</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testStartProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RuntimeService runtimeService = activitiRule.getRuntimeService();</span><br><span class="line">    Map&lt;String, Object&gt; variables = Maps.newHashMap();</span><br><span class="line">    variables.put(<span class="string">"key1"</span>, <span class="string">"value1"</span>);</span><br><span class="line">    </span><br><span class="line">    ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"my-process"</span>, variables);</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">"processInstance: &#123;&#125;"</span>, processInstance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-2-1-2-根据流程定义-id"><a href="#5-2-1-2-根据流程定义-id" class="headerlink" title="5.2.1.2 根据流程定义 id"></a>5.2.1.2 根据流程定义 id</h4><blockquote><p>使用 ProcessDefintionId 进行获取的时候, 需要先通过 <code>RepositoryService</code> 获取到对应的 id</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据流程定义 id 启动流程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testStartProcessById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RepositoryService repositoryService = activitiRule.getRepositoryService();</span><br><span class="line">    ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().singleResult();</span><br><span class="line">    RuntimeService runtimeService = activitiRule.getRuntimeService();</span><br><span class="line">    Map&lt;String, Object&gt; variables = Maps.newHashMap();</span><br><span class="line">    variables.put(<span class="string">"key1"</span>, <span class="string">"value1"</span>);</span><br><span class="line">    ProcessInstance processInstance = runtimeService.startProcessInstanceById(processDefinition.getId(), variables);</span><br><span class="line">    log.info(<span class="string">"processInstance: &#123;&#125;"</span>, processInstance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-2-1-3-通过-ProcessInstanceBuilder-完成流程的设置以及启动"><a href="#5-2-1-3-通过-ProcessInstanceBuilder-完成流程的设置以及启动" class="headerlink" title="5.2.1.3 通过 ProcessInstanceBuilder 完成流程的设置以及启动"></a>5.2.1.3 通过 ProcessInstanceBuilder 完成流程的设置以及启动</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testProcessBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RuntimeService runtimeService = activitiRule.getRuntimeService();</span><br><span class="line">    Map&lt;String, Object&gt; variables = Maps.newHashMap();</span><br><span class="line">    variables.put(<span class="string">"key1"</span>, <span class="string">"value1"</span>);</span><br><span class="line">    ProcessInstance processInstance = runtimeService.createProcessInstanceBuilder()</span><br><span class="line">            .businessKey(<span class="string">"businessKey001"</span>)</span><br><span class="line">            .processDefinitionKey(<span class="string">"my-process"</span>)</span><br><span class="line">            .variables(variables)</span><br><span class="line">            .start();</span><br><span class="line">    log.info(<span class="string">"processInstance: &#123;&#125;"</span>, processInstance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-2-1-4-设置和获取流程变量"><a href="#5-2-1-4-设置和获取流程变量" class="headerlink" title="5.2.1.4 设置和获取流程变量"></a>5.2.1.4 设置和获取流程变量</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testVariables</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RuntimeService runtimeService = activitiRule.getRuntimeService();</span><br><span class="line">    Map&lt;String, Object&gt; variables = Maps.newHashMap();</span><br><span class="line">    variables.put(<span class="string">"key1"</span>, <span class="string">"value1"</span>);</span><br><span class="line">    variables.put(<span class="string">"key2"</span>, <span class="string">"value2"</span>);</span><br><span class="line">    variables.put(<span class="string">"key3"</span>, <span class="string">"value3"</span>);</span><br><span class="line">    ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"my-process"</span>, variables);</span><br><span class="line">    log.info(<span class="string">"processInstance: &#123;&#125;"</span>, processInstance);</span><br><span class="line">    <span class="comment">// 覆盖原有内容</span></span><br><span class="line">    runtimeService.setVariable(processInstance.getId(), <span class="string">"key3"</span>, <span class="string">"newValue4"</span>);</span><br><span class="line">    runtimeService.setVariable(processInstance.getId(), <span class="string">"key4"</span>, <span class="string">"value4"</span>);</span><br><span class="line">    <span class="comment">// 根据流程实例 id 获取流程变量</span></span><br><span class="line">    Map&lt;String, Object&gt; map = runtimeService.getVariables(processInstance.getId());</span><br><span class="line">    log.info(<span class="string">"variable map: &#123;&#125;"</span>, map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>日志输出:</p><pre><code>11:55:06.844 [main] [INFO] variable map: {key1=value1, key2=value2, key3=newValue4, key4=value4}  o.d.a.c.RuntimeServiceTest.testVariables:94</code></pre><h4 id="5-2-1-5-对流程实例的查询"><a href="#5-2-1-5-对流程实例的查询" class="headerlink" title="5.2.1.5 对流程实例的查询"></a>5.2.1.5 对流程实例的查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testProcessInstanceQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RuntimeService runtimeService = activitiRule.getRuntimeService();</span><br><span class="line">    Map&lt;String, Object&gt; variables = Maps.newHashMap();</span><br><span class="line">    ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"my-process"</span>, variables);</span><br><span class="line">    log.info(<span class="string">"processInstance: &#123;&#125;"</span>, processInstance);</span><br><span class="line">    ProcessInstance processInstance1 = runtimeService.createProcessInstanceQuery()</span><br><span class="line">            .processInstanceId(processInstance.getId())</span><br><span class="line">            .singleResult();</span><br><span class="line">    log.info(<span class="string">"processInstance1: &#123;&#125;"</span>, processInstance1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-2-1-6-对执行流的查询"><a href="#5-2-1-6-对执行流的查询" class="headerlink" title="5.2.1.6 对执行流的查询"></a>5.2.1.6 对执行流的查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testExecutionQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RuntimeService runtimeService = activitiRule.getRuntimeService();</span><br><span class="line">    Map&lt;String, Object&gt; variables = Maps.newHashMap();</span><br><span class="line">    ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"my-process"</span>, variables);</span><br><span class="line">    log.info(<span class="string">"processInstance: &#123;&#125;"</span>, processInstance);</span><br><span class="line">    List&lt;Execution&gt; executionList = runtimeService.createExecutionQuery()</span><br><span class="line">            .listPage(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">for</span> (Execution execution : executionList) &#123;</span><br><span class="line">        log.info(<span class="string">"execution: &#123;&#125;"</span>, execution);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-2-2-流程实例与执行流"><a href="#5-2-2-流程实例与执行流" class="headerlink" title="5.2.2 流程实例与执行流"></a>5.2.2 流程实例与执行流</h3><ul><li><code>流程实例(ProcessInstance)</code> 表示一次工作流业务的数据实体, 当每次启动流程的时候, 生成一个流程实例</li><li><code>执行流(Execution)</code> 表示流程实例中具体的执行路径, 如果简单的流程只有一条执行路径, 那么此时流程实例和执行流是一对一的关系</li><li>流程实例接口继承与执行流</li></ul><h3 id="5-2-3-流程触发"><a href="#5-2-3-流程触发" class="headerlink" title="5.2.3 流程触发"></a>5.2.3 流程触发</h3><ul><li>使用 trigger 触发 receiveTask 节点</li><li>触发信号捕获事件 singalEventRecivied(信号可以全局发送)</li><li>触发消息捕获事件 messageEventReceived(消息只能针对某一个流程实例)</li></ul><h4 id="5-2-3-1-流程触发-trigger"><a href="#5-2-3-1-流程触发-trigger" class="headerlink" title="5.2.3.1 流程触发 trigger"></a>5.2.3.1 流程触发 trigger</h4><p><img src="https://i.stack.imgur.com/CoNyK.png" alt=""></p><h5 id="流程配置文件"><a href="#流程配置文件" class="headerlink" title="流程配置文件"></a>流程配置文件</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:activiti</span>=<span class="string">"http://activiti.org/bpmn"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:bpmndi</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/DI"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdc</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DC"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdi</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="attr">typeLanguage</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">expressionLanguage</span>=<span class="string">"http://www.w3.org/1999/XPath"</span> <span class="attr">targetNamespace</span>=<span class="string">"http://www.activiti.org/test"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"my-process"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"start"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow1"</span> <span class="attr">sourceRef</span>=<span class="string">"start"</span> <span class="attr">targetRef</span>=<span class="string">"someTask"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;userTask id="someTask" name="Activiti is awesome!"/&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiveTask</span> <span class="attr">id</span>=<span class="string">"someTask"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow2"</span> <span class="attr">sourceRef</span>=<span class="string">"someTask"</span> <span class="attr">targetRef</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process-trigger.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTrigger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RuntimeService runtimeService = activitiRule.getRuntimeService();</span><br><span class="line">    ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"my-process"</span>);</span><br><span class="line">    <span class="comment">// 开始流程后流程实例就会在 receiveTask 节点等待处理</span></span><br><span class="line">    Execution execution = runtimeService.createExecutionQuery()</span><br><span class="line">            .activityId(<span class="string">"someTask"</span>)</span><br><span class="line">            .singleResult();</span><br><span class="line">    log.info(<span class="string">"execution: &#123;&#125;"</span>, execution);</span><br><span class="line">    runtimeService.trigger(execution.getId());</span><br><span class="line">    <span class="comment">// 再次查询</span></span><br><span class="line">    execution = runtimeService.createExecutionQuery()</span><br><span class="line">            .activityId(<span class="string">"someTask"</span>)</span><br><span class="line">            .singleResult();</span><br><span class="line">    log.info(<span class="string">"execution: &#123;&#125;"</span>, execution);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="输出日志"><a href="#输出日志" class="headerlink" title="输出日志"></a>输出日志</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">14:59:58.256 [main] [INFO] execution: Execution[ id &apos;5&apos; ] - activity &apos;someTask - parent &apos;4&apos;  o.d.a.c.RuntimeServiceTest.testTrigger:137</span><br><span class="line">14:59:58.291 [main] [INFO] execution: null  o.d.a.c.RuntimeServiceTest.testTrigger:142]</span><br></pre></td></tr></table></figure><blockquote><p>当完成了触发之后, 执行对象已经执行完成</p></blockquote><h4 id="5-2-3-2-流程触发-singalEventReceived"><a href="#5-2-3-2-流程触发-singalEventReceived" class="headerlink" title="5.2.3.2 流程触发 singalEventReceived"></a>5.2.3.2 流程触发 singalEventReceived</h4><blockquote><p>流程开始后, 流程会暂停在中间节点(SingalCatchingEvent), 当它获取到信号时间的时候, 才会继续流转</p></blockquote><p><img src="https://i.stack.imgur.com/TJv25.png" alt=""></p><h5 id="流程定义文件-1"><a href="#流程定义文件-1" class="headerlink" title="流程定义文件"></a>流程定义文件</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:activiti</span>=<span class="string">"http://activiti.org/bpmn"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:bpmndi</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/DI"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdc</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DC"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdi</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="attr">typeLanguage</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">expressionLanguage</span>=<span class="string">"http://www.w3.org/1999/XPath"</span> <span class="attr">targetNamespace</span>=<span class="string">"http://www.activiti.org/test"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">signal</span> <span class="attr">id</span>=<span class="string">"signalStart"</span> <span class="attr">name</span>=<span class="string">"my-signal"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"my-process"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"start"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow1"</span> <span class="attr">sourceRef</span>=<span class="string">"start"</span> <span class="attr">targetRef</span>=<span class="string">"signal-received"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 定义捕获边界事件, 当该节点接收到 my-signal 信号后会继续向后流转 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">intermediateCatchEvent</span> <span class="attr">id</span>=<span class="string">"signal-received"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">signalEventDefinition</span> <span class="attr">signalRef</span>=<span class="string">"signalStart"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">intermediateCatchEvent</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;userTask id="someTask" name="Activiti is awesome!"/&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow2"</span> <span class="attr">sourceRef</span>=<span class="string">"signal-received"</span> <span class="attr">targetRef</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="测试代码-1"><a href="#测试代码-1" class="headerlink" title="测试代码"></a>测试代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process-signal.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSignalEventReceived</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RuntimeService runtimeService = activitiRule.getRuntimeService();</span><br><span class="line">    ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"my-process"</span>);</span><br><span class="line">    <span class="comment">// 查询数据库是否有一个正在等待信号的节点</span></span><br><span class="line">    Execution execution = runtimeService.createExecutionQuery()</span><br><span class="line">            .signalEventSubscriptionName(<span class="string">"my-signal"</span>)</span><br><span class="line">            .singleResult();</span><br><span class="line">    log.info(<span class="string">"execution: &#123;&#125;"</span>, execution);</span><br><span class="line">    <span class="comment">// 触发信号</span></span><br><span class="line">    runtimeService.signalEventReceived(<span class="string">"my-signal"</span>);</span><br><span class="line">    <span class="comment">// 重新执行查询</span></span><br><span class="line">    execution = runtimeService.createExecutionQuery()</span><br><span class="line">            .signalEventSubscriptionName(<span class="string">"my-signal"</span>)</span><br><span class="line">            .singleResult();</span><br><span class="line">    log.info(<span class="string">"execution: &#123;&#125;"</span>, execution);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="日志输出-4"><a href="#日志输出-4" class="headerlink" title="日志输出"></a>日志输出</h5><pre><code>15:14:42.184 [main] [INFO] execution: Execution[ id &apos;5&apos; ] - activity &apos;signal-received - parent &apos;4&apos;  o.d.a.c.RuntimeServiceTest.testSignalEventReceived:15515:14:42.216 [main] [INFO] execution: null  o.d.a.c.RuntimeServiceTest.testSignalEventReceived:163</code></pre><h4 id="5-2-3-3-流程触发-messageEventReceived"><a href="#5-2-3-3-流程触发-messageEventReceived" class="headerlink" title="5.2.3.3 流程触发 messageEventReceived"></a>5.2.3.3 流程触发 messageEventReceived</h4><blockquote><p>消息触发与信号触发非常相似, 唯一的不同是: 信号与具体的流程实例无关, 消息在执行过程中必须制定流程实例 id</p></blockquote><p><img src="https://i.stack.imgur.com/KxdJB.png" alt=""></p><h4 id="流程定义文件-2"><a href="#流程定义文件-2" class="headerlink" title="流程定义文件"></a>流程定义文件</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:activiti</span>=<span class="string">"http://activiti.org/bpmn"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:bpmndi</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/DI"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdc</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DC"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdi</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="attr">typeLanguage</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">expressionLanguage</span>=<span class="string">"http://www.w3.org/1999/XPath"</span> <span class="attr">targetNamespace</span>=<span class="string">"http://www.activiti.org/test"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">message</span> <span class="attr">id</span>=<span class="string">"messageStart"</span> <span class="attr">name</span>=<span class="string">"my-message"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"my-process"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"start"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow1"</span> <span class="attr">sourceRef</span>=<span class="string">"start"</span> <span class="attr">targetRef</span>=<span class="string">"message-received"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 定义捕获边界事件, 当该节点接收到 my-message 消息后会继续向后流转 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">intermediateCatchEvent</span> <span class="attr">id</span>=<span class="string">"message-received"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">messageEventDefinition</span> <span class="attr">messageRef</span>=<span class="string">"messageStart"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">intermediateCatchEvent</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;userTask id="someTask" name="Activiti is awesome!"/&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow2"</span> <span class="attr">sourceRef</span>=<span class="string">"message-received"</span> <span class="attr">targetRef</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="测试代码-2"><a href="#测试代码-2" class="headerlink" title="测试代码"></a>测试代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process-message.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMessageEventReceived</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RuntimeService runtimeService = activitiRule.getRuntimeService();</span><br><span class="line">    ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span class="string">"my-process"</span>);</span><br><span class="line">    <span class="comment">// 查询数据库是否有一个正在等待信号的节点</span></span><br><span class="line">    Execution execution = runtimeService.createExecutionQuery()</span><br><span class="line">            .messageEventSubscriptionName(<span class="string">"my-message"</span>)   <span class="comment">// 查询订阅了该信号的执行流</span></span><br><span class="line">            .singleResult();</span><br><span class="line">    log.info(<span class="string">"execution: &#123;&#125;"</span>, execution);</span><br><span class="line">    <span class="comment">// 触发消息, 不同于信号的触发, message 在触发时需要指定 executionId</span></span><br><span class="line">    runtimeService.messageEventReceived(<span class="string">"my-message"</span>, execution.getId());</span><br><span class="line">    <span class="comment">// 重新执行查询</span></span><br><span class="line">    execution = runtimeService.createExecutionQuery()</span><br><span class="line">            .messageEventSubscriptionName(<span class="string">"my-message"</span>)</span><br><span class="line">            .singleResult();</span><br><span class="line">    log.info(<span class="string">"execution: &#123;&#125;"</span>, execution);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="日志输出-5"><a href="#日志输出-5" class="headerlink" title="日志输出"></a>日志输出</h5><pre><code>15:37:52.024 [main] [INFO] execution: Execution[ id &apos;5&apos; ] - activity &apos;message-received - parent &apos;4&apos;  o.d.a.c.RuntimeServiceTest.testMessageEventReceived:17515:37:52.054 [main] [INFO] execution: null  o.d.a.c.RuntimeServiceTest.testMessageEventReceived:183</code></pre><h4 id="5-2-3-4-流程基于-message-启动"><a href="#5-2-3-4-流程基于-message-启动" class="headerlink" title="5.2.3.4 流程基于 message 启动"></a>5.2.3.4 流程基于 message 启动</h4><h5 id="流程定义"><a href="#流程定义" class="headerlink" title="流程定义"></a>流程定义</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:activiti</span>=<span class="string">"http://activiti.org/bpmn"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:bpmndi</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/DI"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdc</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DC"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdi</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="attr">typeLanguage</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">expressionLanguage</span>=<span class="string">"http://www.w3.org/1999/XPath"</span> <span class="attr">targetNamespace</span>=<span class="string">"http://www.activiti.org/test"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 此时既可以基于 key 启动, 也可以基于 message 启动 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">message</span> <span class="attr">id</span>=<span class="string">"messageStart"</span> <span class="attr">name</span>=<span class="string">"my-message"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"my-process"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 需要将 messageEventDefinition 放在开始节点 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"start"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">messageEventDefinition</span> <span class="attr">messageRef</span>=<span class="string">"messageStart"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow1"</span> <span class="attr">sourceRef</span>=<span class="string">"start"</span> <span class="attr">targetRef</span>=<span class="string">"someTask"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"someTask"</span> <span class="attr">name</span>=<span class="string">"Activiti is awesome!"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow2"</span> <span class="attr">sourceRef</span>=<span class="string">"someTask"</span> <span class="attr">targetRef</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="测试代码-3"><a href="#测试代码-3" class="headerlink" title="测试代码"></a>测试代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process-message-start.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMessageStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RuntimeService runtimeService = activitiRule.getRuntimeService();</span><br><span class="line">    ProcessInstance processInstance = runtimeService.startProcessInstanceByMessage(<span class="string">"my-message"</span>);</span><br><span class="line">    log.info(<span class="string">"processInstance: &#123;&#125;"</span>, processInstance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="日志输出-6"><a href="#日志输出-6" class="headerlink" title="日志输出"></a>日志输出</h5><pre><code>15:45:12.844 [main] [INFO] processInstance: ProcessInstance[5]  o.d.a.c.RuntimeServiceTest.testMessageStart:195</code></pre><blockquote><p>基于 message 启动流程时, ProcessInstance 的 id 是 5, 意味着在流程订阅表中多插入了一条数据, 在实际启动过程中, 还是通过 message 找到 ProcessDefinition 的 key, 最终根据 key 来启动</p></blockquote><h2 id="5-3-TaskService-任务管理服务"><a href="#5-3-TaskService-任务管理服务" class="headerlink" title="5.3 TaskService 任务管理服务"></a>5.3 TaskService 任务管理服务</h2><p>TaskService 提供的功能:</p><ul><li>对用户任务管理和流程的控制</li><li>设置用户任务的权限信息(拥有者/候选人/办理人)</li><li>针对用户任务添加任务附件, 任务评论和事件记录</li></ul><p>TaskService 对 Task 管理与流程控制:</p><ul><li>Task 对象的创建, 删除</li><li>查询 Task, 并驱动 Task 节点完成执行</li><li>Task 相关参数变量设置<ul><li>local 变量</li><li>非 local 变量</li></ul></li></ul><h3 id="5-3-1-基本操作"><a href="#5-3-1-基本操作" class="headerlink" title="5.3.1 基本操作"></a>5.3.1 基本操作</h3><h4 id="5-3-1-1-获取-task-设置变量-驱动完成"><a href="#5-3-1-1-获取-task-设置变量-驱动完成" class="headerlink" title="5.3.1.1 获取 task/ 设置变量/ 驱动完成"></a>5.3.1.1 获取 task/ 设置变量/ 驱动完成</h4><h5 id="流程定义文件-3"><a href="#流程定义文件-3" class="headerlink" title="流程定义文件"></a>流程定义文件</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:activiti</span>=<span class="string">"http://activiti.org/bpmn"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:bpmndi</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/DI"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdc</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DC"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdi</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="attr">typeLanguage</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">expressionLanguage</span>=<span class="string">"http://www.w3.org/1999/XPath"</span> <span class="attr">targetNamespace</span>=<span class="string">"http://www.activiti.org/test"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"my-process"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"start"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow1"</span> <span class="attr">sourceRef</span>=<span class="string">"start"</span> <span class="attr">targetRef</span>=<span class="string">"someTask"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 添加候选人 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"someTask"</span> <span class="attr">name</span>=<span class="string">"Activiti is awesome!"</span> <span class="attr">activiti:candidateUsers</span>=<span class="string">"destiny,destiny1,destiny2"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 添加描述, message 会根据上下文中传入的 message 变量值去替换 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">documentation</span>&gt;</span></span><br><span class="line">                some task $&#123;message&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow2"</span> <span class="attr">sourceRef</span>=<span class="string">"someTask"</span> <span class="attr">targetRef</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="测试代码-4"><a href="#测试代码-4" class="headerlink" title="测试代码"></a>测试代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process-task.bpmn20.xml"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTaskService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; variables = Maps.newHashMap();</span><br><span class="line">        variables.put(<span class="string">"message"</span>, <span class="string">"my test message"</span>);</span><br><span class="line">        TaskService taskService = activitiRule.getTaskService();</span><br><span class="line">        <span class="comment">// 部署流程定义文件</span></span><br><span class="line">        ProcessInstance processInstance = activitiRule.getRuntimeService()</span><br><span class="line">                .startProcessInstanceByKey(<span class="string">"my-process"</span>, variables);</span><br><span class="line">        Task task = taskService.createTaskQuery().singleResult();</span><br><span class="line">        log.info(<span class="string">"task: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(task, ToStringStyle.JSON_STYLE));</span><br><span class="line">        log.info(<span class="string">"task.description: &#123;&#125;"</span>, task.getDescription());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置变量</span></span><br><span class="line">        taskService.setVariable(task.getId(), <span class="string">"k1"</span>, <span class="string">"v1"</span>);</span><br><span class="line">        taskService.setVariableLocal(task.getId(), <span class="string">"localK1"</span>, <span class="string">"localV1"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// local 只在 task 范围可见</span></span><br><span class="line">        Map&lt;String, Object&gt; taskServiceVariables = taskService.getVariables(task.getId());</span><br><span class="line">        Map&lt;String, Object&gt; taskServiceVariablesLocal = taskService.getVariablesLocal(task.getId());</span><br><span class="line">        <span class="comment">// 根据流程获取</span></span><br><span class="line">        Map&lt;String, Object&gt; processVariables = activitiRule.getRuntimeService().getVariables(task.getExecutionId());</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"taskServiceVariables: &#123;&#125;"</span>, taskServiceVariables);             <span class="comment">// &#123;k1=v1, localK1=localV1, message=my test message&#125;</span></span><br><span class="line">        log.info(<span class="string">"taskServiceVariablesLocal: &#123;&#125;"</span>, taskServiceVariablesLocal);   <span class="comment">// &#123;localK1=localV1&#125;</span></span><br><span class="line">        log.info(<span class="string">"processVariables: &#123;&#125;"</span>, processVariables);                     <span class="comment">// &#123;k1=v1, message=my test message&#125;</span></span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; completeVar = Maps.newHashMap();</span><br><span class="line">        completeVar.put(<span class="string">"cKey1"</span>, <span class="string">"cValue1"</span>);</span><br><span class="line">        taskService.complete(task.getId(), completeVar);</span><br><span class="line"></span><br><span class="line">        Task task1 = taskService.createTaskQuery().taskId(task.getId()).singleResult();</span><br><span class="line">        log.info(<span class="string">"task1: &#123;&#125;"</span>, task1);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h5 id="日志输出-7"><a href="#日志输出-7" class="headerlink" title="日志输出"></a>日志输出</h5><pre><code>16:13:26.654 [main] [INFO] Loading XML bean definitions from class path resource [activiti.cfg.xml]  o.s.b.f.x.XmlBeanDefinitionReader.loadBeanDefinitions:31616:13:28.438 [main] [INFO] Activiti 5 compatibility handler implementation not found or error during instantiation : org.activiti.compatibility.DefaultActiviti5CompatibilityHandler. Activiti 5 backwards compatibility disabled.  o.a.e.c.DefaultActiviti5CompatibilityHandlerFactory.createActiviti5CompatibilityHandler:3816:13:28.451 [main] [INFO] performing create on engine with resource org/activiti/db/create/activiti.h2.create.engine.sql  o.a.e.i.d.DbSqlSession.executeSchemaResource:114716:13:28.527 [main] [INFO] performing create on history with resource org/activiti/db/create/activiti.h2.create.history.sql  o.a.e.i.d.DbSqlSession.executeSchemaResource:114716:13:28.535 [main] [INFO] performing create on identity with resource org/activiti/db/create/activiti.h2.create.identity.sql  o.a.e.i.d.DbSqlSession.executeSchemaResource:114716:13:28.541 [main] [INFO] ProcessEngine default created  o.a.e.i.ProcessEngineImpl.&lt;init&gt;:8716:13:28.793 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:13:28.796 [main] [INFO] 4 (process instance)└── 6 : start (StartEvent, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:13:28.798 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:13:28.799 [main] [INFO] 4 (process instance)└── 6 : start (StartEvent, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:13:28.800 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:13:28.800 [main] [INFO] 4 (process instance)└── 6 : start -&gt; someTask, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:13:28.802 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:13:28.802 [main] [INFO] 4 (process instance)└── 6 : someTask (UserTask, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:13:28.878 [main] [INFO] task: {&quot;owner&quot;:null,&quot;assigneeUpdatedCount&quot;:0,&quot;originalAssignee&quot;:null,&quot;assignee&quot;:null,&quot;delegationState&quot;:null,&quot;parentTaskId&quot;:null,&quot;name&quot;:&quot;Activiti is awesome!&quot;,&quot;localizedName&quot;:null,&quot;description&quot;:&quot;some task my test message&quot;,&quot;localizedDescription&quot;:null,&quot;priority&quot;:50,&quot;createTime&quot;:&quot;Mon Dec 03 16:13:28 CST 2018&quot;,&quot;dueDate&quot;:null,&quot;suspensionState&quot;:1,&quot;category&quot;:null,&quot;isIdentityLinksInitialized&quot;:false,&quot;taskIdentityLinkEntities&quot;:[],&quot;executionId&quot;:&quot;6&quot;,&quot;execution&quot;:null,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;processInstance&quot;:null,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;taskDefinitionKey&quot;:&quot;someTask&quot;,&quot;formKey&quot;:null,&quot;isDeleted&quot;:false,&quot;isCanceled&quot;:false,&quot;eventName&quot;:null,&quot;currentActivitiListener&quot;:null,&quot;tenantId&quot;:&quot;&quot;,&quot;queryVariables&quot;:null,&quot;forcedUpdate&quot;:false,&quot;claimTime&quot;:null,&quot;variableInstances&quot;:null,&quot;usedVariablesCache&quot;:{},&quot;transientVariabes&quot;:null,&quot;cachedElContext&quot;:null,&quot;id&quot;:&quot;9&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}  o.d.a.c.TaskServiceTest.testTaskService:3316:13:28.878 [main] [INFO] task.description: some task my test message  o.d.a.c.TaskServiceTest.testTaskService:3416:13:28.893 [main] [INFO] taskServiceVariables: {k1=v1, localK1=localV1, message=my test message}  o.d.a.c.TaskServiceTest.testTaskService:4616:13:28.893 [main] [INFO] taskServiceVariablesLocal: {localK1=localV1}  o.d.a.c.TaskServiceTest.testTaskService:4716:13:28.893 [main] [INFO] processVariables: {k1=v1, message=my test message}  o.d.a.c.TaskServiceTest.testTaskService:4816:13:28.893 [main] [INFO] 4 (process instance)└── 6 : someTask (UserTask, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:13:28.893 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:13:28.893 [main] [INFO] 4 (process instance)└── 6 : someTask (UserTask, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:13:28.893 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:13:28.893 [main] [INFO] 4 (process instance)└── 6 : someTask -&gt; end, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:13:28.893 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:13:28.893 [main] [INFO] 4 (process instance)└── 6 : end (EndEvent, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:13:28.893 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:13:28.893 [main] [INFO] 4 (process instance)└── 6 : end (EndEvent, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:13:28.893 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.EndExecutionOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:13:28.893 [main] [INFO] 4 (process instance)└── 6 : end (EndEvent, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:13:28.893 [main] [INFO] task1: null  o.d.a.c.TaskServiceTest.testTaskService:55</code></pre><h4 id="5-3-1-2-TaskService-设置-Task-权限信息"><a href="#5-3-1-2-TaskService-设置-Task-权限信息" class="headerlink" title="5.3.1.2 TaskService 设置 Task 权限信息"></a>5.3.1.2 TaskService 设置 Task 权限信息</h4><ul><li>候选用户(candidateUser) 和候选组(candidateGroup)</li><li>指定拥有人(Owner)和办理人(Assignee)</li><li>通过 claim 设置办理人(发现 task 已经有指定办理人且不是 claim 指定的人就会抛出异常)</li></ul><h5 id="流程定义-1"><a href="#流程定义-1" class="headerlink" title="流程定义"></a>流程定义</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:activiti</span>=<span class="string">"http://activiti.org/bpmn"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:bpmndi</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/DI"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdc</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DC"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdi</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="attr">typeLanguage</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">expressionLanguage</span>=<span class="string">"http://www.w3.org/1999/XPath"</span> <span class="attr">targetNamespace</span>=<span class="string">"http://www.activiti.org/test"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"my-process"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"start"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow1"</span> <span class="attr">sourceRef</span>=<span class="string">"start"</span> <span class="attr">targetRef</span>=<span class="string">"someTask"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 添加候选人 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"someTask"</span> <span class="attr">name</span>=<span class="string">"Activiti is awesome!"</span> <span class="attr">activiti:candidateUsers</span>=<span class="string">"destiny,destiny1,destiny2"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 添加描述, message 会根据上下文中传入的 message 变量值去替换 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">documentation</span>&gt;</span></span><br><span class="line">                some task $&#123;message&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow2"</span> <span class="attr">sourceRef</span>=<span class="string">"someTask"</span> <span class="attr">targetRef</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="测试代码-5"><a href="#测试代码-5" class="headerlink" title="测试代码"></a>测试代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process-task.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTaskServiceUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; variables = Maps.newHashMap();</span><br><span class="line">    variables.put(<span class="string">"message"</span>, <span class="string">"my test message"</span>);</span><br><span class="line">    activitiRule.getRuntimeService().startProcessInstanceByKey(<span class="string">"my-process"</span>, variables);</span><br><span class="line">    TaskService taskService = activitiRule.getTaskService();</span><br><span class="line">    Task task = taskService.createTaskQuery().singleResult();</span><br><span class="line">    log.info(<span class="string">"task: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(task, ToStringStyle.JSON_STYLE));</span><br><span class="line">    log.info(<span class="string">"task.description: &#123;&#125;"</span>, task.getDescription());</span><br><span class="line">    taskService.setOwner(task.getId(), <span class="string">"user1"</span>);</span><br><span class="line">    <span class="comment">// 可能存在覆盖已有代办放的问题, 因此不推荐</span></span><br><span class="line">    <span class="comment">// taskService.setAssignee(task.getId(), "destiny");</span></span><br><span class="line">    <span class="comment">// 查询在候选人列表, 且未指定办理人的 task 列表</span></span><br><span class="line">    List&lt;Task&gt; taskList = taskService.createTaskQuery()</span><br><span class="line">            .taskCandidateOrAssigned(<span class="string">"destiny"</span>)</span><br><span class="line">            .taskUnassigned()</span><br><span class="line">            .listPage(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="comment">// 使用 claim 设置候选人</span></span><br><span class="line">    <span class="keyword">for</span> (Task task1 : taskList) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            taskService.claim(task1.getId(), <span class="string">"destiny"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 查看当前 task 的所有用户关系内容</span></span><br><span class="line">    List&lt;IdentityLink&gt; identityLinkList = taskService.getIdentityLinksForTask(task.getId());</span><br><span class="line">    <span class="keyword">for</span> (IdentityLink identityLink : identityLinkList) &#123;</span><br><span class="line">        log.info(<span class="string">"identityLink: &#123;&#125;"</span>, identityLink);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 完成任务, 首先找到处于代办状态的所有 task</span></span><br><span class="line">    List&lt;Task&gt; destinys = taskService.createTaskQuery().taskAssignee(<span class="string">"destiny"</span>).listPage(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">for</span> (Task destiny : destinys) &#123;</span><br><span class="line">        variables.clear();</span><br><span class="line">        variables.put(<span class="string">"cKey1"</span>, <span class="string">"cValue1"</span>);</span><br><span class="line">        taskService.complete(destiny.getId(), variables);</span><br><span class="line">    &#125;</span><br><span class="line">    destinys = taskService.createTaskQuery().taskAssignee(<span class="string">"destiny"</span>).listPage(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">    log.info(<span class="string">"是否存在: &#123;&#125;"</span>, CollectionUtils.isEmpty(destinys));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="输出日志-1"><a href="#输出日志-1" class="headerlink" title="输出日志"></a>输出日志</h5><pre><code>16:41:28.534 [main] [INFO] Loading XML bean definitions from class path resource [activiti.cfg.xml]  o.s.b.f.x.XmlBeanDefinitionReader.loadBeanDefinitions:31616:41:30.373 [main] [INFO] Activiti 5 compatibility handler implementation not found or error during instantiation : org.activiti.compatibility.DefaultActiviti5CompatibilityHandler. Activiti 5 backwards compatibility disabled.  o.a.e.c.DefaultActiviti5CompatibilityHandlerFactory.createActiviti5CompatibilityHandler:3816:41:30.385 [main] [INFO] performing create on engine with resource org/activiti/db/create/activiti.h2.create.engine.sql  o.a.e.i.d.DbSqlSession.executeSchemaResource:114716:41:30.443 [main] [INFO] performing create on history with resource org/activiti/db/create/activiti.h2.create.history.sql  o.a.e.i.d.DbSqlSession.executeSchemaResource:114716:41:30.449 [main] [INFO] performing create on identity with resource org/activiti/db/create/activiti.h2.create.identity.sql  o.a.e.i.d.DbSqlSession.executeSchemaResource:114716:41:30.453 [main] [INFO] ProcessEngine default created  o.a.e.i.ProcessEngineImpl.&lt;init&gt;:8716:41:30.631 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:41:30.636 [main] [INFO] 4 (process instance)└── 6 : start (StartEvent, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:41:30.638 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:41:30.638 [main] [INFO] 4 (process instance)└── 6 : start (StartEvent, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:41:30.639 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:41:30.640 [main] [INFO] 4 (process instance)└── 6 : start -&gt; someTask, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:41:30.640 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:41:30.641 [main] [INFO] 4 (process instance)└── 6 : someTask (UserTask, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:41:30.715 [main] [INFO] task: {&quot;owner&quot;:null,&quot;assigneeUpdatedCount&quot;:0,&quot;originalAssignee&quot;:null,&quot;assignee&quot;:null,&quot;delegationState&quot;:null,&quot;parentTaskId&quot;:null,&quot;name&quot;:&quot;Activiti is awesome!&quot;,&quot;localizedName&quot;:null,&quot;description&quot;:&quot;some task my test message&quot;,&quot;localizedDescription&quot;:null,&quot;priority&quot;:50,&quot;createTime&quot;:&quot;Mon Dec 03 16:41:30 CST 2018&quot;,&quot;dueDate&quot;:null,&quot;suspensionState&quot;:1,&quot;category&quot;:null,&quot;isIdentityLinksInitialized&quot;:false,&quot;taskIdentityLinkEntities&quot;:[],&quot;executionId&quot;:&quot;6&quot;,&quot;execution&quot;:null,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;processInstance&quot;:null,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;taskDefinitionKey&quot;:&quot;someTask&quot;,&quot;formKey&quot;:null,&quot;isDeleted&quot;:false,&quot;isCanceled&quot;:false,&quot;eventName&quot;:null,&quot;currentActivitiListener&quot;:null,&quot;tenantId&quot;:&quot;&quot;,&quot;queryVariables&quot;:null,&quot;forcedUpdate&quot;:false,&quot;claimTime&quot;:null,&quot;variableInstances&quot;:null,&quot;usedVariablesCache&quot;:{},&quot;transientVariabes&quot;:null,&quot;cachedElContext&quot;:null,&quot;id&quot;:&quot;9&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}  o.d.a.c.TaskServiceTest.testTaskServiceUser:6916:41:30.715 [main] [INFO] task.description: some task my test message  o.d.a.c.TaskServiceTest.testTaskServiceUser:7016:41:30.739 [main] [INFO] identityLink: IdentityLinkEntity[id=10, type=candidate, userId=destiny, taskId=9]  o.d.a.c.TaskServiceTest.testTaskServiceUser:9416:41:30.740 [main] [INFO] identityLink: IdentityLinkEntity[id=12, type=candidate, userId=destiny1, taskId=9]  o.d.a.c.TaskServiceTest.testTaskServiceUser:9416:41:30.740 [main] [INFO] identityLink: IdentityLinkEntity[id=14, type=candidate, userId=destiny2, taskId=9]  o.d.a.c.TaskServiceTest.testTaskServiceUser:9416:41:30.740 [main] [INFO] identityLink: IdentityLinkEntity[id=null, type=assignee, userId=destiny, taskId=9]  o.d.a.c.TaskServiceTest.testTaskServiceUser:9416:41:30.740 [main] [INFO] identityLink: IdentityLinkEntity[id=null, type=owner, userId=user1, taskId=9]  o.d.a.c.TaskServiceTest.testTaskServiceUser:9416:41:30.749 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.TriggerExecutionOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:41:30.751 [main] [INFO] 4 (process instance)└── 6 : someTask (UserTask, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:41:30.752 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:41:30.753 [main] [INFO] 4 (process instance)└── 6 : someTask (UserTask, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:41:30.754 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:41:30.754 [main] [INFO] 4 (process instance)└── 6 : someTask -&gt; end, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:41:30.755 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:41:30.755 [main] [INFO] 4 (process instance)└── 6 : end (EndEvent, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:41:30.755 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:41:30.755 [main] [INFO] 4 (process instance)└── 6 : end (EndEvent, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:41:30.757 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.EndExecutionOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3316:41:30.757 [main] [INFO] 4 (process instance)└── 6 : end (EndEvent, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3416:41:30.770 [main] [INFO] 是否存在: true  o.d.a.c.TaskServiceTest.testTaskServiceUser:106</code></pre><h3 id="5-3-2-TaskService-设置-Task-附加信息"><a href="#5-3-2-TaskService-设置-Task-附加信息" class="headerlink" title="5.3.2 TaskService 设置 Task 附加信息"></a>5.3.2 TaskService 设置 Task 附加信息</h3><ul><li>任务附件(Attachment)创建与查询</li><li>任务评论(Comment)创建与查询</li><li>事件记录(Event)创建于查询</li></ul><h4 id="5-3-2-1-任务附件-Attachment-创建与查询"><a href="#5-3-2-1-任务附件-Attachment-创建与查询" class="headerlink" title="5.3.2.1 任务附件(Attachment)创建与查询"></a>5.3.2.1 任务附件(Attachment)创建与查询</h4><h5 id="流程定义-2"><a href="#流程定义-2" class="headerlink" title="流程定义"></a>流程定义</h5><p>同上</p><h4 id="测试代码-6"><a href="#测试代码-6" class="headerlink" title="测试代码"></a>测试代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process-task.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTaskAttachment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; variables = Maps.newHashMap();</span><br><span class="line">    variables.put(<span class="string">"message"</span>, <span class="string">"my test message"</span>);</span><br><span class="line">    activitiRule.getRuntimeService().startProcessInstanceByKey(<span class="string">"my-process"</span>, variables);</span><br><span class="line">    TaskService taskService = activitiRule.getTaskService();</span><br><span class="line">    Task task = taskService.createTaskQuery().singleResult();</span><br><span class="line">    <span class="comment">// 可以上传数据流或 url</span></span><br><span class="line">    Attachment attachment = taskService.createAttachment(<span class="string">"url"</span>, task.getId(), task.getProcessInstanceId(), <span class="string">"name"</span>, <span class="string">"desc"</span>, <span class="string">"/url/test.png"</span>);</span><br><span class="line">    log.info(<span class="string">"attachment: &#123;&#125;"</span>, attachment);</span><br><span class="line">    List&lt;Attachment&gt; taskAttachments = taskService.getTaskAttachments(task.getId());</span><br><span class="line">    <span class="keyword">for</span> (Attachment taskAttachment : taskAttachments) &#123;</span><br><span class="line">        log.info(<span class="string">"taskAttachment: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(taskAttachment, ToStringStyle.JSON_STYLE));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="日志输出-8"><a href="#日志输出-8" class="headerlink" title="日志输出"></a>日志输出</h4><pre><code>17:12:47.043 [main] [INFO] attachment: org.activiti.engine.impl.persistence.entity.AttachmentEntityImpl@72b16078  o.d.a.c.TaskServiceTest.testTaskAttachment:11917:12:47.050 [main] [INFO] taskAttachment: {&quot;name&quot;:&quot;name&quot;,&quot;description&quot;:&quot;desc&quot;,&quot;type&quot;:&quot;url&quot;,&quot;taskId&quot;:&quot;9&quot;,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;url&quot;:&quot;/url/test.png&quot;,&quot;contentId&quot;:null,&quot;content&quot;:null,&quot;userId&quot;:null,&quot;time&quot;:&quot;Mon Dec 03 17:12:47 CST 2018&quot;,&quot;id&quot;:&quot;16&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}  o.d.a.c.TaskServiceTest.testTaskAttachment:122</code></pre><h4 id="5-3-2-2-任务评论-Comment-创建与查询"><a href="#5-3-2-2-任务评论-Comment-创建与查询" class="headerlink" title="5.3.2.2 任务评论(Comment)创建与查询"></a>5.3.2.2 任务评论(Comment)创建与查询</h4><h5 id="流程定义-3"><a href="#流程定义-3" class="headerlink" title="流程定义"></a>流程定义</h5><p>同上</p><h5 id="测试代码-7"><a href="#测试代码-7" class="headerlink" title="测试代码"></a>测试代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process-task.bpmn20.xml"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTaskComment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; variables = Maps.newHashMap();</span><br><span class="line">    variables.put(<span class="string">"message"</span>, <span class="string">"my test message"</span>);</span><br><span class="line">    activitiRule.getRuntimeService().startProcessInstanceByKey(<span class="string">"my-process"</span>, variables);</span><br><span class="line">    TaskService taskService = activitiRule.getTaskService();</span><br><span class="line">    Task task = taskService.createTaskQuery().singleResult();</span><br><span class="line">    <span class="comment">// 添加评论</span></span><br><span class="line">    taskService.addComment(task.getId(), task.getProcessInstanceId(), <span class="string">"record note1"</span>);</span><br><span class="line">    taskService.addComment(task.getId(), task.getProcessInstanceId(), <span class="string">"record note2"</span>);</span><br><span class="line">    List&lt;Comment&gt; taskComments = taskService.getTaskComments(task.getId());</span><br><span class="line">    <span class="keyword">for</span> (Comment taskComment : taskComments) &#123;</span><br><span class="line">        log.info(<span class="string">"taskComment: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(taskComment, ToStringStyle.JSON_STYLE));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 事件记录</span></span><br><span class="line">    List&lt;Event&gt; taskEvents = taskService.getTaskEvents(task.getId());</span><br><span class="line">    <span class="keyword">for</span> (Event taskEvent : taskEvents) &#123;</span><br><span class="line">        log.info(<span class="string">"taskEvent: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(taskEvent, ToStringStyle.JSON_STYLE));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="日志输出-9"><a href="#日志输出-9" class="headerlink" title="日志输出"></a>日志输出</h5><pre><code>17:05:17.107 [main] [INFO] taskComment: {&quot;type&quot;:&quot;comment&quot;,&quot;userId&quot;:null,&quot;time&quot;:&quot;Mon Dec 03 17:05:17 CST 2018&quot;,&quot;taskId&quot;:&quot;9&quot;,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;action&quot;:&quot;AddComment&quot;,&quot;message&quot;:&quot;record note2&quot;,&quot;fullMessage&quot;:&quot;record note2&quot;,&quot;id&quot;:&quot;17&quot;,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}  o.d.a.c.TaskServiceTest.testTaskComment:14017:05:17.107 [main] [INFO] taskComment: {&quot;type&quot;:&quot;comment&quot;,&quot;userId&quot;:null,&quot;time&quot;:&quot;Mon Dec 03 17:05:17 CST 2018&quot;,&quot;taskId&quot;:&quot;9&quot;,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;action&quot;:&quot;AddComment&quot;,&quot;message&quot;:&quot;record note1&quot;,&quot;fullMessage&quot;:&quot;record note1&quot;,&quot;id&quot;:&quot;16&quot;,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}  o.d.a.c.TaskServiceTest.testTaskComment:14017:05:17.109 [main] [INFO] taskEvent: {&quot;type&quot;:&quot;comment&quot;,&quot;userId&quot;:null,&quot;time&quot;:&quot;Mon Dec 03 17:05:17 CST 2018&quot;,&quot;taskId&quot;:&quot;9&quot;,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;action&quot;:&quot;AddComment&quot;,&quot;message&quot;:&quot;record note2&quot;,&quot;fullMessage&quot;:&quot;record note2&quot;,&quot;id&quot;:&quot;17&quot;,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}  o.d.a.c.TaskServiceTest.testTaskComment:14617:05:17.110 [main] [INFO] taskEvent: {&quot;type&quot;:&quot;comment&quot;,&quot;userId&quot;:null,&quot;time&quot;:&quot;Mon Dec 03 17:05:17 CST 2018&quot;,&quot;taskId&quot;:&quot;9&quot;,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;action&quot;:&quot;AddComment&quot;,&quot;message&quot;:&quot;record note1&quot;,&quot;fullMessage&quot;:&quot;record note1&quot;,&quot;id&quot;:&quot;16&quot;,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}  o.d.a.c.TaskServiceTest.testTaskComment:146</code></pre><blockquote><h5 id="Comment-和-Event-的区别"><a href="#Comment-和-Event-的区别" class="headerlink" title="Comment 和 Event 的区别"></a>Comment 和 Event 的区别</h5><p>所有对 task 的操作都会生成新的 Event 记录, comment 只是其中的一种, 比如在上例中新增 owner 或 assignee, 也会产生新的 event 记录</p></blockquote><h2 id="5-4-身份管理服务"><a href="#5-4-身份管理服务" class="headerlink" title="5.4 身份管理服务"></a>5.4 身份管理服务</h2><blockquote><p>Activiti 提供了相对比较简单的用户/用户组管理</p></blockquote><p>主要功能:</p><ul><li>管理用户(User)</li><li>管理用户组(Group)</li><li>用户与用户组的关系(Membership)(多对多关系)</li></ul><h3 id="5-4-1-创建用户-用户组-对应关系"><a href="#5-4-1-创建用户-用户组-对应关系" class="headerlink" title="5.4.1 创建用户/用户组/对应关系"></a>5.4.1 创建用户/用户组/对应关系</h3><h4 id="流程定义-4"><a href="#流程定义-4" class="headerlink" title="流程定义"></a>流程定义</h4><blockquote><p>此处不需要基于流程定义完成</p></blockquote><h4 id="测试代码-8"><a href="#测试代码-8" class="headerlink" title="测试代码"></a>测试代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IdentityServiceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">public</span> ActivitiRule activitiRule = <span class="keyword">new</span> ActivitiRule();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIdentity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IdentityService identityService = activitiRule.getIdentityService();</span><br><span class="line">        User user1 = identityService.newUser(<span class="string">"user1"</span>);</span><br><span class="line">        user1.setEmail(<span class="string">"destinywk@163.com"</span>);</span><br><span class="line">        User user2 = identityService.newUser(<span class="string">"user2"</span>);</span><br><span class="line">        user2.setEmail(<span class="string">"destinywk@126.com"</span>);</span><br><span class="line">        identityService.saveUser(user1);</span><br><span class="line">        identityService.saveUser(user2);</span><br><span class="line"></span><br><span class="line">        Group group1 = identityService.newGroup(<span class="string">"group1"</span>);</span><br><span class="line">        identityService.saveGroup(group1);</span><br><span class="line">        Group group2 = identityService.newGroup(<span class="string">"group2"</span>);</span><br><span class="line">        identityService.saveGroup(group2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建关系</span></span><br><span class="line">        identityService.createMembership(<span class="string">"user1"</span>, <span class="string">"group1"</span>);</span><br><span class="line">        identityService.createMembership(<span class="string">"user2"</span>, <span class="string">"group1"</span>);</span><br><span class="line">        identityService.createMembership(<span class="string">"user1"</span>, <span class="string">"group2"</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;User&gt; userList = identityService.createUserQuery()</span><br><span class="line">                .memberOfGroup(<span class="string">"group1"</span>)</span><br><span class="line">                .listPage(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (User user : userList) &#123;</span><br><span class="line">            log.info(<span class="string">"user: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(user, ToStringStyle.JSON_STYLE));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;Group&gt; groupList = identityService.createGroupQuery()</span><br><span class="line">                .groupMember(<span class="string">"user1"</span>).listPage(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">        <span class="keyword">for</span> (Group group : groupList) &#123;</span><br><span class="line">            log.info(<span class="string">"group: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(group, ToStringStyle.JSON_STYLE));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="日志输出-10"><a href="#日志输出-10" class="headerlink" title="日志输出"></a>日志输出</h4><pre><code>17:37:12.982 [main] [INFO] Loading XML bean definitions from class path resource [activiti.cfg.xml]  o.s.b.f.x.XmlBeanDefinitionReader.loadBeanDefinitions:31617:37:14.894 [main] [INFO] Activiti 5 compatibility handler implementation not found or error during instantiation : org.activiti.compatibility.DefaultActiviti5CompatibilityHandler. Activiti 5 backwards compatibility disabled.  o.a.e.c.DefaultActiviti5CompatibilityHandlerFactory.createActiviti5CompatibilityHandler:3817:37:14.910 [main] [INFO] performing create on engine with resource org/activiti/db/create/activiti.h2.create.engine.sql  o.a.e.i.d.DbSqlSession.executeSchemaResource:114717:37:14.971 [main] [INFO] performing create on history with resource org/activiti/db/create/activiti.h2.create.history.sql  o.a.e.i.d.DbSqlSession.executeSchemaResource:114717:37:14.978 [main] [INFO] performing create on identity with resource org/activiti/db/create/activiti.h2.create.identity.sql  o.a.e.i.d.DbSqlSession.executeSchemaResource:114717:37:14.982 [main] [INFO] ProcessEngine default created  o.a.e.i.ProcessEngineImpl.&lt;init&gt;:8717:37:15.041 [main] [INFO] user: {&quot;firstName&quot;:null,&quot;lastName&quot;:null,&quot;email&quot;:&quot;destinywk@163.com&quot;,&quot;password&quot;:null,&quot;pictureByteArrayRef&quot;:&quot;ByteArrayRef[id=null, name=null, entity=null]&quot;,&quot;id&quot;:&quot;user1&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}  o.d.a.c.IdentityServiceTest.testIdentity:4617:37:15.042 [main] [INFO] user: {&quot;firstName&quot;:null,&quot;lastName&quot;:null,&quot;email&quot;:&quot;destinywk@126.com&quot;,&quot;password&quot;:null,&quot;pictureByteArrayRef&quot;:&quot;ByteArrayRef[id=null, name=null, entity=null]&quot;,&quot;id&quot;:&quot;user2&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}  o.d.a.c.IdentityServiceTest.testIdentity:4617:37:15.048 [main] [INFO] group: {&quot;name&quot;:null,&quot;type&quot;:null,&quot;id&quot;:&quot;group1&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}  o.d.a.c.IdentityServiceTest.testIdentity:5217:37:15.048 [main] [INFO] group: {&quot;name&quot;:null,&quot;type&quot;:null,&quot;id&quot;:&quot;group2&quot;,&quot;revision&quot;:1,&quot;isInserted&quot;:false,&quot;isUpdated&quot;:false,&quot;isDeleted&quot;:false}  o.d.a.c.IdentityServiceTest.testIdentity:52</code></pre><p>身份管理服务的调用过程:</p><p><img src="https://user-images.githubusercontent.com/17758731/49366329-08018200-f724-11e8-8b70-9fb9f4f6a6d5.png" alt="image"></p><p>会将 User 封装成一个 Command, 交由命令执行器去执行, 最后调用 MyBatis 底层接口去操作 DB</p><h2 id="5-5-表单管理服务-FormService"><a href="#5-5-表单管理服务-FormService" class="headerlink" title="5.5 表单管理服务 FormService"></a>5.5 表单管理服务 FormService</h2><p>功能:</p><ul><li>解析流程定义中表单项的配置</li><li>提供提交表单的方式驱动用户节点流转</li><li>获取自定义外部表单 key</li></ul><h3 id="5-5-1"><a href="#5-5-1" class="headerlink" title="5.5.1"></a>5.5.1</h3><h4 id="流程定义-5"><a href="#流程定义-5" class="headerlink" title="流程定义"></a>流程定义</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:activiti</span>=<span class="string">"http://activiti.org/bpmn"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:bpmndi</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/DI"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdc</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DC"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">xmlns:omgdi</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="attr">typeLanguage</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">expressionLanguage</span>=<span class="string">"http://www.w3.org/1999/XPath"</span> <span class="attr">targetNamespace</span>=<span class="string">"http://www.activiti.org/test"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"my-process"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"start"</span> <span class="attr">activiti:formKey</span>=<span class="string">"/rest/process/form/start"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 配置表单项 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">activiti:formProperty</span> <span class="attr">id</span>=<span class="string">"message"</span> <span class="attr">name</span>=<span class="string">"信息"</span> <span class="attr">type</span>=<span class="string">"string"</span> <span class="attr">required</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow1"</span> <span class="attr">sourceRef</span>=<span class="string">"start"</span> <span class="attr">targetRef</span>=<span class="string">"someTask"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"someTask"</span> <span class="attr">name</span>=<span class="string">"Activiti is awesome!"</span> <span class="attr">activiti:formKey</span>=<span class="string">"/rest/process/form/userTask"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 配置表单项 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">activiti:formProperty</span> <span class="attr">id</span>=<span class="string">"yesOrNo"</span> <span class="attr">name</span>=<span class="string">"审批"</span> <span class="attr">type</span>=<span class="string">"string"</span> <span class="attr">required</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow2"</span> <span class="attr">sourceRef</span>=<span class="string">"someTask"</span> <span class="attr">targetRef</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"end"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="测试代码-9"><a href="#测试代码-9" class="headerlink" title="测试代码"></a>测试代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FormServiceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">public</span> ActivitiRule activitiRule = <span class="keyword">new</span> ActivitiRule();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Deployment</span>(resources = &#123;<span class="string">"org/destiny/activiti/my-process-form.bpmn20.xml"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFormService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FormService formService = activitiRule.getFormService();</span><br><span class="line">        <span class="comment">// 获取流程定义文件</span></span><br><span class="line">        ProcessDefinition processDefinition = activitiRule.getRepositoryService().createProcessDefinitionQuery().singleResult();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取 startForm 的 key 和 data</span></span><br><span class="line">        String startFormKey = formService.getStartFormKey(processDefinition.getId());</span><br><span class="line">        log.info(<span class="string">"startFormKey: &#123;&#125;"</span>, startFormKey);</span><br><span class="line">        StartFormData startFormData = formService.getStartFormData(processDefinition.getId());</span><br><span class="line">        log.info(<span class="string">"startFormKey: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(startFormData, ToStringStyle.JSON_STYLE));</span><br><span class="line">        <span class="keyword">for</span> (FormProperty startFormProperty : startFormData.getFormProperties()) &#123;</span><br><span class="line">            log.info(<span class="string">"startFormProperty: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(startFormProperty, ToStringStyle.JSON_STYLE));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动流程</span></span><br><span class="line">        Map&lt;String, String&gt; properties = Maps.newHashMap();</span><br><span class="line">        properties.put(<span class="string">"message"</span>, <span class="string">"my test message"</span>);</span><br><span class="line">        formService.submitStartFormData(processDefinition.getId(), properties);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询 task</span></span><br><span class="line">        Task task = activitiRule.getTaskService().createTaskQuery().singleResult();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取 taskForm 的 data</span></span><br><span class="line">        TaskFormData taskFormData = formService.getTaskFormData(task.getId());</span><br><span class="line">        log.info(<span class="string">"taskFormData: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(taskFormData, ToStringStyle.JSON_STYLE));</span><br><span class="line">        <span class="keyword">for</span> (FormProperty taskFormProperty : taskFormData.getFormProperties()) &#123;</span><br><span class="line">            log.info(<span class="string">"taskFormProperty: &#123;&#125;"</span>, ToStringBuilder.reflectionToString(taskFormProperty, ToStringStyle.JSON_STYLE));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="日志输出-11"><a href="#日志输出-11" class="headerlink" title="日志输出"></a>日志输出</h4><pre><code>18:15:27.539 [main] [INFO] startFormKey: /rest/process/form/start  o.d.a.c.FormServiceTest.testFormService:3618:15:27.547 [main] [INFO] startFormKey: {&quot;processDefinition&quot;:&quot;ProcessDefinitionEntity[my-process:1:3]&quot;,&quot;formKey&quot;:&quot;/rest/process/form/start&quot;,&quot;deploymentId&quot;:&quot;1&quot;,&quot;formProperties&quot;:[org.activiti.engine.impl.form.FormPropertyImpl@3bde62ff]}  o.d.a.c.FormServiceTest.testFormService:3818:15:27.547 [main] [INFO] startFormProperty: {&quot;id&quot;:&quot;message&quot;,&quot;name&quot;:&quot;信息&quot;,&quot;type&quot;:&quot;org.activiti.engine.impl.form.StringFormType@2baa8d82&quot;,&quot;isRequired&quot;:true,&quot;isReadable&quot;:true,&quot;isWritable&quot;:true,&quot;value&quot;:null}  o.d.a.c.FormServiceTest.testFormService:4018:15:27.561 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3318:15:27.564 [main] [INFO] 4 (process instance)└── 5 : start (StartEvent, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3418:15:27.565 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3318:15:27.566 [main] [INFO] 4 (process instance)└── 5 : start (StartEvent, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3418:15:27.567 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3318:15:27.567 [main] [INFO] 4 (process instance)└── 5 : start -&gt; someTask, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3418:15:27.568 [main] [INFO] Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :  o.a.e.i.i.DebugCommandInvoker.executeOperation:3318:15:27.568 [main] [INFO] 4 (process instance)└── 5 : someTask (UserTask, parent id 4 (active)  o.a.e.i.i.DebugCommandInvoker.executeOperation:3418:15:27.602 [main] [INFO] taskFormData: {&quot;task&quot;:&quot;Task[id=10, name=Activiti is awesome!]&quot;,&quot;formKey&quot;:&quot;/rest/process/form/userTask&quot;,&quot;deploymentId&quot;:&quot;1&quot;,&quot;formProperties&quot;:[org.activiti.engine.impl.form.FormPropertyImpl@4e4efc1b]}  o.d.a.c.FormServiceTest.testFormService:5318:15:27.602 [main] [INFO] taskFormProperty: {&quot;id&quot;:&quot;yesOrNo&quot;,&quot;name&quot;:&quot;审批&quot;,&quot;type&quot;:&quot;org.activiti.engine.impl.form.StringFormType@2baa8d82&quot;,&quot;isRequired&quot;:true,&quot;isReadable&quot;:true,&quot;isWritable&quot;:true,&quot;value&quot;:null}  o.d.a.c.FormServiceTest.testFormService:55</code></pre><h2 id="5-6-HistoryService-历史数据管理服务"><a href="#5-6-HistoryService-历史数据管理服务" class="headerlink" title="5.6 HistoryService 历史数据管理服务"></a>5.6 HistoryService 历史数据管理服务</h2><p>作用:</p><ul><li>管理流程实例哦结束后的历史数据</li><li>构建历史数据的查询对象</li><li>根据流程实例 id 删除流程历史数据</li></ul><table><thead><tr><th>历史数据实体</th><th>描述</th></tr></thead><tbody><tr><td>HistoricProcessInstance</td><td>历史流程实例实体类</td></tr><tr><td>HistoricVariableInstance</td><td>流程或任务变量值的实体</td></tr><tr><td>HistoricActivityInstance</td><td>单个活动节点执行的信息</td></tr><tr><td>HistoricTaskInstance</td><td>用户任务实例的信息</td></tr><tr><td>HistoricDetail</td><td>历史流程活动任务详细信息</td></tr></tbody></table><ul><li>HistoryService 构建历史查询对象:<ul><li>create<code>[历史数据实体]</code>Query</li><li>createNative<code>[历史数据实体]</code>Query</li><li>createProcessInstanceHistoryLogQuery: 只能查出一个流程实例的一个对象, 每次只能查出一条记录, 包含流程实体所有的其他数据, 包括task, Activiti, comment 等信息</li></ul></li><li>HistoryService 删除历史操作<ul><li>deleteHistoricProcessInstance, 采用级联操作, 删除与流程实例相关的所有历史信息</li><li>deleteHistoricTaskInstance, 范围相对较小, 只删除 Task 及 Task 相关的变量</li></ul></li></ul><h2 id="5-7-ManagementService-管理服务"><a href="#5-7-ManagementService-管理服务" class="headerlink" title="5.7 ManagementService 管理服务"></a>5.7 ManagementService 管理服务</h2><p>作用:</p><ul><li>Job 任务管理</li><li>数据库相关通用操作</li><li>执行流程引擎命令(Command)</li></ul><h3 id="5-7-1-Job-任务管理"><a href="#5-7-1-Job-任务管理" class="headerlink" title="5.7.1 Job 任务管理"></a>5.7.1 Job 任务管理</h3><table><thead><tr><th>工作查询对象</th><th>描述</th></tr></thead><tbody><tr><td>JobQuery</td><td>查询一般工作</td></tr><tr><td>TimerJobQuery</td><td>查询定时任务</td></tr><tr><td>SuspendedKobQUery</td><td>查询中断工作</td></tr><tr><td>DeadLetterJobQuery</td><td>查询无法执行的工作(一般重试三次)</td></tr></tbody></table><h3 id="5-7-2-数据库相关操作"><a href="#5-7-2-数据库相关操作" class="headerlink" title="5.7.2 数据库相关操作"></a>5.7.2 数据库相关操作</h3><ul><li>查询表结构元数据</li><li>通用表查询</li><li>执行自定义的 sql 查询</li></ul><h2 id="5-8-DynamicBpmnService-动态流程定义服务"><a href="#5-8-DynamicBpmnService-动态流程定义服务" class="headerlink" title="5.8 DynamicBpmnService 动态流程定义服务"></a>5.8 DynamicBpmnService 动态流程定义服务</h2><blockquote><p>不推荐使用</p></blockquote><h1 id="6-数据库设计和模型映射"><a href="#6-数据库设计和模型映射" class="headerlink" title="6 数据库设计和模型映射"></a>6 数据库设计和模型映射</h1><table><thead><tr><th>数据表分类</th><th>描述</th></tr></thead><tbody><tr><td><code>ACT_GE_*</code></td><td>通用数据表</td></tr><tr><td><code>ACT_RE_*</code></td><td>流程定义存储表</td></tr><tr><td><code>ACT_ID_*</code></td><td>身份信息表</td></tr><tr><td><code>ACT_RU_*</code></td><td>运行时数据库表</td></tr><tr><td><code>ACT_HI_*</code></td><td>历史数据库表</td></tr></tbody></table><h2 id="6-1-MySql-建表语句"><a href="#6-1-MySql-建表语句" class="headerlink" title="6.1 MySql 建表语句"></a>6.1 MySql 建表语句</h2><blockquote><p>除了核心引擎是必选的, 其他两个不是必须的</p></blockquote><ul><li>核心引擎: activiti.mysql.create.engine.sql</li><li>历史数据: activiti.mysql.create.history.sql</li><li>身份信息: activiti.mysql.create.identity.sql</li></ul><h3 id="6-1-1-通用数据库"><a href="#6-1-1-通用数据库" class="headerlink" title="6.1.1 通用数据库"></a>6.1.1 通用数据库</h3><table><thead><tr><th>数据表分类</th><th>描述</th></tr></thead><tbody><tr><td>ACT_GE_PROPERTY</td><td>属性表(保存流程引擎的 key-value 键值属性)</td></tr><tr><td>ACT_GE_BYTEARRAY</td><td>资源表(存储流程定义相关的资源)</td></tr></tbody></table><h1 id="7-BPMN2-0-概述"><a href="#7-BPMN2-0-概述" class="headerlink" title="7 BPMN2.0 概述"></a>7 BPMN2.0 概述</h1><ul><li>是一套业务流程模型与符号建模标准</li><li>精准的执行语义来描述元素的操作</li><li>以 XML 为载体, 以符号可视化业务</li></ul><p>BPMN2.0元素:</p><ul><li>流对象</li><li>连接对象</li><li>数据</li><li>泳道</li><li>描述对象</li></ul><p><img src="https://user-images.githubusercontent.com/17758731/49372749-a26ac100-f736-11e8-89f1-b01d14fa6f1d.png" alt="image"><br><img src="https://user-images.githubusercontent.com/17758731/49372819-d0e89c00-f736-11e8-984f-34464892a1b9.png" alt="image"></p><h2 id="7-1-流对象"><a href="#7-1-流对象" class="headerlink" title="7.1 流对象"></a>7.1 流对象</h2><ul><li>活动(Activities): User Task, Service Task…</li><li>事件(Events): Start Event, End Event…</li><li>网关(Gateway): Exclusive Gateway…</li></ul><h1 id="8-Activiti-集成-Spring-Boot"><a href="#8-Activiti-集成-Spring-Boot" class="headerlink" title="8 Activiti 集成 Spring Boot"></a>8 Activiti 集成 Spring Boot</h1><p>Activiti6.0 依赖的 SpringBoot 版本是 1.2.6</p><p>如果直接与 SpringBoot 2.0.0 集成的话, 会出现 ClassNotFound 等问题</p><p>因此在集成 SpringBoot 2.0.0 的时候, 需要 Activiti6.0 源码进行部分改动</p><p>升级 Activiti 6.0 依赖 SpringBoot 版本为 2.0.0 的改动</p><ul><li>升级 SpringBoot 依赖并解决编译错误</li><li>更新 activiti-spring-boot-starter-basic 版本并安装</li><li>集成使用 Activiti 的 AutoConfiguration 功能</li></ul><p>如果直接将 SpringBoot 2.0.0 和 activiti-spring-boot-starter-basic 6.0.0 集成, 会发生如下错误:</p><pre><code>java.lang.IllegalStateException: Failed to load ApplicationContextCaused by: org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &apos;documentationPluginsBootstrapper&apos; defined in URL [jar:file:/Users/destiny/.m2/repository/io/springfox/springfox-spring-web/2.8.0/springfox-spring-web-2.8.0.jar!/springfox/documentation/spring/web/plugins/DocumentationPluginsBootstrapper.class]: Unsatisfied dependency expressed through constructor parameter 1; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &apos;webMvcRequestHandlerProvider&apos; defined in URL [jar:file:/Users/destiny/.m2/repository/io/springfox/springfox-spring-web/2.8.0/springfox-spring-web-2.8.0.jar!/springfox/documentation/spring/web/plugins/WebMvcRequestHandlerProvider.class]: Unsatisfied dependency expressed through constructor parameter 1; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;requestMappingHandlerMapping&apos; defined in class path resource [org/springframework/boot/autoconfigure/web/servlet/WebMvcAutoConfiguration$EnableWebMvcConfiguration.class]: Invocation of init method failed; nested exception is java.lang.ArrayStoreException: sun.reflect.annotation.TypeNotPresentExceptionProxy...Caused by: org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &apos;webMvcRequestHandlerProvider&apos; defined in URL [jar:file:/Users/destiny/.m2/repository/io/springfox/springfox-spring-web/2.8.0/springfox-spring-web-2.8.0.jar!/springfox/documentation/spring/web/plugins/WebMvcRequestHandlerProvider.class]: Unsatisfied dependency expressed through constructor parameter 1; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;requestMappingHandlerMapping&apos; defined in class path resource [org/springframework/boot/autoconfigure/web/servlet/WebMvcAutoConfiguration$EnableWebMvcConfiguration.class]: Invocation of init method failed; nested exception is java.lang.ArrayStoreException: sun.reflect.annotation.TypeNotPresentExceptionProxy...Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;requestMappingHandlerMapping&apos; defined in class path resource [org/springframework/boot/autoconfigure/web/servlet/WebMvcAutoConfiguration$EnableWebMvcConfiguration.class]: Invocation of init method failed; nested exception is java.lang.ArrayStoreException: sun.reflect.annotation.TypeNotPresentExceptionProxy...Caused by: java.lang.ArrayStoreException: sun.reflect.annotation.TypeNotPresentExceptionProxy...</code></pre><p>真正的原因是对应的类无法找到</p><h2 id="8-1-修改-activiti-源码以适应-SpringBoot-2-0-0-版本升级"><a href="#8-1-修改-activiti-源码以适应-SpringBoot-2-0-0-版本升级" class="headerlink" title="8.1 修改 activiti 源码以适应 SpringBoot 2.0.0 版本升级"></a>8.1 修改 activiti 源码以适应 SpringBoot 2.0.0 版本升级</h2><h3 id="8-1-1-将-activiti-中-SpringBoot-依赖升级到-2-0-0"><a href="#8-1-1-将-activiti-中-SpringBoot-依赖升级到-2-0-0" class="headerlink" title="8.1.1 将 activiti 中 SpringBoot 依赖升级到 2.0.0"></a>8.1.1 将 activiti 中 SpringBoot 依赖升级到 2.0.0</h3><p>修改 Activiti 源码中 <code>modules/activiti-spring-boot/pom.xml</code> pom 文件, 将其中 </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">spring.boot.version</span>&gt;</span>1.2.6.RELEASE<span class="tag">&lt;/<span class="name">spring.boot.version</span>&gt;</span></span><br></pre></td></tr></table></figure><p>修改为</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">spring.boot.version</span>&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/<span class="name">spring.boot.version</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后重新编译源码, 此时以下几个类会报错</p><h4 id="8-1-1-1-org-activiti-spring-boot-actuate-endpoint-ProcessEngineEndpoint"><a href="#8-1-1-1-org-activiti-spring-boot-actuate-endpoint-ProcessEngineEndpoint" class="headerlink" title="8.1.1.1 org.activiti.spring.boot.actuate.endpoint.ProcessEngineEndpoint"></a>8.1.1.1 <code>org.activiti.spring.boot.actuate.endpoint.ProcessEngineEndpoint</code></h4><p><img src="https://user-images.githubusercontent.com/17758731/49379804-fe3f4500-f74a-11e8-85f2-8c8b58390f6d.png" alt="image"></p><blockquote><p>主要的问题是 SpringBoot 从 1 升级到 2 的时候, 对 EndPoint 的使用方式发生了改变:<br>1.x 是继承一个抽象类 AbstractEndpoint<br>2.x 修改为使用对应的注解</p></blockquote><p>修改后的源码如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.activiti.spring.boot.actuate.endpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.ProcessEngine;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.impl.cfg.ProcessEngineConfigurationImpl;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.impl.persistence.deploy.DefaultDeploymentCache;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.impl.persistence.deploy.DeploymentCache;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.impl.persistence.deploy.ProcessDefinitionCacheEntry;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.repository.ProcessDefinition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.actuate.endpoint.annotation.Endpoint;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.actuate.endpoint.annotation.ReadOperation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Registers a Boot Actuator endpoint that provides information on the</span></span><br><span class="line"><span class="comment"> * running process instance and renders BPMN diagrams of the deployed processes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Josh Long</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//@ConfigurationProperties(prefix = "endpoints.activiti")</span></span><br><span class="line"><span class="meta">@Endpoint</span>(id = <span class="string">"activiti"</span>)                  <span class="comment">// 使用注解 Endpoint</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessEngineEndpoint</span> </span>&#123;        <span class="comment">// 不再继承 AbstractEndpoint</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProcessEngine processEngine;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProcessEngineEndpoint</span><span class="params">(ProcessEngine processEngine)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.processEngine = processEngine; <span class="comment">// 不再继承 Endpoint, 因此不需要调用 super 构造方法</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ReadOperation</span>                          <span class="comment">// 不需要 @Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">activiti</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; metrics = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process definitions</span></span><br><span class="line">        metrics.put(<span class="string">"processDefinitionCount"</span>, processEngine.getRepositoryService().createProcessDefinitionQuery().count());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// List of all process definitions</span></span><br><span class="line">        List&lt;ProcessDefinition&gt; processDefinitions = processEngine.getRepositoryService().createProcessDefinitionQuery().orderByProcessDefinitionKey().asc().list();</span><br><span class="line">        List&lt;String&gt; processDefinitionKeys = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ProcessDefinition processDefinition : processDefinitions) &#123;</span><br><span class="line">            processDefinitionKeys.add(processDefinition.getKey() + <span class="string">" (v"</span> + processDefinition.getVersion() + <span class="string">")"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        metrics.put(<span class="string">"deployedProcessDefinitions"</span>, processDefinitionKeys);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process instances</span></span><br><span class="line">        Map&lt;String, Object&gt; processInstanceCountMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        metrics.put(<span class="string">"runningProcessInstanceCount"</span>, processInstanceCountMap);</span><br><span class="line">        <span class="keyword">for</span> (ProcessDefinition processDefinition : processDefinitions) &#123;</span><br><span class="line">            processInstanceCountMap.put(processDefinition.getKey() + <span class="string">" (v"</span> + processDefinition.getVersion() + <span class="string">")"</span>,</span><br><span class="line">                    processEngine.getRuntimeService().createProcessInstanceQuery().processDefinitionId(processDefinition.getId()).count());</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, Object&gt; completedProcessInstanceCountMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        metrics.put(<span class="string">"completedProcessInstanceCount"</span>, completedProcessInstanceCountMap);</span><br><span class="line">        <span class="keyword">for</span> (ProcessDefinition processDefinition : processDefinitions) &#123;</span><br><span class="line">            completedProcessInstanceCountMap.put(processDefinition.getKey() + <span class="string">" (v"</span> + processDefinition.getVersion() + <span class="string">")"</span>,</span><br><span class="line">                    processEngine.getHistoryService().createHistoricProcessInstanceQuery().finished().processDefinitionId(processDefinition.getId()).count());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Open tasks</span></span><br><span class="line">        metrics.put(<span class="string">"openTaskCount"</span>, processEngine.getTaskService().createTaskQuery().count());</span><br><span class="line">        metrics.put(<span class="string">"completedTaskCount"</span>, processEngine.getHistoryService().createHistoricTaskInstanceQuery().finished().count());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Tasks completed today</span></span><br><span class="line">        metrics.put(<span class="string">"completedTaskCountToday"</span>, processEngine.getHistoryService().createHistoricTaskInstanceQuery().finished().taskCompletedAfter(</span><br><span class="line">                <span class="keyword">new</span> Date(System.currentTimeMillis() - secondsForDays(<span class="number">1</span>))).count());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process steps</span></span><br><span class="line">        metrics.put(<span class="string">"completedActivities"</span>, processEngine.getHistoryService().createHistoricActivityInstanceQuery().finished().count());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process definition cache</span></span><br><span class="line">        DeploymentCache&lt;ProcessDefinitionCacheEntry&gt; deploymentCache = ((ProcessEngineConfigurationImpl) processEngine.getProcessEngineConfiguration()).getProcessDefinitionCache();</span><br><span class="line">        <span class="keyword">if</span> (deploymentCache <span class="keyword">instanceof</span> DefaultDeploymentCache) &#123;</span><br><span class="line">            metrics.put(<span class="string">"cachedProcessDefinitionCount"</span>, ((DefaultDeploymentCache) deploymentCache).size());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> metrics;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">secondsForDays</span><span class="params">(<span class="keyword">int</span> days)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hour = <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">int</span> day = <span class="number">24</span> * hour;</span><br><span class="line">        <span class="keyword">return</span> days * day;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8-1-1-2-org-activiti-spring-boot-actuate-endpoint-ProcessEngineMvcEndpoint"><a href="#8-1-1-2-org-activiti-spring-boot-actuate-endpoint-ProcessEngineMvcEndpoint" class="headerlink" title="8.1.1.2 org.activiti.spring.boot.actuate.endpoint.ProcessEngineMvcEndpoint"></a>8.1.1.2 <code>org.activiti.spring.boot.actuate.endpoint.ProcessEngineMvcEndpoint</code></h4><p><img src="https://user-images.githubusercontent.com/17758731/49380305-5a569900-f74c-11e8-8e35-ea7325e21a8d.png" alt="image"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.activiti.spring.boot.actuate.endpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.activiti.bpmn.BpmnAutoLayout;</span><br><span class="line"><span class="keyword">import</span> org.activiti.bpmn.model.BpmnModel;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.RepositoryService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.repository.ProcessDefinition;</span><br><span class="line"><span class="keyword">import</span> org.activiti.image.ProcessDiagramGenerator;</span><br><span class="line"><span class="keyword">import</span> org.activiti.image.impl.DefaultProcessDiagramGenerator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.InputStreamResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Renders a valid running BPMN process definition as a BPMN diagram.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This is duplicative of the functionality in the full REST API implementation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Joram Barrez</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Josh Long</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessEngineMvcEndpoint</span> </span>&#123;                 <span class="comment">// 同样不再继承 EndpointMvcAdapter</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RepositoryService repositoryService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProcessEngineEndpoint processEngineEndpoint;  <span class="comment">// 创建一个 ProcessEngineEndpoint 私有变量</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProcessEngineMvcEndpoint</span><span class="params">(ProcessEngineEndpoint processEngineEndpoint, RepositoryService repositoryService)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        super(processEngineEndpoint);</span></span><br><span class="line">        <span class="keyword">this</span>.processEngineEndpoint = processEngineEndpoint;</span><br><span class="line">        <span class="keyword">this</span>.repositoryService = repositoryService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Look up the process definition by key. For example,</span></span><br><span class="line"><span class="comment">     * this is &lt;A href="http://localhost:8080/activiti/processes/fulfillmentProcess"&gt;process-diagram for&lt;/A&gt;</span></span><br><span class="line"><span class="comment">     * a process definition named &#123;<span class="doctag">@code</span> fulfillmentProcess&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/processes/&#123;processDefinitionKey:.*&#125;"</span>, method = RequestMethod.GET, produces = MediaType.IMAGE_JPEG_VALUE)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity <span class="title">processDefinitionDiagram</span><span class="params">(@PathVariable String processDefinitionKey)</span> </span>&#123;</span><br><span class="line">      ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery()</span><br><span class="line">              .processDefinitionKey(processDefinitionKey)</span><br><span class="line">              .latestVersion()</span><br><span class="line">              .singleResult();</span><br><span class="line">      <span class="keyword">if</span> (processDefinition == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> ResponseEntity.status(HttpStatus.NOT_FOUND).body(<span class="keyword">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ProcessDiagramGenerator processDiagramGenerator = <span class="keyword">new</span> DefaultProcessDiagramGenerator();</span><br><span class="line">      BpmnModel bpmnModel = repositoryService.getBpmnModel(processDefinition.getId());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (bpmnModel.getLocationMap().size() == <span class="number">0</span>) &#123;</span><br><span class="line">          BpmnAutoLayout autoLayout = <span class="keyword">new</span> BpmnAutoLayout(bpmnModel);</span><br><span class="line">          autoLayout.execute();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      InputStream is = processDiagramGenerator.generateJpgDiagram(bpmnModel);</span><br><span class="line">      <span class="keyword">return</span> ResponseEntity.ok(<span class="keyword">new</span> InputStreamResource(is));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8-1-1-3-org-activiti-spring-boot-EndpointAutoConfiguration"><a href="#8-1-1-3-org-activiti-spring-boot-EndpointAutoConfiguration" class="headerlink" title="8.1.1.3 org.activiti.spring.boot.EndpointAutoConfiguration"></a>8.1.1.3 <code>org.activiti.spring.boot.EndpointAutoConfiguration</code></h4><p><img src="https://user-images.githubusercontent.com/17758731/49380552-f4b6dc80-f74c-11e8-88b1-dd29cba005e1.png" alt="image"></p><blockquote><p>报错原因: SpringBoot2 不再使用 AbstractEndpoint<br>开启该表达式 AutoConfiguration 不会生效, 因此需要删除</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.activiti.spring.boot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.ProcessEngine;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.RepositoryService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.spring.boot.actuate.endpoint.ProcessEngineEndpoint;</span><br><span class="line"><span class="keyword">import</span> org.activiti.spring.boot.actuate.endpoint.ProcessEngineMvcEndpoint;</span><br><span class="line"><span class="comment">//import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The idea behind this module is that Spring Security could</span></span><br><span class="line"><span class="comment"> * talk to the &#123;<span class="doctag">@link</span> org.activiti.engine.IdentityService&#125;</span></span><br><span class="line"><span class="comment"> * as required.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Josh Long</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//@ConditionalOnClass (name = "org.springframework.boot.actuate.endpoint.AbstractEndpoint")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EndpointAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProcessEngineEndpoint <span class="title">processEngineEndpoint</span><span class="params">(ProcessEngine engine)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProcessEngineEndpoint(engine);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProcessEngineMvcEndpoint <span class="title">processEngineMvcEndpoint</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            ProcessEngineEndpoint engineEndpoint, RepositoryService repositoryService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProcessEngineMvcEndpoint(engineEndpoint, repositoryService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8-1-1-4-org-activiti-spring-boot-DataSourceProcessEngineAutoConfiguration"><a href="#8-1-1-4-org-activiti-spring-boot-DataSourceProcessEngineAutoConfiguration" class="headerlink" title="8.1.1.4 org.activiti.spring.boot.DataSourceProcessEngineAutoConfiguration"></a>8.1.1.4 <code>org.activiti.spring.boot.DataSourceProcessEngineAutoConfiguration</code></h4><p><img src="https://user-images.githubusercontent.com/17758731/49381205-5cb9f280-f74e-11e8-8a49-e2ced833c6b2.png" alt="image"></p><blockquote><p>报错原因: ConditionalOnMissingClass 注解中的 name 已经不能使用</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.activiti.spring.boot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.activiti.spring.SpringAsyncExecutor;</span><br><span class="line"><span class="keyword">import</span> org.activiti.spring.SpringProcessEngineConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureAfter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Joram Barrez</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Josh Long</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter</span>(DataSourceAutoConfiguration.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceProcessEngineAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//  @ConditionalOnMissingClass(name= "javax.persistence.EntityManagerFactory")</span></span><br><span class="line">  <span class="meta">@ConditionalOnMissingClass</span>(value= <span class="string">"javax.persistence.EntityManagerFactory"</span>)   <span class="comment">// 将 name 替换为 value</span></span><br><span class="line">  <span class="meta">@EnableConfigurationProperties</span>(ActivitiProperties.class)</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceProcessEngineConfiguration</span> <span class="keyword">extends</span> <span class="title">AbstractProcessEngineAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpringProcessEngineConfiguration <span class="title">springProcessEngineConfiguration</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            DataSource dataSource,</span></span></span><br><span class="line"><span class="function"><span class="params">            PlatformTransactionManager transactionManager,</span></span></span><br><span class="line"><span class="function"><span class="params">            SpringAsyncExecutor springAsyncExecutor)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.baseSpringProcessEngineConfiguration(dataSource, transactionManager, springAsyncExecutor);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8-1-1-4-org-activiti-spring-boot-SecurityAutoConfiguration"><a href="#8-1-1-4-org-activiti-spring-boot-SecurityAutoConfiguration" class="headerlink" title="8.1.1.4 org.activiti.spring.boot.SecurityAutoConfiguration"></a>8.1.1.4 <code>org.activiti.spring.boot.SecurityAutoConfiguration</code></h4><p><img src="https://user-images.githubusercontent.com/17758731/49381360-aa365f80-f74e-11e8-8e61-c70b2fa462ea.png" alt="image"></p><blockquote><p>报错原因: 包结构发生改变, 导致原有的类全路径不可用</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.activiti.engine.IdentityService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.rest.security.BasicAuthenticationProvider;</span><br><span class="line"><span class="keyword">import</span> org.activiti.spring.security.IdentityServiceUserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureBefore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.configurers.GlobalAuthenticationConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Installs a Spring Security adapter for the Activiti</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.activiti.engine.IdentityService&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Josh Long</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//@AutoConfigureBefore(org.springframework.boot.autoconfigure.security.SecurityAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureBefore</span>(org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration.class)   <span class="comment">// 修改类路径</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Configuration</span></span><br><span class="line">  <span class="meta">@ConditionalOnClass</span>( UserDetailsService.class)</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetailsServiceConfiguration</span></span></span><br><span class="line"><span class="class">          <span class="keyword">extends</span> <span class="title">GlobalAuthenticationConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      auth.userDetailsService( userDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">userDetailsService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> IdentityServiceUserDetailsService(<span class="keyword">this</span>.identityService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IdentityService identityService;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Configuration</span></span><br><span class="line">  <span class="meta">@ConditionalOnClass</span>(name = &#123;<span class="string">"org.activiti.rest.service.api.RestUrls"</span>, <span class="string">"org.springframework.web.servlet.DispatcherServlet"</span>&#125;)</span><br><span class="line">  <span class="meta">@EnableWebSecurity</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfiguration</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationProvider <span class="title">authenticationProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> BasicAuthenticationProvider();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      http</span><br><span class="line">        .authenticationProvider(authenticationProvider())</span><br><span class="line">        .csrf().disable()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">          .anyRequest().authenticated()</span><br><span class="line">          .and()</span><br><span class="line">        .httpBasic();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="8-2-对-Activiti-版本做更改"><a href="#8-2-对-Activiti-版本做更改" class="headerlink" title="8.2 对 Activiti 版本做更改"></a>8.2 对 Activiti 版本做更改</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-spring-boot-starters<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-spring-boot-starter-basic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 在此处新增版本 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.0-boot2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;properties&gt; &lt;spring.framework.version&gt;4.1.4.RELEASE&lt;/spring.framework.version&gt; </span></span><br><span class="line"><span class="comment">&lt;/properties&gt; --&gt;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>尝试执行 <code>mvn clean install</code></p><p>此时 maven 会去尝试下载 <code>6.0.0-boot2</code> 版本, 但显然公网仓库中不会存在</p><pre><code>[INFO] Scanning for projects...[INFO] [INFO] ----------&lt; org.activiti:activiti-spring-boot-starter-basic &gt;-----------[INFO] Building activiti-spring-boot-starter-basic 6.0.0-boot2[INFO] --------------------------------[ jar ]---------------------------------[WARNING] The POM for org.activiti:activiti-engine:jar:6.0.0-boot2 is missing, no dependency information available[WARNING] The POM for org.activiti:activiti-spring:jar:6.0.0-boot2 is missing, no dependency information available[WARNING] The POM for org.activiti:activiti-rest:jar:6.0.0-boot2 is missing, no dependency information available[WARNING] The POM for org.activiti:activiti-common-rest:jar:6.0.0-boot2 is missing, no dependency information available[WARNING] The POM for org.activiti:activiti-image-generator:jar:6.0.0-boot2 is missing, no dependency information available[WARNING] The POM for org.activiti:activiti-bpmn-model:jar:6.0.0-boot2 is missing, no dependency information available[WARNING] The POM for org.activiti:activiti-bpmn-layout:jar:6.0.0-boot2 is missing, no dependency information available[INFO] ------------------------------------------------------------------------[INFO] BUILD FAILURE[INFO] ------------------------------------------------------------------------[INFO] Total time:  0.850 s[INFO] Finished at: 2018-12-03T23:15:57+08:00[INFO] ------------------------------------------------------------------------[ERROR] Failed to execute goal on project activiti-spring-boot-starter-basic: Could not resolve dependencies for project org.activiti:activiti-spring-boot-starter-basic:jar:6.0.0-boot2: The following artifacts could not be resolved: org.activiti:activiti-engine:jar:6.0.0-boot2, org.activiti:activiti-spring:jar:6.0.0-boot2, org.activiti:activiti-rest:jar:6.0.0-boot2, org.activiti:activiti-common-rest:jar:6.0.0-boot2, org.activiti:activiti-image-generator:jar:6.0.0-boot2, org.activiti:activiti-bpmn-model:jar:6.0.0-boot2, org.activiti:activiti-bpmn-layout:jar:6.0.0-boot2: Failure to find org.activiti:activiti-engine:jar:6.0.0-boot2 in http://maven.aliyun.com/nexus/content/groups/public was cached in the local repository, resolution will not be reattempted until the update interval of nexus-aliyun has elapsed or updates are forced -&gt; [Help 1][ERROR] [ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.[ERROR] Re-run Maven using the -X switch to enable full debug logging.[ERROR] [ERROR] For more information about the errors and possible solutions, please read the following articles:[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/DependencyResolutionException</code></pre><blockquote><p>错误原因: activiti-spring-boot-starter-basic 的版本号被修改为 6.0.0-boot2, 但安装的时候, 对应的 <code>activiti-engine</code> 版本只有 6.0.0, 并没有 <code>6.0.0-boot2</code><br>可以将所有需要找 <code>6.0.0-boot2</code> 的版本修改为去找 <code>6.0.0</code></p></blockquote><p>将根 pom 中所有的 <code>${project.version}</code> 修改为 <code>6.0.0</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;前段时间入职字节跳动, 目前负责 Lark 工作流审批功能的开发, 选用工作流引擎 &lt;code&gt;Activiti&lt;/code&gt; 进行开发, 因此在此记录下对 &lt;code&gt;Activiti&lt;/code&gt; 的学习过程.&lt;/p&gt;
&lt;/blockquote
      
    
    </summary>
    
      <category term="Activiti" scheme="https://destinywang.github.io/blog/categories/Activiti/"/>
    
      <category term="Java" scheme="https://destinywang.github.io/blog/categories/Activiti/Java/"/>
    
      <category term="工作流" scheme="https://destinywang.github.io/blog/categories/Activiti/Java/%E5%B7%A5%E4%BD%9C%E6%B5%81/"/>
    
    
      <category term="Activiti" scheme="https://destinywang.github.io/blog/tags/Activiti/"/>
    
  </entry>
  
  <entry>
    <title>Golang快速入门</title>
    <link href="https://destinywang.github.io/blog/2018/11/24/Golang%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
    <id>https://destinywang.github.io/blog/2018/11/24/Golang快速入门/</id>
    <published>2018-11-24T02:56:30.000Z</published>
    <updated>2018-11-25T03:13:17.084Z</updated>
    
    <content type="html"><![CDATA[<h1 id="6-函数"><a href="#6-函数" class="headerlink" title="6. 函数"></a>6. 函数</h1><h2 id="6-2-包的引出和使用原理"><a href="#6-2-包的引出和使用原理" class="headerlink" title="6.2 包的引出和使用原理"></a>6.2 包的引出和使用原理</h2><p>当调用另一个文件的函数时, 就需要在调用方引入该文件所在的 <code>package</code></p><blockquote><p>Go 代码的每一个文件都是属于一个包的, 也就是说 Go 是以包的形式来管理文件和项目目录结构的.</p></blockquote><p>Go 语言中, 每个文件夹下的所有 Go 源代码必须属于同一个包, 推荐与文件夹名相同. 而在 import 的时候, 只以包为基本单位而不是 Go 源码文件.</p><p>包的基本作用:</p><ol><li>区分相同名称的函数, 变量等标识符</li><li>管理项目</li><li>控制函数, 变量等访问范围</li></ol><p>声明 package 的基本语法:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> <span class="string">`包名`</span></span><br></pre></td></tr></table></figure></p><p>引入包的基本语法<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">`包路径`</span></span><br></pre></td></tr></table></figure></p><p>在引入包路径的时候, 是从 <code>$GOPATH/src</code> 路径下开始引入</p><h4 id="包的注意事项和细节"><a href="#包的注意事项和细节" class="headerlink" title="包的注意事项和细节"></a>包的注意事项和细节</h4><ol><li>在该一个文件打包的时候, 该包对应一个文件夹, 文件的包名通常和文件所在的文件夹名一致, 且一般为小写字母;</li><li>当一个文件要使用其他包函数或变量的时候, 需要先引入对应的包<br>package 指令在文件第一行, 然后是 import 指令<br>在 import 包时, 路径从 <code>$GOPATH/src</code> 下开始, 不用带 src, 编译器会自动从 src 下开始引入. 如当执行 <code>import fmt</code> 的时候, 实际上是从 <code>$GOPATH/src/fmt</code> 进行引入.</li><li>为了让其他包的文件可以访问到本包的函数, 则需要首字母大写, 类似其他编程语言的 <code>public</code>, 这样才能跨包访问;</li><li>在访问其他包函数的时候, 去语法是 <code>包名.函数名</code></li><li>如果报名比较长, Go 支持给包取别名, 而取别名后, 原包名就不可再使用;</li><li>在同一个包下, 不能有相同的函数名或相同的全局变量, 否则会报重复定义的错;</li><li>如果需要编译一个可执行程序文件, 就需要将这个包声明为 <code>main</code>, 即 <code>package main</code></li></ol><h2 id="6-3-函数调用机制底层剖析"><a href="#6-3-函数调用机制底层剖析" class="headerlink" title="6.3 函数调用机制底层剖析"></a>6.3 函数调用机制底层剖析</h2><h3 id="6-3-1-运行时内存结构"><a href="#6-3-1-运行时内存结构" class="headerlink" title="6.3.1 运行时内存结构"></a>6.3.1 运行时内存结构</h3><ol><li>在调用一个函数时, 会给该函数重新分配一个新的空间, 编译器会通过自身的处理让这个新的空间和其他栈空间分开;</li><li>在每个函数对应的栈中, 数据空间是独立的, 不会混淆;</li><li>当一个函数调用完毕后, 程序会销毁这个函数对应的栈空间.</li></ol><p><img src=".Golang快速入门_images/a4522b60.png" alt=""></p><h3 id="6-3-2-return-语句"><a href="#6-3-2-return-语句" class="headerlink" title="6.3.2 return 语句"></a>6.3.2 return 语句</h3><blockquote><p>Go 函数支持返回多个值</p></blockquote><ol><li>如果返回多个值时, 在接收时, 如果希望忽略某个返回值, 可以使用 <code>_</code> 符号表示忽略</li><li>如果返回值只有一个, <code>(返回值类型列表)</code> 可以不写 <code>()</code><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> 函数名<span class="params">(形参列表...)</span> <span class="params">(返回值类型列表...)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 函数体</span></span><br><span class="line">    <span class="keyword">return</span> 返回值列表</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="6-4-函数的递归调用"><a href="#6-4-函数的递归调用" class="headerlink" title="6.4 函数的递归调用"></a>6.4 函数的递归调用</h2><blockquote><p>函数体内又调用了自身, 这个过程就叫做递归</p></blockquote><p>递归函数需要遵守的规则:</p><ol><li>执行一个函数时, 就创建一个新的受保护的独立内存空间(新函数栈);</li><li>函数的局部变量是独立的, 不会相互影响;</li><li>递归必须向退出的条件逼近;</li><li>当一个函数执行完毕, 或者遇到 <code>return</code>, 就会返回, 遵守谁调用就将结果返回给谁, 同时当函数执行完毕或者返回时, 该函数本身也会被系统销毁.</li></ol><h3 id="6-4-1-Fibonacci-数列"><a href="#6-4-1-Fibonacci-数列" class="headerlink" title="6.4.1 Fibonacci 数列"></a>6.4.1 Fibonacci 数列</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fibonacci</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">1</span> || n == <span class="number">2</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fibonacci(n - <span class="number">1</span>) + finonacci(n - <span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-4-2-求函数值"><a href="#6-4-2-求函数值" class="headerlink" title="6.4.2 求函数值"></a>6.4.2 求函数值</h3><blockquote><p>f(1)=3;<br>f(n)=2*f(n-1)+1</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> * f(n<span class="number">-1</span>) + <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-4-3-猴子吃桃"><a href="#6-4-3-猴子吃桃" class="headerlink" title="6.4.3 猴子吃桃"></a>6.4.3 猴子吃桃</h3><blockquote><p>有一堆桃子, 猴子第一天吃了其中的一半又多吃了一个, 后面每天都吃其中的一半再多一个, 当吃到第 10 天的时候发现只有一个桃子, 求最初有多少个桃子.</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// peach(n) = (peach(n+1) + 1) * 2</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">peach</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (peach(n+<span class="number">1</span>) + <span class="number">1</span>) * <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-5-函数注意事项和细节讨论"><a href="#6-5-函数注意事项和细节讨论" class="headerlink" title="6.5 函数注意事项和细节讨论"></a>6.5 函数注意事项和细节讨论</h2><ol><li>函数的形参列表可以是多个, 返回值列表也可以是多个;</li><li>形参列表和返回值列表的数据类型可以是值类型和引用类型;</li><li>函数的命名规范遵循标识符命名规范, 首字母不能使数字, 首字母大写该函数可以被其他包访问, 类似 <code>public</code>; 首字母小写, 只能被本包文件使用, 其他包文件不能访问, 类似 <code>private</code>;</li><li>函数中变量是局部的, 函数外不生效;</li><li>基本数据类型和数组默认是值传递, 即进行值拷贝, 在函数内修改, 不会影响到原来的值;</li><li>如果希望函数内的变量能修改函数外的变量, 可以传入变量的地址 <code>&amp;变量标识符</code>, 函数内以指针的方式操作变量;</li><li>Go 语言的函数不支持重载;</li><li>在 Go 中, 函数也是一种数据类型, 可以赋值给一个变量, 则该变量就是一个函数类型的变量了, 通过该变量可以对函数调用;</li><li>既然函数时一种数据类型, 那么在 Go 中, 函数可以作为形参传递并且被调用.</li><li>为了简化数据类型定义, Go 支持自定义数据类型, 基本语法 <code>type 自定义数据类型名 数据类型</code>, 相当于一个别名;</li><li>支持对函数返回值命名.</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;6-函数&quot;&gt;&lt;a href=&quot;#6-函数&quot; class=&quot;headerlink&quot; title=&quot;6. 函数&quot;&gt;&lt;/a&gt;6. 函数&lt;/h1&gt;&lt;h2 id=&quot;6-2-包的引出和使用原理&quot;&gt;&lt;a href=&quot;#6-2-包的引出和使用原理&quot; class=&quot;headerli
      
    
    </summary>
    
      <category term="Golang" scheme="https://destinywang.github.io/blog/categories/Golang/"/>
    
    
      <category term="Golang" scheme="https://destinywang.github.io/blog/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>Go语言入门(3)--面向接口</title>
    <link href="https://destinywang.github.io/blog/2018/11/18/Go%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A8-3-%E9%9D%A2%E5%90%91%E6%8E%A5%E5%8F%A3/"/>
    <id>https://destinywang.github.io/blog/2018/11/18/Go语言入门-3-面向接口/</id>
    <published>2018-11-18T02:53:18.000Z</published>
    <updated>2018-11-18T12:28:56.969Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Go 语言面向对象只支持封装, 传统面向对象语言中靠继承和多态完成的事情在 Go 中都是通过接口来完成, 因此 Go 中的接口比传统的语言灵活很多</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Traversal <span class="keyword">interface</span> &#123;</span><br><span class="line">    Traverse()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    traversal := getTraversal()</span><br><span class="line">    traversal.Traverse()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="1-duck-typing"><a href="#1-duck-typing" class="headerlink" title="1. duck typing"></a>1. duck typing</h1><blockquote><p>“像鸭子走路, 像鸭子叫(长得像鸭子), 那么它就是鸭子”</p></blockquote><p>描述事物的外部行为而非内部结构</p><p>严格来说 Go 属于结构化类型系统, 类似 <code>duck typing</code></p><h2 id="1-1-python-中的-ducking-typing"><a href="#1-1-python-中的-ducking-typing" class="headerlink" title="1.1 python 中的 ducking typing"></a>1.1 python 中的 ducking typing</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(retriever)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> retriever.get(<span class="string">"org.destiny.io"</span>)</span><br></pre></td></tr></table></figure><ul><li>运行时才知道传入的 retriever 有没有 <code>get</code></li><li>通常需要注释来说明接口</li></ul><h2 id="1-2-C-中的-ducking-typing"><a href="#1-2-C-中的-ducking-typing" class="headerlink" title="1.2 C++ 中的 ducking typing"></a>1.2 C++ 中的 ducking typing</h2><p>通过模板来实现 duck typing, 编译时才知道传入的 retriever 有没有 get, 而在编写代码的时候不能直接感知, 因此也需要注释来说明接口</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">R</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">string</span> <span class="title">download</span>(<span class="title">const</span> <span class="title">R</span>&amp; <span class="title">retriever</span>) &#123;</span></span><br><span class="line">    <span class="keyword">return</span> retriever.get(<span class="string">"org.destiny.io"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-3-Java-中的类似代码"><a href="#1-3-Java-中的类似代码" class="headerlink" title="1.3 Java 中的类似代码"></a>1.3 Java 中的类似代码</h2><p>传入的参数必须实现 Retriever 接口<br>但不属于 duck typing</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;R extends Retriever&gt;</span><br><span class="line"><span class="function">String <span class="title">downlaad</span><span class="params">(R r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> r.get(<span class="string">"org.destiny.io"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-4-Go-语言中的-duck-typing"><a href="#1-4-Go-语言中的-duck-typing" class="headerlink" title="1.4 Go 语言中的 duck typing"></a>1.4 Go 语言中的 duck typing</h2><ul><li>同时需要 <code>Readable</code>, <code>Appendable</code> 怎么办</li><li>同时具有 python, C++ 的 duck typing 的灵活性</li><li>又具有 Java 的类型检查</li></ul><h1 id="2-接口的定义和实现"><a href="#2-接口的定义和实现" class="headerlink" title="2. 接口的定义和实现"></a>2. 接口的定义和实现</h1><ul><li>download: 使用者</li><li>retriever: 实现者</li></ul><p>接口由使用者定义</p><blockquote><p>main.go<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Retriever <span class="keyword">interface</span> &#123;</span><br><span class="line">    Get(url <span class="keyword">string</span>) <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">download</span><span class="params">(r Retriever)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> r.Get(<span class="string">"org.destiny.io"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> r Retriever</span><br><span class="line">    r = mock.Retriever&#123;<span class="string">"this is a mock Retriever"</span>&#125;</span><br><span class="line">    fmt.Println(download(r))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>retriever.go<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Retriever <span class="keyword">struct</span> &#123;</span><br><span class="line">    Contents <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r Retriever)</span> <span class="title">Get</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> r.Contents</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>real/retriever.go<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Retriever <span class="keyword">struct</span> &#123;</span><br><span class="line">    UserAgent <span class="keyword">string</span></span><br><span class="line">    TimeOut time.Duration</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r Retriever)</span> <span class="title">Get</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    resp, err := http.Get(url)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    result, err := httputil.DumpResponse(resp, <span class="literal">true</span>)</span><br><span class="line">    resp.Body.Close()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">string</span>(result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>main/retriever.go<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> r Retriever</span><br><span class="line">    r = <span class="built_in">real</span>.Retriever&#123;&#125;</span><br><span class="line">    fmt.Println(download(r))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><h1 id="3-接口的值类型"><a href="#3-接口的值类型" class="headerlink" title="3. 接口的值类型"></a>3. 接口的值类型</h1><p>继续上例:<br>打印出 <code>r</code> 的具体类型</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> r Retriever</span><br><span class="line">    r = mock.Retriever&#123;<span class="string">"this is a mock Retriever"</span>&#125;</span><br><span class="line">    fmt.Printf(<span class="string">"%T, %v\n"</span>, r, r)    <span class="comment">// mock.Retriever &#123;this is a mock Retriever&#125;</span></span><br><span class="line">    r = <span class="built_in">real</span>.Retriever&#123;&#125;</span><br><span class="line">    <span class="comment">// 输出的空格代表 string 类型的 UserAgent, 0s 代表 time.Duration 类型的额 TimeOut</span></span><br><span class="line">    fmt.Printf(<span class="string">"%T, %v\n"</span>, r, r)    <span class="comment">// real.Retriever &#123; 0s&#125;</span></span><br><span class="line">    fmt.Println(download(r))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>r 中一共包含两项内容:<br>r 的类型以及 r 的内容</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;Go 语言面向对象只支持封装, 传统面向对象语言中靠继承和多态完成的事情在 Go 中都是通过接口来完成, 因此 Go 中的接口比传统的语言灵活很多&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;ta
      
    
    </summary>
    
      <category term="golang" scheme="https://destinywang.github.io/blog/categories/golang/"/>
    
    
      <category term="golang" scheme="https://destinywang.github.io/blog/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Go语言入门(2)--面向接口</title>
    <link href="https://destinywang.github.io/blog/2018/11/06/Go%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A8-2-%E9%9D%A2%E5%90%91%E6%8E%A5%E5%8F%A3/"/>
    <id>https://destinywang.github.io/blog/2018/11/06/Go语言入门-2-面向接口/</id>
    <published>2018-11-06T12:14:18.000Z</published>
    <updated>2018-11-07T12:25:33.050Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-结构体和方法"><a href="#1-结构体和方法" class="headerlink" title="1. 结构体和方法"></a>1. 结构体和方法</h1><ul><li>go 语言只支持封装, 不支持继承和多态</li><li>go 语言没有 class, 只有 struct</li></ul><h2 id="1-1-结构的创建"><a href="#1-1-结构的创建" class="headerlink" title="1.1 结构的创建"></a>1.1 结构的创建</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TreeNode <span class="keyword">struct</span> &#123;</span><br><span class="line">    Left, Right * TreeNode</span><br><span class="line">    value <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 创建一个 value 为 0, left, right 都为 nil 的 treeNode</span></span><br><span class="line"><span class="keyword">var</span> root treeNode</span><br><span class="line">fmt.Println(root)<span class="comment">// &#123;0 &lt;nil&gt; &lt;nil&gt;&#125;</span></span><br><span class="line"></span><br><span class="line">root1 := treeNode&#123;value:<span class="number">3</span>, left:&amp;treeNode&#123;&#125;, right:&amp;treeNode&#123;<span class="number">5</span>, <span class="literal">nil</span>, <span class="literal">nil</span>&#125;&#125;</span><br><span class="line">root1.right.left = <span class="built_in">new</span>(treeNode)</span><br><span class="line">fmt.Println(root1)<span class="comment">// &#123;3 0xc00000a080 0xc00000a0a0&#125;</span></span><br><span class="line">fmt.Println(*root1.left)<span class="comment">// &amp;&#123;0 &lt;nil&gt; &lt;nil&gt;&#125;</span></span><br><span class="line">fmt.Println(*root1.right)<span class="comment">// &amp;&#123;5 0xc00000a0c0 &lt;nil&gt;&#125;</span></span><br><span class="line">fmt.Println(*root1.right.left)<span class="comment">// &amp;&#123;0 &lt;nil&gt; &lt;nil&gt;&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-2-结构的方法"><a href="#1-2-结构的方法" class="headerlink" title="1.2 结构的方法"></a>1.2 结构的方法</h2><p>行如接受者的写法, 也是采用值传递, 也就意味着如果需要在函数内对结构体做修改, 必须采用传指针的方式</p><ul><li><code>func (node treeNode) print() {...}</code> 只能完成读操作</li><li><code>func (node *treeNode) setValue() {...}</code> 才能进行修改</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> treeNode <span class="keyword">struct</span> &#123;</span><br><span class="line">value <span class="keyword">int</span></span><br><span class="line">left, right * treeNode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为结构体创建方法的时候, 不能直接写在结构体内部</span></span><br><span class="line"><span class="comment">// 在函数名的前面加了一个括号, 称为接收者</span></span><br><span class="line"><span class="comment">// 代表 print 函数并非无参, 而是必须由 treeNode 对象来调用</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node treeNode)</span> <span class="title">print</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(node.value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 创建一个 value 为 0, left, right 都为 nil 的 treeNode</span></span><br><span class="line"><span class="keyword">var</span> root treeNode</span><br><span class="line">fmt.Println(root)<span class="comment">// &#123;0 &lt;nil&gt; &lt;nil&gt;&#125;</span></span><br><span class="line"></span><br><span class="line">root1 := treeNode&#123;value:<span class="number">3</span>, left:&amp;treeNode&#123;&#125;, right:&amp;treeNode&#123;<span class="number">5</span>, <span class="literal">nil</span>, <span class="literal">nil</span>&#125;&#125;</span><br><span class="line">root1.right.left = <span class="built_in">new</span>(treeNode)</span><br><span class="line">fmt.Println(root1)<span class="comment">// &#123;3 0xc00000a080 0xc00000a0a0&#125;</span></span><br><span class="line">fmt.Println(*root1.left)<span class="comment">// &amp;&#123;0 &lt;nil&gt; &lt;nil&gt;&#125;</span></span><br><span class="line">fmt.Println(*root1.right)<span class="comment">// &amp;&#123;5 0xc00000a0c0 &lt;nil&gt;&#125;</span></span><br><span class="line">fmt.Println(*root1.right.left)<span class="comment">// &amp;&#123;0 &lt;nil&gt; &lt;nil&gt;&#125;</span></span><br><span class="line"></span><br><span class="line">root.<span class="built_in">print</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>go 语言中的函数自身做了兼容, 调用参数的使用, 不论采用传值还是传地址, 都可以按照函数的要求自动转型</p><ul><li>实际调用如果是传指针, 编译器会自动将结构体取地址</li><li>实际调用如果是传值, 编译器会自动将指针解引用</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node treeNode)</span> <span class="title">print</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(node.value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node treeNode)</span> <span class="title">setValue</span><span class="params">(value <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">node.value = value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    pRoot := &amp;root</span><br><span class="line">pRoot.<span class="built_in">print</span>()</span><br><span class="line">pRoot.setValue(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">aRoot := root</span><br><span class="line">aRoot.<span class="built_in">print</span>()</span><br><span class="line">aRoot.setValue(<span class="number">200</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>只有使用指针才能改变结构的内容<br>nil 指针也可以调用方法</p></blockquote><blockquote><p>值接受者与指针接收者:<br>要改变必须使用指针接收者<br>结构过大也需要考虑使用指针接收者<br>值接受者是 go 语言特有的概念<br>值/指针接受者均可接受值/指针, 编译器会自行做修正</p></blockquote><h1 id="2-包和封装"><a href="#2-包和封装" class="headerlink" title="2. 包和封装"></a>2. 包和封装</h1><ul><li>名字一般使用 <code>CamelCase</code></li><li>首字母大写: public</li><li>首字母小写: private</li></ul><blockquote><p>而 public 和 private 的概念是针对包提出的</p></blockquote><ul><li>每个目录一个包</li><li>main 包比较特殊, 包含可执行入口</li><li>为结构定义的方法必须放在同一个包内</li><li>可以是不同的文件</li></ul><h1 id="3-扩展已有类型"><a href="#3-扩展已有类型" class="headerlink" title="3. 扩展已有类型"></a>3. 扩展已有类型</h1><p>既然 go 语言没有继承和多态, 该如何去扩充系统类型或者别人的类型:</p><ul><li>定义别名</li><li>使用组合</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> queue</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Queue []<span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queue)</span> <span class="title">Push</span><span class="params">(v <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">*q = <span class="built_in">append</span>(*q, v)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queue)</span> <span class="title">Pop</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">head := (*q)[<span class="number">0</span>]</span><br><span class="line">*q = (*q)[<span class="number">1</span>:]</span><br><span class="line"><span class="keyword">return</span> head</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queue)</span> <span class="title">IsEmpty</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">len</span>(*q) == <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"demo/queue"</span></span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">q := queue.Queue&#123;<span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line">q.Push(<span class="number">2</span>)</span><br><span class="line">q.Push(<span class="number">3</span>)</span><br><span class="line">fmt.Println(q.Pop())<span class="comment">// 1</span></span><br><span class="line">fmt.Println(q.Pop())<span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">fmt.Println(q.IsEmpty())<span class="comment">// false</span></span><br><span class="line">fmt.Println(q.Pop())<span class="comment">// 3</span></span><br><span class="line">fmt.Println(q.IsEmpty())<span class="comment">// true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;1-结构体和方法&quot;&gt;&lt;a href=&quot;#1-结构体和方法&quot; class=&quot;headerlink&quot; title=&quot;1. 结构体和方法&quot;&gt;&lt;/a&gt;1. 结构体和方法&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;go 语言只支持封装, 不支持继承和多态&lt;/li&gt;
&lt;li&gt;go 语言没有 
      
    
    </summary>
    
      <category term="golang" scheme="https://destinywang.github.io/blog/categories/golang/"/>
    
    
      <category term="golang" scheme="https://destinywang.github.io/blog/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Go语言入门(1)--基本语法</title>
    <link href="https://destinywang.github.io/blog/2018/11/04/Go%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A8-1-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/"/>
    <id>https://destinywang.github.io/blog/2018/11/04/Go语言入门-1-基本语法/</id>
    <published>2018-11-04T03:12:52.000Z</published>
    <updated>2018-11-06T12:15:43.518Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-安装与环境"><a href="#1-安装与环境" class="headerlink" title="1. 安装与环境"></a>1. 安装与环境</h1><ul><li>下载: <a href="https://studygolang.com/dl" target="_blank" rel="noopener">https://studygolang.com/dl</a></li><li>Mac 默认安装在 <code>/usr/local/go/</code> 路径下</li></ul><h1 id="2-基本语法"><a href="#2-基本语法" class="headerlink" title="2. 基本语法"></a>2. 基本语法</h1><h3 id="基本输出"><a href="#基本输出" class="headerlink" title="基本输出"></a>基本输出</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"Hello World"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-1-变量"><a href="#2-1-变量" class="headerlink" title="2.1 变量"></a>2.1 变量</h2><h3 id="2-1-1-定义变量"><a href="#2-1-1-定义变量" class="headerlink" title="2.1.1 定义变量"></a>2.1.1 定义变量</h3><ul><li>使用 <code>var</code> 关键字<ul><li><code>var a, b, c</code></li><li><code>var s1, s2 = &quot;abc&quot;, &quot;def&quot;</code></li><li>可放在函数内, 也可放在保内</li><li>在 <code>var()</code> 中集中定义</li></ul></li><li>编译器可以自动决定类型<ul><li><code>var q, w, e, r = 1, true, variable, &quot;a&quot;</code></li></ul></li><li>使用 <code>:=</code> 定义变量<ul><li><code>z, x, v, c := 1, true, variable, &quot;a&quot;</code></li><li>只能在函数内使用</li></ul></li></ul><h3 id="2-1-2-内建变量类型"><a href="#2-1-2-内建变量类型" class="headerlink" title="2.1.2 内建变量类型"></a>2.1.2 内建变量类型</h3><ul><li>bool, string</li><li>(u)int, (u)int8, (u)int16, (u)int32, (u)int64, uintptr</li><li>byte, rune(长度四个字节, 代表一个字符, 类似 char)</li><li>float32, float64, complex64, complex128(复数类型)</li></ul><p>特别需要注意 go 对复数的支持:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">euler</span><span class="params">()</span></span> &#123;</span><br><span class="line">i := <span class="number">1</span></span><br><span class="line"><span class="comment">// 在表示负数的时候, 虚部直接与 i 连写就可以</span></span><br><span class="line">c1 := <span class="number">3</span> + <span class="number">4i</span></span><br><span class="line"><span class="comment">// 如果中间加上 *, 会变成乘法表达式</span></span><br><span class="line">c2 := <span class="number">3</span> + <span class="number">4</span> * i</span><br><span class="line">fmt.Println(c1, c2)<span class="comment">// 输出结果: (3+4i) 7</span></span><br><span class="line">fmt.Println(cmplx.Abs(c1))<span class="comment">// 输出结果: 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 证明欧拉定律</span></span><br><span class="line">fmt.Printf(<span class="string">"%.4f"</span>, cmplx.Pow(math.E, <span class="number">1i</span> * math.Pi) + <span class="number">1</span>)<span class="comment">// 输出结果: (0.0000+0.0000i)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="2-1-3-强制类型转换"><a href="#2-1-3-强制类型转换" class="headerlink" title="2.1.3 强制类型转换"></a>2.1.3 强制类型转换</h3><blockquote><p>go 语言只有强制类型转换, 没有隐式类型转换</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">triangle</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> a, b <span class="keyword">int</span> = <span class="number">3</span>, <span class="number">4</span></span><br><span class="line"><span class="keyword">var</span> c <span class="keyword">int</span></span><br><span class="line"><span class="comment">// 最初的方案 math.Sqrt(a * a + b * b) 会报错</span></span><br><span class="line"><span class="comment">// 因为 Sqrt 函数的参数和返回值都是 float64 类型的, 需要进行强制类型转换</span></span><br><span class="line">c = <span class="keyword">int</span>(math.Sqrt(<span class="keyword">float64</span>(a*a + b*b)))</span><br><span class="line">fmt.Println(c)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-1-4-常量的定义"><a href="#2-1-4-常量的定义" class="headerlink" title="2.1.4 常量的定义"></a>2.1.4 常量的定义</h3><ul><li>语法: <code>const filename = &quot;abc.txt&quot;</code></li><li>const 数值可作为各种类型</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consts</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">const</span> fileName = <span class="string">"abc.txt"</span></span><br><span class="line"><span class="keyword">const</span> a, b = <span class="number">3</span>, <span class="number">4</span></span><br><span class="line"><span class="keyword">var</span> c <span class="keyword">int</span></span><br><span class="line"><span class="comment">// 此处不同于 var, 常量类似于文本替换, 只要不定义类型, 就可以表示成多种类型</span></span><br><span class="line">c = <span class="keyword">int</span>(math.Sqrt(a*a + b*b))</span><br><span class="line">fmt.Println(c)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-1-5-枚举"><a href="#2-1-5-枚举" class="headerlink" title="2.1.5 枚举"></a>2.1.5 枚举</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">enums</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">cpp    = <span class="number">0</span></span><br><span class="line">java   = <span class="number">1</span></span><br><span class="line">python = <span class="number">2</span></span><br><span class="line">golang = <span class="number">3</span></span><br><span class="line">)</span><br><span class="line">fmt.Println(cpp, java, python, golang)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>go 语言为这种语法做了简化<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">enums</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line"><span class="comment">// iota 表示这组 const 是自增值</span></span><br><span class="line">cpp = <span class="literal">iota</span></span><br><span class="line">java</span><br><span class="line">python</span><br><span class="line">golang</span><br><span class="line">)</span><br><span class="line">fmt.Println(cpp, java, python, golang)<span class="comment">// 输出: 0 1 2 3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以使用 <code>iota</code> 参与运算, 实现复杂的枚举初始值<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">enums</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 使用 iota 参与运算</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">b = <span class="number">1</span> &lt;&lt; (<span class="number">10</span> * <span class="literal">iota</span>)</span><br><span class="line">kb</span><br><span class="line">mb</span><br><span class="line">gb</span><br><span class="line">tb</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">fmt.Println(b, kb, mb, gb, tb)<span class="comment">// 输出结果: 1 1024 1048576 1073741824 1099511627776</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="2-2-条件语句"><a href="#2-2-条件语句" class="headerlink" title="2.2 条件语句"></a>2.2 条件语句</h2><h3 id="2-2-1-if-else"><a href="#2-2-1-if-else" class="headerlink" title="2.2.1 if else"></a>2.2.1 if else</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">const</span> filename = <span class="string">"abc.txt"</span></span><br><span class="line">contents, err := ioutil.ReadFile(filename)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"%s\n"</span>, contents)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>go 中的条件判断可以简化成如下形式:</p><ul><li>if 条件语句中可以赋值;</li><li>if 条件中赋值的变量作用域就在这个 if 中.</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">const</span> filename = <span class="string">"abc.txt"</span></span><br><span class="line"><span class="keyword">if</span> contents, err := ioutil.ReadFile(filename); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"%s\n"</span>, contents)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-2-switch"><a href="#2-2-2-switch" class="headerlink" title="2.2.2 switch"></a>2.2.2 switch</h3><blockquote><p>go 中的 switch 会自动 break, 除非使用 <code>fallthrough</code></p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">grade</span><span class="params">(score <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">g := <span class="string">""</span></span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line"><span class="keyword">case</span> score &lt; <span class="number">60</span>:</span><br><span class="line">g = <span class="string">"F"</span></span><br><span class="line"><span class="keyword">case</span> score &lt; <span class="number">80</span>:</span><br><span class="line">g = <span class="string">"C"</span></span><br><span class="line"><span class="keyword">case</span> score &lt; <span class="number">90</span>:</span><br><span class="line">g = <span class="string">"B"</span></span><br><span class="line"><span class="keyword">case</span> score &lt;= <span class="number">100</span>:</span><br><span class="line">g = <span class="string">"A"</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"wrong score: %d"</span>, score))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> g</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-3-循环"><a href="#2-2-3-循环" class="headerlink" title="2.2.3 循环"></a>2.2.3 循环</h3><ul><li>for 的条件中不需要括号</li><li>for 的条件里可以省略初始条件, 结束条件, 递增表达式</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">convertToBin</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    result := <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> ; n &gt; <span class="number">0</span>; n /= <span class="number">2</span> &#123;</span><br><span class="line">lsb := n % <span class="number">2</span></span><br><span class="line">result = strconv.Itoa(lsb) + result</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>省略初始条件, 相当于 while</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> scanner.Scan() &#123;</span><br><span class="line">    fmt.Println(scanner.Text())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>无限循环</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"forever"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-3-函数"><a href="#2-3-函数" class="headerlink" title="2.3 函数"></a>2.3 函数</h2><ul><li>函数名在前, 返回类型在后</li><li>可返回多个值</li><li>函数可以作为参数</li><li>没有默认参数, 可选参数</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">eval</span><span class="params">(a, b <span class="keyword">int</span>, op <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">result := <span class="number">0</span></span><br><span class="line"><span class="keyword">switch</span> op &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"+"</span>:</span><br><span class="line">result = a + b</span><br><span class="line"><span class="keyword">case</span> <span class="string">"-"</span>:</span><br><span class="line">result = a - b</span><br><span class="line"><span class="keyword">case</span> <span class="string">"*"</span>:</span><br><span class="line">result = a * b</span><br><span class="line"><span class="keyword">case</span> <span class="string">"/"</span>:</span><br><span class="line">result = a / b</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">"unsupported operation: "</span> + op)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>go 语言中的函数还可以一次返回多个值<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当需要返回多种类型时, 所有类型需要按顺序写在参数列表后的括号中</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">div</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> a / b, a % b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>go 语言的函数在返回多值的情况下, 可以指定变量名<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">div</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="params">(q, r <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> a / b, a % b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在接受具有多个返回值的函数执行结果时, 如果存在某些返回值不需要, 可以使用 <code>_</code> 的方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">q, r = div(16, 7)       // 两个返回值都需要</span><br><span class="line">q, _ = div(16, 7)       // 只需要第一个返回值</span><br></pre></td></tr></table></figure></p><h4 id="函数指针"><a href="#函数指针" class="headerlink" title="函数指针"></a>函数指针</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * apply 函数接收三个参数 1. 一个参数为两个 int 并且返回一个 int 的函数</span></span><br><span class="line"><span class="comment"> * 2. 一个 int</span></span><br><span class="line"><span class="comment"> * 3. 一个 int</span></span><br><span class="line"><span class="comment"> * 并且自身返回一个int</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">apply</span><span class="params">(op <span class="keyword">func</span>(<span class="keyword">int</span>, <span class="keyword">int</span>)</span> <span class="title">int</span>, <span class="title">a</span>, <span class="title">b</span> <span class="title">int</span>) <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="comment">// 获取指向 op 函数的指针</span></span><br><span class="line">pointer := reflect.ValueOf(op).Pointer()</span><br><span class="line"><span class="comment">// 通过反射获取函数名</span></span><br><span class="line">opName := runtime.FuncForPC(pointer).Name()</span><br><span class="line">fmt.Printf(<span class="string">"Calling function %s with args (%d, %d)"</span>, opName, a, b)     <span class="comment">// 输出结果: Calling function main.pow with args (3, 4)</span></span><br><span class="line">fmt.Println()</span><br><span class="line"><span class="keyword">return</span> op(a, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pow</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">int</span>(math.Pow(<span class="keyword">float64</span>(a), <span class="keyword">float64</span>(b)))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(apply(pow, <span class="number">3</span>, <span class="number">4</span>))       <span class="comment">// 输出结果: 81</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以直接把 pow 函数调用处在调用处声明为匿名函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(apply(<span class="function"><span class="keyword">func</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">int</span>(math.Pow(<span class="keyword">float64</span>(a), <span class="keyword">float64</span>(b)))</span><br><span class="line">&#125;, <span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-4-指针"><a href="#2-4-指针" class="headerlink" title="2.4 指针"></a>2.4 指针</h2><ul><li>go 语言的指针不同于 C 的指针, 不能参与运算</li><li>go 语言之后值传递一种方式</li></ul><blockquote><p>值传递与引用传递<br>值传递: 调用方法的时候将参数做了一份拷贝, 与调用方的参数无关<br>引用传递: 不进行拷贝, 可能会对原值进行修改<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pass_by_val</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">    a++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pass_by_ref</span><span class="params">(<span class="keyword">int</span>&amp; a)</span> </span>&#123;</span><br><span class="line">    a++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">3</span>;</span><br><span class="line">    pass_by_val(a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"After pass_by_val: %d\n"</span>, a)    <span class="comment">// 3</span></span><br><span class="line">    pass_by_ref(a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"After pass_by_ref: %d\n"</span>, a)    <span class="comment">// 4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><table><thead><tr><th>变量</th><th>函数</th><th>调用结果</th></tr></thead><tbody><tr><td><code>var a int</code></td><td><code>func f(a int)</code></td><td>f 函数的会对 a 的副本进行操作, 无论如何操作都不会影响原值</td></tr><tr><td><code>var a int</code></td><td><code>func f(pa *int)</code></td><td>f 函数对 a 的修改会影响到原值</td></tr><tr><td><code>var cache Cache</code></td><td><code>func f(cache Cache)</code></td><td>cache 本身是一个指针</td></tr></tbody></table><p>交换值:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">swap</span><span class="params">(a, b *<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">*b, *a = *a, *b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">swap1</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> b, a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a, b := <span class="number">3</span>, <span class="number">4</span></span><br><span class="line">swap(&amp;a, &amp;b)</span><br><span class="line">fmt.Println(a, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="3-内建容器"><a href="#3-内建容器" class="headerlink" title="3. 内建容器"></a>3. 内建容器</h1><h2 id="3-1-数组"><a href="#3-1-数组" class="headerlink" title="3.1 数组"></a>3.1 数组</h2><ul><li>数量写在类型前</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 如果不进行初始化, int 数组所有元素都是0</span></span><br><span class="line"><span class="keyword">var</span> arr1 [<span class="number">5</span>]<span class="keyword">int</span></span><br><span class="line"><span class="comment">// 使用 := 初始化的时候, 必须初始化内容</span></span><br><span class="line">arr2 := [<span class="number">3</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>&#125;</span><br><span class="line"><span class="comment">// 可以不指定长度, 由编译器去填充</span></span><br><span class="line">arr3 := [...]<span class="keyword">int</span>&#123;<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span>&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(arr1, arr2, arr3)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>数组是值类型, 即传参的时候会进行 copy</p></blockquote><ul><li>[10]int 和 [20]int 是不同类型</li><li>与大部分语言的设计不同, 调用 func f(arr [10]int) 时会 copy 数组</li><li>在 go 语言中一般不直接使用数组, 而是切片</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printArray</span><span class="params">(arr [5]<span class="keyword">int</span>)</span></span>  &#123;</span><br><span class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> arr &#123;</span><br><span class="line"><span class="built_in">println</span>(i, v)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    printArray(arr1)</span><br><span class="line">printArray(arr2)    <span class="comment">// 会报错: cannot use arr2 (type [3]int) as type [5]int in argument to printArray</span></span><br><span class="line">printArray(arr3)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的例子说明, 在 go 语言中, 长度为 3 的数组和长度为 5 的数组是不同的数据类型, 不能作为参数传递给 <code>printArray</code></p><h4 id="在函数调用中传递数组指针"><a href="#在函数调用中传递数组指针" class="headerlink" title="在函数调用中传递数组指针"></a>在函数调用中传递数组指针</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printArray</span><span class="params">(arr *[5]<span class="keyword">int</span>)</span></span>  &#123;</span><br><span class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> arr &#123;</span><br><span class="line">fmt.Println(i, v)</span><br><span class="line">&#125;</span><br><span class="line">arr[<span class="number">0</span>] = <span class="number">100</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    printArray(&amp;arr1)   <span class="comment">// [100, 0, 0, 0, 0]</span></span><br><span class="line">printArray(&amp;arr3)   <span class="comment">// [100, 4, 6, 8, 10]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-2-Slice-切片"><a href="#3-2-Slice-切片" class="headerlink" title="3.2 Slice(切片)"></a>3.2 Slice(切片)</h2><ul><li>slice 本身没有数据, 是对底层 array 的一个 view</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">arr := [...]<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;</span><br><span class="line">s := arr[<span class="number">2</span>:<span class="number">6</span>]</span><br><span class="line">fmt.Println(<span class="string">"arr[2:6]: "</span>, s)<span class="comment">// [2 3 4 5]</span></span><br><span class="line">fmt.Println(<span class="string">"arr[:6]: "</span>, arr[:<span class="number">6</span>])    <span class="comment">// [0 1 2 3 4 5]</span></span><br><span class="line">fmt.Println(<span class="string">"arr[2:]: "</span>, arr[<span class="number">2</span>:])    <span class="comment">// [2 3 4 5 6 7]</span></span><br><span class="line">fmt.Println(<span class="string">"arr[:]: "</span>, arr[:])    <span class="comment">// [0 1 2 3 4 5 6 7]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上例中的 <code>s</code> 就是一个切片, 表示数组的一个左开右闭的区间</p><pre><code>arr: 0 1 2 3 4 5 6 7s  :     ↑       ↑</code></pre><blockquote><p>slice 是一个引用类型, 对切片的修改会对原数组造成同样的修改<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateSlice</span><span class="params">(s []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">s[<span class="number">0</span>] = <span class="number">100</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">arr := [...]<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;</span><br><span class="line">s := arr[<span class="number">2</span>:<span class="number">6</span>]</span><br><span class="line">fmt.Println(s)<span class="comment">// [2 3 4 5]</span></span><br><span class="line"></span><br><span class="line">updateSlice(s)</span><br><span class="line">fmt.Println(arr)<span class="comment">// [0 1 100 3 4 5 6 7]</span></span><br><span class="line">fmt.Println(s)<span class="comment">// [100 3 4 5]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>slice 也可以继续生成 slice, 但不论如何生成, 都是针对同一个数组的 view</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">arr := [...]<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;</span><br><span class="line">s := arr[<span class="number">2</span>:<span class="number">6</span>]</span><br><span class="line">fmt.Println(<span class="string">"arr[2:6]: "</span>, s)<span class="comment">// [2 3 4 5]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">"ReSlice"</span>)</span><br><span class="line">fmt.Println(<span class="string">"s"</span>, s)<span class="comment">// [2 3 4 5]</span></span><br><span class="line">fmt.Println(<span class="string">"arr"</span>, arr)<span class="comment">// [0 1 2 3 4 5 6 7]</span></span><br><span class="line">s = s[:<span class="number">6</span>]</span><br><span class="line">fmt.Println(<span class="string">"s[:6]"</span>, s)<span class="comment">// [2 3 4 5 6 7]</span></span><br><span class="line">s = s[<span class="number">2</span>:]</span><br><span class="line">fmt.Println(<span class="string">"s[2:]"</span>, s)<span class="comment">// [4 5 6 7]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-1-Slice-的扩展"><a href="#3-2-1-Slice-的扩展" class="headerlink" title="3.2.1 Slice 的扩展"></a>3.2.1 Slice 的扩展</h3><ul><li>slice 可以向后扩展, 不能向前扩展</li><li>读取 slice 元素的时候, 不能超过 len(s), 向后扩展不能超过底层数组 cap(s)</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"Extending Slice"</span>)</span><br><span class="line">s1 := arr[<span class="number">2</span>:<span class="number">6</span>]</span><br><span class="line">s2 := s1[<span class="number">3</span>:<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">fmt.Println(s1)<span class="comment">// [100 3 4 5]</span></span><br><span class="line">fmt.Println(<span class="string">"len of s1"</span>, <span class="built_in">len</span>(s1))<span class="comment">// 4</span></span><br><span class="line">fmt.Println(<span class="string">"cap of s1"</span>, <span class="built_in">cap</span>(s1))<span class="comment">// 6</span></span><br><span class="line">fmt.Println(s2)<span class="comment">// [5 6]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 Slice 实现中, 有三个主要的元素:</p><ul><li>ptr: 当前指向的数组元素索引</li><li>len: 当前 slice 的总长度, 如 s1:= arr[2:6], len 为 4</li><li>cap: 当前 slice 的最大长度, 为原数组 len 之后的长度, 如 s1:= arr[2:6], cap 为 2</li></ul><pre><code>s2 := s1[3:5]                  0, 1, 2                               ↓  ↓s1 := arr[2:6]        0, 1, 2, 3, 4, 5                      ↓           ↓arr:            0, 1, 2, 3, 4, 5, 6, 7</code></pre><h3 id="3-2-2-向-slice-添加元素"><a href="#3-2-2-向-slice-添加元素" class="headerlink" title="3.2.2 向 slice 添加元素"></a>3.2.2 向 slice 添加元素</h3><ul><li>添加元素时如果超过 cap, 系统会重新分配更大的底层数组</li><li>由于值传递的关系, <code>append()</code> 操作的必须接收返回值</li><li>s = append(s, val)</li><li>slice 的 cap 初始值是0 , 当 slice 的底层数组需要扩容的时候, 底层数组的长度会扩充为之前的 2 倍</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(s2)<span class="comment">// [5 6]</span></span><br><span class="line">fmt.Println(arr)<span class="comment">// [0 1 2 3 4 5 6 7]</span></span><br><span class="line">s3 := <span class="built_in">append</span>(s2, <span class="number">10</span>)</span><br><span class="line">s4 := <span class="built_in">append</span>(s3, <span class="number">11</span>)</span><br><span class="line">s5 := <span class="built_in">append</span>(s4, <span class="number">12</span>)</span><br><span class="line">fmt.Println(s3)<span class="comment">// [5 6 10]</span></span><br><span class="line">fmt.Println(s4)<span class="comment">// [5 6 10 11]</span></span><br><span class="line">fmt.Println(s5)<span class="comment">// [5 6 10 11 12]</span></span><br><span class="line">fmt.Println(arr)<span class="comment">// [0 1 2 3 4 5 6 10]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>s2 是 arr 的一个 view, 对应 arr 的 [5, 6] 两个元素, s2 进行 <code>append()</code> 操作时, 由于 arr 数组后面还有空间, 则直接进行替换, 而 s3, s4 在进行 <code>append()</code> 操作的时候, 由于超出了 arr 数组的范围, go 会重新分配一个新的数组, 并将 arr 初始化进去再进行 <code>append()</code></p><h3 id="3-2-3-slice-复制"><a href="#3-2-3-slice-复制" class="headerlink" title="3.2.3 slice 复制"></a>3.2.3 slice 复制</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s1 := []<span class="keyword">int</span>&#123;<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>&#125;</span><br><span class="line">s2 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">16</span>, <span class="number">32</span>)</span><br><span class="line"><span class="built_in">copy</span>(s2, s1)</span><br><span class="line">printSlice(s2)<span class="comment">// [2 4 6 8 0 0 0 0 0 0 0 0 0 0 0 0], len = 16, cap = 32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-4-slice-删除元素"><a href="#3-2-4-slice-删除元素" class="headerlink" title="3.2.4 slice 删除元素"></a>3.2.4 slice 删除元素</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    printSlice(s2)<span class="comment">// [2 4 6 8 0 0 0 0 0 0 0 0 0 0 0 0], len = 16, cap = 32</span></span><br><span class="line">s2 = <span class="built_in">append</span>(s2[:<span class="number">3</span>], s2[<span class="number">4</span>:]...)</span><br><span class="line">printSlice(s2)<span class="comment">// [2 4 6 0 0 0 0 0 0 0 0 0 0 0 0], len = 15, cap = 3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-5-pop"><a href="#3-2-5-pop" class="headerlink" title="3.2.5 pop"></a>3.2.5 pop</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"popping from front"</span>)</span><br><span class="line">front := s2[<span class="number">0</span>]</span><br><span class="line">s2 = s2[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">"popping from back"</span>)</span><br><span class="line">tail := s2[<span class="built_in">len</span>(s2)<span class="number">-1</span>]</span><br><span class="line">s2 = s2[:<span class="built_in">len</span>(s2)<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">fmt.Println(front, tail)<span class="comment">// 2 0</span></span><br><span class="line">printSlice(s2)<span class="comment">// [4 6 0 0 0 0 0 0 0 0 0 0 0], len = 13, cap = 31</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-3-Map"><a href="#3-3-Map" class="headerlink" title="3.3 Map"></a>3.3 Map</h2><p>定义方式:</p><ul><li><code>map[k]v</code>: key 为 k, value 为 v 的 map</li><li><code>map[k1]map[k2]v</code>: key 为 k1, value 为一个 key 为 k2 value 为 v 的 map</li></ul><p>map 中 key 的要求:</p><ol><li>map 底层使用哈希表实现, 必须可以比较相等</li><li>除了 slice, map, function 等内建类型都可以作为 key</li><li>struct 类型不包括上述字段, 也可以作为 key</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// map 的创建方式一</span></span><br><span class="line">m1 := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span> &#123;</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"destiny"</span>,</span><br><span class="line">    <span class="string">"course"</span>: <span class="string">"golang"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// map 的创建方式二</span></span><br><span class="line">m2 := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// map 的创建方式三</span></span><br><span class="line"><span class="keyword">var</span> m3 <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span></span><br></pre></td></tr></table></figure><h4 id="map-的遍历"><a href="#map-的遍历" class="headerlink" title="map 的遍历"></a>map 的遍历</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">m := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"destiny"</span>,</span><br><span class="line"><span class="string">"course"</span>: <span class="string">"golang"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> m &#123;</span><br><span class="line">fmt.Println(k, v)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="map-获取-value"><a href="#map-获取-value" class="headerlink" title="map 获取 value"></a>map 获取 value</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">m := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"destiny"</span>,</span><br><span class="line"><span class="string">"course"</span>: <span class="string">"golang"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">name := m[<span class="string">"name"</span>]</span><br><span class="line">fmt.Println(name)       <span class="comment">// destiny</span></span><br><span class="line"></span><br><span class="line">gender := m[<span class="string">"gender"</span>]</span><br><span class="line">fmt.Println(gender)     <span class="comment">// "" 不存在的内容返回 zero value</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>从 map 获取 value 的时候, 不存在的 key 会返回空串, 那么我们应该如何确定这个 key 是原本就不存在还是只是在 map 中确实放置了一个空串?<br>该接口还可以接受一个返回值, 用来判断这个 key 是否真的存在</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">m := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"destiny"</span>,</span><br><span class="line"><span class="string">"course"</span>: <span class="string">"golang"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">name, ok := m[<span class="string">"name"</span>]</span><br><span class="line">fmt.Println(name, ok)           <span class="comment">// destiny true</span></span><br><span class="line"></span><br><span class="line">gender, ok := m[<span class="string">"gender"</span>]</span><br><span class="line">fmt.Println(gender, ok)         <span class="comment">//  false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以写成如下格式</span></span><br><span class="line"><span class="keyword">if</span> name, ok := m[<span class="string">"name"</span>]; ok &#123;</span><br><span class="line">    fmt.Println(name, ok)       <span class="comment">// destiny true</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"key dosen't exist"</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="map-删除元素"><a href="#map-删除元素" class="headerlink" title="map 删除元素"></a>map 删除元素</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">m := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"destiny"</span>,</span><br><span class="line"><span class="string">"course"</span>: <span class="string">"golang"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> name, ok := m[<span class="string">"name"</span>]; ok &#123;</span><br><span class="line">fmt.Println(name, ok)       <span class="comment">// there</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"key doesn't exist"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">delete</span>(m, <span class="string">"name"</span>)</span><br><span class="line"><span class="keyword">if</span> name, ok := m[<span class="string">"name"</span>]; ok &#123;</span><br><span class="line">fmt.Println(name, ok)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"key doesn't exist"</span>)<span class="comment">// there</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="利用-map-寻找最长不含有重复字符的子串"><a href="#利用-map-寻找最长不含有重复字符的子串" class="headerlink" title="利用 map 寻找最长不含有重复字符的子串"></a>利用 map 寻找最长不含有重复字符的子串</h4><p>对于每一个字母 x</p><ul><li><code>lastOccurred[x]</code>不存在, 或者 <code>&lt;start</code>, 则不需要处理</li><li><code>lastOccurred[x] &gt;= start</code>, 更新 start</li><li>更新 <code>lastOccurred[x]</code>, 更新 <code>maxLength</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">lengthOfNonRepeatingSubStr</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="comment">// 记录每个字符最后出现的位置</span></span><br><span class="line">lastOccurred := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">byte</span>]<span class="keyword">int</span>)</span><br><span class="line">start := <span class="number">0</span></span><br><span class="line">maxLength := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i, ch := <span class="keyword">range</span> []<span class="keyword">byte</span>(s) &#123;</span><br><span class="line"><span class="keyword">if</span> lastI, ok := lastOccurred[ch]; ok &amp;&amp; lastI &gt;= start &#123;</span><br><span class="line"><span class="comment">// 如果当前字符最后一次出现的位置 &gt;= start, 需要将 start 更新到该字符位置之后</span></span><br><span class="line">start = lastOccurred[ch] + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> i-start+<span class="number">1</span> &gt; maxLength &#123;</span><br><span class="line">maxLength = i - start + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">lastOccurred[ch] = i</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> maxLength</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(lengthOfNonRepeatingSubStr(<span class="string">"abcabcab"</span>))</span><br><span class="line">fmt.Println(lengthOfNonRepeatingSubStr(<span class="string">"bbbbb"</span>))</span><br><span class="line">fmt.Println(lengthOfNonRepeatingSubStr(<span class="string">"pwwkew"</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-4-rune"><a href="#3-4-rune" class="headerlink" title="3.4 rune"></a>3.4 rune</h2><blockquote><p>rune 相当于 go 语言中的 char</p></blockquote><ul><li>使用 <code>range</code> 遍历 <code>pos, rune</code> 对</li><li>使用 <code>utf8.RuneCountInString</code> 获得字符数量</li><li>使用 <code>len</code> 获得字节长度</li><li>使用 <code>[]byte</code> 获得字节数组</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="string">"我是Destiny!"</span><span class="comment">// UTF-8</span></span><br><span class="line">fmt.Println(<span class="built_in">len</span>(s))<span class="comment">// 20</span></span><br><span class="line">fmt.Printf(<span class="string">"%X"</span>, []<span class="keyword">byte</span>(s))<span class="comment">// E68891E698AF44657374696E7921</span></span><br><span class="line">fmt.Println()</span><br><span class="line"><span class="comment">// 每个中文三个字节</span></span><br><span class="line"><span class="keyword">for</span> _, b := <span class="keyword">range</span> []<span class="keyword">byte</span>(s) &#123;</span><br><span class="line">fmt.Printf(<span class="string">"%X "</span>, b)<span class="comment">// E6 88 91 E6 98 AF 44 65 73 74 69 6E 79 21</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println()</span><br><span class="line"><span class="keyword">for</span> i, ch := <span class="keyword">range</span> s &#123;<span class="comment">// ch is a rune</span></span><br><span class="line"><span class="comment">// (0: 6211)// E6 88 91 的 UTF-8 编码转换成 Unicode 后为 6211</span></span><br><span class="line"><span class="comment">// (3: 662F)</span></span><br><span class="line"><span class="comment">// (6: 44)</span></span><br><span class="line"><span class="comment">// (7: 65)</span></span><br><span class="line"><span class="comment">// (8: 73)</span></span><br><span class="line"><span class="comment">// (9: 74)</span></span><br><span class="line"><span class="comment">// (10: 69)</span></span><br><span class="line"><span class="comment">// (11: 6E)</span></span><br><span class="line"><span class="comment">// (12: 79)</span></span><br><span class="line"><span class="comment">// (13: 21)</span></span><br><span class="line">fmt.Printf(<span class="string">"(%d: %X)"</span>, i, ch)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println()</span><br><span class="line"></span><br><span class="line">fmt.Println(utf8.RuneCountInString(s))<span class="comment">// 10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;1-安装与环境&quot;&gt;&lt;a href=&quot;#1-安装与环境&quot; class=&quot;headerlink&quot; title=&quot;1. 安装与环境&quot;&gt;&lt;/a&gt;1. 安装与环境&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;下载: &lt;a href=&quot;https://studygolang.com/dl&quot; t
      
    
    </summary>
    
      <category term="golang" scheme="https://destinywang.github.io/blog/categories/golang/"/>
    
    
      <category term="golang" scheme="https://destinywang.github.io/blog/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Java逃逸分析</title>
    <link href="https://destinywang.github.io/blog/2018/09/07/Java%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/"/>
    <id>https://destinywang.github.io/blog/2018/09/07/Java逃逸分析/</id>
    <published>2018-09-07T14:45:00.000Z</published>
    <updated>2018-09-07T14:45:38.224Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-逃逸概念的引入"><a href="#1-逃逸概念的引入" class="headerlink" title="1. 逃逸概念的引入"></a>1. 逃逸概念的引入</h1><blockquote><p>我们都知道, Java 创建的对象都是被分配到堆内存上, 但是事实并不是这么绝对, 通过对Java对象分配的过程分析, 可以知道有两个地方会导致 Java 中创建出来的对象并不一定分别在所认为的堆上. 这两个点分别是 Java 中的 <code>逃逸分析</code> 和 <code>TLAB(Thread Local Allocation Buffer)</code>线程私有的缓存区。</p></blockquote><h1 id="2-逃逸分析基本概念"><a href="#2-逃逸分析基本概念" class="headerlink" title="2. 逃逸分析基本概念"></a>2. 逃逸分析基本概念</h1><p>逃逸分析, 是一种可以有效减少 Java 程序中同步负载和内存堆分配压力的跨函数全局数据流分析算法. 通过逃逸分析, <code>Hotspot编译器</code> 能够分析出一个新的对象的引用的使用范围从而决定是否要将这个对象分配到堆上.</p><p>在计算机语言编译器优化原理中, 逃逸分析是指分析指针动态范围的方法, 它同编译器优化原理的指针分析和外形分析相关联. 当变量(或者对象)在方法中分配后, 其指针有可能被返回或者被全局引用, 这样就会被其他过程或者线程所引用, 这种现象称作指针(或者引用)的 <code>逃逸(Escape)</code> . 通俗点讲, 如果一个对象的指针被多个方法或者线程引用时, 那么我们就称这个对象的指针发生了逃逸.</p><h2 id="2-1-具体分析"><a href="#2-1-具体分析" class="headerlink" title="2.1. 具体分析"></a>2.1. 具体分析</h2><p>逃逸分析研究对于 java 编译器有什么好处呢? 我们知道 java 对象总是在堆中被分配的, 因此 java 对象的创建和回收对系统的开销是很大的. java 语言被批评的一个地方, 也是认为 java 性能慢的一个原因就是  java 不支持栈上分配对象, JDK6里的 <code>Swing</code> 内存和性能消耗的瓶颈就是由于 GC 来遍历引用树并回收内存的, 如果对象的数目比较多, 将给 GC 带来较大的压力, 也间接得影响了性能. 减少临时对象在堆内分配的数量, 无疑是最有效的优化方法. java 中应用里普遍存在一种场景, 一般是在方法体内, 声明了一个局部变量, 并且该变量在方法执行生命周期内未发生逃逸, 按照  JVM 内存分配机制, 首先会在堆内存上创建类的实例(对象), 然后将此对象的引用压入调用栈, 继续执行, 这是 JVM 优化前的方式. 当然, 我们可以采用逃逸分析对 JVM  进行优化, 即针对栈的重新分配方式, 首先我们需要分析并且找到未逃逸的变量, 将该变量类的实例化内存直接在栈里分配, 无需进入堆, 分配完成之后, 继续调用栈内执行, 最后线程执行结束, 栈空间被回收, 局部变量对象也被回收, 通过这种方式的优化, 与优化前的方案主要区别在于对象的存储介质, 优化前是在堆中, 而优化后的是在栈中, 从而减少了堆中临时对象的分配(较耗时), 最终完成性能的优化.</p><blockquote><p>逃逸分析实际上是 JVM 的一种为优化提供支持的分析手段, 逃逸分析的范围分为两个, 方法逃逸和线程逃逸</p></blockquote><h3 id="2-2-1-方法逃逸"><a href="#2-2-1-方法逃逸" class="headerlink" title="2.2.1 方法逃逸"></a>2.2.1 方法逃逸</h3><blockquote><p>不逃逸出当前方法, 就是说在一个方法内 <code>new</code> 出来的对象, 它的引用没有泄露到这个方法之外<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">int</span> b;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">bar</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    Foo foo = <span class="keyword">new</span> Foo();</span><br><span class="line">    foo.a = a;</span><br><span class="line">    foo.b = b;</span><br><span class="line">    <span class="comment">// foo 对象没有逃逸出 bar 方法, 只在 bar 方法里当做局部变量存在</span></span><br><span class="line">    <span class="keyword">return</span> foo.a + foo.b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><p>在上面的例子中, Foo 对象就没有逃逸出 bar 方法, 只有一个局部 foo 变量引用这个对象, foo 变量既没有被当做返回值, 也没有当做另一个方法的参数.</p><p>但其实我们一般写的普通 Java Bean 都会有 getter /setter </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">int</span> b;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Foo</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.a = a;</span><br><span class="line">        <span class="keyword">this</span>.b = b;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果在 <code>bar()</code> 方法里依然给 Foo 实例对象赋值, 那肯定就会调用到 Foo 的成员方法 <code>setA(), setB()</code>, 把局部变量 foo 的 this 作为参数传递给 foo 的成员方法, 这个时候变量 foo 确实逃逸除了 bar 方法, 而 JIT 提供了 <code>方法内联</code>, 在完成方法内联后, 这个参数传递实际上优化掉了.</p><h3 id="2-2-2-线程逃逸"><a href="#2-2-2-线程逃逸" class="headerlink" title="2.2.2 线程逃逸"></a>2.2.2 线程逃逸</h3><blockquote><p>不逃逸出当前线程, 指的是实例对象没有被别的类引用到. 该对象的引用赋值到其他对象的字段, 或其他类的静态字段上, 没办法让它进入一个全局可见的范围, 这个时候我们认为该实例没有逃逸出当前线程</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">bar</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    Foo foo = <span class="keyword">new</span> Foo();</span><br><span class="line">    foo.a = a;</span><br><span class="line">    foo.b = b;</span><br><span class="line">    <span class="keyword">return</span> doBar(foo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doBar</span><span class="params">(Foo foo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> foo.a + foo.b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>bar()</code> 方法调用了 <code>doBar()</code>, 把 foo 实例作为入参传入了 <code>doBar()</code>, 这个时候认为 foo 逃逸除了 bar 方法, 但是 bar 和 doBar 都在一个类中, 并没有被其他类引用, 我们认为 foo 对象没有逃逸出线程.</p><h2 id="2-3-JVM-为逃逸分析所做的优化"><a href="#2-3-JVM-为逃逸分析所做的优化" class="headerlink" title="2.3. JVM 为逃逸分析所做的优化"></a>2.3. JVM 为逃逸分析所做的优化</h2><h3 id="2-3-1-标量替换"><a href="#2-3-1-标量替换" class="headerlink" title="2.3.1 标量替换"></a>2.3.1 标量替换</h3><blockquote><p>Java 中标量的意思是不能再分割的量, 如基本类型和 Reference 类型, 反之成为聚合量, 如果把一个对象拆开, 将它的成员变量分割成标量, 这个就叫标量替换.</p></blockquote><p>如果逃逸分析发现一个对象不会被外部访问, 并且该对象可以被拆散, 那么经过优化后, 并不直接生成该对象, 而是在栈上创建若干个成员变量, 原本的对象就无需再堆上整体分配空间了.</p><pre><code>栈帧内分配对象的行为成为栈上分配, 目的是减少新生代的 GC 频率, 见解提高 JVM 性能, 通过 -XX+EliminateAllcations 可以开启标量替换.</code></pre><h3 id="2-3-2-锁消除优化"><a href="#2-3-2-锁消除优化" class="headerlink" title="2.3.2 锁消除优化"></a>2.3.2 锁消除优化</h3><blockquote><p>Java 方法中返回值如果没有被其他类用到, 那这个对象就不会逃逸出线程, 我们知道变量的读写竞争的时候需要加锁访问, 如果确定该变量不会逃逸出该线程, 那同步访问控制就可以优化掉.</p></blockquote><h2 id="2-4-实操"><a href="#2-4-实操" class="headerlink" title="2.4 实操"></a>2.4 实操</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Sting name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// getters / setters / constructors</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">bar</span><span class="params">(Foo foo)</span> </span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User(<span class="number">23</span>);</span><br><span class="line">    <span class="keyword">return</span> foo.getA() + foo.getB() + user.getAge();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Foo foo = <span class="keyword">new</span> Foo();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000000</span>; ++i) &#123;</span><br><span class="line">        foo.setA(<span class="number">4</span>);</span><br><span class="line">        foo.setB(<span class="number">45</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-1-关闭逃逸分析"><a href="#2-4-1-关闭逃逸分析" class="headerlink" title="2.4.1 关闭逃逸分析"></a>2.4.1 关闭逃逸分析</h3><p>启动 JVM 参数</p><pre><code>-server-XX:-DoEscapeAnalysis</code></pre><p>使用 <code>jmap -histo</code><br><img src="http://oetw0yrii.bkt.clouddn.com/18-8-30/3446787.jpg" alt=""></p><h3 id="2-4-2-打开逃逸分析"><a href="#2-4-2-打开逃逸分析" class="headerlink" title="2.4.2 打开逃逸分析"></a>2.4.2 打开逃逸分析</h3><p>JVM 参数</p><pre><code>-server-XX:+DoEscapeAnalysis</code></pre><p><img src="http://oetw0yrii.bkt.clouddn.com/18-8-30/67522193.jpg" alt=""></p><p>可以看到, 只有少量的对象在堆上实例化, 大部分对象的属性被标量替换了.</p><h1 id="3-JIT-编译"><a href="#3-JIT-编译" class="headerlink" title="3. JIT 编译"></a>3. JIT 编译</h1><p>在 JVM 中触发 JIT 编译是基于两个计数器:</p><ol><li>一个方法被调用的次数</li><li>存在有分支的方法中的循环次数, 如果方法里面有一个很长的循环, 这时候需要编译到这个循环, 每一次分支的循环被调用, 该分支的计数器都会增加</li></ol><p>增加 <code>-XX:+PrintCompileation</code> 参数观察 JVM 输出的编译日志</p><pre><code>- 96    1       3       java.lang.String::equals (81 bytes) 96    4       3       java.io.UnixFileSystem::normalize (75 bytes) 97    9       3       java.lang.String::hashCode (55 bytes) 97    8       3       java.lang.Object::&lt;init&gt; (1 bytes) 97    7       3       java.lang.AbstractStringBuilder::ensureCapacityInternal (16 bytes) 98    3       3       java.lang.String::length (6 bytes) 98   10       3       java.lang.Math::min (11 bytes) 98    2       3       java.lang.System::getSecurityManager (4 bytes) 98    6       3       java.util.Arrays::copyOf (19 bytes) 98   11     n 0       java.lang.System::arraycopy (native)   (static) 98   12       3       java.lang.String::indexOf (70 bytes) 98   15       3       sun.nio.cs.UTF_8$Encoder::encode (359 bytes) 99   13       4       java.lang.String::charAt (29 bytes) 99   16       3       java.lang.String::lastIndexOf (52 bytes) 99    5       3       java.util.HashMap::hash (20 bytes)100   18       3       java.lang.String::&lt;init&gt; (82 bytes)100   14       3       java.lang.StringBuilder::toString (17 bytes)100   19       3       java.lang.String::startsWith (72 bytes)100   20       1       java.util.ArrayList::size (5 bytes)100   17       1       java.lang.ref.Reference::get (5 bytes)101   21       1       sun.instrument.TransformerManager::getSnapshotTransformerList (5 bytes)101   22       3       java.lang.String::startsWith (7 bytes)101   23       3       java.lang.String::indexOf (166 bytes)102   26       1       java.lang.Object::&lt;init&gt; (1 bytes)102    8       3       java.lang.Object::&lt;init&gt; (1 bytes)   made not entrant102   30       3       org.destiny.demo.Foo::setA (6 bytes)102   31       3       org.destiny.demo.Foo::setB (6 bytes)102   32       3       org.destiny.demo.User::bar (25 bytes)102   33       3       org.destiny.demo.User::&lt;init&gt; (10 bytes)103   34       1       org.destiny.demo.Foo::setA (6 bytes)103   30       3       org.destiny.demo.Foo::setA (6 bytes)   made not entrant103   35       1       org.destiny.demo.Foo::setB (6 bytes)103   31       3       org.destiny.demo.Foo::setB (6 bytes)   made not entrant103   27       1       org.destiny.demo.Foo::getA (5 bytes)103   28       1       org.destiny.demo.Foo::getB (5 bytes)103   29       1       org.destiny.demo.User::getAge (5 bytes)103   24       3       java.lang.String::endsWith (17 bytes)103   36       4       org.destiny.demo.User::bar (25 bytes)103   25       3       java.lang.ref.SoftReference::get (29 bytes)104   32       3       org.destiny.demo.User::bar (25 bytes)   made not entrant104   37       1       java.lang.ThreadLocal::access$400 (5 bytes)106   38       3       java.lang.String::indexOf (7 bytes)106   39       3       java.lang.Character::toLowerCase (9 bytes)106   40       3       java.lang.CharacterDataLatin1::toLowerCase (39 bytes)108   41 %     3       org.destiny.demo.User::main @ 18 (48 bytes)108   42       3       org.destiny.demo.User::main (48 bytes)109   43 %     4       org.destiny.demo.User::main @ 18 (48 bytes)112   41 %     3       org.destiny.demo.User::main @ -2 (48 bytes)   made not entrant150   43 %     4       org.destiny.demo.User::main @ -2 (48 bytes)   made not entrant </code></pre><p>编译日志分为 7 列, 依次是</p><ul><li>时间(基于 JVM 启动的时间戳)</li><li>编译任务 id(基本递增)</li><li>编译属性</li><li>tiered_level(分为 4 级)</li><li>方法信息</li><li>占用字节数</li><li>deopt</li></ul><p>其中, 编译属性 <code>attribute</code> 分为:</p><table><thead><tr><th>属性值</th><th>属性描述</th></tr></thead><tbody><tr><td>%</td><td>The compilation is OSR</td></tr><tr><td>s</td><td>The method is synchronized</td></tr><tr><td>!</td><td>The method has an exception handler</td></tr><tr><td>b</td><td>Compliation occurred in blocking mode</td></tr><tr><td>n</td><td>Compliation occurred for a wrapper to a native method</td></tr></tbody></table><p>tiered_level:</p><table><thead><tr><th>值</th><th>描述</th></tr></thead><tbody><tr><td>0</td><td>Interpreted Code</td></tr><tr><td>1</td><td>Simple C1 Compiled Code</td></tr><tr><td>2</td><td>Limited C1 Compiled Code</td></tr><tr><td>3</td><td>Full C1 Compiled Code</td></tr><tr><td>4</td><td>C2 Compile Code</td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;1-逃逸概念的引入&quot;&gt;&lt;a href=&quot;#1-逃逸概念的引入&quot; class=&quot;headerlink&quot; title=&quot;1. 逃逸概念的引入&quot;&gt;&lt;/a&gt;1. 逃逸概念的引入&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;我们都知道, Java 创建的对象都是被分配到堆内存上
      
    
    </summary>
    
      <category term="JVM" scheme="https://destinywang.github.io/blog/categories/JVM/"/>
    
      <category term="逃逸分析" scheme="https://destinywang.github.io/blog/categories/JVM/%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/"/>
    
    
      <category term="逃逸分析" scheme="https://destinywang.github.io/blog/tags/%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>分布式事务总结</title>
    <link href="https://destinywang.github.io/blog/2018/09/02/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%80%BB%E7%BB%93/"/>
    <id>https://destinywang.github.io/blog/2018/09/02/分布式事务总结/</id>
    <published>2018-09-02T02:21:57.000Z</published>
    <updated>2018-09-02T02:31:04.504Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. 定义</h1><pre><code>事务能够提供一种将一个活动涉及到的所有操作纳入到一个不可分割的执行单元的机制.组成事务的操作只有在操作均能正常执行的情况下才能提交, 只要其中任意一步执行失败, 都将导致整个操作回滚.</code></pre><h1 id="2-数据库本地事务"><a href="#2-数据库本地事务" class="headerlink" title="2. 数据库本地事务"></a>2. 数据库本地事务</h1><h2 id="2-1-ACID"><a href="#2-1-ACID" class="headerlink" title="2.1 ACID"></a>2.1 ACID</h2><table><thead><tr><th>特性</th><th>描述</th></tr></thead><tbody><tr><td>原子性</td><td>一个事务的所有操作, 要么全部完成, 要么全部不完成, 不会结束在中间某个环节</td></tr><tr><td>一致性</td><td>在一个事务执行之前和执行之后, 数据库必须保持处于一致的状态. 如果事务成功执行, 系统中所有的变化都将正确地被应用, 反之, 所有变化都将被回滚</td></tr><tr><td>隔离性</td><td>当不同的事务操作相同的数据的时候, 每个事务都有各自的完整数据空间, 由事务所做的修改必须与任何其他事务所做的修改隔离, 事务不会看到数据的中间状态.</td></tr><tr><td>持久性</td><td>只要事务成功结束, 它对数据库所做的更新就必须永久保存下来</td></tr></tbody></table><p><img src="http://oetw0yrii.bkt.clouddn.com/18-8-4/3451917.jpg" alt=""></p><p>而事务的 ACID 是通过 InnoDB 日志和锁来保证.</p><ul><li>事务的隔离性是通过数据库锁的机制来实现;</li><li>持久性是通过 redo log(重做日志) 来实现的</li><li>原子性和一致性是通过 undo log(回滚日志)</li></ul><pre><code>Undo log: 为了满足事务的原子性, 在操作任何数据之前, 首先将数据备份到一个地方, 然后对数据进行修改, 如果出现了错误, 或者用户执行 RollBack, 系统可以利用 Undo log 中的备份将数据恢复到事务开始之前的状态Redo log: 记录新数据的备份, 在事务提交之前, 只要将 Redo log 持久化即可, 当系统崩溃时, 虽然数据没有持久化, 但是 Redo log 已经持久化, 系统可以根据 Redo log 的内容, 将所有数据恢复到最新状态.</code></pre><h1 id="3-分布式事务"><a href="#3-分布式事务" class="headerlink" title="3. 分布式事务"></a>3. 分布式事务</h1><h2 id="3-1-分布式事务概念"><a href="#3-1-分布式事务概念" class="headerlink" title="3.1 分布式事务概念"></a>3.1 分布式事务概念</h2><pre><code>指事物的参与者, 支持事务的服务器, 资源服务器以及事务管理器分别位于不同的分布式系统之上.本质上讲, 分布式事务就是为了保证不同数据库的数据一致性.</code></pre><h2 id="3-2-场景"><a href="#3-2-场景" class="headerlink" title="3.2 场景"></a>3.2 场景</h2><h3 id="3-2-1-service-多个节点"><a href="#3-2-1-service-多个节点" class="headerlink" title="3.2.1 service 多个节点"></a>3.2.1 service 多个节点</h3><blockquote><p>随着互联网快速发展, SOA, 微服务等架构模式正在被大规模使用, 一个公司内, 用户的资产可能被分为好多个部分, 比如余额, 积分, 优惠券等</p></blockquote><p><img src="http://oetw0yrii.bkt.clouddn.com/18-8-4/44346101.jpg" alt=""></p><p>这样的话传统的单机事务实现方式无法保证积分扣减成功之后, 优惠券也能正确完成扣减操作.</p><h3 id="3-2-2-resource-多个节点"><a href="#3-2-2-resource-多个节点" class="headerlink" title="3.2.2 resource 多个节点"></a>3.2.2 resource 多个节点</h3><blockquote><p>同样, 由于单表数据过大需要进行拆分, 一次转账业务需要在北京的 MySQL 实例向 上海的 MySQL 实例转账, 同样无法保证他们能同时成功.</p></blockquote><p><img src="http://oetw0yrii.bkt.clouddn.com/18-8-4/47229853.jpg" alt=""></p><h2 id="3-3-分布式事务基础"><a href="#3-3-分布式事务基础" class="headerlink" title="3.3 分布式事务基础"></a>3.3 分布式事务基础</h2><h3 id="3-3-1-CAP"><a href="#3-3-1-CAP" class="headerlink" title="3.3.1 CAP"></a>3.3.1 CAP</h3><ul><li>C: 对某个执行的客户端来说, 读操作能返回最新的写操作. 对于数据分布在不同节点上的数据来说, 如果在某个节点更新了数据, 那么在其他节点都能读取到最新的数据, 那么就成为强一致, 反之就是分布式不一致;</li><li>A: 非故障的节点在一定时间内返回合理的响应(不是错误或超时), 可用性的关键在于: <code>合理的时间</code> 和 <code>合理的响应</code>, 请求不能无限期得不到响应, 并且需要得到系统正确的返回结果;</li><li>P: 当出现网络分区后, 系统依然能够正常工作.</li></ul><p>在分布式系统中, 网络永远无法 100% 可靠, 分区是一个一定会出现的情况, 如果我们选择 AC 而放弃 P, 当分区发生时, 为了保证一致性, 这个时候必须拒绝请求, 当时 A 又不允许拒绝, 所以分布式系统理论上不可能选择 CA 架构, 只能选择 CP 或者 AP 架构.</p><p>对于 CP 来说, 放弃可用性, 追求一致性和分区容错性, 比如 Zookeeper 就是追求强一致.</p><p>对于 AP 来说, 放弃一致性(强一致), 追求分区容错和可用, 这是很多分布式系统的选择.</p><p>CAP 是忽略网络延迟的, 也就是当事务提交时, 从节点 A 复制到节点 B, 但是在现实中总会有一定的时间延迟.</p><h3 id="3-3-2-BASE"><a href="#3-3-2-BASE" class="headerlink" title="3.3.2 BASE"></a>3.3.2 BASE</h3><pre><code>基本可用, 软状态, 最终一致性的缩写本质上是 AP 的一个扩张, 通过软状态实现基本可用和最终一致性.</code></pre><ul><li>BA: 基本可用, 分布式系统出现故障时, 允许损失部分可用功能, 保证核心功能可用;</li><li>软状态: 允许系统中存在中间状态, 这个状态不影响系统可用性, 这里指的是 CAP 中的不一致;</li><li>最终一致性: 经过一段时间后, 所有节点数据都将达到一致.</li></ul><h1 id="4-分布式事务的解决方案"><a href="#4-分布式事务的解决方案" class="headerlink" title="4. 分布式事务的解决方案"></a>4. 分布式事务的解决方案</h1><h2 id="4-1-是否真的需要分布式事务"><a href="#4-1-是否真的需要分布式事务" class="headerlink" title="4.1 是否真的需要分布式事务"></a>4.1 是否真的需要分布式事务</h2><pre><code>首先要明确是否真的需要分布式事务?</code></pre><p>是否存在由于服务拆分过细导致不合理的分布式系统设计?</p><p>可以先考虑将多个微服务聚合成一个单机服务, 避免引入不必要的成本和复杂度.</p><h2 id="4-2-2PC"><a href="#4-2-2PC" class="headerlink" title="4.2 2PC"></a>4.2 2PC</h2><p><img src="http://images2015.cnblogs.com/blog/524341/201607/524341-20160718200514638-1914892480.png" alt="image"></p><p>第一阶段: 事务管理器要求每个涉及到事务的数据库预提交此操作, 并反映是否可以提交</p><p>第二节点: 事务协调器要求每个数据库提交数据, 或者回滚</p><p>优点: 保证数据强一致, 实现简单;</p><p>缺点: 事务管理器存在单机风险; 整个过程存在同步阻塞; 数据可能不一致; 不支持高并发.</p><h2 id="4-3-TCC"><a href="#4-3-TCC" class="headerlink" title="4.3 TCC"></a>4.3 TCC</h2><p>相比 2PC, 解决了以下问题</p><ol><li>解决了协调者单点, 引入集群</li><li>引入超时, 超时后进行补偿, 并且不会锁定整个资源, 将资源转换为业务逻辑形式</li><li>数据一致性, 有了补偿机制后, 由业务管理其控制一致性</li></ol><pre><code>Try 阶段: 尝试执行, 完成所有业务检查(一致性), 预留必须业务资源(准隔离性)Confirm 阶段: 确认执行真正的业务, 不做任何业务检查, 只使用 Try 阶段预留的业务资源, Confirm 操作满足幂等性. 要求具备幂等设计, Confirm 失败后需要进行重试.Cancel 阶段: 取消执行, 释放 Try 阶段预留的业务资源, 也需要满足幂等性.</code></pre><p><img src="http://oetw0yrii.bkt.clouddn.com/18-8-4/81578002.jpg" alt=""></p><h2 id="4-4-本地消息表"><a href="#4-4-本地消息表" class="headerlink" title="4.4 本地消息表"></a>4.4 本地消息表</h2><pre><code>将需要分布式处理的任务通过消息日至的方式来异步执行</code></pre><p>消息日志可以存储到本地文本, 数据库或者消息队列, 再通过业务规则或人工发起重试, 人工重试更多应用于支付系统</p><blockquote><p>举一个购物的例子</p></blockquote><ol><li>当账户扣款的时候, 需要在扣款相关的服务上新增一个本地消息表, 需要把记录扣款和写入扣减商品库存的本地消息表放入同一个事务.</li><li>有个定时任务去轮询本地事务表, 把没有发送的消息扔给商品服务, 让它扣减库存, 到达商品服务后, 先写入这个服务器的事务表, 再进行扣减, 扣减成功后, 更新事务表中的状态;</li><li>商品服务器通过定时任务扫描消息表或者直接通过扣款服务吗扣款服务本地消息表进行更新;</li><li>针对特定情况, 定时扫描未成功处理的消息, 进行重新发送, 在商品服务收到消息后, 先判断是否是重复消息, 如果已经接受, 再判断是否执行, 如果执行再马上又进行通知事务, 如果未执行, 就需要重新执行需要由业务保证幂等.</li></ol><p><img src="http://oetw0yrii.bkt.clouddn.com/18-8-4/62419454.jpg" alt=""></p><ol><li>在分布式事务操作的一方完成写业务数据的操作之后向本地消息表发送一个消息，本地事务能保证这个消息一定会被写入本地消息表中。</li><li>之后将本地消息表中的消息转发到 Kafka 等消息队列中，如果转发成功则将消息从本地消息表中删除，否则继续重新转发。</li><li>在分布式事务操作的另一方从消息队列中读取一个消息，并执行消息中的操作。</li></ol><h2 id="4-5-MQ-事务"><a href="#4-5-MQ-事务" class="headerlink" title="4.5 MQ 事务"></a>4.5 MQ 事务</h2><p>还是以转账的模型举例:<br><img src="https://upload-images.jianshu.io/upload_images/175724-92abb226f288ff9c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/621" alt="image"></p><h4 id="1-先发送消息"><a href="#1-先发送消息" class="headerlink" title="1. 先发送消息"></a>1. 先发送消息</h4><p><img src="https://upload-images.jianshu.io/upload_images/175724-1927b8f3d14ef823.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/618" alt="image"></p><p>如果消息发送成功，但是扣款失败，消费端就会消费此消息，进而向Smith账户加钱。</p><h4 id="2-先扣款"><a href="#2-先扣款" class="headerlink" title="2. 先扣款"></a>2. 先扣款</h4><p><img src="https://upload-images.jianshu.io/upload_images/175724-367b5cf60cbdfa16.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/619" alt="image"></p><p>如果扣款成功，发送消息失败，就会出现Bob扣钱了，但是Smith账户未加钱。</p><h4 id="3-RocketMQ-的实现"><a href="#3-RocketMQ-的实现" class="headerlink" title="3. RocketMQ 的实现"></a>3. RocketMQ 的实现</h4><p><img src="https://upload-images.jianshu.io/upload_images/175724-ab0085543c6d02d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/621" alt="image"></p><ol><li>发送 <code>Prepared</code> 消息时，会拿到消息的地址;</li><li>执行本地事物;</li><li>通过第一阶段拿到的地址去访问消息, 并修改消息的状态.</li></ol><p>这样可以保证消息发送消息和本地事务执行成功保持原子性操作.</p><h4 id="问题1-如果步骤-3-失败怎么办"><a href="#问题1-如果步骤-3-失败怎么办" class="headerlink" title="问题1: 如果步骤 3 失败怎么办"></a>问题1: 如果步骤 3 失败怎么办</h4><pre><code>RocketMQ会定期扫描消息集群中的事物消息，如果发现了Prepared消息，它会向消息发送端(生产者)确认，Bob的钱到底是减了还是没减呢？如果减了是回滚还是继续发送确认消息呢？RocketMQ会根据发送端设置的策略来决定是回滚还是继续发送确认消息。这样就保证了消息发送与本地事务同时成功或同时失败。</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// =============================发送事务消息的一系列准备工作========================================</span></span><br><span class="line"><span class="comment">// 未决事务，MQ服务器回查客户端</span></span><br><span class="line"><span class="comment">// 也就是上文所说的，当RocketMQ发现`Prepared消息`时，会根据这个Listener实现的策略来决断事务</span></span><br><span class="line">TransactionCheckListener transactionCheckListener = <span class="keyword">new</span> TransactionCheckListenerImpl();</span><br><span class="line"><span class="comment">// 构造事务消息的生产者</span></span><br><span class="line">TransactionMQProducer producer = <span class="keyword">new</span> TransactionMQProducer(<span class="string">"groupName"</span>);</span><br><span class="line"><span class="comment">// 设置事务决断处理类</span></span><br><span class="line">producer.setTransactionCheckListener(transactionCheckListener);</span><br><span class="line"><span class="comment">// 本地事务的处理逻辑，相当于示例中检查Bob账户并扣钱的逻辑</span></span><br><span class="line">TransactionExecuterImpl tranExecuter = <span class="keyword">new</span> TransactionExecuterImpl();</span><br><span class="line">producer.start()</span><br><span class="line"><span class="comment">// 构造MSG，省略构造参数</span></span><br><span class="line">Message msg = <span class="keyword">new</span> Message(......);</span><br><span class="line"><span class="comment">// 发送消息</span></span><br><span class="line">SendResult sendResult = producer.sendMessageInTransaction(msg, tranExecuter, <span class="keyword">null</span>);</span><br><span class="line">producer.shutdown();</span><br></pre></td></tr></table></figure><p>接着查看 <code>sendMessageInTransaction</code> 方法的源码，总共分为3个阶段：发送 Prepared 消息、执行本地事务、发送确认消息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  ================================事务消息的发送过程=============================================</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> TransactionSendResult <span class="title">sendMessageInTransaction</span><span class="params">(.....)</span>  </span>&#123;</span><br><span class="line">    <span class="comment">// 逻辑代码，非实际代码</span></span><br><span class="line">    <span class="comment">// 1.发送消息</span></span><br><span class="line">    sendResult = <span class="keyword">this</span>.send(msg);</span><br><span class="line">    <span class="comment">// sendResult.getSendStatus() == SEND_OK</span></span><br><span class="line">    <span class="comment">// 2.如果消息发送成功，处理与消息关联的本地事务单元</span></span><br><span class="line">    LocalTransactionState localTransactionState = tranExecuter.executeLocalTransactionBranch(msg, arg);</span><br><span class="line">    <span class="comment">// 3.结束事务</span></span><br><span class="line">    <span class="keyword">this</span>.endTransaction(sendResult, localTransactionState, localException);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>endTransaction</code> 方法会将请求发往 <code>broker(mq server)</code> 去更新事务消息的最终状态：</p><ol><li>根据 sendResult 找到 Prepared 消息, sendResult 包含事务消息的 ID</li><li>根据 localTransaction 更新消息的最终状态</li></ol><h4 id="问题2-Consumer-消费失败怎么办"><a href="#问题2-Consumer-消费失败怎么办" class="headerlink" title="问题2: Consumer 消费失败怎么办"></a>问题2: Consumer 消费失败怎么办</h4><pre><code>如果 Bob 的账户的余额已经减少，且消息已经发送成功，Smith 端开始消费这条消息，这个时候就会出现消费失败和消费超时两个问题.解决超时问题的思路就是一直重试，直到消费端消费消息成功，整个过程中有可能会出现消息重复的问题，按照前面的思路解决即可。</code></pre><p><img src="https://upload-images.jianshu.io/upload_images/175724-1d9ba7bcd230e0dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/624" alt="image"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;1-定义&quot;&gt;&lt;a href=&quot;#1-定义&quot; class=&quot;headerlink&quot; title=&quot;1. 定义&quot;&gt;&lt;/a&gt;1. 定义&lt;/h1&gt;&lt;pre&gt;&lt;code&gt;事务能够提供一种将一个活动涉及到的所有操作纳入到一个不可分割的执行单元的机制.
组成事务的操作只有在操作
      
    
    </summary>
    
      <category term="分布式事务" scheme="https://destinywang.github.io/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
    
      <category term="分布式事务" scheme="https://destinywang.github.io/blog/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>实现简易JVM</title>
    <link href="https://destinywang.github.io/blog/2018/06/24/%E5%AE%9E%E7%8E%B0%E7%AE%80%E6%98%93JVM/"/>
    <id>https://destinywang.github.io/blog/2018/06/24/实现简易JVM/</id>
    <published>2018-06-24T15:07:51.000Z</published>
    <updated>2018-07-01T15:04:36.832Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-23/68954491.jpg" alt=""></p><ol><li>Java 源代码经过编译生成 class 文件</li><li>在不同的操作系统上分别实现 JVM, JVM 在不同操作系统上实现差异很大, 如线程, 图形界面等, 由 JVM 屏蔽与操作系统的接口</li></ol><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-23/18183015.jpg" alt=""></p><h2 id="1-1-Class-文件格式"><a href="#1-1-Class-文件格式" class="headerlink" title="1.1 Class 文件格式"></a>1.1 Class 文件格式</h2><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-23/7574723.jpg" alt=""></p><h3 id="1-1-1-魔数-amp-版本-amp-常量池个数"><a href="#1-1-1-魔数-amp-版本-amp-常量池个数" class="headerlink" title="1.1.1 魔数 &amp; 版本 &amp; 常量池个数"></a>1.1.1 魔数 &amp; 版本 &amp; 常量池个数</h3><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-23/37222872.jpg" alt=""></p><ul><li>Magic Number <ul><li>确定这是一个 Java 文件</li></ul></li><li>Minor / Major Version: 版本号</li><li>16 进制<ul><li>Major Version (0x34) = 52</li><li>常量池个数 (0x36) = 54</li></ul></li><li>大端模式(Big-Endian): 高位在前<ul><li><code>00 36</code> 而不是 <code>36 00</code></li></ul></li></ul><h3 id="1-1-2-常量池"><a href="#1-1-2-常量池" class="headerlink" title="1.1.2 常量池"></a>1.1.2 常量池</h3><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-23/57215332.jpg" alt=""></p><p><code>0036</code> 代表常量池常量的个数, 后面的 <code>07</code> 通过查表发现含义为 <code>ClassInfo</code> 的 <code>tag</code> 值, 而 <code>name_index</code> 值为 2, 代表类名在第二个常量中.</p><p>第二个常量开头为 <code>01</code>, 查表得知是一个 <code>Utf8</code> 字符串, <code>0021</code> 代表长度 <code>length</code> 值为 33. 而后面 33 个字节 <code>63 6F 6D 2F 63 6F 64 65 72 69 73 69 6E 67 2F 65 78 61 6D 70 6C 65 2F 45 6D 70 6C 6F 79 65 65 56 31</code> 转换成字符串之后的值为 <code>com/coderising/example/EmployeeV1</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Class_info &#123;</span><br><span class="line">    u1 tag;         // 值为7</span><br><span class="line">    u2 name_index;  // 名称索引</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Utf8_info &#123;</span><br><span class="line">    u1 tag;             // 值为1</span><br><span class="line">    u2 length;          // 长度</span><br><span class="line">    u1 bytes[length];   // 内容</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-1-2-1-常量池实例"><a href="#1-1-2-1-常量池实例" class="headerlink" title="1.1.2.1 常量池实例"></a>1.1.2.1 常量池实例</h4><table><thead><tr><th style="text-align:center">索引</th><th style="text-align:center">类型</th><th style="text-align:center">操作数 1</th><th style="text-align:center">操作数 2</th><th style="text-align:center">含义</th></tr></thead><tbody><tr><td style="text-align:center">#1</td><td style="text-align:center">ClassInfo</td><td style="text-align:center">#2</td></tr><tr><td style="text-align:center">#2</td><td style="text-align:center">Utf8</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">org/destiny/jvm/model/Employee</td></tr><tr><td style="text-align:center">#3</td><td style="text-align:center">ClassInfo</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">#4</td></tr><tr><td style="text-align:center">#4</td><td style="text-align:center">Utf8</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">java/lang/Object</td></tr><tr><td style="text-align:center">#5</td><td style="text-align:center">Utf8</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">name</td></tr><tr><td style="text-align:center">#6</td><td style="text-align:center">Utf8</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">Ljava/lang/String</td></tr><tr><td style="text-align:center">#7</td><td style="text-align:center">Utf8</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">age</td></tr><tr><td style="text-align:center">#8</td><td style="text-align:center">Utf8</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">I</td></tr><tr><td style="text-align:center">#9</td><td style="text-align:center">Utf8</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center"><init></init></td></tr><tr><td style="text-align:center">#10</td><td style="text-align:center">Utf8</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">…</td></tr><tr><td style="text-align:center">#11</td><td style="text-align:center">Utf8</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">…</td></tr><tr><td style="text-align:center">#12</td><td style="text-align:center">MethodRef</td><td style="text-align:center">#3</td><td style="text-align:center">#13</td><td style="text-align:center"><code>java.lang.Object&lt;init&gt;()V</code></td></tr><tr><td style="text-align:center">#13</td><td style="text-align:center">NameAndType</td><td style="text-align:center">#9</td><td style="text-align:center">#14</td><td style="text-align:center"><code>&lt;init&gt;()V</code></td></tr><tr><td style="text-align:center">#14</td><td style="text-align:center">Utf8</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">()V</td></tr><tr><td style="text-align:center">#15</td><td style="text-align:center">FieldRef</td><td style="text-align:center">#1</td><td style="text-align:center">#16</td><td style="text-align:center"><code>org/destiny/jvm/model/Employee 包含一个 Ljava/lang/String 类型的变量 name</code></td></tr><tr><td style="text-align:center">#16</td><td style="text-align:center">NameAndType</td><td style="text-align:center">#5</td><td style="text-align:center">#6</td><td style="text-align:center"><code>Ljava/lang/String 类型的变量 name</code></td></tr></tbody></table><h3 id="1-1-3-访问标志"><a href="#1-1-3-访问标志" class="headerlink" title="1.1.3 访问标志"></a>1.1.3 访问标志</h3><table><thead><tr><th style="text-align:center">标志名称</th><th style="text-align:center">标志值</th><th style="text-align:center">含义</th></tr></thead><tbody><tr><td style="text-align:center">ACC_PUBLIC</td><td style="text-align:center">0x0001</td><td style="text-align:center">public 类型</td></tr><tr><td style="text-align:center">ACC_FINAL</td><td style="text-align:center">0x0002</td><td style="text-align:center">声明为 final 类型</td></tr><tr><td style="text-align:center">ACC_SUPER</td><td style="text-align:center">0x0020</td><td style="text-align:center">是否允许使用 <code>invokespecial</code> 字节码指令的新语义</td></tr><tr><td style="text-align:center">ACC_INTERFACE</td><td style="text-align:center">0x0200</td><td style="text-align:center">声明为接口</td></tr><tr><td style="text-align:center">ACC_ABSTRACT</td><td style="text-align:center">0x0400</td><td style="text-align:center">Abstract 类型</td></tr><tr><td style="text-align:center">ACC_SYNTHETIC</td><td style="text-align:center">0x1000</td><td style="text-align:center">这个类并非由用户代码产生</td></tr><tr><td style="text-align:center">ACC_ANNOTATION</td><td style="text-align:center">0x2000</td><td style="text-align:center">注解</td></tr><tr><td style="text-align:center">ACC_ENUM</td><td style="text-align:center">0x4000</td><td style="text-align:center">枚举</td></tr></tbody></table><h3 id="1-1-4-类索引-父类索引"><a href="#1-1-4-类索引-父类索引" class="headerlink" title="1.1.4 类索引, 父类索引"></a>1.1.4 类索引, 父类索引</h3><pre><code>类索引和父类索引都是指向常量池的索引</code></pre><p>由于 Java 采用动态连接</p><p>动态连接是一个将符号引用解析为直接引用的过程。当java虚拟机执行字节码时，如果它遇到一个操作码，这个操作码第一次使用一个指向另一个类的符号引用</p><p>那么虚拟机就必须解析这个符号引用。在解析时，虚拟机执行两个基本任务</p><ol><li>查找被引用的类，（如果必要的话就装载它）</li><li>将符号引用替换为直接引用，这样当它以后再次遇到相同的引用时，它就可以立即使用这个直接引用，而不必花时间再次解析这个符号引用了。</li></ol><h3 id="1-1-5-接口"><a href="#1-1-5-接口" class="headerlink" title="1.1.5 接口"></a>1.1.5 接口</h3><h3 id="1-1-6-字段"><a href="#1-1-6-字段" class="headerlink" title="1.1.6 字段"></a>1.1.6 字段</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">u2 fields_count;         // 字段数量</span><br><span class="line"></span><br><span class="line">field_info &#123;</span><br><span class="line">    u2 access_flags;                            // 访问控制符</span><br><span class="line">    u2 name_index;                              // 指向常量池的入口</span><br><span class="line">    u2 descriptor_index;                        // 指向常量池的入口</span><br><span class="line">    u2 attribute_count;                         // 该字段的属性数量</span><br><span class="line">    attribute_info attributes[attribute_count]; // 属性信息</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>标志字符含义</p><table><thead><tr><th>header 1</th><th>header 2</th></tr></thead><tbody><tr><td>B</td><td>byte</td></tr><tr><td>C</td><td>char</td></tr><tr><td>D</td><td>double</td></tr><tr><td>F</td><td>float</td></tr><tr><td>I</td><td>int</td></tr><tr><td>J</td><td>long</td></tr><tr><td>S</td><td>short</td></tr><tr><td>Z</td><td>boolean</td></tr><tr><td>V</td><td>void</td></tr><tr><td>L</td><td>对象类型的通用前缀, 如 <code>Ljava/lang/Object</code></td></tr></tbody></table><h3 id="1-1-7-方法"><a href="#1-1-7-方法" class="headerlink" title="1.1.7 方法"></a>1.1.7 方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">u2 methods_count;           // 方法数量</span><br><span class="line"></span><br><span class="line">method_info &#123;</span><br><span class="line">    u2 access_flags;                // 访问标志</span><br><span class="line">    u2 name_index;                  // 指向常量池的入口</span><br><span class="line">    u2 descriptor_index;            // 指向常量池的入口</span><br><span class="line">    u2 attributes_count;            // 该字段的属性数量</span><br><span class="line">    attribute_info attributes[attributes_count];    // 属性信息</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>(Ljava/lang/String;)V</code> 表示 <code>参数为 String, 返回值为 void 的方法</code><br><code>(Ljava/lang/String;IF)V</code> 表示 <code>参数为 String, int, float, 返回值为 void 的方法</code></p></blockquote><h3 id="1-1-8-属性"><a href="#1-1-8-属性" class="headerlink" title="1.1.8 属性"></a>1.1.8 属性</h3><ul><li>方法和字段都可能有属性<ul><li>方法中可能有 <code>Code</code> 属性, 字段可能有 <code>Constant Value</code> 属性</li></ul></li><li>属性中可能嵌套属性<ul><li><code>code</code> 属性中还可能有 <code>Line Number Table</code>, <code>Local Variable Table</code>, <code>Stack Map Table</code> 等属性</li></ul></li><li>虚拟机的实现中还可以自定义属性</li></ul><h4 id="1-1-8-1-Constant-Value"><a href="#1-1-8-1-Constant-Value" class="headerlink" title="1.1.8.1 Constant Value"></a>1.1.8.1 Constant Value</h4><pre><code>如果某字段为静态类型(access_flag 中包含 ACC_STATIC 标志)将会被分配 Constant Value 属性</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ConstantValue_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;    <span class="comment">// 必须是对常量池的一个有效索引, 常量池在该索引处的项必须是 UTF8Info, 表示字符串 "ConstantValue"</span></span><br><span class="line">    u4 attribute_length;        <span class="comment">// 固定为 2</span></span><br><span class="line">    u2 constantvalue_index;     <span class="comment">// 必须是对常量池的一个有效索引, 常量池在该索引处的项给出该属性表示的常量值, 可能的值有 Constant_String, Constant_Long 等</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-1-8-2-Code"><a href="#1-1-8-2-Code" class="headerlink" title="1.1.8.2 Code"></a>1.1.8.2 Code</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Code_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;            <span class="comment">// 指向常量池, 应该是 UTF8Info, 且值为 "Code"</span></span><br><span class="line">    u4 attribute_length;                <span class="comment">// 属性长度, 不包括开始的 6 个字节</span></span><br><span class="line">    u2 max_stack;                       <span class="comment">// 操作数栈的最大深度</span></span><br><span class="line">    u2 max_locals;                      <span class="comment">// 最大局部变量表个数</span></span><br><span class="line">    u4 code_length;                     <span class="comment">// 该方法的代码长度</span></span><br><span class="line">    u1 code[code_length];               <span class="comment">// 真正的字节码</span></span><br><span class="line">    u2 exception_table_length;          <span class="comment">// 捕获异常表的长度</span></span><br><span class="line">    &#123;</span><br><span class="line">        u2 start_pc;        <span class="comment">// 捕获起始地址</span></span><br><span class="line">        u2 end_pc;          <span class="comment">// 捕获结束地址</span></span><br><span class="line">        u2 handler_pc;      <span class="comment">// </span></span><br><span class="line">        u2 catch_type;      <span class="comment">// 异常类型</span></span><br><span class="line">    &#125; exception_table[exception_table_length];  <span class="comment">// 捕获异常表</span></span><br><span class="line">    u2 attributes_count;                <span class="comment">// </span></span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Code 属性中的字节码</strong></p><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-24/71745531.jpg" alt=""></p><table><thead><tr><th style="text-align:center">字节码</th><th style="text-align:center">命令</th><th style="text-align:center">含义</th></tr></thead><tbody><tr><td style="text-align:center">2A</td><td style="text-align:center">aload_0</td><td style="text-align:center">从局部变量表第 0 个值压入操作数栈</td></tr><tr><td style="text-align:center">B4 00 15</td><td style="text-align:center">getfield #21</td><td style="text-align:center">获取对象的字段值</td></tr><tr><td style="text-align:center">10 1E</td><td style="text-align:center">bipush 30</td><td style="text-align:center">将 30 压入栈中</td></tr><tr><td style="text-align:center">A2 00 0E</td><td style="text-align:center">if_icmp_ge 20</td><td style="text-align:center">将当前</td></tr></tbody></table><h4 id="1-1-8-3-LineNumber"><a href="#1-1-8-3-LineNumber" class="headerlink" title="1.1.8.3 LineNumber"></a>1.1.8.3 LineNumber</h4><pre><code>code属性的一个子属性可选的变长属性, 维护 Java 源代码行号与字节码行号(偏移量之间的对应关系)</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LineNumberTable_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;</span><br><span class="line">    u4 attribute_length;</span><br><span class="line">    u2 line_number_table_length;</span><br><span class="line">    &#123;</span><br><span class="line">        u2 start_pc;        <span class="comment">// 字节码偏移量</span></span><br><span class="line">        u2 line_number;     <span class="comment">// 行号</span></span><br><span class="line">    &#125; line_number_table[line_number_table_length];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-1-8-4-LocalVariableTable-属性"><a href="#1-1-8-4-LocalVariableTable-属性" class="headerlink" title="1.1.8.4 LocalVariableTable 属性"></a>1.1.8.4 LocalVariableTable 属性</h4><pre><code>code属性的一个子属性可选的变长属性, 维护栈帧中局部变量表中变量与 Java 源码中定义变量的关系</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LocalVariableTable_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;</span><br><span class="line">    u4 attribute_length;</span><br><span class="line">    u2 local_variable_table_length;</span><br><span class="line">    &#123;</span><br><span class="line">        u2 start_pc;            <span class="comment">// 局部变量位于 [start_pc, start_pc + length)之间</span></span><br><span class="line">        u2 length;</span><br><span class="line">        u2 name_index;          <span class="comment">// 局部变量的名称索引</span></span><br><span class="line">        u2 descriptor_index;    <span class="comment">// 局部变量的描述符索引</span></span><br><span class="line">        u2 index;               <span class="comment">// 局部变量在栈帧中的索引</span></span><br><span class="line">    &#125; local_variable_table[local_variable_table_length];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-2-JVM-运行时动态行为"><a href="#1-2-JVM-运行时动态行为" class="headerlink" title="1.2 JVM 运行时动态行为"></a>1.2 JVM 运行时动态行为</h2><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-24/2593924.jpg" alt=""></p><ul><li>线程中包含函数栈帧, 其中每个函数帧表示某一个函数的调用过程</li><li>在每一个函数帧的内部, JVM 又细分了 <code>局部变量表</code>, <code>操作数栈</code> 等</li><li>局部变量和操作数栈中的变量会引用堆中的对象</li><li>常量池引用指向方法区, 方法区保存了类的元数据以及方法的字节码</li></ul><h3 id="1-2-1-实例"><a href="#1-2-1-实例" class="headerlink" title="1.2.1 实例"></a>1.2.1 实例</h3><p>Java 源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> num = i + j;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">demo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        add(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>转换成字节码后:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">demo:</span><br><span class="line"><span class="number">0</span>: aload_0</span><br><span class="line"><span class="number">1</span>: bipush   <span class="number">10</span></span><br><span class="line"><span class="number">3</span>: bipush   <span class="number">20</span></span><br><span class="line"><span class="number">5</span>: invokevirtial    #<span class="number">2</span></span><br><span class="line"><span class="number">8</span>: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">add:</span><br><span class="line"><span class="number">0</span>: aload_1</span><br><span class="line"><span class="number">1</span>: aload_2</span><br><span class="line"><span class="number">2</span>: iadd</span><br><span class="line"><span class="number">3</span>: istore_3</span><br><span class="line"><span class="number">4</span>: <span class="keyword">return</span></span><br></pre></td></tr></table></figure></p><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-24/39159076.jpg" alt=""></p><p>调用 <code>add</code> 函数, 生成新的函数帧</p><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-24/5082789.jpg" alt=""></p><p><code>0: aload_1</code>: 将局部变量表第 1 个变量压入操作数栈;<br><code>1: aload_2</code>: 将局部变量表第 2 个变量压入操作数栈;<br><code>2: iadd</code>: 将操作数栈顶端的两个元素弹出, 相加并将结果压入栈顶<br><code>3: istore_3</code>: 将操作数栈栈顶元素放在局部变量表第 3 个元素中<br><code>4: return</code>: 执行完毕</p><h1 id="2-ClassLoader"><a href="#2-ClassLoader" class="headerlink" title="2. ClassLoader"></a>2. ClassLoader</h1><h2 id="2-1-Java-是动态链接"><a href="#2-1-Java-是动态链接" class="headerlink" title="2.1 Java 是动态链接"></a>2.1 Java 是动态链接</h2><ul><li>C: 编译 -&gt; 链接 -&gt; 生成 <code>.exe</code> -&gt; 执行<ul><li>函数 A 调用函数 B, 在链接时会直接在函数 A 中记录函数 B 的地址</li></ul></li><li>Java: 编译 -&gt; <code>.class</code> -&gt; 装载执行<ul><li>类 A 中使用了另一个类 B, 在 A.class 中只保存类 B 的名称, 而不会保留 B 的 “地址”</li><li>在运行时根据名称来查找类, 装载类</li></ul></li></ul><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-24/64108809.jpg" alt=""></p><h2 id="2-2-类加载器的委托模型"><a href="#2-2-类加载器的委托模型" class="headerlink" title="2.2 类加载器的委托模型"></a>2.2 类加载器的委托模型</h2><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-24/90661799.jpg" alt=""></p><p>工作原理</p><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-24/74913726.jpg" alt=""></p><h2 id="2-3-类加载器的命名空间"><a href="#2-3-类加载器的命名空间" class="headerlink" title="2.3 类加载器的命名空间"></a>2.3 类加载器的命名空间</h2><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-24/81556783.jpg" alt=""></p><p><code>类加载器 + 类名</code> 唯一确定一个类, 只有同一个加载器加载的类才是相同的类.</p><h2 id="2-4-验证"><a href="#2-4-验证" class="headerlink" title="2.4 验证"></a>2.4 验证</h2><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-24/9057717.jpg" alt=""></p><h2 id="2-5-自定义类加载器"><a href="#2-5-自定义类加载器" class="headerlink" title="2.5 自定义类加载器"></a>2.5 自定义类加载器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; classPaths = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] byteCodes = loadByteCode(name);</span><br><span class="line">        <span class="keyword">if</span> (byteCodes == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> defineClass(name, byteCodes, <span class="number">0</span>, byteCodes.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] loadClassFile(String classFileName) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String classPath: classPaths) &#123;</span><br><span class="line">            String realPath = classPath + File.separatorChar + classFileName.replace(<span class="string">'.'</span>, File.separatorChar) + <span class="string">".class"</span>;</span><br><span class="line">            </span><br><span class="line">            File file = <span class="keyword">new</span> File(classFileName);</span><br><span class="line">            <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> IOUtils.toByteArray(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>DefineClass</code> 方法</p><ul><li><code>protected final Class&lt;?&gt; defineClass(String name, byte[] b, int off, int length) throws ClassFormatError;</code></li><li>只要传递给该方法一个合法字节数组, 就可以转化成一个 Class 对象, 这就意味着可以从任何地方组装类:<ul><li>磁盘</li><li>zip 文件</li><li>网络</li><li>运行时动态生成</li></ul></li></ul><h1 id="3-常量池"><a href="#3-常量池" class="headerlink" title="3. 常量池"></a>3. 常量池</h1><h2 id="3-1-常见结构"><a href="#3-1-常见结构" class="headerlink" title="3.1 常见结构"></a>3.1 常见结构</h2><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-24/54920383.jpg" alt=""></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">CONSTANT_Class_info &#123;</span><br><span class="line">    u1 tag;         <span class="comment">// 7</span></span><br><span class="line">    u2 name_index;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CONSTANT_Utf8_info &#123;</span><br><span class="line">    u1 tag;             <span class="comment">// 1</span></span><br><span class="line">    u2 length;          <span class="comment">// 长度</span></span><br><span class="line">    u1 bytes[length];   <span class="comment">// content</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CONSTANT_String_info &#123;</span><br><span class="line">    u1 tag;             <span class="comment">// </span></span><br><span class="line">    u2 string_index;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CONSTANT_Fieldref_info &#123;</span><br><span class="line">    u1 tag;             <span class="comment">// 9</span></span><br><span class="line">    u2 class_index;     <span class="comment">// </span></span><br><span class="line">    u2 name_and_type_index;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CONSTANT_Methodref_info &#123;</span><br><span class="line">    u1 tag;             <span class="comment">// 10</span></span><br><span class="line">    u2 class_index;</span><br><span class="line">    u2 name_and_type_index;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CONSTANT_NameAndType_info &#123;</span><br><span class="line">    u1 tag;             <span class="comment">// 12</span></span><br><span class="line">    u2 class_index;</span><br><span class="line">    u2 descriptor_index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-24/51804525.jpg" alt=""></p><h2 id="3-2-访问标志"><a href="#3-2-访问标志" class="headerlink" title="3.2 访问标志"></a>3.2 访问标志</h2><table><thead><tr><th style="text-align:center">标志名称</th><th style="text-align:center">标志值</th><th style="text-align:center">含义</th></tr></thead><tbody><tr><td style="text-align:center">ACC_PUBLIC</td><td style="text-align:center">0x0001</td><td style="text-align:center">public 类型</td></tr><tr><td style="text-align:center">ACC_FINAL</td><td style="text-align:center">0x0002</td><td style="text-align:center">声明为 final 类型</td></tr><tr><td style="text-align:center">ACC_SUPER</td><td style="text-align:center">0x0020</td><td style="text-align:center">是否允许使用 <code>invokespecial</code> 字节码指令的新语义</td></tr><tr><td style="text-align:center">ACC_INTERFACE</td><td style="text-align:center">0x0200</td><td style="text-align:center">声明为接口</td></tr><tr><td style="text-align:center">ACC_ABSTRACT</td><td style="text-align:center">0x0400</td><td style="text-align:center">Abstract 类型</td></tr><tr><td style="text-align:center">ACC_SYNTHETIC</td><td style="text-align:center">0x1000</td><td style="text-align:center">这个类并非由用户代码产生</td></tr><tr><td style="text-align:center">ACC_ANNOTATION</td><td style="text-align:center">0x2000</td><td style="text-align:center">注解</td></tr><tr><td style="text-align:center">ACC_ENUM</td><td style="text-align:center">0x4000</td><td style="text-align:center">枚举</td></tr></tbody></table><h1 id="4-字段-amp-方法"><a href="#4-字段-amp-方法" class="headerlink" title="4. 字段 &amp; 方法"></a>4. 字段 &amp; 方法</h1><h2 id="4-1-字段"><a href="#4-1-字段" class="headerlink" title="4.1 字段"></a>4.1 字段</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">u2 fields_count;         // 字段数量</span><br><span class="line"></span><br><span class="line">field_info &#123;</span><br><span class="line">    u2 access_flags;                            // 访问控制符</span><br><span class="line">    u2 name_index;                              // 指向常量池的入口</span><br><span class="line">    u2 descriptor_index;                        // 指向常量池的入口</span><br><span class="line">    u2 attribute_count;                         // 该字段的属性数量</span><br><span class="line">    attribute_info attributes[attribute_count]; // 属性信息</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-24/51718592.jpg" alt=""></p><p>可以看到上图中有两个字段, 分别为 <code>String</code> 类型的 <code>name</code>, 和 <code>int</code> 类型的 <code>age</code></p><ul><li><code>Name Index</code> 表示常量池中变量名称的索引</li><li><code>Desc Index</code> 表示常量池中变量类型的索引</li></ul><h2 id="4-2-方法"><a href="#4-2-方法" class="headerlink" title="4.2 方法"></a>4.2 方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">u2 methods_count;           // 方法数量</span><br><span class="line"></span><br><span class="line">method_info &#123;</span><br><span class="line">    u2 access_flags;                // 访问标志</span><br><span class="line">    u2 name_index;                  // 指向常量池的入口</span><br><span class="line">    u2 descriptor_index;            // 指向常量池的入口</span><br><span class="line">    u2 attributes_count;            // 该字段的属性数量</span><br><span class="line">    attribute_info attributes[attributes_count];    // 属性信息</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-24/11946975.jpg" alt=""></p><p>以第一个方法为例:</p><ul><li><code>Name Index</code> 表示方法名称为 <code>&lt;init&gt;</code>, 即构造方法</li><li><code>Desc Index</code> 表示方法签名为 <code>(Ljava/lang/String;I)V</code>, 即 <code>(String, int):void</code></li></ul><h2 id="4-3-属性"><a href="#4-3-属性" class="headerlink" title="4.3 属性"></a>4.3 属性</h2><h3 id="4-3-1-Code-属性"><a href="#4-3-1-Code-属性" class="headerlink" title="4.3.1 Code 属性"></a>4.3.1 Code 属性</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Code_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;            <span class="comment">// 指向常量池, 应该是 UTF8Info, 且值为 "Code"</span></span><br><span class="line">    u4 attribute_length;                <span class="comment">// 属性长度, 不包括开始的 6 个字节</span></span><br><span class="line">    u2 max_stack;                       <span class="comment">// 操作数栈的最大深度</span></span><br><span class="line">    u2 max_locals;                      <span class="comment">// 最大局部变量表个数</span></span><br><span class="line">    u4 code_length;                     <span class="comment">// 该方法的代码长度</span></span><br><span class="line">    u1 code[code_length];               <span class="comment">// 真正的字节码</span></span><br><span class="line">    u2 exception_table_length;          <span class="comment">// 捕获异常表的长度</span></span><br><span class="line">    &#123;</span><br><span class="line">        u2 start_pc;        <span class="comment">// 捕获起始地址</span></span><br><span class="line">        u2 end_pc;          <span class="comment">// 捕获结束地址</span></span><br><span class="line">        u2 handler_pc;      <span class="comment">// </span></span><br><span class="line">        u2 catch_type;      <span class="comment">// 异常类型</span></span><br><span class="line">    &#125; exception_table[exception_table_length];  <span class="comment">// 捕获异常表</span></span><br><span class="line">    u2 attributes_count;                <span class="comment">// 嵌套属性数量</span></span><br><span class="line">    attribute_info attributes[attributes_count];    <span class="comment">// 嵌套属性</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>code 属性一般由两个常见的子属性, 分别是:</p><ul><li>LineNumberTable</li><li>LocalVariableTable</li></ul><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-24/56894058.jpg" alt=""></p><h3 id="4-3-2-LocalLineTable"><a href="#4-3-2-LocalLineTable" class="headerlink" title="4.3.2 LocalLineTable"></a>4.3.2 LocalLineTable</h3><pre><code>通过该属性可以完成字节码与 Java 源码的行号映射可以在 debug 的时候准确找到源码并且抛出异常的时候堆栈信息可以找到对应行号</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">LineNumberTable_arrtibute &#123;</span><br><span class="line">    u2 attribute_name_index;        <span class="comment">// 指向常量池, 必须是值为 "LineNumberTable" 的 Utf8 常量</span></span><br><span class="line">    u4 arrtibute_length;            <span class="comment">// 当前属性长度, 不包括开始的 6 个字节</span></span><br><span class="line">    u2 line_number_table_length;    <span class="comment">// line_number_table 数组元素个数</span></span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">        u2 start_pc;                <span class="comment">// start_pc 值必须是 code[] 数组的一个索引</span></span><br><span class="line">        u2 line_number;             <span class="comment">// 源文件的行号</span></span><br><span class="line">    &#125; line_number_table[line_number_table_length];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-3-LocalVariableTable"><a href="#4-3-3-LocalVariableTable" class="headerlink" title="4.3.3 LocalVariableTable"></a>4.3.3 LocalVariableTable</h3><pre><code>LocalVariableTable 属性建立了方法中的局部变量与源代码中的局部变量之间的对应关系。 </code></pre><p>每个 LocalVariableTable  的 local_variable_table 部分可以看做是一个数组， 每个数组项是一个叫做local_variable_info的结构， 该结构描述了某个局部变量的变量名和描述符， 还有和源代码的对应关系。</p><p>下面讲解 <code>local_variable_info</code> 的各个部分：   </p><ul><li><code>start_pc</code> 是当前 local_variable_info 所对应的局部变量的作用域的起始字节码偏移量； </li><li><code>length</code> 是当前 <code>local_variable_info</code> 所对应的局部变量的作用域的大小。 也就是从字节码偏移量 <code>start_pc</code>  到 <code>start_pc+length</code> 就是当前局部变量的作用域范围； </li><li><code>name_index</code> 指向常量池中的一个 <code>CONSTANT_Utf8_info</code> ， 该 <code>CONSTANT_Utf8_info</code> 描述了当前局部变量的变量名； </li><li><code>descriptor_index</code> 指向常量池中的一个 <code>CONSTANT_Utf8_info</code> ， 该 <code>CONSTANT_Utf8_info</code> 描述了当前局部变量的描述符； </li><li><code>index</code> 描述了在该方法被执行时，当前局部变量在栈中局部变量表中的位置。 </li></ul><p>由此可知， 方法中的每个局部变量都会对应一个local_variable_info 。 </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">LocalVariableTable_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;        <span class="comment">// 指向常量池, 必须是值为 "LocalVariableTable_attribute" 的 Utf8 常量</span></span><br><span class="line">    u4 attribute_length;            <span class="comment">// 当前属性长度, 不包括开始的 6 个字节</span></span><br><span class="line">    u2 local_variable_table_length; <span class="comment">// local_variable_table[] 的元素个数</span></span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">        u2 start_pc;                <span class="comment">// 局部变量的索引都在范围 [start_pc, start_pc + length)</span></span><br><span class="line">        u2 length;</span><br><span class="line">        u2 name_index;              <span class="comment">// 变量名索引, 在常量池中</span></span><br><span class="line">        u2 descriptor_index;        <span class="comment">// 变量描述索引(在常量池中)</span></span><br><span class="line">        u2 index;                   <span class="comment">// 此局部变量在当前栈帧的局部变量表中的索引</span></span><br><span class="line">    &#125; local_variable_table[local_variable_table_length]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-25/6624730.jpg" alt=""></p><p>解析以上字节码得到:</p><table><thead><tr><th style="text-align:center">start pc</th><th style="text-align:center">length</th><th style="text-align:center">slot</th><th style="text-align:center">name</th><th style="text-align:center">descript</th></tr></thead><tbody><tr><td style="text-align:center">0</td><td style="text-align:center">15</td><td style="text-align:center">0</td><td style="text-align:center">this</td><td style="text-align:center">Lorg/destiny/jvm/model/Employee</td></tr><tr><td style="text-align:center">0</td><td style="text-align:center">15</td><td style="text-align:center">1</td><td style="text-align:center">name</td><td style="text-align:center">Ljava/lang/String</td></tr><tr><td style="text-align:center">0</td><td style="text-align:center">15</td><td style="text-align:center">2</td><td style="text-align:center">age</td><td style="text-align:center">I</td></tr></tbody></table><p>在解析 <code>code</code> 属性时需要注意的两点:</p><ul><li><code>code</code> 属性中包含了方法真正的字节码</li><li><code>code</code> 属性中包含几个子属性, 包括 <code>LineNumberTable</code>, <code>LocalVariableTable</code>等, 也需要进行解析.</li></ul><p>在 <code>Field</code>, <code>Method</code>, <code>Attribute</code> 三者中, 我们可以抽象出如下的关系:</p><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-25/90459462.jpg" alt=""></p><h3 id="4-3-4-Exceptions"><a href="#4-3-4-Exceptions" class="headerlink" title="4.3.4 Exceptions"></a>4.3.4 Exceptions</h3><pre><code>如果代码中出现了try{}catch{}块,那么try{}块内的机器指令的地址范围记录下来, 并且记录对应的catch{}块中的起始机器指令地址.当运行时在try块中有异常抛出的话, JVM会将catch{}块对应懂得其实机器指令地址传递给PC寄存器，从而实现指令跳转.</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">u2 exception_table_length;          <span class="comment">// 捕获异常表的长度</span></span><br><span class="line">&#123;</span><br><span class="line">    u2 start_pc;        <span class="comment">// 捕获起始地址</span></span><br><span class="line">    u2 end_pc;          <span class="comment">// 捕获结束地址</span></span><br><span class="line">    u2 handler_pc;      <span class="comment">// </span></span><br><span class="line">    u2 catch_type;      <span class="comment">// 异常类型</span></span><br><span class="line">&#125; exception_table[exception_table_length];  <span class="comment">// 捕获异常表</span></span><br></pre></td></tr></table></figure><p><code>exception_table</code> 记录了该 code 属性中所有显示抛出的异常信心, 包括异常的作用于及类型.</p><h1 id="5-字节码指令"><a href="#5-字节码指令" class="headerlink" title="5. 字节码指令"></a>5. 字节码指令</h1><h2 id="5-1-main-方法字节码"><a href="#5-1-main-方法字节码" class="headerlink" title="5.1 main 方法字节码"></a>5.1 main 方法字节码</h2><p>Employee 的 main 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Employee employee = <span class="keyword">new</span> Employee(<span class="string">"destiny"</span>, <span class="number">24</span>);</span><br><span class="line">    employee.sayHello();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>经过编译后的字节码:<br><img src="http://oetw0yrii.bkt.clouddn.com/18-6-26/52634127.jpg" alt=""></p><h3 id="5-1-1-new"><a href="#5-1-1-new" class="headerlink" title="5.1.1 new"></a>5.1.1 new</h3><pre><code>new indexbyte1 indexbyte2</code></pre><ul><li>操作: 创建一个对象</li><li>(indexbyte1 &lt;&lt; 8) | indexbyte2 得到一个指向常量池的索引</li><li>BB 00 01 对应 <code>new #1</code>, 对应的类就是 <code>org/destiny/jvm/model/Employee</code></li></ul><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-26/55866163.jpg" alt=""></p><ol><li>在堆中创建一个新对象</li><li>将该对象的引用压入栈中</li></ol><h3 id="5-1-2-dup"><a href="#5-1-2-dup" class="headerlink" title="5.1.2 dup"></a>5.1.2 dup</h3><ul><li>操作: 复制操作数栈栈顶的值, 并压入栈中</li></ul><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-26/56559512.jpg" alt=""></p><h3 id="5-1-3-ldc"><a href="#5-1-3-ldc" class="headerlink" title="5.1.3 ldc"></a>5.1.3 ldc</h3><pre><code>ldc index</code></pre><ul><li>操作: 从运行时常量池中提取数据压入栈中</li><li><code>ldc #43</code>, 43 在常量池中的值为字符串 <code>destiny</code></li></ul><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-26/3305320.jpg" alt=""></p><h3 id="5-1-4-bipush"><a href="#5-1-4-bipush" class="headerlink" title="5.1.4 bipush"></a>5.1.4 bipush</h3><pre><code>bipush byte</code></pre><ul><li>将有符号 byte 扩展为一个 int 类型的值 value, 然后将 value 压入到操作数栈中.</li><li>byte 是一个立即数而非常量池引用</li></ul><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-26/78725468.jpg" alt=""></p><h3 id="5-1-5-invokespecial-indexbyte1-indexbyte2"><a href="#5-1-5-invokespecial-indexbyte1-indexbyte2" class="headerlink" title="5.1.5 invokespecial indexbyte1 indexbyte2"></a>5.1.5 invokespecial indexbyte1 indexbyte2</h3><ul><li>操作: 对一个对象进行初始化, 父类的初始化, 调用私有方法(因为没有多态性为)</li><li>(indexbyte1 &lt;&lt; 8) | indexbyte2 得到一个指向常量池的索引</li><li><code>invokespecial #45</code></li><li>常量池 #45 是一个 <code>methodref</code>: <code>&lt;init&gt;:(Ljava/lang/String;I)V</code></li><li>需要形成新的栈帧</li></ul><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-26/44315742.jpg" alt=""></p><h3 id="5-1-6-astore-n"><a href="#5-1-6-astore-n" class="headerlink" title="5.1.6 astore_n"></a>5.1.6 astore_n</h3><ul><li>操作: 将栈顶的 <code>reference</code> 类型数据保存到局部变量表中</li><li>astore_0</li><li>astore_1</li><li>astore_2</li><li>astore_3</li></ul><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-26/31300372.jpg" alt=""></p><h3 id="5-1-7-aload-n"><a href="#5-1-7-aload-n" class="headerlink" title="5.1.7 aload_n"></a>5.1.7 aload_n</h3><ul><li>操作: 从局部变量表中加载一个 reference 类型的值到操作数栈中</li><li>aload_0</li><li>aload_1</li><li>aload_2</li><li>aload_3</li></ul><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-26/9829577.jpg" alt=""></p><h3 id="5-1-8-invokevirtual-indexbyte1-indexbyte2"><a href="#5-1-8-invokevirtual-indexbyte1-indexbyte2" class="headerlink" title="5.1.8 invokevirtual indexbyte1 indexbyte2"></a>5.1.8 invokevirtual indexbyte1 indexbyte2</h3><ul><li>操作: 调用实例方法, 依据实例的具体类型进行分派(多态)</li><li>(indexbyte1 &lt;&lt; 8) | indexbyte2</li><li><code>invokevirtual #47</code> =&gt; <code>sayHello: ()V</code></li><li>也需要形成新的栈帧</li></ul><h3 id="5-1-9-return"><a href="#5-1-9-return" class="headerlink" title="5.1.9 return"></a>5.1.9 return</h3><ul><li>操作: 方法返回, 从当前函数栈帧退出, 无返回值.</li></ul><h2 id="5-2-方法指令"><a href="#5-2-方法指令" class="headerlink" title="5.2  方法指令"></a>5.2 <init> 方法指令</init></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Employee</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.age = age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-26/3230642.jpg" alt=""></p><h3 id="5-2-1-aload-0"><a href="#5-2-1-aload-0" class="headerlink" title="5.2.1 aload_0"></a>5.2.1 aload_0</h3><ul><li>操作: 从局部变量表中加载 index 为 0 的 reference 类型的值到操作数栈中</li></ul><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-26/18433274.jpg" alt=""></p><h3 id="5-2-2-aload-1"><a href="#5-2-2-aload-1" class="headerlink" title="5.2.2 aload_1"></a>5.2.2 aload_1</h3><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-26/25073553.jpg" alt=""></p><h3 id="5-2-3-putfield-indexbyte1-indexbyte2"><a href="#5-2-3-putfield-indexbyte1-indexbyte2" class="headerlink" title="5.2.3 putfield indexbyte1 indexbyte2"></a>5.2.3 putfield indexbyte1 indexbyte2</h3><ul><li>操作: 给一个对象字段赋值</li><li>(indexbyte1 &lt;&lt; 8) | indexbyte2</li><li><code>putfield #15</code> =&gt; <code>putfield name:Ljava/lang/String</code></li></ul><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-26/36898043.jpg" alt=""></p><h3 id="5-3-3-iload-2"><a href="#5-3-3-iload-2" class="headerlink" title="5.3.3 iload_2"></a>5.3.3 iload_2</h3><ul><li>操作: 从局部变量中把 index 为 2 的 int 类型的值加载到操作数栈中</li><li>reference 类型使用 <code>aload</code>, int 类型使用 <code>iload</code></li></ul><h2 id="5-4-字节码指令的设计实现"><a href="#5-4-字节码指令的设计实现" class="headerlink" title="5.4 字节码指令的设计实现"></a>5.4 字节码指令的设计实现</h2><p>使用 <code>命令模式</code> 来抽象该场景, 即将所有字节码指令抽象为命令对象, 基类声明 <code>command</code> 方法, 再根据操作数的不同泛化出不同的抽象子类</p><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-26/32409326.jpg" alt=""></p><h1 id="6-JVM-执行引擎"><a href="#6-JVM-执行引擎" class="headerlink" title="6 JVM 执行引擎"></a>6 JVM 执行引擎</h1><p><img src="http://oetw0yrii.bkt.clouddn.com/18-7-1/2187429.jpg" alt=""></p><h2 id="6-1-Java-命令"><a href="#6-1-Java-命令" class="headerlink" title="6.1 Java 命令"></a>6.1 Java 命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp path1;path2 org.destiny.jvm.Employee</span><br></pre></td></tr></table></figure><ul><li>cp: classpath(s), 默认是当前路径</li><li>class name: 系统需要找到这个类的 main 方法, 然后执行它的字节码</li></ul><h2 id="6-2-执行过程"><a href="#6-2-执行过程" class="headerlink" title="6.2 执行过程"></a>6.2 执行过程</h2><ul><li>加载类<ul><li>工具: <code>ClassFileLoader</code></li><li>目的地: 方法区</li></ul></li><li>获取类的 <code>public static void main(String[] args)</code> 方法<ul><li>从方法区寻找</li></ul></li><li>执行 <code>main</code> 方法的字节码<ul><li>字节码指令</li><li>栈帧(StackFrame)</li><li>堆(Heap)</li></ul></li></ul><h2 id="6-3-字节码指令的分类"><a href="#6-3-字节码指令的分类" class="headerlink" title="6.3 字节码指令的分类"></a>6.3 字节码指令的分类</h2><table><thead><tr><th style="text-align:center">类型</th><th style="text-align:center">指令</th></tr></thead><tbody><tr><td style="text-align:center">依次执行</td><td style="text-align:center"><code>new</code><br><code>bipush</code><br><code>ldc</code><br><code>dup</code></td></tr><tr><td style="text-align:center">暂停当前栈帧并创建新栈帧</td><td style="text-align:center"><code>invokespecial</code><br><code>invokevirtual</code></td></tr><tr><td style="text-align:center">跳转到另一行去执行</td><td style="text-align:center"><code>if_icmp_ge</code><br><code>if_icmple</code><br><code>goto</code></td></tr><tr><td style="text-align:center">退出当前栈帧</td><td style="text-align:center"><code>return</code></td></tr></tbody></table><h1 id="7-垃圾回收机制"><a href="#7-垃圾回收机制" class="headerlink" title="7. 垃圾回收机制"></a>7. 垃圾回收机制</h1><h2 id="7-1-Java-对象的内存布局"><a href="#7-1-Java-对象的内存布局" class="headerlink" title="7.1 Java 对象的内存布局"></a>7.1 Java 对象的内存布局</h2><p><img src="http://oetw0yrii.bkt.clouddn.com/18-7-1/13981658.jpg" alt=""></p><ul><li>MarkWord: 标注对象的元信息<ul><li>GC 年龄</li><li>锁的标志位</li></ul></li><li>ClassPointer: 指向方法区的类信息的指针</li><li>InstanceData: 类实例对象的数据<ul><li>方法信息保存在方法区</li></ul></li><li>padding: 填充</li></ul><h2 id="7-2-对象分配和垃圾回收"><a href="#7-2-对象分配和垃圾回收" class="headerlink" title="7.2 对象分配和垃圾回收"></a>7.2 对象分配和垃圾回收</h2><ul><li>对象优先分配在新生代<ul><li>如果 Eden 区没有足够的空间, 则触发一次 MinorGC</li><li>Java 对象大多具有生命周期短暂的特点, MinorGC 非常频繁, 速度也很快</li></ul></li><li>大对象直接进入老年代<ul><li>可以根据参数设置阈值</li></ul></li><li>长期存活对象进入老年代<ul><li>每个对象都有一个年龄(age), 在 MarkWord 中</li><li>如果 age 超过阈值, 则晋升到老年代</li></ul></li><li>动态年龄判断<ul><li>如果在 Survivor 空间中相同年龄的所有对象大小的总数和大于 Survivor 空间的一半, 年龄大于或等于该年龄的对象可以直接进入老年代</li></ul></li></ul><h2 id="MinorGC-时-新生代与老年代的关系"><a href="#MinorGC-时-新生代与老年代的关系" class="headerlink" title="MinorGC 时 新生代与老年代的关系"></a>MinorGC 时 新生代与老年代的关系</h2><p><img src="http://oetw0yrii.bkt.clouddn.com/18-7-1/2587031.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;1-概述&quot;&gt;&lt;a href=&quot;#1-概述&quot; class=&quot;headerlink&quot; title=&quot;1. 概述&quot;&gt;&lt;/a&gt;1. 概述&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;http://oetw0yrii.bkt.clouddn.com/18-6-23/68954491.
      
    
    </summary>
    
      <category term="JVM" scheme="https://destinywang.github.io/blog/categories/JVM/"/>
    
    
      <category term="JVM" scheme="https://destinywang.github.io/blog/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>Netty(1)基本概念</title>
    <link href="https://destinywang.github.io/blog/2018/06/24/Netty-1-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/"/>
    <id>https://destinywang.github.io/blog/2018/06/24/Netty-1-基本概念/</id>
    <published>2018-06-24T09:43:11.000Z</published>
    <updated>2018-06-24T15:06:29.100Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-Netty-架构设计"><a href="#1-Netty-架构设计" class="headerlink" title="1. Netty 架构设计"></a>1. Netty 架构设计</h1><p>Netty应用中必不可少的组件：</p><table><thead><tr><th>组件</th><th>作用</th></tr></thead><tbody><tr><td><code>Bootstrap</code> / <code>ServerBootstrap</code></td><td>一个Netty应用通常由一个Bootstrap开始，<br>它主要作用是配置整个Netty程序，串联起各个组件。</td></tr><tr><td><code>EventLoop</code></td><td>为 Channel 处理 IO 操作，一个 EventLoop 可以为多个 Channel 服务。</td></tr><tr><td><code>EventLoopGroup</code></td><td>包含多个 EventLoopGroup</td></tr><tr><td><code>Channel</code></td><td>一个 Socket 连接，或者其他和 IO 操作相关的组件，它和 EventLoop 一起用来参与 IO 处理。</td></tr><tr><td><code>Future</code> / <code>ChannelFuture</code></td><td>在 Netty 中所有的 IO 操作都是异步的，<br>因此，你不能立刻得知消息是否被正确处理，但是我们可以过一会等它执行完成或者直接注册一个监听，<br>具体的实现就是通过 Future 和 ChannelFutures ,他们可以注册一个监听，当操作执行成功或失败时监听会自动触发。<br>总之，所有的操作都会返回一个 ChannelFuture。</td></tr><tr><td><code>ChannelInitializer</code></td><td>当一个链接建立时，我们需要知道怎么来接收或者发送数据，<br>当然，我们有各种各样的 Handler 实现来处理它，那么 ChannelInitializer 便是用来配置这些 Handler ，<br>它会提供一个  ChannelPipeline，并把 Handler 加入到 ChannelPipeline。</td></tr><tr><td><code>ChannelHandler</code></td><td>为了支持各种协议和处理数据的方式，便诞生了 Handler 组件。<br>Handler 主要用来处理各种事件，这里的事件很广泛，比如可以是连接、数据接收、异常、数据转换等。</td></tr><tr><td><code>ChannelPipeline</code></td><td>一个 Netty 应用基于 ChannelPipeline 机制，这种机制需要依赖于 EventLoop 和 EventLoopGroup ，因为它们三个都和事件或者事件处理相关</td></tr></tbody></table><h2 id="1-1-Netty-是如何处理连接请求和业务逻辑"><a href="#1-1-Netty-是如何处理连接请求和业务逻辑" class="headerlink" title="1.1 Netty 是如何处理连接请求和业务逻辑"></a>1.1 Netty 是如何处理连接请求和业务逻辑</h2><p>Netty是一个非阻塞的、事件驱动的、网络编程框架。</p><p>一个Channel会对应一个EventLoop，而一个EventLoop会对应着一个线程，也就是说，仅有一个线程在负责一个Channel的IO操作。</p><blockquote><p>当一个连接到达，Netty会注册一个channel，然后EventLoopGroup会分配一个EventLoop绑定到这个channel,在这个channel的整个生命周期过程中，都会由绑定的这个EventLoop来为它服务，而这个EventLoop就是一个线程。</p></blockquote><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-4/60707346.jpg" alt=""></p><blockquote><p>EventLoopGroup 和 EventLoop 的关系</p></blockquote><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-4/9536915.jpg" alt=""></p><h2 id="1-2-BootsStrapping"><a href="#1-2-BootsStrapping" class="headerlink" title="1.2 BootsStrapping"></a>1.2 BootsStrapping</h2><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-4/35530633.jpg" alt=""></p><p>我们利用 BootsStrapping 来配置 netty 应用，它有两种类型，一种用于 Client 端：BootsStrap，另一种用于Server端：ServerBootstrap，要想区别如何使用它们，你仅需要记住一个用在 Client 端，一个用在 Server 端。下面我们来详细介绍一下这两种类型的区别：</p><ol><li>ServerBootstrap 用于 Server 端，通过调用 <code>bind()</code> 方法来绑定到一个端口监听连接； Bootstrap 用于 Client 端，需要调用 <code>connect()</code> 方法来连接服务器端，但我们也可以通过调用 <code>bind()</code> 方法返回的 <code>ChannelFuture</code> 中获取 Channel 去 connect 服务器端。</li><li>客户端的 Bootstrap 一般用一个 EventLoopGroup，而服务器端的 ServerBootstrap 会用到两个（这两个也可以是同一个实例）。为何服务器端要用到两个 EventLoopGroup 呢？这么设计有明显的好处，如果一个 ServerBootstrap 有两个 EventLoopGroup，那么就可以把第一个 EventLoopGroup 用来专门负责绑定到端口监听连接事件，而把第二个 EventLoopGroup 用来处理每个接收到的连接。</li></ol><h2 id="1-3-ChannelHandler"><a href="#1-3-ChannelHandler" class="headerlink" title="1.3 ChannelHandler"></a>1.3 ChannelHandler</h2><p>应用程序中用到的最多的应该就是ChannelHandler，我们可以这么想象，数据在一个ChannelPipeline中流动，而ChannelHandler便是其中的一个个的小阀门，这些数据都会经过每一个ChannelHandler并且被它处理。</p><p>一个ChannelPipeline可以把两种Handler（ChannelInboundHandler和ChannelOutboundHandler）混合在一起，当一个数据流进入ChannelPipeline时，它会从ChannelPipeline头部开始传给第一个ChannelInboundHandler，当第一个处理完后再传给下一个，一直传递到管道的尾部。与之相对应的是，当数据被写出时，它会从管道的尾部开始，先经过管道尾部的“最后”一个ChannelOutboundHandler，当它处理完成后会传递给前一个ChannelOutboundHandler。</p><p>数据在各个Handler之间传递，这需要调用方法中传递的ChanneHandlerContext来操作， 在netty的API中提供了两个基类分ChannelOutboundHandlerAdapter和ChannelOutboundHandlerAdapter，他们仅仅实现了调用ChanneHandlerContext来把消息传递给下一个Handler，因为我们只关心处理数据，因此我们的程序中可以继承这两个基类来帮助我们做这些，而我们仅需实现处理数据的部分即可。</p><p>我们知道InboundHandler和OutboundHandler在ChannelPipeline中是混合在一起的，那么它们如何区分彼此呢？其实很容易，因为它们各自实现的是不同的接口，对于inbound event，Netty会自动跳过OutboundHandler,相反若是outbound event，ChannelInboundHandler会被忽略掉。</p><p>当一个ChannelHandler被加入到ChannelPipeline中时，它便会获得一个ChannelHandlerContext的引用，而ChannelHandlerContext可以用来读写Netty中的数据流。因此，现在可以有两种方式来发送数据，一种是把数据直接写入Channel，一种是把数据写入ChannelHandlerContext，它们的区别是写入Channel的话，数据流会从Channel的头开始传递，而如果写入ChannelHandlerContext的话，数据流会流入管道中的下一个Handler。  </p><h2 id="1-4-Encoders-Decoders-and-Domain-Logic"><a href="#1-4-Encoders-Decoders-and-Domain-Logic" class="headerlink" title="1.4  Encoders, Decoders and Domain Logic"></a>1.4  Encoders, Decoders and Domain Logic</h2><h3 id="Encoders和Decoders"><a href="#Encoders和Decoders" class="headerlink" title="Encoders和Decoders"></a>Encoders和Decoders</h3><p>因为我们在网络传输时只能传输字节流，因此，才发送数据之前，我们必须把我们的message型转换为bytes，与之对应，我们在接收数据后，必须把接收到的bytes再转换成message。我们把bytes to message这个过程称作Decode(解码成我们可以理解的)，把message to bytes这个过程成为Encode。</p><p>Netty中提供了很多现成的编码/解码器，我们一般从他们的名字中便可知道他们的用途，如ByteToMessageDecoder、MessageToByteEncoder，如专门用来处理Google Protobuf协议的ProtobufEncoder、 ProtobufDecoder。</p><p>我们前面说过，具体是哪种Handler就要看它们继承的是InboundAdapter还是OutboundAdapter，对于Decoders,很容易便可以知道它是继承自ChannelInboundHandlerAdapter或 ChannelInboundHandler，因为解码的意思是把ChannelPipeline传入的bytes解码成我们可以理解的message（即Java Object），而ChannelInboundHandler正是处理Inbound Event，而Inbound Event中传入的正是字节流。Decoder会覆盖其中的“ChannelRead()”方法，在这个方法中来调用具体的decode方法解码传递过来的字节流，然后通过调用ChannelHandlerContext.fireChannelRead(decodedMessage)方法把编码好的Message传递给下一个Handler。与之类似，Encoder就不必多少了。</p><h3 id="Domain-Logic"><a href="#Domain-Logic" class="headerlink" title="Domain Logic"></a>Domain Logic</h3><p>其实我们最最关心的事情就是如何处理接收到的解码后的数据，我们真正的业务逻辑便是处理接收到的数据。Netty提供了一个最常用的基类SimpleChannelInboundHandler<t>，其中T就是这个Handler处理的数据的类型（上一个Handler已经替我们解码好了），消息到达这个Handler时，Netty会自动调用这个Handler中的channelRead0(ChannelHandlerContext,T)方法，T是传递过来的数据对象，在这个方法中我们便可以任意写我们的业务逻辑了。</t></p><h1 id="2-Hello-World"><a href="#2-Hello-World" class="headerlink" title="2. Hello World"></a>2. Hello World</h1><h2 id="2-1-依赖"><a href="#2-1-依赖" class="headerlink" title="2.1 依赖"></a>2.1 依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.21.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2-2-Server-端-ChannelHandler"><a href="#2-2-Server-端-ChannelHandler" class="headerlink" title="2.2 Server 端 ChannelHandler"></a>2.2 Server 端 ChannelHandler</h2><p>我们不需要使每一个 <code>InboundChannel</code> 继承自 <code>ChannelInboundHandler</code>，因为直接继承的话需要实现 <code>ChannelInboundHandler</code> 中的所有接口，在一般的 <code>Channel</code> 中没必要这么做，只需要继承 <code>ChannelInboundHandelAdapter</code>，继承它的适配器就可以。</p><p>需要实现几个重要的方法，包括读取方法 <code>channelRead(ChannelHandlerContext, ctx)</code> 和异常处理方法 <code>exceptionCaught(ChannelHandlerContext ctx, Throwable cause)</code> 即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"HelloWorldServerHandler.channelActive"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"HelloWorldServerHandler.channelRead"</span>);</span><br><span class="line">        System.out.println(ctx.channel().remoteAddress().toString() + <span class="string">"-&gt; server: "</span> + msg.toString());</span><br><span class="line">        ctx.write(<span class="string">"server write: "</span> + msg);</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-3-服务端"><a href="#2-3-服务端" class="headerlink" title="2.3 服务端"></a>2.3 服务端</h2><p>需要一个 <code>ServerBootStrap</code>，用于引导 Netty Server 端的初始化工作。<br>我们需要指定它的 <code>transports</code>，是 <code>NIO还</code> 是 <code>OIO</code> ,还需要指定端口号，安装 <code>server</code> 端的处理器，也就是我们之前写的 <code>HelloWorldServerHandler</code> ，还有一些 <code>Option</code> 的配置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloWorldServer</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap().group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class).localAddress(<span class="keyword">new</span> InetSocketAddress(port))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            socketChannel.pipeline()</span><br><span class="line">                                    .addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> StringDecoder())</span><br><span class="line">                                    .addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> StringEncoder())</span><br><span class="line">                                    .addLast(<span class="keyword">new</span> HelloWorldServerHandler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;).option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            ChannelFuture future = serverBootstrap.bind(port).sync();</span><br><span class="line"></span><br><span class="line">            future.channel().write(<span class="string">"Hello Netty Client, I am a Server"</span>);</span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">9527</span>;</span><br><span class="line">        <span class="keyword">new</span> HelloWorldServer(port).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-4-Client-端-ChannelHandler"><a href="#2-4-Client-端-ChannelHandler" class="headerlink" title="2.4 Client 端 ChannelHandler"></a>2.4 Client 端 ChannelHandler</h2><p>整体与 <code>HelloWorldServerHandler</code> 类似</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"HelloWorldClientHandler.channelActive"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"HelloWorldClientHandler.channelRead: ==&gt;"</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-5-Client-端"><a href="#2-5-Client-端" class="headerlink" title="2.5 Client 端"></a>2.5 Client 端</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">            bootstrap.group(group).channel(NioSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            socketChannel.pipeline()</span><br><span class="line">                                    .addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> StringDecoder())</span><br><span class="line">                                    .addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> StringEncoder())</span><br><span class="line">                                    .addLast(<span class="keyword">new</span> HelloWorldClientHandler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            ChannelFuture future = bootstrap.connect(<span class="string">"127.0.0.1"</span>, <span class="number">9527</span>).sync();</span><br><span class="line">            future.channel().writeAndFlush(<span class="string">"Hello Netty Server, I am a common client"</span>);</span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分别启动 <code>Server 端</code> 和 <code>Client 端</code> 即可看到运行结果。</p><p>具体过程如下：</p><ol><li><code>HelloWorldServer</code> 启动，完成 <code>ChannelHandler</code> 的初始化，监听指定端口，在 <code>ChannelFuture future = serverBootstrap.bind(port).sync()</code> 处进行阻塞；</li><li><code>HelloWorldClient</code> 启动，完成 <code>ChannelHandler</code> 的初始化，并向 <code>127.0.0.1:9527</code> 发送一条信息，同时阻塞等待返回结果；</li><li><code>HelloWorldServerHandler</code> 读取到 <code>HelloWorldClient</code> 发送的消息，并写入自己的消息 <code>ctx.write(&quot;server write: &quot; + msg)</code></li><li><code>HelloWorldClientHandler</code> 读取到 <code>HelloWorldServerHandler</code>； 发送的消息，打印到控制台。</li></ol><h1 id="3-Hello-World-结构图"><a href="#3-Hello-World-结构图" class="headerlink" title="3. Hello World 结构图"></a>3. Hello World 结构图</h1><p><img src="http://oetw0yrii.bkt.clouddn.com/18-5-31/70138342.jpg" alt=""></p><h1 id="4-ChannelHandler、ChannelHandlerContext-和-ChannelPipeline"><a href="#4-ChannelHandler、ChannelHandlerContext-和-ChannelPipeline" class="headerlink" title="4. ChannelHandler、ChannelHandlerContext 和 ChannelPipeline"></a>4. <code>ChannelHandler</code>、<code>ChannelHandlerContext</code> 和 <code>ChannelPipeline</code></h1><blockquote><p>ChannelInboundHandlerAdapter<br><img src="http://oetw0yrii.bkt.clouddn.com/18-6-3/26874824.jpg" alt=""></p></blockquote><blockquote><p>ChannelOutboundHandlerAdapter<br><img src="http://oetw0yrii.bkt.clouddn.com/18-6-3/88244957.jpg" alt=""></p></blockquote><p>我们平时继承的最多的就是 <code>ChannelInboundHandlerAdapter</code> 和 <code>ChannelOutboundHandlerAdapter</code> ，这两个不是接口也不是抽象类，所以我们可以仅仅重写我们需要的方法，没有必须要实现的方法</p><p><code>ChannelHandler</code>, <code>ChannelHandlerContext</code> , <code>ChannelPipeline</code> 这三者的关系很特别，相辅相成，一个 <code>ChannelPipeline</code> 中可以有多个 <code>ChannelHandler</code> 实例，而每一个 <code>ChannelHandler</code> 实例与 <code>ChannelPipeline</code> 之间的桥梁就是 <code>ChannelHandlerContext</code> 实例</p><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-3/34681069.jpg" alt=""></p><p>如果能够获取到 <code>ChannelHandlerContext</code> 实例的话，就可以获取到需要的一切。同时，可以根据 <code>ChannelHandlerContext</code> 执行 <code>ChannelHandler</code> 中的方法</p><h2 id="4-1-示例"><a href="#4-1-示例" class="headerlink" title="4.1 示例"></a>4.1 示例</h2><ul><li>首先新增两个 <code>ChannelHandler</code></li><li>修改 <code>HelloWorldClient</code> 中的代码</li></ul><h3 id="4-1-1-BaseClient1Handler"><a href="#4-1-1-BaseClient1Handler" class="headerlink" title="4.1.1 BaseClient1Handler"></a>4.1.1 <code>BaseClient1Handler</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseClient1Handler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"BaseClient1Handler.channelActive"</span>);</span><br><span class="line">        ctx.fireChannelActive();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"BaseClient1Handler.channelInactive"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-1-2-BaseClient2Handler"><a href="#4-1-2-BaseClient2Handler" class="headerlink" title="4.1.2 BaseClient2Handler"></a>4.1.2 <code>BaseClient2Handler</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseClient2Handler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"BaseClient2Handler.channelActive"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-1-3-HelloWorldClient"><a href="#4-1-3-HelloWorldClient" class="headerlink" title="4.1.3 HelloWorldClient"></a>4.1.3 HelloWorldClient</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">            bootstrap.group(group).channel(NioSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            socketChannel.pipeline()</span><br><span class="line">                                    .addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> StringDecoder())</span><br><span class="line">                                    .addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> StringEncoder())</span><br><span class="line"><span class="comment">//                                    .addLast(new HelloWorldClientHandler());</span></span><br><span class="line">                                    .addLast(<span class="keyword">new</span> BaseClient1Handler())</span><br><span class="line">                                    .addLast(<span class="keyword">new</span> BaseClient2Handler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            ChannelFuture future = bootstrap.connect(<span class="string">"127.0.0.1"</span>, <span class="number">9527</span>).sync();</span><br><span class="line">            future.channel().writeAndFlush(<span class="string">"Hello Netty Server, I am a common client"</span>);</span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-1-4-执行结果"><a href="#4-1-4-执行结果" class="headerlink" title="4.1.4 执行结果"></a>4.1.4 执行结果</h3><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-3/12664699.jpg" alt=""></p><p>此时看到，<code>BaseClient1Handler</code> 和 <code>BaseClient2Handler</code> 都执行了 <code>channelActive()</code> 方法。</p><p>但如果把 <code>BaseClient1Handler</code> 的 <code>ctx.fireChannelActive()</code> 去掉，那么只会有 <code>BaseClient1Handler</code> 执行该方法</p><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-3/67183442.jpg" alt=""></p><pre><code>也就是说如果一个 channelPipeline 中有多个 channelHandler 时，且这些 channelHandler 中有同样的方法时，例如这里的 channelActive 方法，只会调用处在第一个的 channelHandler 中的 channelActive 方法，如果你想要调用后续的 channelHandler 的同名的方法就需要调用以 &quot;fire&quot; 为开头的方法了，这样做很灵活</code></pre><p>这样设计的优点：</p><ol><li>每一个 <code>handler</code> 只需要关注自己要处理的方法，如果你不关注 <code>channelActive</code> 方法时，你自定义的 <code>channelhandler</code> 就不需要重写 <code>channelActive</code> 方法;</li><li>异常处理，如果 <code>exceptionCaught</code> 方法每个 <code>handler</code> 都重写了，只需有一个类捕捉到然后做处理就可以了，不需要每个 <code>handler</code> 都处理一遍;</li><li>灵活性，也许左侧第一个 <code>ChannelHandler</code> 根本不需要管理某个业务逻辑，但是从第二个 <code>ChannelHandler</code> 就需要关注处理某个业务需求了，那么就可以很灵活地从第二个 <code>ChannelHandler</code> 开始处理业务，不需要从channel中的第一个 <code>ChannelHandler</code> 开始处理.</li></ol><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-3/72901126.jpg" alt=""></p><h1 id="5-ByteBuf"><a href="#5-ByteBuf" class="headerlink" title="5. ByteBuf"></a>5. <code>ByteBuf</code></h1><pre><code>网络传输的载体是 byte, 这是任何框架谁也逃脱不了的一种规定. JAVA 的 NIO 提供了 ByteBuffer, 用来完成这项任务.</code></pre><p><img src="http://oetw0yrii.bkt.clouddn.com/18-6-4/88956497.jpg" alt=""></p><p>读的时候，可读的区域是下标区间是 <code>[readerIndex，writeIndex)</code> ，可写区间的是 <code>[writerIndex,capacity-1]</code> ，但是 <code>discardable</code> 这段区间就会变得相对无用，既不能读，也不能写</p><p>从内存分配角度看，ByteBuf 可以分为两类：</p><ol><li>堆内存字节缓冲区: 特点是内存的分配和回收速度快，可以被 JVM 自动回收，缺点是如果进行 Socket 的 I/O 读写，需要额外做一次内存复制，将堆内存对应的缓冲区复制到内核 Channel 中，性能会有一定程度的下降。</li><li><p>直接内存字节缓冲区: 非堆内存，它在堆外进行内存分配，相比于堆内存，它的分配和回收速度会慢一些，但是将它写入或者从 Socket Channel 中读取时，由于少了一次内存复制，速度比堆内存快。</p><p> ByteBuf 最佳实践: 在 I/O 通信线程的读写缓冲区使用 <code>DirectByteBuf</code>, 后端业务消息的编码模块使用 <code>HeapByteBuf</code>, 这样组合可以达到性能最优.</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;1-Netty-架构设计&quot;&gt;&lt;a href=&quot;#1-Netty-架构设计&quot; class=&quot;headerlink&quot; title=&quot;1. Netty 架构设计&quot;&gt;&lt;/a&gt;1. Netty 架构设计&lt;/h1&gt;&lt;p&gt;Netty应用中必不可少的组件：&lt;/p&gt;
&lt;table&gt;
      
    
    </summary>
    
      <category term="Netty" scheme="https://destinywang.github.io/blog/categories/Netty/"/>
    
    
      <category term="Netty" scheme="https://destinywang.github.io/blog/tags/Netty/"/>
    
  </entry>
  
</feed>
